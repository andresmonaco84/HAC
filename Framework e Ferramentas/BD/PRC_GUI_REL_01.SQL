CREATE OR REPLACE PROCEDURE "PRC_GUI_REL_01" (
    pDATA_INI IN TSS_SPSADT_SGS_SOL_V3.DT_ATENDIMENTO%TYPE DEFAULT NULL,
    pDATA_FIM IN TSS_SPSADT_SGS_SOL_V3.DT_ATENDIMENTO%TYPE DEFAULT NULL,
    pCAD_PRO_ID_PROFISSIONAL IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%TYPE DEFAULT NULL,
    pCAD_PLA_CD_TIPOPLANO_GB IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL, --ACS
    pCAD_PLA_CD_TIPOPLANO_PL IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL, --ACS
    pCAD_PLA_CD_TIPOPLANO_FU IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_PLA_CD_TIPOPLANO_NP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_PLA_CD_TIPOPLANO_PA IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_PLA_CD_TIPOPLANO_SP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pASS_PAP_FL_STATUS_AUTOR IN TB_ASS_PAP_PAC_ATEN_PROC.ASS_PAP_FL_STATUS_AUTOR%TYPE DEFAULT NULL,
     pTIPO_QUIMIOTERAPIA VARCHAR2 DEFAULT NULL,
     pTIPO_RADIOTERAPIA VARCHAR2 DEFAULT NULL,
     IO_CURSOR OUT PKG_CURSOR.T_CURSOR

   --   ,TESTE OUT LONG
  )
  IS
  /********************************************************************
  *    PROCEDURE: PRC_GUI_REL_01
  *
  *    DATA CRIACAO: 14/09/2015  POR: PEDRO
  *    ALTERAC?O:
  *
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
begin
OPEN v_cursor FOR

SELECT DISTINCT S.NR_ATENDIMENTO,
                S.DT_ATENDIMENTO,
                S.DT_SOL,
                S.DATA_VALIDADE,
                S.NM_BENEF,
                S.NR_PRONTUARIO,
                PES.CAD_PES_DT_NASCIMENTO,
                PES.CAD_PES_TP_SEXO,
                S.NM_PROF_SOL,
                PAP.ATD_ATE_NR_CONSELHO_SOLIC,
                PAP.ATD_ATE_CD_UFCONSELHO_SOLIC,
                TRIM(PAP.TIS_CPR_CD_CONSELHOPROF_SOLIC) TIS_CPR_CD_CONSELHOPROF_SOLIC,
                CNV.CAD_CNV_CD_HAC_PRESTADOR,
                CNV.CAD_CNV_NM_FANTASIA,
                PLA.CAD_PLA_CD_PLANO_HAC,
                PLA.CAD_PLA_NM_NOME_PLANO,
                DECODE(Q.NR_ATENDIMENTO,NULL,'RADIOTERAPIA','QUIMIOTERAPIA') TIPO_ATENDIMENTO,
                QP.DT_PREVISTA_ADMIN,
                QP.CD_TABELA,
                QP.CD_MEDICAMENTO,
                QP.DS_MEDICAMENTO,
                QP.NR_DOSE_MEDICAMENTO,
                VIA.TIS_VIA_DS_DESCRICAO,
                QP.QTD_FREQUENCIA_DIARIA

FROM  TSS_SPSADT_SGS_SOL_V3         S
LEFT JOIN TSS_SOLIC_QUIMIO_SGS_V3   Q ON Q.NR_ATENDIMENTO = S.NR_ATENDIMENTO
--LEFT JOIN TSS_SOLIC_RADIO_SGS_V3   R ON Q.NR_ATENDIMENTO = S.NR_ATENDIMENTO
JOIN TB_ASS_PAP_PAC_ATEN_PROC PAP ON PAP.ATD_ATE_ID = S.NR_ATENDIMENTO
JOIN TB_CAD_PAC_PACIENTE PAC ON PAC.CAD_PAC_ID_PACIENTE = S.IDT_PACIENTE
JOIN TB_CAD_CNV_CONVENIO CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
JOIN TB_CAD_PES_PESSOA PES ON PES.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
JOIN TB_CAD_PRO_PROFISSIONAL PRO ON PRO.CAD_PRO_NR_CONSELHO = PAP.ATD_ATE_NR_CONSELHO_SOLIC
                                AND PRO.CAD_PRO_SG_UF_CONSELHO = PAP.ATD_ATE_CD_UFCONSELHO_SOLIC
                                AND PRO.TIS_CPR_CD_CONSELHOPROF = PAP.TIS_CPR_CD_CONSELHOPROF_SOLIC
LEFT JOIN TSS_SOLIC_QUIMIO_PROC_SGS_V3 QP ON QP.NR_ATENDIMENTO = S.NR_ATENDIMENTO 
LEFT JOIN TB_TIS_VIA_VIA_ADMIN VIA ON VIA.TIS_VIA_CD_CODIGO = QP.CD_VIA_ADMINISTRATIVA
--LEFT JOIN TSS_SPSADT_PROC_SOL_SGS_V3     P    ON P.NR_CONTA           = S.NR_CONTA
                                           --  AND P.CD_PARCELA         = S.FAT_CCP_ID
--                                             AND P.NR_ATENDIMENTO     = S.NR_ATENDIMENTO
--                                             AND P.IDT_PACIENTE       = S.IDT_PACIENTE
                                             
WHERE 1=1 
AND (pDATA_INI IS NULL OR S.DT_ATENDIMENTO >= pDATA_INI)
AND (pDATA_FIM IS NULL OR S.DT_ATENDIMENTO <= pDATA_FIM)
AND (pASS_PAP_FL_STATUS_AUTOR IS NULL OR pap.ASS_PAP_FL_STATUS_AUTOR = pASS_PAP_FL_STATUS_AUTOR)
AND (pCAD_PRO_ID_PROFISSIONAL IS NULL OR PRO.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL)
AND (pCAD_PLA_CD_TIPOPLANO_GB IS not NULL and CNV.CAD_TPE_CD_CODIGO =  'ACS'
   OR  pCAD_PLA_CD_TIPOPLANO_PL  IS NOT NULL AND CNV.CAD_TPE_CD_CODIGO =  'ACS'
   OR  pCAD_PLA_CD_TIPOPLANO_PA  IS NOT NULL AND CNV.CAD_TPE_CD_CODIGO =  'PA'
   OR  pCAD_PLA_CD_TIPOPLANO_SP  IS NOT NULL AND CNV.CAD_TPE_CD_CODIGO =  'SP'
   OR  pCAD_PLA_CD_TIPOPLANO_FU  IS NOT NULL AND CNV.CAD_TPE_CD_CODIGO =  'FU'
   OR  pCAD_PLA_CD_TIPOPLANO_NP  IS NOT NULL AND CNV.CAD_TPE_CD_CODIGO =  'NP')

AND (pTIPO_QUIMIOTERAPIA IS not NULL and Q.NR_ATENDIMENTO IS NOT NULL
   OR  NULL IS NULL)   --pTIPO_RADIOTERAPIA  IS NOT NULL AND Q.NR_ATENDIMENTO IS NOT NULL)     
 ;

IO_CURSOR := V_CURSOR;

END PRC_GUI_REL_01;
