CREATE OR REPLACE PROCEDURE "PRC_FAT_REL_GUIA_SADT_V3" (
     pLOTE IN TB_FAT_FCL_CONTR_EMI_LOTE.FAT_FCL_NR_SEQ_LOTE%TYPE DEFAULT NULL,
      pATD_ATE_ID IN TSS_SPSADT_SGS_V3.NR_ATENDIMENTO%TYPE DEFAULT NULL,
    pCAD_PAC_ID_PACIENTE IN TSS_SPSADT_SGS_V3.IDT_PACIENTE%TYPE DEFAULT NULL,
    pFAT_CCP_ID IN TSS_SPSADT_SGS_V3.CD_PARCELA%TYPE DEFAULT NULL,
    pFAT_COC_ID IN TSS_SPSADT_SGS_V3.NR_CONTA%TYPE DEFAULT NULL,
    pTISS_SIMPLIFICADA IN TB_CAD_CNV_CONVENIO.CAD_CNV_FL_DISCRIMINAPACCONTA%TYPE DEFAULT NULL,
     IO_CURSOR OUT PKG_CURSOR.T_CURSOR
   --  ,TESTE OUT LONG
  )
  IS
  /********************************************************************
  *    PROCEDURE: PRC_FAT_REL_GUIA_SADT_V3
  *
  *    DATA CRIACAO: 14/05/2014  POR: PEDRO
  *    ALTERAC?O:
  *
  *    ATENDIMENTO AMB. E INTERNAC?O EXTERNO( N?O INTERNA, UTILIZA SALA DE CIRURG.)
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(3000);
  V_SELECT  varchar2(30000);
begin   --SELECT * FROM TB_FAT_FCL_CONTR_EMI_LOTE FCL ORDER BY 1 DESC
  V_WHERE := NULL;
IF pATD_ATE_ID IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND FCL.ATD_ATE_ID = ' || pATD_ATE_ID; END IF;
IF pCAD_PAC_ID_PACIENTE IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND FCL.CAD_PAC_ID_PACIENTE = ' || pCAD_PAC_ID_PACIENTE; END IF;
IF pFAT_CCP_ID IS NOT NULL THEN V_WHERE := V_WHERE || ' AND FCL.FAT_CCP_ID = ' || pFAT_CCP_ID;    END IF;
IF pFAT_COC_ID IS NOT NULL THEN    V_WHERE := V_WHERE || ' AND FCL.FAT_COC_ID = ' || pFAT_COC_ID;    END IF;
V_SELECT:=
'
SELECT 
         AAA.FAT_FCL_NR_SEQ_LOTE,      AAA.FAT_FCL_NR_SEQ_IMPRIME,
      AAA.AA_RECEITA,
      AAA.CD_CONVENIO,
      AAA.DS_CONVENIO,
      NVL(NVL(AAA.NR_ATENDIMENTO,GAMBI.NR_ATENDIMENTO),GAMBI2.NR_ATENDIMENTO) NR_ATENDIMENTO,
          NVL(NVL(AAA.CD_PARCELA,GAMBI.CD_PARCELA),GAMBI2.CD_PARCELA) CD_PARCELA,
          NVL(NVL(AAA.IDT_PACIENTE,GAMBI.IDT_PACIENTE),GAMBI2.IDT_PACIENTE) IDT_PACIENTE,
          NVL(NVL(AAA.NR_CONTA,GAMBI.NR_CONTA),GAMBI2.NR_CONTA) NR_CONTA,
      AAA.CD_REGISTRO_ANS ,
      AAA.NR_GUIA_PRINCIPAL,
      AAA.DT_AUTORIZACAO,
      AAA.CD_SENHA,
      AAA.DT_VAL_SENHA,
      AAA.NR_GUIA_OPERADORA,
--DADOS DO BENEFICIARIO      
      AAA.NR_CARTEIRA_BENEF,
      AAA.DT_VAL_CARTEIRA_BENEF,
      AAA.NM_SOCIAL,
      AAA.NM_BENEF,
      AAA.NR_CNS_BENEF,
      AAA.ID_ATENDIMENTO_RN, 
--DADOS DO SOLICITANTE
      AAA.CD_OPER_CNPJ_CPF_SOL,
      AAA.NM_CONT_SOL,      
      AAA.NM_PROF_SOL,      
      AAA.CONS_PROF_SOL,
      AAA.NR_CONS_PROF_SOL,
      AAA.SG_UF_PROF_SOL ,
      AAA.CD_ESPEC_SOL,
      AAA.ASSINATURA_SOL,
--DADOS DA SOLICITAC?O / PROCEDIMENTOS OU ITENS ASSISTENCIAIS SOLICITADOS      
      AAA.CD_TP_CARAT_ATEND,
      AAA.DT_SOL,
      AAA.DS_IND_CLINICA,
      AAA.CD_COBERTURA_ESPECIAL,
      AAA.TABELA_ITEM,
      AAA.COD_PROCEDIMENTO_ASSISTENCIAL,
      AAA.DESCRICAO_ITEM,
      AAA.QTD_SOLIC_ITEM,
      AAA.QTD_AUT_ITEM,
--DADOS DO CONTRATADO EXECUTANTE      
      AAA.CD_OPER_CNPJ_CPF_EXEC,
      AAA.NM_CONT_EXEC,      
      AAA.CD_CNES_EXEC,
--DADOS DO ATENDIMENTO      
      AAA.CD_TP_ATENDIMENTO,
      AAA.CD_ID_ACIDENTE,
      AAA.CD_TIPO_CONSULTA,--S.CD_TP_SAIDA ,
      AAA.CD_REGIME_ATENDIMENTO,
      AAA.CD_SAUDE_OCUPACIONAL,
      AAA.MOTIVO_ENCERRAMENTO,
--DADOS DA EXECUC?O / PROCEDIMENTOS E EXAMES REALIZADOS
      NVL(NVL(AAA.NR_SEQ_PROC,GAMBI.NR_SEQ_PROC),1) NR_SEQ_PROC,
      AAA.DT_PROC_REAL,
      AAA.HR_INI_PROC,
      AAA.HR_FIM_PROC,
      AAA.CD_TABELAS,
      AAA.CD_PROC_REAL,
      AAA.DS_PROC_REAL,
      AAA.QT_PROC_REAL,
      AAA.CD_VIA_ACESSO ,
      AAA.CD_TECNICA_UTILIZADA,
      AAA.NR_RED_ACR ,
      AAA.VL_UNIT_PROC,
      AAA.VL_TOTAL_PROC_PROC ,
--IDENTIFICAC?O DOS PROFISSIONAIS EXECUTANTES      
      --E.AA_RECEITA,
      NVL(NVL(AAA.NR_SEQ_PROF,GAMBI2.NR_SEQ_PROF),1) NR_SEQ_PROF,
      AAA.CD_POS_PROF_EQUIPE,
      AAA.CD_OPER_CNPJ_CPF_EXEC_E,
      AAA.NM_PROF_EXEC,
      AAA.SG_CONS_PROF_EXEC,
      AAA.NR_CONS_PROF_EXEC,
      AAA.SG_UF_PROF_EXEC,      
      AAA.CD_ESPEC_EXEC,      
--OBS E TOTAIS      
      AAA.DS_OBSERVACAO,
      AAA.VL_TOTAL_PROC ,
      AAA.VL_TOTAL_TX_ALUGUEIS ,
      AAA.VL_TOTAL_MAT,
      AAA.VL_TOTAL_OPM,
      AAA.VL_TOTAL_MED,
      AAA.VL_TOTAL_GASES,
      AAA.VL_TOTAL_GERAL    
FROM 
(
SELECT DISTINCT FCL.FAT_FCL_NR_SEQ_LOTE,      FCL.FAT_FCL_NR_SEQ_IMPRIME,
      S.AA_RECEITA,
      S.CD_CONVENIO,
      S.DS_CONVENIO,
      S.NR_ATENDIMENTO,
      S.CD_PARCELA,
      S.IDT_PACIENTE,
      S.NR_CONTA,
      S.CD_REGISTRO_ANS ,
      S.NR_GUIA_PRINCIPAL,
      S.DT_AUTORIZACAO,
      S.CD_SENHA,
      S.DT_VAL_SENHA,
      S.NR_GUIA_OPERADORA,
--DADOS DO BENEFICIARIO      
      S.NR_CARTEIRA_BENEF,
      S.DT_VAL_CARTEIRA_BENEF,
      S.NM_SOCIAL,
      S.NM_BENEF,
      S.NR_CNS_BENEF,
      S.ID_ATENDIMENTO_RN, 
--DADOS DO SOLICITANTE
      S.CD_OPER_CNPJ_CPF_SOL,
      S.NM_CONT_SOL,      
      S.NM_PROF_SOL,      
      S.CONS_PROF_SOL,
      S.NR_CONS_PROF_SOL,
      S.SG_UF_PROF_SOL ,
      S.CD_ESPEC_SOL,
      NULL ASSINATURA_SOL,
--DADOS DA SOLICITAC?O / PROCEDIMENTOS OU ITENS ASSISTENCIAIS SOLICITADOS      
      S.CD_TP_CARAT_ATEND,
      S.DT_SOL,
      S.DS_IND_CLINICA,
      S.CD_COBERTURA_ESPECIAL,
      NULL TABELA_ITEM,
      NULL COD_PROCEDIMENTO_ASSISTENCIAL,
      NULL DESCRICAO_ITEM,
      NULL QTD_SOLIC_ITEM,
      NULL QTD_AUT_ITEM,
--DADOS DO CONTRATADO EXECUTANTE      
      S.CD_OPER_CNPJ_CPF_EXEC,
      S.NM_CONT_EXEC,      
      S.CD_CNES_EXEC,
--DADOS DO ATENDIMENTO      
      S.CD_TP_ATENDIMENTO,
      S.CD_ID_ACIDENTE,
      S.CD_TIPO_CONSULTA,--S.CD_TP_SAIDA ,
      S.CD_REGIME_ATENDIMENTO,
      S.CD_SAUDE_OCUPACIONAL,
      NULL MOTIVO_ENCERRAMENTO,
--DADOS DA EXECUC?O / PROCEDIMENTOS E EXAMES REALIZADOS
   DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,TO_NUMBER(P.NR_SEQ)) NR_SEQ_PROC,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.DT_PROC_REAL) DT_PROC_REAL,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,DECODE(P.HR_INI_PROC,NULL,'''', SUBSTR(LPAD(TO_CHAR(P.HR_INI_PROC),4,''0''),1,2) || '':'' || SUBSTR(LPAD(TO_CHAR(P.HR_INI_PROC),4,''0''),3,2)))   HR_INI_PROC,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,DECODE(P.HR_FIM_PROC,NULL,'''', SUBSTR(LPAD(TO_CHAR(P.HR_FIM_PROC),4,''0''),1,2) || '':'' || SUBSTR(LPAD(TO_CHAR(P.HR_FIM_PROC),4,''0''),3,2)))   HR_FIM_PROC,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.CD_TABELAS) CD_TABELAS,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.CD_PROC_REAL) CD_PROC_REAL,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.DS_PROC_REAL) DS_PROC_REAL,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,REPLACE(TO_CHAR(P.QT_PROC_REAL),''.'','','')) QT_PROC_REAL,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.CD_VIA_ACESSO) CD_VIA_ACESSO,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.CD_TECNICA_UTILIZADA) CD_TECNICA_UTILIZADA,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.NR_RED_ACR) NR_RED_ACR,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.VL_UNIT_PROC) VL_UNIT_PROC,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,P.VL_TOTAL_PROC) VL_TOTAL_PROC_PROC   ,
--IDENTIFICAC?O DOS PROFISSIONAIS EXECUTANTES      
      --E.AA_RECEITA,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,TO_NUMBER(E.NR_SEQ))  NR_SEQ_PROF,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,E.CD_POS_PROF_EQUIPE) CD_POS_PROF_EQUIPE,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,E.CD_OPER_CNPJ_CPF_EXEC)  CD_OPER_CNPJ_CPF_EXEC_E,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,E.NM_PROF_EXEC) NM_PROF_EXEC,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,E.SG_CONS_PROF_EXEC) SG_CONS_PROF_EXEC,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,E.NR_CONS_PROF_EXEC) NR_CONS_PROF_EXEC,
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,E.SG_UF_PROF_EXEC) SG_UF_PROF_EXEC ,      
      DECODE('||CHR(39)|| pTISS_SIMPLIFICADA ||CHR(39)||' ,''S'',NULL,E.CD_ESPEC_EXEC) CD_ESPEC_EXEC,   
--OBS E TOTAIS      
      S.DS_OBSERVACAO,
      S.VL_TOTAL_PROC ,
      S.VL_TOTAL_TX_ALUGUEIS ,
      S.VL_TOTAL_MAT,
      S.VL_TOTAL_OPM,
      S.VL_TOTAL_MED,
      S.VL_TOTAL_GASES,
      S.VL_TOTAL_GERAL      
FROM TB_FAT_FCL_CONTR_EMI_LOTE      FCL
     JOIN TSS_SPSADT_SGS_V3              S    ON S.NR_CONTA           = FCL.FAT_COC_ID
                                             AND S.CD_PARCELA         = FCL.FAT_CCP_ID
                                             AND S.NR_ATENDIMENTO     = FCL.ATD_ATE_ID
                                             AND S.IDT_PACIENTE       = FCL.CAD_PAC_ID_PACIENTE
LEFT JOIN TSS_SPSADT_PROC_REAL_SGS_V3     P    ON P.NR_CONTA           = FCL.FAT_COC_ID
                                             AND P.CD_PARCELA         = FCL.FAT_CCP_ID
                                             AND P.NR_ATENDIMENTO     = FCL.ATD_ATE_ID
                                             AND P.IDT_PACIENTE       = FCL.CAD_PAC_ID_PACIENTE
LEFT JOIN TSS_SPSADT_PROC_EQUIPE_SGS_V3   E    ON E.NR_CONTA           = FCL.FAT_COC_ID
                                             AND E.CD_PARCELA         = FCL.FAT_CCP_ID
                                             AND E.NR_ATENDIMENTO     = FCL.ATD_ATE_ID
                                             AND E.IDT_PACIENTE       = FCL.CAD_PAC_ID_PACIENTE
        WHERE (FCL.FAT_FCL_NR_SEQ_LOTE  = ' ||CHR(39)|| PLOTE ||CHR(39)||' )'
       || V_WHERE || '        
   ) AAA
FULL JOIN (SELECT FCL.FAT_FCL_NR_SEQ_LOTE, FCL.ATD_ATE_ID NR_ATENDIMENTO, FCL.CAD_PAC_ID_PACIENTE IDT_PACIENTE, FCL.FAT_CCP_ID CD_PARCELA, FCL.FAT_COC_ID NR_CONTA, A.NR_SEQ_PROC FROM TB_FAT_FCL_CONTR_EMI_LOTE FCL 
          LEFT JOIN (SELECT 1 NR_SEQ_PROC FROM DUAL UNION 
                    SELECT 2 NR_SEQ_PROC FROM DUAL UNION
                    SELECT 3 NR_SEQ_PROC FROM DUAL UNION
                    SELECT 4 NR_SEQ_PROC FROM DUAL UNION
                    SELECT 5 NR_SEQ_PROC FROM DUAL ) A ON 1=1
          WHERE FCL.FAT_FCL_NR_SEQ_LOTE       = ' ||CHR(39)|| PLOTE ||CHR(39)||' '
       || V_WHERE || '           
          ) GAMBI ON GAMBI.NR_SEQ_PROC        = NVL(AAA.NR_SEQ_PROC,1)
                AND GAMBI.NR_CONTA            = AAA.NR_CONTA
                AND GAMBI.CD_PARCELA          = AAA.CD_PARCELA
                AND GAMBI.NR_ATENDIMENTO      = AAA.NR_ATENDIMENTO
                AND GAMBI.IDT_PACIENTE        = AAA.IDT_PACIENTE
FULL JOIN (SELECT FCL.FAT_FCL_NR_SEQ_LOTE, FCL.ATD_ATE_ID NR_ATENDIMENTO, FCL.CAD_PAC_ID_PACIENTE IDT_PACIENTE, FCL.FAT_CCP_ID CD_PARCELA, FCL.FAT_COC_ID NR_CONTA, A.NR_SEQ_PROF FROM TB_FAT_FCL_CONTR_EMI_LOTE FCL 
          LEFT JOIN (SELECT 1 NR_SEQ_PROF FROM DUAL UNION 
                    SELECT 2 NR_SEQ_PROF FROM DUAL UNION
                    SELECT 3 NR_SEQ_PROF FROM DUAL UNION
                    SELECT 4 NR_SEQ_PROF FROM DUAL 
                    ) A ON 1=1
          WHERE FCL.FAT_FCL_NR_SEQ_LOTE       = ' ||CHR(39)|| PLOTE ||CHR(39)||' '
       || V_WHERE || '  
          ) GAMBI2 ON GAMBI2.NR_SEQ_PROF       = NVL(AAA.NR_SEQ_PROF,1)
                AND GAMBI2.NR_CONTA            = AAA.NR_CONTA
                AND GAMBI2.CD_PARCELA          = AAA.CD_PARCELA
                AND GAMBI2.NR_ATENDIMENTO      = AAA.NR_ATENDIMENTO
                AND GAMBI2.IDT_PACIENTE        = AAA.IDT_PACIENTE
         ORDER BY  AAA.FAT_FCL_NR_SEQ_LOTE,AAA.FAT_FCL_NR_SEQ_IMPRIME,   NVL(AAA.NR_SEQ_PROC,GAMBI.NR_SEQ_PROC),NVL(AAA.NR_SEQ_PROF,GAMBI2.NR_SEQ_PROF)'
  ;
  --    TESTE :=  V_SELECT ;
	 --dbms_output.put_line(V_SELECT);
  OPEN v_cursor FOR
   V_SELECT ;
  -- SELECT 1 FROM DUAL;
             IO_CURSOR := V_CURSOR;
  END PRC_FAT_REL_GUIA_SADT_V3;
