CREATE OR REPLACE PROCEDURE "PRC_INT_REL_35_SITUACAO_QLE"
(
  pATD_ATE_DT_ATENDIMENTO_INI IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
  pATD_ATE_DT_ATENDIMENTO_FIM IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
  pATD_ATE_HR_ATENDIMENTO_INI IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_HR_ATENDIMENTO%TYPE DEFAULT NULL,
  pATD_ATE_HR_ATENDIMENTO_FIM IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_HR_ATENDIMENTO%TYPE DEFAULT NULL,
  pATD_ATE_FL_CARATER_SOLIC_U IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_CARATER_SOLIC%TYPE DEFAULT NULL,
  pATD_ATE_FL_CARATER_SOLIC_E IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_CARATER_SOLIC%TYPE DEFAULT NULL,
  pFAIXA_ETARIA_INI VARCHAR2 DEFAULT NULL,
  pFAIXA_ETARIA_FIM VARCHAR2 DEFAULT NULL,
  pCAD_UNI_ID_UNIDADE IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
  pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
  pCAD_SET_ID IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,
  pCAD_SET_NR_ANDAR IN TB_CAD_SET_SETOR.CAD_SET_NR_ANDAR%TYPE DEFAULT NULL,
  pATD_AIC_TP_SITUACAO_PAC IN TB_ATD_AIC_ATE_INT_COMPL.ATD_AIC_TP_SITUACAO_PAC%TYPE DEFAULT NULL,
  pATD_ATE_TP_PACIENTE_I IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_TP_PACIENTE%TYPE DEFAULT NULL,
  pATD_ATE_TP_PACIENTE_E IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_TP_PACIENTE%TYPE DEFAULT NULL,
  pCAD_QLE_TP_QUARTO_LEITO IN TB_CAD_QLE_QUARTO_LEITO.CAD_QLE_TP_QUARTO_LEITO%TYPE DEFAULT NULL,
  pTIS_TIN_CD_INTER IN TB_ATD_AIC_ATE_INT_COMPL.TIS_TIN_CD_INTERNACAO%TYPE DEFAULT NULL,
  pTIS_TRI_CD_TP_REGINT IN TB_ATD_AIC_ATE_INT_COMPL.TIS_TRI_CD_REGINTENNACAO%TYPE DEFAULT NULL,
  pCAD_PLA_CD_TIPOPLANO_GB IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL, --ACS
  pCAD_PLA_CD_TIPOPLANO_PL IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL, --ACS
  pCAD_PLA_CD_TIPOPLANO_FU IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
  pCAD_PLA_CD_TIPOPLANO_NP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
  pCAD_PLA_CD_TIPOPLANO_PA IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
  pCAD_PLA_CD_TIPOPLANO_SP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
  pCAD_PRD_ID IN TB_CAD_PRD_PRODUTO.CAD_PRD_ID%TYPE DEFAULT NULL,
  pTIS_TAC_CD_TIPO_ACOMODACAO IN TB_TIS_TAC_TIPO_ACOMODACAO.TIS_TAC_CD_TIPO_ACOMODACAO%TYPE DEFAULT NULL,
  pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%TYPE DEFAULT NULL,
  pCAD_PRO_ID_PROF_EXEC IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%TYPE DEFAULT NULL,
  pCAD_PES_TP_SEXO IN TB_CAD_PES_PESSOA.CAD_PES_TP_SEXO%TYPE DEFAULT NULL,
  pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
  pCAD_PLA_ID_PLANO IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%TYPE DEFAULT NULL,
  pCAD_UNI_ID_UNID_PROC IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNID_PROC%TYPE DEFAULT NULL,
  pCAD_SQL_CD_SIT_QUARTO_LEITO IN TB_CAD_QLE_QUARTO_LEITO.CAD_SQL_CD_SIT_QUARTO_LEITO%TYPE DEFAULT NULL,
  io_cursor OUT PKG_CURSOR.t_cursor) is
  /********************************************************************
  *    Procedure: PRC_INT_REL_35_SITUACAO_QLE
  *
  *    Data Criacao:  06/2014   Por: pedro
  *    Data Alteracao:           Por:
  *
  *    Funcao: Popula o Relatorio de Pacientes Internados com varias possibilidades de filtro
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
begin
  OPEN v_cursor FOR
        SELECT QLE.CAD_QLE_TP_QUARTO_LEITO,
               DECODE(QLE.CAD_QLE_TP_QUARTO_LEITO,'I','INTERNO','E','EXTRA') CAD_QLE_TP_QUARTO_LEITO_DS,
               QLE.CAD_QLE_NR_QUARTO, QLE.CAD_QLE_NR_LEITO,TRIM(REPLACE(QLE.CAD_QLE_DS_OBSERVACAO,CHR(10),' '))CAD_QLE_DS_OBSERVACAO,QLE.CAD_SQL_CD_SIT_QUARTO_LEITO,
               TRIM(SQLL.CAD_SQL_DS_SIT_QUARTO_LEITO) CAD_SQL_DS_SIT_QUARTO_LEITO,
               HQL.CAD_HQL_DT_HR_INICIO DT_INICIO,
               TRIM(TAC.TIS_TAC_DS_TIPO_ACOMODACAO) TIS_TAC_DS_TIPO_ACOMODACAO,
               TRIM(TACP.TIS_TAC_DS_TIPO_ACOMODACAO) TIS_TAC_DS_TIPO_ACOMODACAO_P,
               UNI.CAD_UNI_DS_UNIDADE ,
               LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
               SETOR.CAD_SET_DS_SETOR,
               COUNT (QLE.CAD_SQL_CD_SIT_QUARTO_LEITO) OVER(PARTITION BY QLE.CAD_SQL_CD_SIT_QUARTO_LEITO) TOTAL_POR_SITUACAO,
               COUNT (QLE.CAD_SQL_CD_SIT_QUARTO_LEITO) OVER(PARTITION BY QLE.CAD_SET_ID) TOTAL_POR_SETOR,
               COUNT (QLE.CAD_SQL_CD_SIT_QUARTO_LEITO) OVER() TOTAL_GERAL

          FROM TB_CAD_QLE_QUARTO_LEITO      QLE
     LEFT JOIN TB_TIS_TAC_TIPO_ACOMODACAO   TAC   ON TAC.TIS_TAC_CD_TIPO_ACOMODACAO   = QLE.TIS_TAC_CD_TIPO_ACOMODACAO
     LEFT JOIN TB_TIS_TAC_TIPO_ACOMODACAO   TACP  ON TACP.TIS_TAC_CD_TIPO_ACOMODACAO  = QLE.TIS_TAC_CD_TIPO_ACOM_PROV
          JOIN TB_CAD_SQL_SIT_QUARTO_LEITO  SQLL  ON SQLL.CAD_SQL_CD_SIT_QUARTO_LEITO = QLE.CAD_SQL_CD_SIT_QUARTO_LEITO
          JOIN TB_CAD_SET_SETOR             SETOR ON SETOR.CAD_SET_ID                 = QLE.CAD_SET_ID
          JOIN TB_CAD_UNI_UNIDADE           UNI   ON UNI.CAD_UNI_ID_UNIDADE           = SETOR.CAD_UNI_ID_UNIDADE
          JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT   ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO
     LEFT JOIN TB_CAD_HQL_HIS_SIT_QTO_LEITO HQL   ON HQL.CAD_QLE_ID                   = QLE.CAD_QLE_ID
           AND HQL.CAD_HQL_DT_HR_FIM IS NULL

         WHERE (pCAD_UNI_ID_UNIDADE IS NULL OR SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE)
           AND (pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO)
           AND (pCAD_SET_ID IS NULL OR QLE.CAD_SET_ID = pCAD_SET_ID)
           AND (pCAD_SQL_CD_SIT_QUARTO_LEITO IS NULL OR QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = pCAD_SQL_CD_SIT_QUARTO_LEITO)
           AND ((QLE.CAD_QLE_TP_QUARTO_LEITO = 'I' AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO != '2') OR
                (QLE.CAD_QLE_TP_QUARTO_LEITO IN ('I','E') AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = '2'))

      ORDER BY SETOR.CAD_SET_DS_SETOR,
               QLE.CAD_QLE_NR_QUARTO,
               QLE.CAD_QLE_NR_LEITO;
  IO_CURSOR := V_CURSOR;
END PRC_INT_REL_35_SITUACAO_QLE;
