CREATE OR REPLACE PROCEDURE "PRC_CAD_PLA_FINALIZAR_VIGENCIA" (
     pCAD_CNV_ID_CONVENIO IN TB_CAD_PLA_PLANO.CAD_CNV_ID_CONVENIO%type,
     pCAD_PLA_ID_PLANO IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%type default NULL,          
     pCAD_PLA_DT_FIM_VIGENCIA IN TB_CAD_PLA_PLANO.CAD_PLA_DT_FIM_VIGENCIA%type default NULL,
     pSEG_USU_ID_USUARIO IN TB_CAD_PLA_PLANO.SEG_USU_ID_USUARIO%type,
     pCAD_PLA_DS_OBS_FIM_VIG IN TB_CAD_PLA_PLANO.CAD_PLA_DS_OBS_FIM_VIG%type default NULL,

     pCAD_PLA_FL_SITUACAO_PLANO IN TB_CAD_PLA_PLANO.CAD_PLA_FL_SITUACAO_PLANO%type default NULL
  )
  is
  /********************************************************************
  *    Procedure: PRC_CAD_PLA_FINALIZAR_VIGENCIA
  *  
  *******************************************************************/
 
  begin
    
    --Finaliza a vigência do plano de saúde
    UPDATE TB_CAD_PLA_PLANO
    SET
        CAD_PLA_DT_ULT_ATUALIZACAO = SYSDATE,
        SEG_USU_ID_USUARIO = pSEG_USU_ID_USUARIO,
        CAD_PLA_DT_FIM_VIGENCIA = PCAD_PLA_DT_FIM_VIGENCIA,
        CAD_PLA_DS_OBS_FIM_VIG = PCAD_PLA_DS_OBS_FIM_VIG,
        CAD_PLA_FL_SITUACAO_PLANO = DECODE(PCAD_PLA_FL_SITUACAO_PLANO,NULL, CAD_PLA_FL_SITUACAO_PLANO,PCAD_PLA_FL_SITUACAO_PLANO)
    WHERE
        CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO
    AND (pCAD_PLA_ID_PLANO IS NULL OR CAD_PLA_ID_PLANO = pCAD_PLA_ID_PLANO);

    --Finaliza a vigência do local de atendimento
    --PRC_ASS_CLP_FINALIZAR_VIGENCIA(pCAD_CNV_ID_CONVENIO, pCAD_PLA_ID_PLANO, pCAD_PLA_DT_FIM_VIGENCIA, pSEG_USU_ID_USUARIO);
    
    --Finaliza a vigência do tipo de atendimento
    --PRC_ASS_PTA_FINALIZAR_VIGENCIA(pCAD_CNV_ID_CONVENIO, pCAD_PLA_ID_PLANO, pCAD_PLA_DT_FIM_VIGENCIA, pSEG_USU_ID_USUARIO, PCAD_PLA_DS_OBS_FIM_VIG);
    
    --Finaliza a vigência do tipo de acomodação
   -- PRC_ASS_CTP_FINALIZAR_VIGENCIA(pCAD_CNV_ID_CONVENIO, pCAD_PLA_ID_PLANO, pCAD_PLA_DT_FIM_VIGENCIA, pSEG_USU_ID_USUARIO);
    
    --Finaliza a vigência do histórico
    PRC_CAD_PHS_FINALIZAR_VIGENCIA(pCAD_CNV_ID_CONVENIO, pCAD_PLA_ID_PLANO, pCAD_PLA_DT_FIM_VIGENCIA, pSEG_USU_ID_USUARIO, PCAD_PLA_FL_SITUACAO_PLANO);
    
    
  end PRC_CAD_PLA_FINALIZAR_VIGENCIA;
 