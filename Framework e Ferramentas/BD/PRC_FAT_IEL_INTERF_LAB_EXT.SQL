CREATE OR REPLACE PROCEDURE "PRC_FAT_IEL_INTERF_LAB_EXT" ( pATD_ATE_ID IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_ID%TYPE,
                                                           pCODIGOPRD IN TB_CAD_PRD_PRODUTO.CAD_PRD_CD_CODIGO%TYPE,
                                                           pTABELAPRD IN TB_CAD_PRD_PRODUTO.TIS_MED_CD_TABELAMEDICA%TYPE,
                                                           pDATAEXA IN TB_IEL_INTERF_EXAMES_LAB.IEL_DT_EXAME%TYPE,
                                                           pHORAEXA IN TB_IEL_INTERF_EXAMES_LAB.IEL_HR_EXAME%TYPE,
                                                           pACAO IN TB_IEL_INTERF_EXAMES_LAB.IEF_DS_ACAO%TYPE,
                                                           pIEL_QT_EXAME IN TB_IEL_INTERF_EXAMES_LAB.IEL_QT_EXAME%TYPE DEFAULT NULL,
                                                           pCAD_PRO_ID_PROF_EXEC IN TB_ATD_ATE_ATENDIMENTO.CAD_PRO_ID_PROF_EXEC%TYPE DEFAULT NULL)
IS
vATD_ATE_TP_PACIENTE   TB_ATD_ATE_ATENDIMENTO.ATD_ATE_TP_PACIENTE%TYPE;
vCAD_PAC_ID_PACIENTE   TB_CAD_PAC_PACIENTE.CAD_PAC_ID_PACIENTE%TYPE;
vCAD_UNI_ID_UNIDADE    TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE;
vCAD_LAT_ID_LOCAL      TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE;
vCAD_SET_ID_SETOR      TB_ATD_ATE_ATENDIMENTO.CAD_SET_ID%TYPE;
vCAD_PRD_ID_ORIGEM     TB_CAD_PRD_PRODUTO.CAD_PRD_ID%TYPE;
vCODCON                SADT_PACIENTE.CODCON%TYPE;
vCONTADOR              NUMBER;
vERRO_PRODUTO              NUMBER;
vERRO_ATENDIMENTO            NUMBER;
BEGIN
 
 BEGIN
  SELECT 1 into vERRO_ATENDIMENTO FROM TB_ATD_ATE_ATENDIMENTO ATE WHERE ATE.ATD_ATE_ID = pATD_ATE_ID;
  EXCEPTION WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20001,'Atendimento ' || pATD_ATE_ID ||' n?o encontrado.');
  END;
  
  BEGIN
  SELECT 1 into vERRO_PRODUTO FROM TB_CAD_PRD_PRODUTO PRD
         WHERE PRD.CAD_PRD_CD_CODIGO = pCODIGOPRD AND PRD.TIS_MED_CD_TABELAMEDICA = pTABELAPRD;
  EXCEPTION WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20002,'N?o foi encontrado o produto ' || pCODIGOPRD || ' na tabela ' || pTABELAPRD);
  END;
  -- BUSCA DADOS DA REQUISIC?O;
  BEGIN
    SELECT ATD.ATD_ATE_TP_PACIENTE,
           PAC.CAD_PAC_ID_PACIENTE,
           ATD.CAD_UNI_ID_UNIDADE,
           ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO,
           CASE WHEN ATD.CAD_UNI_ID_UNIDADE = 244 AND ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E') THEN 1092
                WHEN ATD.CAD_UNI_ID_UNIDADE = 245 AND ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E') THEN 121
                WHEN ATD.CAD_UNI_ID_UNIDADE = 247 AND ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E') THEN 123
                ELSE ATD.CAD_SET_ID END SETOR,
           PRD.CAD_PRD_ID,
           CON.CAD_CNV_CD_HAC_PRESTADOR
      INTO vATD_ATE_TP_PACIENTE,
           vCAD_PAC_ID_PACIENTE,
           vCAD_UNI_ID_UNIDADE,
           vCAD_LAT_ID_LOCAL,
           vCAD_SET_ID_SETOR,
           vCAD_PRD_ID_ORIGEM,
           vCODCON
      FROM TB_ATD_ATE_ATENDIMENTO        ATD,
           TB_CAD_CNV_CONVENIO           CON,
           TB_CAD_PAC_PACIENTE           PAC,
           TB_CAD_PRD_PRODUTO            PRD
     WHERE FNC_BUSCAR_PACIENTE_ATUAL(ATD.ATD_ATE_ID) = PAC.CAD_PAC_ID_PACIENTE
       AND CON.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
       AND (CON.CAD_CNV_CD_HAC_PRESTADOR != 'PA__' OR (CON.CAD_CNV_CD_HAC_PRESTADOR = 'PA__' AND ATD.ATD_ATE_TP_PACIENTE IN ('I','E')))
       AND ATD.ATD_ATE_ID = pATD_ATE_ID
       AND PRD.CAD_PRD_CD_CODIGO = pCODIGOPRD
       AND PRD.TIS_MED_CD_TABELAMEDICA = pTABELAPRD
       AND ROWNUM = 1;
  EXCEPTION
    WHEN OTHERS THEN
      RAISE_APPLICATION_ERROR(-20000,'1Erro ' || pATD_ATE_ID ||' tabela ' || pTABELAPRD || ' produto ' || pCODIGOPRD);
  END;
  -- VERIFICA SE EXISTE REQUISIC?O QUE AINDA N?O FOI FATURADA;
  /*BEGIN
    SELECT COUNT(*)
      INTO vCONTADOR
      FROM TB_IEL_INTERF_EXAMES_LAB
     WHERE ATD_ATE_ID = pATD_ATE_ID
       AND CAD_PAC_ID_PACIENTE = vCAD_PAC_ID_PACIENTE
       AND IEL_DT_EXAME = pDATAEXA
       AND IEL_HR_EXAME = pHORAEXA
       AND CAD_PRD_ID_DIGITADO = vCAD_PRD_ID_ORIGEM
       AND IEF_DS_ACAO = 'INS';
    EXCEPTION
      WHEN OTHERS THEN*/
        vCONTADOR := 0;
 --END;
 
 
  IF vCONTADOR = 0 AND pACAO = 'INS' THEN
    -- INSERE DADOS DA REQUISIC?O;
    BEGIN
      INSERT INTO TB_IEL_INTERF_EXAMES_LAB
        (ATD_ATE_ID,
         ATD_ATE_TP_PACIENTE,
         CAD_PAC_ID_PACIENTE,
         CAD_UNI_ID_UNIDADE,
         CAD_LAT_ID_LOCAL,
         CAD_SET_ID_SETOR,
         IEL_DT_EXAME,
         IEL_HR_EXAME,
         IEL_CD_MNEMONICO,
         CAD_PRD_ID_DIGITADO,
         IEL_FL_ATUALIZADO_LANCAM,
         IEF_DT_CRIACAO,
         IEF_DS_ACAO,
         SEG_USU_ID_USUARIO,
         IEF_DT_ULTIMA_ATUALIZACAO,
         ATS_APL_ID,
         CAD_PRO_ID_PROFISSIONAL,
         IEL_QT_EXAME,
         IEL_DS_OBSERVACAO)
      VALUES
        (pATD_ATE_ID,
         vATD_ATE_TP_PACIENTE,
         vCAD_PAC_ID_PACIENTE,
         vCAD_UNI_ID_UNIDADE,
         vCAD_LAT_ID_LOCAL,
         vCAD_SET_ID_SETOR,
         pDATAEXA,
         pHORAEXA,
         NULL,
         vCAD_PRD_ID_ORIGEM,
         'N',
         SYSDATE,
         pACAO,
         19362,
         SYSDATE,
         SEQ_ATS_APL.NEXTVAL,
         DECODE(pCAD_PRO_ID_PROF_EXEC,NULL,2467,pCAD_PRO_ID_PROF_EXEC),
         NVL(pIEL_QT_EXAME,1),
         'REGISTRO INCLUIDO COM SUCESSO EM '||TO_CHAR(SYSDATE,'DD/MM/YYYY HH24:MI:SS'));
    EXCEPTION
      WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20000,'2Erro Inclus?o Atend. ' || pATD_ATE_ID ||' tabela ' || pTABELAPRD || ' produto ' || pCODIGOPRD);
    END;
  ELSE IF vCONTADOR = 1 AND pACAO = 'INS' THEN
    RAISE_APPLICATION_ERROR(-20003,'3Ja existe Atend. ' || pATD_ATE_ID ||' tabela ' || pTABELAPRD || ' produto ' || pCODIGOPRD);
    END IF;
  END IF;
COMMIT;
END PRC_FAT_IEL_INTERF_LAB_EXT;
