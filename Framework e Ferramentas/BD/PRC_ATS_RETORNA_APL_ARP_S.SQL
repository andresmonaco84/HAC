CREATE OR REPLACE PROCEDURE "PRC_ATS_RETORNA_APL_ARP_S"
  (
     pATS_APL_STATUS_LAUDO   IN TB_ATS_APL_ATEN_PROCED_LAUDO.ATS_APL_STATUS_LAUDO%TYPE DEFAULT NULL,
     pATS_ATE_CD_INTLIB      IN TB_ATS_APL_ATEN_PROCED_LAUDO.ATS_ATE_CD_INTLIB%TYPE DEFAULT NULL,
     pCAD_UNI_ID_UNIDADE     IN TB_ATS_ARP_ATEN_RESULT_PROCED.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
     pAUX_EPP_CD_ESPECPROC   IN TB_ATS_ARP_ATEN_RESULT_PROCED.ATS_EPP_CD_ESPECPROC%TYPE DEFAULT NULL,
     pATS_APL_DT_LAUDO_INI   IN TB_ATS_APL_ATEN_PROCED_LAUDO.ATS_APL_DT_LAUDO%TYPE DEFAULT NULL,
     pATS_APL_DT_LAUDO_FIM   IN TB_ATS_APL_ATEN_PROCED_LAUDO.ATS_APL_DT_LAUDO%TYPE DEFAULT NULL,
     pATS_APR_NR_SEQ_LOTE    IN TB_ATS_ARP_ATEN_RESULT_PROCED.ATS_APR_NR_SEQ_LOTE%TYPE DEFAULT NULL,
     pATS_ATE_ID             IN TB_ATS_APL_ATEN_PROCED_LAUDO.ATS_ATE_ID%TYPE DEFAULT NULL,
     pTIS_MED_CD_TABELAMEDICA IN TB_ATS_APL_ATEN_PROCED_LAUDO.TIS_MED_CD_TABELAMEDICA%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_ATS_RETORNA_APL_ARP_S
  *
  *    Data Alteracao:  24/06/2009  Por: Pedro
  *    Alteracao: IF pATS_APL_STATUS_LAUDO = 'P' para poder pesq por exame impresso AND (APL.ATS_APL_STATUS_LAUDO != ''L'')
  *
  *    Data Alteracao:  05/08/2009  Por: Pedro
  *    Alteracao: AND ATS.ATS_ATE_FL_STATUS    != ' ||CHR(39)|| 'C' ||CHR(39)||  CORRECAO
  *
  *    Data Alteracao:  29/03/2010  Por: Pedro
  *    Alteracao: pTIS_MED_CD_TABELAMEDICA
  *
  *    Funcao: Recupera os dados do Laudo do Procedimento/Exame
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(4000);
  V_SELECT varchar2(4000);
  begin
   V_WHERE := NULL;
   IF pATS_APL_DT_LAUDO_INI IS NOT NULL AND pATS_APL_DT_LAUDO_FIM IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND APL.ATS_APL_DT_LAUDO >= ' || CHR(39)|| pATS_APL_DT_LAUDO_INI ||CHR(39)|| ' AND APL.ATS_APL_DT_LAUDO <= ' ||CHR(39)|| pATS_APL_DT_LAUDO_FIM ||CHR(39);
   ELSIF pATS_APL_DT_LAUDO_INI IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND APL.ATS_APL_DT_LAUDO = ' ||CHR(39)|| pATS_APL_DT_LAUDO_INI ||CHR(39);
   END IF;
   IF pATS_APL_STATUS_LAUDO IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND APL.ATS_APL_STATUS_LAUDO = ' ||CHR(39)|| pATS_APL_STATUS_LAUDO ||CHR(39);
   END IF;
   IF pATS_APL_STATUS_LAUDO = 'P'  THEN
    V_WHERE := V_WHERE || ' AND ARP.ATS_APR_NR_SEQ_LOTE IS NOT NULL';
   END IF;
   IF pATS_ATE_CD_INTLIB IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND APL.ATS_ATE_CD_INTLIB = ' || pATS_ATE_CD_INTLIB;
   END IF;
   IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND ARP.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE;
   END IF;
   IF pAUX_EPP_CD_ESPECPROC IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND ARP.ATS_EPP_CD_ESPECPROC = ' || pAUX_EPP_CD_ESPECPROC;
   END IF;
   IF pATS_APR_NR_SEQ_LOTE IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND ARP.ATS_APR_NR_SEQ_LOTE = ' || pATS_APR_NR_SEQ_LOTE;
   END IF;
   IF pATS_ATE_ID IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND ARP.ATS_ATE_ID = ' || pATS_ATE_ID;
   END IF;
    IF pTIS_MED_CD_TABELAMEDICA IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND ARP.TIS_MED_CD_TABELAMEDICA = ' || pTIS_MED_CD_TABELAMEDICA;
   END IF;
   V_SELECT := 'SELECT
       ATS.ATS_ATE_DT_REALIZ_PROCED,
       APL.ATS_APL_ID,
       APL.ATS_ATE_ID,
       APL.ATS_APL_DT_LAUDO,
       APL.ATS_APL_HR_LAUDO,
       APL.ATS_APL_DS_OBSERVACAO,
       APL.CAD_PRO_ID_PROF,
       APL.CAD_CLC_ID,
       APL.ATS_APL_STATUS_LAUDO,
       APL.ATS_APL_DT_ULTIMA_ATUALIZACAO,
       APL.SEG_USU_ID_USUARIO,
       APL.ATS_APL_TEXTO_LAUDO,
       APL.AUX_EPP_CD_ESPECPROC,
       APL.ATS_ATE_IN_INTLIB,
       APL.ATS_ATE_CD_INTLIB,
       APL.CAD_PRD_ID,
       ARP.ATS_ARP_DT_RESULTADO,
       ARP.CAD_SET_ID_SETOR,
       ARP.ATS_APR_FL_STATUS,
       ARP.ATS_APR_DT_ENTREGA_RESP,
       ARP.ATS_APR_HR_ENTREGA_RESP,
       ARP.ATS_APR_NM_NOME_RESP_RECEB,
       ARP.ATS_APR_DT_ULTIMA_ATUALIZACAO,
       ARP.SEG_USU_ID_USUARIO,
       ARP.ATS_ATE_CD_INTLIB,
       ARP.ATS_ATE_IN_INTLIB,
       ARP.ATS_EPP_CD_ESPECPROC,
       ARP.ATS_ATE_ID,
       ARP.CAD_PRD_ID,
       ARP.CAD_UNI_ID_UNIDADE,
       ARP.ATS_APR_DT_PROTOCOLO,
       ARP.ATS_APR_HR_PROTOCOLO,
       ARP.SEG_USU_ID_PROTOCOLO,
       ARP.ATS_APR_DS_OBSERVACAO,
       ARP.ATS_APR_NR_SEQ_LOTE,
       ARP.ATS_APR_NR_SEQ_DIGITACAO,
       case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_NM_NOME
          --  WHEN PAC.CAD_PAC_IDT_RN = 1 AND PES_PAC.CAD_PES_NM_RN IS NOT NULL THEN PES_PAC.CAD_PES_NM_RN
            ELSE PES_PAC.CAD_PES_NM_PESSOA
       END CAD_PES_NM_PESSOA,
       
       SETOR.CAD_SET_DS_SETOR,
       UNI.CAD_UNI_DS_UNIDADE,
       PRD.CAD_PRD_NM_MNEMONICO || '' - '' || PRD.CAD_PRD_DS_DESCRICAO AS CAD_PRD_DS_DESCRICAO,
       ATS.TIS_MED_CD_TABELAMEDICA,
       USU.SEG_USU_DS_NOME

  FROM TB_ATS_APL_ATEN_PROCED_LAUDO APL
  LEFT JOIN TB_ATS_ARP_ATEN_RESULT_PROCED ARP
  ON   ARP.ATS_ATE_CD_INTLIB = APL.ATS_ATE_CD_INTLIB
  AND  ARP.ATS_ATE_IN_INTLIB = APL.ATS_ATE_IN_INTLIB
  AND  ARP.ATS_ATE_ID = APL.ATS_ATE_ID
  AND  ARP.ATS_EPP_CD_ESPECPROC = APL.AUX_EPP_CD_ESPECPROC
  AND  ARP.CAD_PRD_ID = APL.CAD_PRD_ID
  AND  ARP.TIS_MED_CD_TABELAMEDICA = APL.TIS_MED_CD_TABELAMEDICA
  JOIN TB_ATS_ATE_ATENDIMENTO_SADT ATS
  ON   ATS.ATS_ATE_CD_INTLIB = APL.ATS_ATE_CD_INTLIB
  AND  ATS.ATS_ATE_IN_INTLIB = APL.ATS_ATE_IN_INTLIB
  AND  ATS.ATS_ATE_ID = APL.ATS_ATE_ID
  AND  ATS.AUX_EPP_CD_ESPECPROC = APL.AUX_EPP_CD_ESPECPROC
  AND  ATS.CAD_PRD_ID = APL.CAD_PRD_ID
  AND  ATS.TIS_MED_CD_TABELAMEDICA = APL.TIS_MED_CD_TABELAMEDICA
  JOIN TB_CAD_PAC_PACIENTE PAC  ON   PAC.CAD_PAC_ID_PACIENTE = ATS.CAD_PAC_ID_PACIENTE_INT
  JOIN TB_CAD_PES_PESSOA PES_PAC  ON   PES_PAC.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
  JOIN TB_CAD_SET_SETOR SETOR  ON   SETOR.CAD_SET_ID = ATS.CAD_SET_ID
  JOIN TB_CAD_UNI_UNIDADE UNI  ON   UNI.CAD_UNI_ID_UNIDADE = ARP.CAD_UNI_ID_UNIDADE
  JOIN TB_CAD_PRD_PRODUTO PRD  ON   PRD.CAD_PRD_ID = ATS.CAD_PRD_ID
  LEFT JOIN TB_SEG_USU_USUARIO USU ON USU.SEG_USU_ID_USUARIO = ARP.SEG_USU_ID_PROTOCOLO
  LEFT JOIN TB_ATD_IDR_INT_DADOS_RN IDR ON IDR.ATD_IDR_ID = ATS.ATS_ATE_ID_RN
  WHERE
        ATS.ATS_ATE_FL_STATUS    != ' ||CHR(39)|| 'C' ||CHR(39)||
       'AND APL.ATS_APL_STATUS_LAUDO != ' ||CHR(39)|| 'L' ||CHR(39)||
       V_WHERE ||
       'ORDER BY ARP.ATS_APR_NR_SEQ_DIGITACAO
       ';
    OPEN v_cursor FOR
    V_SELECT;
    io_cursor := v_cursor;
  end PRC_ATS_RETORNA_APL_ARP_S;
