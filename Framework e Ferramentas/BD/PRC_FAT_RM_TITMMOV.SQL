CREATE OR REPLACE PROCEDURE "PRC_FAT_RM_TITMMOV" (pIDMOV         in number,
                                                  pDATAEMISSAO   in date,
                                                  pVALOR         in number,
                                                  pPERCENTUALISS in number,
                                                  pIDPRD         in number) is
  v_seq number;
	v_codfilial number;
	v_codloc varchar2(10);
begin	

	select codfilial, codloc 
	into v_codfilial, v_codloc
	from 
	rm.tmov@rm
	where idmov = pIDMOV;  	

  select nvl(max(numerosequencial), 0) + 1 as seq
    into v_seq
    from rm.titmmov@rm
   where idmov = pIDMOV;
  insert into rm.titmmov@rm
    (TITMMOV.CODCOLIGADA,
     IDMOV,
     NSEQITMMOV,
     NUMEROSEQUENCIAL,
     titmmov.idprd,
     CODTIP,
     QUANTIDADE,
	 QUANTIDADETOTAL,
     PRECOUNITARIO,
     PRECOTABELA,
     PERCENTUALDESC,
     VALORDESC,
     PERCENTUALDESP,
     VALORDESP,
     DATAEMISSAO,
     CODUND,
     QUANTIDADEARECEBER,
     CODCPG,
     DATAENTREGA,
     NSEQITMCNT,
     VALORTOTALITEM,
     VALORESCRITURACAO,
     CST,
     VALORUNTORCAMENTO,
     CODLOC,
     VALORLIQUIDO,
		 CODFILIAL)
  values
    (1,
     pIDMOV,
     v_seq,
     v_seq,
     pIDPRD, --    34641, 
     'ISS',
     1,
	 1,
     pVALOR,
     0, --0
     0, --0
     0, --0
     0, --0
     0, --0
     pDATAEMISSAO,
     'UN',
     1,
     33,
     pDATAEMISSAO,
     0,
     0,
     0,
     0,
     pVALOR,
     v_codloc,
     pVALOR,
		 v_codfilial);
  --ISS    
  insert into rm.ttrbmov@rm
    (ALIQUOTA,
     ALIQUOTAPORVALOR,
     BASECHEIA,
     BASEDECALCULO,
     BASEDECALCULOCALCULADA,
     CODCOLIGADA,
     CODRETENCAO,
     CODTRB,
     CODTRBBASE,
     CODUNDREFERENCIA,
     EDITADO,
     FATORREDUCAO,
     FATORSUBSTTRIB,
     IDMOV,
     MODALIDADEBC,
     NSEQITMMOV,
     PERCDIFERIMENTOPARCIALICMS,
     SITTRIBUTARIA,
     TIPORECOLHIMENTO,
     VALOR,
     VLRISENTO)
  values
    (pPERCENTUALISS, --ALIQUOTA
     null, --ALIQUOTAPORVALOR,
     null, --BASECHEIA,
     pVALOR, --BASEDECALCULO,
     pVALOR, --BASEDECALCULOCALCULADA,
     1, --CODCOLIGADA,
     null, --CODRETENCAO,
     'ISS', --CODTRB,
     'ISS', --CODTRBBASE,
     null, --CODUNDREFERENCIA,
     0, --EDITADO,
     null, --FATORREDUCAO,
     null, --FATORSUBSTTRIB,
     pIDMOV,
     null, --MODALIDADEBC,
     v_seq, --NSEQITMMOV,
     null, --PERCDIFERIMENTOPARCIALICMS,
     null, --SITTRIBUTARIA,
     null, --TIPORECOLHIMENTO,
     (pPERCENTUALISS * (pVALOR / 100)), --VALOR,
     null --VLRISENTO
     );
  --pis
  insert into rm.ttrbmov@rm
    (ALIQUOTA,
     ALIQUOTAPORVALOR,
     BASECHEIA,
     BASEDECALCULO,
     BASEDECALCULOCALCULADA,
     CODCOLIGADA,
     CODRETENCAO,
     CODTRB,
     CODTRBBASE,
     CODUNDREFERENCIA,
     EDITADO,
     FATORREDUCAO,
     FATORSUBSTTRIB,
     IDMOV,
     MODALIDADEBC,
     NSEQITMMOV,
     PERCDIFERIMENTOPARCIALICMS,
     SITTRIBUTARIA,
     TIPORECOLHIMENTO,
     VALOR,
     VLRISENTO)
  values
    (0, --ALIQUOTA
     null, --ALIQUOTAPORVALOR,
     null, --BASECHEIA,
     pVALOR, --BASEDECALCULO,
     0, --BASEDECALCULOCALCULADA,
     1, --CODCOLIGADA,
     null, --CODRETENCAO,
     'PIS', --CODTRB,
     null, --CODTRBBASE,
     null, --CODUNDREFERENCIA,
     0, --EDITADO,
     null, --FATORREDUCAO,
     null, --FATORSUBSTTRIB,
     pIDMOV,
     null, --MODALIDADEBC,
     v_seq, --NSEQITMMOV,
     null, --PERCDIFERIMENTOPARCIALICMS,
     null, --SITTRIBUTARIA,
     null, --TIPORECOLHIMENTO,
     0, --(pPERCENTUALISS * (pVALOR/100)), --VALOR,
     null --VLRISENTO
     );
  --IRRF
  insert into rm.ttrbmov@rm
    (ALIQUOTA,
     ALIQUOTAPORVALOR,
     BASECHEIA,
     BASEDECALCULO,
     BASEDECALCULOCALCULADA,
     CODCOLIGADA,
     CODRETENCAO,
     CODTRB,
     CODTRBBASE,
     CODUNDREFERENCIA,
     EDITADO,
     FATORREDUCAO,
     FATORSUBSTTRIB,
     IDMOV,
     MODALIDADEBC,
     NSEQITMMOV,
     PERCDIFERIMENTOPARCIALICMS,
     SITTRIBUTARIA,
     TIPORECOLHIMENTO,
     VALOR,
     VLRISENTO)
  values
    (0, --ALIQUOTA
     null, --ALIQUOTAPORVALOR,
     null, --BASECHEIA,
     pVALOR, --BASEDECALCULO,
     0, --BASEDECALCULOCALCULADA,
     1, --CODCOLIGADA,
     null, --CODRETENCAO,
     'IRRF', --CODTRB,
     null, --CODTRBBASE,
     null, --CODUNDREFERENCIA,
     0, --EDITADO,
     null, --FATORREDUCAO,
     null, --FATORSUBSTTRIB,
     pIDMOV,
     null, --MODALIDADEBC,
     v_seq, --NSEQITMMOV,
     null, --PERCDIFERIMENTOPARCIALICMS,
     null, --SITTRIBUTARIA,
     null, --TIPORECOLHIMENTO,
     0, --(pPERCENTUALISS * (pVALOR/100)), --VALOR,
     null --VLRISENTO
     );
  --CSLL
  insert into rm.ttrbmov@rm
    (ALIQUOTA,
     ALIQUOTAPORVALOR,
     BASECHEIA,
     BASEDECALCULO,
     BASEDECALCULOCALCULADA,
     CODCOLIGADA,
     CODRETENCAO,
     CODTRB,
     CODTRBBASE,
     CODUNDREFERENCIA,
     EDITADO,
     FATORREDUCAO,
     FATORSUBSTTRIB,
     IDMOV,
     MODALIDADEBC,
     NSEQITMMOV,
     PERCDIFERIMENTOPARCIALICMS,
     SITTRIBUTARIA,
     TIPORECOLHIMENTO,
     VALOR,
     VLRISENTO)
  values
    (0, --ALIQUOTA
     null, --ALIQUOTAPORVALOR,
     null, --BASECHEIA,
     pVALOR, --BASEDECALCULO,
     0, --BASEDECALCULOCALCULADA,
     1, --CODCOLIGADA,
     null, --CODRETENCAO,
     'CSLL', --CODTRB,
     null, --CODTRBBASE,
     null, --CODUNDREFERENCIA,
     0, --EDITADO,
     null, --FATORREDUCAO,
     null, --FATORSUBSTTRIB,
     pIDMOV,
     null, --MODALIDADEBC,
     v_seq, --NSEQITMMOV,
     null, --PERCDIFERIMENTOPARCIALICMS,
     null, --SITTRIBUTARIA,
     null, --TIPORECOLHIMENTO,
     0, --(pPERCENTUALISS * (pVALOR/100)), --VALOR,
     null --VLRISENTO
     );
  --COFINS
  insert into rm.ttrbmov@rm
    (ALIQUOTA,
     ALIQUOTAPORVALOR,
     BASECHEIA,
     BASEDECALCULO,
     BASEDECALCULOCALCULADA,
     CODCOLIGADA,
     CODRETENCAO,
     CODTRB,
     CODTRBBASE,
     CODUNDREFERENCIA,
     EDITADO,
     FATORREDUCAO,
     FATORSUBSTTRIB,
     IDMOV,
     MODALIDADEBC,
     NSEQITMMOV,
     PERCDIFERIMENTOPARCIALICMS,
     SITTRIBUTARIA,
     TIPORECOLHIMENTO,
     VALOR,
     VLRISENTO)
  values
    (0, --ALIQUOTA
     null, --ALIQUOTAPORVALOR,
     null, --BASECHEIA,
     pVALOR, --BASEDECALCULO,
     0, --BASEDECALCULOCALCULADA,
     1, --CODCOLIGADA,
     null, --CODRETENCAO,
     'COFINS', --CODTRB,
     null, --CODTRBBASE,
     null, --CODUNDREFERENCIA,
     0, --EDITADO,
     null, --FATORREDUCAO,
     null, --FATORSUBSTTRIB,
     pIDMOV,
     null, --MODALIDADEBC,
     v_seq, --NSEQITMMOV,
     null, --PERCDIFERIMENTOPARCIALICMS,
     null, --SITTRIBUTARIA,
     null, --TIPORECOLHIMENTO,
     0, --(pPERCENTUALISS * (pVALOR/100)), --VALOR,
     null --VLRISENTO
     );
  --COF-S
  insert into rm.ttrbmov@rm
    (ALIQUOTA,
     ALIQUOTAPORVALOR,
     BASECHEIA,
     BASEDECALCULO,
     BASEDECALCULOCALCULADA,
     CODCOLIGADA,
     CODRETENCAO,
     CODTRB,
     CODTRBBASE,
     CODUNDREFERENCIA,
     EDITADO,
     FATORREDUCAO,
     FATORSUBSTTRIB,
     IDMOV,
     MODALIDADEBC,
     NSEQITMMOV,
     PERCDIFERIMENTOPARCIALICMS,
     SITTRIBUTARIA,
     TIPORECOLHIMENTO,
     VALOR,
     VLRISENTO)
  values
    (3, --ALIQUOTA
     null, --ALIQUOTAPORVALOR,
     0, --BASECHEIA,
     pVALOR, --BASEDECALCULO,
     0, --BASEDECALCULOCALCULADA,
     1, --CODCOLIGADA,
     2172, --CODRETENCAO,
     'COF-F', --CODTRB,
     'COF-F', --CODTRBBASE,
     null, --CODUNDREFERENCIA,
     0, --EDITADO,
     null, --FATORREDUCAO,
     null, --FATORSUBSTTRIB,
     pIDMOV,
     null, --MODALIDADEBC,
     v_seq, --NSEQITMMOV,
     null, --PERCDIFERIMENTOPARCIALICMS,
     '01', --SITTRIBUTARIA,
     1, --TIPORECOLHIMENTO,
     round((3 * (pVALOR/100)),2), --VALOR,
     null --VLRISENTO
     );     
     --PIS-F
  insert into rm.ttrbmov@rm
    (ALIQUOTA,
     ALIQUOTAPORVALOR,
     BASECHEIA,
     BASEDECALCULO,
     BASEDECALCULOCALCULADA,
     CODCOLIGADA,
     CODRETENCAO,
     CODTRB,
     CODTRBBASE,
     CODUNDREFERENCIA,
     EDITADO,
     FATORREDUCAO,
     FATORSUBSTTRIB,
     IDMOV,
     MODALIDADEBC,
     NSEQITMMOV,
     PERCDIFERIMENTOPARCIALICMS,
     SITTRIBUTARIA,
     TIPORECOLHIMENTO,
     VALOR,
     VLRISENTO)
  values
    (0.65, --ALIQUOTA
     null, --ALIQUOTAPORVALOR,
     0, --BASECHEIA,
     pVALOR, --BASEDECALCULO,
     0, --BASEDECALCULOCALCULADA,
     1, --CODCOLIGADA,
     5979, --CODRETENCAO,
     'PIS-F', --CODTRB,
     'PIS-F', --CODTRBBASE,
     null, --CODUNDREFERENCIA,
     0, --EDITADO,
     null, --FATORREDUCAO,
     null, --FATORSUBSTTRIB,
     pIDMOV,
     null, --MODALIDADEBC,
     v_seq, --NSEQITMMOV,
     null, --PERCDIFERIMENTOPARCIALICMS,
     '01', --SITTRIBUTARIA,
     1, --TIPORECOLHIMENTO,
     round((0.65 * (pVALOR/100)),2), --VALOR,
     null --VLRISENTO
     );     
commit;
end prc_fat_rm_titmmov;
 