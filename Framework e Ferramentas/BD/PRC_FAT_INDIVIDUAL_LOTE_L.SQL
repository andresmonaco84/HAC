CREATE OR REPLACE PROCEDURE "PRC_FAT_INDIVIDUAL_LOTE_L"
(
  pATD_ATE_ID          TB_ATD_ATE_ATENDIMENTO.ATD_ATE_ID%TYPE DEFAULT NULL,
  pCAD_CNV_ID_CONVENIO TB_CAD_PAC_PACIENTE.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
  pCOM_NOTA_FISCAL     DECIMAL DEFAULT NULL, -- Se igual a 1 traz registros com nota fiscal, se não sem nota fiscal
  IO_CURSOR            OUT PKG_CURSOR.T_CURSOR
) 
  IS

  V_CURSOR PKG_CURSOR.T_CURSOR;
BEGIN
  OPEN V_CURSOR FOR
    SELECT DISTINCT LNF.FAT_LNF_ID,
                    LNF.FAT_LNF_DT_EMISSAO,
                    CCP.FAT_NOF_ID
      FROM TB_ATD_ATE_ATENDIMENTO      ATE,
			     TB_FAT_CCP_CONTA_CONS_PARC  CCP,
           TB_CAD_PAC_PACIENTE         PAC,
           TB_CAD_PES_PESSOA           PES,
           TB_CAD_UNI_UNIDADE          UNI,
           TB_FAT_LNF_LOTE_CTA_PARC_NF LNF
     WHERE ATE.ATD_ATE_ID = pATD_ATE_ID
       AND CCP.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO   
       AND CCP.FAT_LNF_ID = LNF.FAT_LNF_ID
       AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
       AND ATE.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
       AND CCP.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND CCP.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
       AND CCP.FAT_CCP_FL_FATURADA = 'S'
       AND ((NVL(pCOM_NOTA_FISCAL, 0) = 0 AND CCP.FAT_NOF_ID IS NULL) OR
            (NVL(pCOM_NOTA_FISCAL, 0) = 1 AND NOT CCP.FAT_NOF_ID IS NULL))  
       AND ATE.ATD_ATE_FL_STATUS = 'A';
    
  IO_CURSOR := V_CURSOR;
END PRC_FAT_INDIVIDUAL_LOTE_L;
 