CREATE OR REPLACE PROCEDURE PRC_COB_REL_22_ESTORNOS
  (
    pCAD_UNI_ID_UNIDADE IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
    pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
    pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    pCAD_PLA_ID_PLANO IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_INI  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pCAD_BAN_ID IN TB_CAD_BAN_BANCO.CAD_BAN_ID%TYPE DEFAULT NULL,
    pASS_BCT_ID IN TB_COB_MGC_MOV_GUIA_COBRANCA.ASS_BCT_ID%TYPE DEFAULT NULL,
    pPENDETE_CONTABILIDADE   VARCHAR2 DEFAULT NULL,
    pENVIADO_CONTABILIDADE   VARCHAR2 DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_ACS IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_FU IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_PA IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_SP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_NP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
     pDATA_CONTAB_INI     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pDATA_CONTAB_FIM     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pDATA_MOVIMENTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pFAT_NOF_NR_NOTAFISCAL   IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_NR_NOTAFISCAL%TYPE DEFAULT NULL,
    pFAT_NOF_TP_SERIEFISCAL  IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_TP_SERIEFISCAL%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_COB_REL_22_ESTORNOS
  *
  *    Data Criac?o: 08/01/2014  Por: PEDRO
  *    Alteracao:
  *
  *******************************************************************/
v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(13000);
  V_SELECT  varchar2(30000);

begin
  V_WHERE := NULL;
IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND NOF.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE; END IF;
IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND NOF.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO;    END IF;
IF pCAD_PLA_ID_PLANO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND NOF.CAD_PLA_ID_PLANO = ' || pCAD_PLA_ID_PLANO;    END IF;
IF pFAT_NOF_NR_NOTAFISCAL IS NOT NULL THEN V_WHERE := V_WHERE || ' AND NOF.FAT_NOF_NR_NOTAFISCAL = ' ||CHR(39)|| pFAT_NOF_NR_NOTAFISCAL ||CHR(39);    END IF;
IF pFAT_NOF_TP_SERIEFISCAL IS NOT NULL THEN V_WHERE := V_WHERE || ' AND NOF.FAT_NOF_TP_SERIEFISCAL = ' ||CHR(39)|| pFAT_NOF_TP_SERIEFISCAL ||CHR(39);    END IF;
IF pDATA_EMISSAO_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >= ' ||CHR(39)|| pDATA_EMISSAO_INI ||CHR(39);    END IF;
IF pDATA_EMISSAO_FIM IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <= ' ||CHR(39)|| pDATA_EMISSAO_FIM ||CHR(39);    END IF;
IF pDATA_VENCIMENTO_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >= ' ||CHR(39)|| pDATA_VENCIMENTO_INI ||CHR(39);    END IF;
IF pDATA_VENCIMENTO_FIM IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <= ' ||CHR(39)|| pDATA_VENCIMENTO_FIM ||CHR(39);    END IF;
IF pDATA_CONTAB_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >= ' ||CHR(39)|| pDATA_CONTAB_INI ||CHR(39);    END IF;
IF pDATA_CONTAB_FIM IS NOT NULL THEN V_WHERE := V_WHERE || ' AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= ' ||CHR(39)|| pDATA_CONTAB_FIM ||CHR(39);    END IF;
IF pDATA_PAGTO_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND MGC.COB_MGC_DT_MOVIMENTO >= ' ||CHR(39)|| pDATA_PAGTO_INI ||CHR(39);    END IF;
IF pDATA_PAGTO_FIM IS NOT NULL THEN V_WHERE := V_WHERE || ' AND MGC.COB_MGC_DT_MOVIMENTO <= ' ||CHR(39)|| pDATA_PAGTO_FIM ||CHR(39);    END IF;
IF pASS_BCT_ID IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND MGC.ASS_BCT_ID = ' || pASS_BCT_ID; END IF; 
IF pCAD_BAN_ID IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND BCT.CAD_BAN_ID = ' || pCAD_BAN_ID; END IF;

V_SELECT:=
'
SELECT DISTINCT
     --  BAN.CAD_BAN_CD_BANCO || '||CHR(39)||' - '||CHR(39)||' || BAN.CAD_BAN_NM_BANCO CAD_BAN_NM_BANCO,
     --  BCT.ASS_BCT_CD_AGENCIA || '||CHR(39)||' / '||CHR(39)||' || BCT.ASS_BCT_NR_CONTA || '||CHR(39)||' - '||CHR(39)||' || BCT.ASS_BCT_CD_CTA_CAIXA_RM ASS_BCT_NR_CONTA,
       UNI.CAD_UNI_ID_UNIDADE,
       UNI.CAD_UNI_DS_RESUMIDA,
       UNI.CAD_UNI_DS_UNIDADE,
       CNV.CAD_CNV_CD_HAC_PRESTADOR,
       CNV.CAD_CNV_NM_FANTASIA,
       TRUNC(NOF.FAT_NFO_DT_EMISSAO) FAT_NFO_DT_EMISSAO,
       TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) FAT_NFO_DT_VENCIMENTO,
       NOF.FAT_NOF_ID,
       NOF.FAT_NOF_NR_NOTAFISCAL,
       NOF.FAT_NOF_TP_SERIEFISCAL,
       NOF.FAT_NFO_VL_FATURADO,
       NVL(NOF.FAT_NFO_VL_LIQUIDO,0) FAT_NFO_VL_LIQUIDO,
       TRUNC(MGC.COB_MGC_DT_MOVIMENTO) COB_MGC_DT_MOVIMENTO,
       SUM(MGC.COB_MGC_VL_MOVIMENTO) ESTORNO
     
FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_COB_CCP_CONTA_CONS_PARC   CCP  ON  CCP.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = CCP.FAT_NOF_ID
                                           AND  MGC.ATD_ATE_ID          = CCP.ATD_ATE_ID
                                           AND  MGC.CAD_PAC_ID_PACIENTE = CCP.CAD_PAC_ID_PACIENTE
                                           AND  MGC.COB_COC_ID          = CCP.COB_COC_ID
                                           AND  MGC.COB_CCP_ID          = CCP.COB_CCP_ID
                                           AND  MGC.ATD_GUI_CD_CODIGO   = CCP.ATD_GUI_CD_CODIGO
                                           AND  TRUNC(MGC.ATD_GUI_DT_VALIDADE) = TRUNC(CCP.ATD_GUI_DT_VALIDADE)

JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE         
LEFT JOIN TB_CAD_TMC_TIPO_MOV_COBRANCA TMC  ON  TMC.CAD_TMC_ID          = MGC.CAD_TMC_ID
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
WHERE  CCP.COB_CCP_FL_STATUS   = '||CHR(39)||'A'||CHR(39)||'
AND    CNV.CAD_CNV_CD_OPCAO_PAGTO = '||CHR(39)||'1'||CHR(39)||'
 AND    MGC.CAD_TMC_ID = 6
 AND (
    ('||CHR(39)|| pPENDETE_CONTABILIDADE ||CHR(39)||' IS NULL AND MGC.COB_MGC_DT_LIBERACAO_CONTAB IS     NULL) OR
    ('||CHR(39)|| pPENDETE_CONTABILIDADE ||CHR(39)||' IS NOT NULL AND MGC.COB_MGC_DT_LIBERACAO_CONTAB IS NOT NULL) OR
    NULL IS NULL
    )
' || V_WHERE || '
GROUP BY 
      -- BAN.CAD_BAN_CD_BANCO || '||CHR(39)||' - '||CHR(39)||' || BAN.CAD_BAN_NM_BANCO ,
      -- BCT.ASS_BCT_CD_AGENCIA || '||CHR(39)||' / '||CHR(39)||' || BCT.ASS_BCT_NR_CONTA || '||CHR(39)||' - '||CHR(39)||' || BCT.ASS_BCT_CD_CTA_CAIXA_RM ,
       UNI.CAD_UNI_ID_UNIDADE,
       UNI.CAD_UNI_DS_RESUMIDA,
       UNI.CAD_UNI_DS_UNIDADE,
       CNV.CAD_CNV_CD_HAC_PRESTADOR,
       CNV.CAD_CNV_NM_FANTASIA,
       TRUNC(NOF.FAT_NFO_DT_EMISSAO) ,
       TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) ,
       NOF.FAT_NOF_ID,
       NOF.FAT_NOF_NR_NOTAFISCAL,
       NOF.FAT_NOF_TP_SERIEFISCAL,
       NOF.FAT_NFO_VL_FATURADO,
       NVL(NOF.FAT_NFO_VL_LIQUIDO,0) ,
       TRUNC(MGC.COB_MGC_DT_MOVIMENTO)' ;
   -- TESTE :=  V_SELECT ;
   --dbms_output.put_line(V_SELECT);
  OPEN v_cursor FOR
 -- SELECT 1 FROM DUAL;
   V_SELECT ;
    io_cursor := v_cursor;
  end PRC_COB_REL_22_ESTORNOS;
