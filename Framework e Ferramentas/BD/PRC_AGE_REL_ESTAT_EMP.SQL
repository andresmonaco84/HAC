create or replace procedure PRC_AGE_REL_ESTAT_EMP
  (
     pDT_INICIO_CONSULTA in TB_AGE_AGD_AGENDA.AGE_AGD_DT_ATENDIMENTO%type,
     pDT_FIM_CONSULTA in TB_AGE_AGD_AGENDA.AGE_AGD_DT_ATENDIMENTO%type,
     pCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%type default null,
     pCAD_LAT_ID_LOCAL_ATENDIMENTO in TB_CAD_LAT_LOCAL_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%type default null,
     pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%type default null,
     pCAD_PLA_CD_TIPOPLANO in tb_cad_pla_plano.cad_pla_cd_tipoplano%type default null,
     pCAD_CNV_ID_CONVENIO in tb_cad_cnv_convenio.cad_cnv_id_convenio%type,
     pCAD_PLA_ID_PLANO in tb_cad_pla_plano.cad_pla_id_plano%type default null,     
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure PRC_AGE_REL_ESTAT_EMP
  *  
  *    Data Alteracao 29/10/2009  Por Pedro
  *     Alteracao alterando os cancelados
  *
  *    Funcao Alimentar relatorio de Estatistica Empresa
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR
   SELECT ROW_NUMBER() OVER(PARTITION BY PLA.CAD_PLA_ID_PLANO ORDER BY CNV.CAD_CNV_ID_CONVENIO) AS SEQ,
       pes.cad_pes_tp_sexo SEXO,
       COUNT(AGD.AGE_AGD_ID) AS FALTOSOS,
       NVL(ATENDIDOS.ATENDIDOS,0) ATENDIDOS,
       NVL(CANCELADOS.CANCELADOS,0) CANCELADOS,
       NVL(AGENDADOS.AGENDADOS,0) AGENDADOS,
       0 ABSENTEISMO,
       CNV.CAD_CNV_ID_CONVENIO,
       CNV.CAD_CNV_CD_HAC_PRESTADOR,
       CNV.CAD_CNV_DS_RAZAOSOCIAL,
       PLA.CAD_PLA_ID_PLANO,
       PLA.CAD_PLA_CD_TIPOPLANO,
       PLA.CAD_PLA_CD_PLANO_HAC,
       PLA.CAD_PLA_NM_NOME_PLANO,
       ESM.CAD_UNI_ID_UNIDADE,
       ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
       ESM.TIS_CBO_CD_CBOS, 
       UNI.CAD_UNI_DS_UNIDADE,
       LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
       CBO.TIS_CBO_DS_CBOS_HAC
  FROM TB_AGE_AGD_AGENDA        AGD
  JOIN TB_AGE_ESM_ESCALA_MEDICA ESM ON ESM.AGE_ESM_ID = AGD.AGE_ESM_ID
  JOIN TB_CAD_PAC_PACIENTE      PAC ON PAC.CAD_PAC_ID_PACIENTE = AGD.CAD_PAC_ID_PACIENTE
  JOIN TB_CAD_PES_PESSOA        PES ON PES.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
  JOIN TB_CAD_PLA_PLANO         PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
  JOIN TB_CAD_CNV_CONVENIO      CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
  JOIN TB_CAD_UNI_UNIDADE       UNI ON UNI.CAD_UNI_ID_UNIDADE = ESM.CAD_UNI_ID_UNIDADE
  JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO
  JOIN TB_TIS_CBO_CBOS          CBO ON CBO.TIS_CBO_CD_CBOS = ESM.TIS_CBO_CD_CBOS
  LEFT JOIN (SELECT COUNT(AGD.AGE_AGD_ID) ATENDIDOS,  pes.cad_pes_tp_sexo,PLA.CAD_CNV_ID_CONVENIO, PLA.CAD_PLA_ID_PLANO,
                    ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS 
          FROM TB_AGE_AGD_AGENDA      AGD
          JOIN TB_AGE_ESM_ESCALA_MEDICA ESM ON ESM.AGE_ESM_ID = AGD.AGE_ESM_ID
          JOIN TB_CAD_PAC_PACIENTE      PAC ON PAC.CAD_PAC_ID_PACIENTE = AGD.CAD_PAC_ID_PACIENTE
          JOIN TB_CAD_PES_PESSOA        PES ON PES.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
          JOIN TB_CAD_PLA_PLANO         PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
          JOIN TB_CAD_CNV_CONVENIO      CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO  
          JOIN TB_ATD_ATE_ATENDIMENTO   ATD ON ATD.ATD_ATE_ID = AGD.AGE_AGD_CD_INTAMB
         WHERE (AGD.AGE_AGD_DT_ATENDIMENTO BETWEEN PDT_INICIO_CONSULTA AND PDT_FIM_CONSULTA)
           AND (PAC.CAD_CNV_ID_CONVENIO = PCAD_CNV_ID_CONVENIO)
           AND (PCAD_PLA_ID_PLANO IS NULL OR PAC.CAD_PLA_ID_PLANO = PCAD_PLA_ID_PLANO)
           AND (PCAD_PLA_CD_TIPOPLANO IS NULL OR PLA.CAD_PLA_CD_TIPOPLANO = PCAD_PLA_CD_TIPOPLANO)
           AND (PCAD_UNI_ID_UNIDADE IS NULL OR ESM.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE)
           AND (PCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = PCAD_LAT_ID_LOCAL_ATENDIMENTO)
           AND (PTIS_CBO_CD_CBOS IS NULL OR ESM.TIS_CBO_CD_CBOS = PTIS_CBO_CD_CBOS)
           AND (AGD.AGE_AGD_FL_STATUS = 'A')

           GROUP BY pes.cad_pes_tp_sexo,PLA.CAD_CNV_ID_CONVENIO, PLA.CAD_PLA_ID_PLANO,
                    ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS 
           ) ATENDIDOS ON ATENDIDOS.cad_pes_tp_sexo = PES.cad_pes_tp_sexo
           AND ATENDIDOS.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
           AND ATENDIDOS.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
           AND ATENDIDOS.CAD_UNI_ID_UNIDADE = ESM.CAD_UNI_ID_UNIDADE
           AND ATENDIDOS.CAD_LAT_ID_LOCAL_ATENDIMENTO = ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO
           AND ATENDIDOS.TIS_CBO_CD_CBOS = ESM.TIS_CBO_CD_CBOS

  LEFT JOIN (SELECT COUNT(AGC.AGE_AGD_ID) CANCELADOS,  pes.cad_pes_tp_sexo,PLA.CAD_CNV_ID_CONVENIO, PLA.CAD_PLA_ID_PLANO,
                    ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS 
          FROM TB_AGE_AGC_AGENDA_CANCELADA AGC
          JOIN TB_AGE_ESM_ESCALA_MEDICA ESM ON ESM.AGE_ESM_ID = AGC.AGE_ESM_ID          
          JOIN TB_CAD_PAC_PACIENTE      PAC ON PAC.CAD_PAC_ID_PACIENTE = AGC.CAD_PAC_ID_PACIENTE
          JOIN TB_CAD_PES_PESSOA        PES ON PES.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
          JOIN TB_CAD_PLA_PLANO         PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
          JOIN TB_CAD_CNV_CONVENIO      CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO  
          JOIN TB_ATD_ATE_ATENDIMENTO   ATD ON ATD.ATD_ATE_ID = AGC.AGE_AGD_CD_INTAMB
         WHERE (AGC.AGE_AGD_DT_ATENDIMENTO BETWEEN PDT_INICIO_CONSULTA AND PDT_FIM_CONSULTA)
           AND (PAC.CAD_CNV_ID_CONVENIO = PCAD_CNV_ID_CONVENIO)
           AND (PCAD_PLA_ID_PLANO IS NULL OR PAC.CAD_PLA_ID_PLANO = PCAD_PLA_ID_PLANO)
           AND (PCAD_PLA_CD_TIPOPLANO IS NULL OR PLA.CAD_PLA_CD_TIPOPLANO = PCAD_PLA_CD_TIPOPLANO)
           AND (PCAD_UNI_ID_UNIDADE IS NULL OR ESM.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE)
           AND (PCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = PCAD_LAT_ID_LOCAL_ATENDIMENTO)
           AND (PTIS_CBO_CD_CBOS IS NULL OR ESM.TIS_CBO_CD_CBOS = PTIS_CBO_CD_CBOS)
           GROUP BY pes.cad_pes_tp_sexo ,PLA.CAD_CNV_ID_CONVENIO, PLA.CAD_PLA_ID_PLANO   ,
                    ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS   
           ) CANCELADOS  ON CANCELADOS.cad_pes_tp_sexo = PES.cad_pes_tp_sexo
           AND CANCELADOS.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
           AND CANCELADOS.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
           AND CANCELADOS.CAD_UNI_ID_UNIDADE = ESM.CAD_UNI_ID_UNIDADE
           AND CANCELADOS.CAD_LAT_ID_LOCAL_ATENDIMENTO = ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO
           AND CANCELADOS.TIS_CBO_CD_CBOS = ESM.TIS_CBO_CD_CBOS           
   LEFT JOIN (SELECT COUNT(AGD.AGE_AGD_ID) AGENDADOS,  pes.cad_pes_tp_sexo,PLA.CAD_CNV_ID_CONVENIO, PLA.CAD_PLA_ID_PLANO,
                     ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS 
          FROM TB_AGE_AGD_AGENDA        AGD
          JOIN TB_AGE_ESM_ESCALA_MEDICA ESM ON ESM.AGE_ESM_ID = AGD.AGE_ESM_ID          
          JOIN TB_CAD_PAC_PACIENTE      PAC ON PAC.CAD_PAC_ID_PACIENTE = AGD.CAD_PAC_ID_PACIENTE
          JOIN TB_CAD_PES_PESSOA        PES ON PES.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
          JOIN TB_CAD_PLA_PLANO         PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
          JOIN TB_CAD_CNV_CONVENIO      CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO  
       
         WHERE (AGD.AGE_AGD_DT_ATENDIMENTO BETWEEN PDT_INICIO_CONSULTA AND PDT_FIM_CONSULTA)
           AND (PAC.CAD_CNV_ID_CONVENIO = PCAD_CNV_ID_CONVENIO)
           AND (PCAD_PLA_ID_PLANO IS NULL OR PAC.CAD_PLA_ID_PLANO = PCAD_PLA_ID_PLANO)
           AND (PCAD_PLA_CD_TIPOPLANO IS NULL OR PLA.CAD_PLA_CD_TIPOPLANO = PCAD_PLA_CD_TIPOPLANO)
           AND (PCAD_UNI_ID_UNIDADE IS NULL OR ESM.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE)
           AND (PCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = PCAD_LAT_ID_LOCAL_ATENDIMENTO)
           AND (PTIS_CBO_CD_CBOS IS NULL OR ESM.TIS_CBO_CD_CBOS = PTIS_CBO_CD_CBOS)
           AND (AGD.AGE_AGD_FL_STATUS <> 'C')
         
           GROUP BY pes.cad_pes_tp_sexo ,PLA.CAD_CNV_ID_CONVENIO, PLA.CAD_PLA_ID_PLANO,
                    ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS 
        ) AGENDADOS   ON AGENDADOS.cad_pes_tp_sexo = PES.cad_pes_tp_sexo
           AND AGENDADOS.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
           AND AGENDADOS.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
           AND AGENDADOS.CAD_UNI_ID_UNIDADE = ESM.CAD_UNI_ID_UNIDADE
           AND AGENDADOS.CAD_LAT_ID_LOCAL_ATENDIMENTO = ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO
           AND AGENDADOS.TIS_CBO_CD_CBOS = ESM.TIS_CBO_CD_CBOS                      
 WHERE (AGD.AGE_AGD_DT_ATENDIMENTO BETWEEN PDT_INICIO_CONSULTA AND PDT_FIM_CONSULTA)
   AND (PAC.CAD_CNV_ID_CONVENIO = PCAD_CNV_ID_CONVENIO)
   AND (PCAD_PLA_ID_PLANO IS NULL OR PAC.CAD_PLA_ID_PLANO = PCAD_PLA_ID_PLANO)
   AND (PCAD_PLA_CD_TIPOPLANO IS NULL OR PLA.CAD_PLA_CD_TIPOPLANO = PCAD_PLA_CD_TIPOPLANO)
   AND (PCAD_UNI_ID_UNIDADE IS NULL OR ESM.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE)
   AND (PCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = PCAD_LAT_ID_LOCAL_ATENDIMENTO)
   AND (PTIS_CBO_CD_CBOS IS NULL OR ESM.TIS_CBO_CD_CBOS = PTIS_CBO_CD_CBOS)
   AND (AGD.AGE_AGD_FL_STATUS IN ('F', 'P'))  
   
 GROUP BY (CNV.CAD_CNV_ID_CONVENIO, 
           CNV.CAD_CNV_CD_HAC_PRESTADOR,
           CNV.CAD_CNV_DS_RAZAOSOCIAL, 
           PLA.CAD_PLA_ID_PLANO,
           PLA.CAD_PLA_CD_TIPOPLANO,           
           PLA.CAD_PLA_CD_PLANO_HAC, 
           PLA.CAD_PLA_NM_NOME_PLANO),
           pes.cad_pes_tp_sexo,
           NVL(ATENDIDOS.ATENDIDOS,0) ,
           NVL(CANCELADOS.CANCELADOS,0) ,
           NVL(AGENDADOS.AGENDADOS,0) ,
           ESM.CAD_UNI_ID_UNIDADE,
           ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
           ESM.TIS_CBO_CD_CBOS ,
           UNI.CAD_UNI_DS_UNIDADE,
           LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
           CBO.TIS_CBO_DS_CBOS_HAC  ;
    io_cursor := v_cursor;
  end PRC_AGE_REL_ESTAT_EMP;
