CREATE OR REPLACE PROCEDURE "PRC_TIS_CBO_ESM_PLC" (
     pCAD_PLA_ID_PLANO in TB_ASS_PLC_PLANO_CBOS.CAD_PLA_ID_PLANO%type,
     pCAD_UNI_ID_UNIDADE in TB_AGE_ESM_ESCALA_MEDICA.CAD_UNI_ID_UNIDADE%TYPE,
     pCAD_LAT_ID_LOCAL_ATENDIMENTO in TB_AGE_ESM_ESCALA_MEDICA.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_TIS_CBO_ESM_PLC
  *
  *    Data Alterac?o: 10/10/2013  Por: Pedro Carvalho
  *    ALTERAÇÃO: SOMENTE ESPECIALIDADES DE ESCALAS ATIVAS PARA A UNIDADE/LOCAL PLANO
  *
  *    Data Alteração:  07/04/2014  Por: Andréa Cazuca
  *    Alteração: Inclusçao dos campos TIS_CBO_VL_IDADE_LIMITE_ESP, TIS_CBO_CD_CBOS_NOVO, TIS_CBO_CD_CBOS_V3
  *               TIS_CBO_FL_STATUS
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR
    
SELECT DISTINCT
       CBO.TIS_CBO_CD_CBOS,
       CBO.TIS_CBO_DS_CBOS,
       CBO.TIS_CBO_FL_STATUS_ENCAMINHA,
       CBO.TIS_CBO_CD_CBOS_HAC,
       CBO.TIS_CBO_DS_CBOS_HAC,
       CBO.TIS_CBO_FL_QTD_ATE_LIMITADA,
       CBO.TIS_CBO_QT_ATEND_PERM_ANO,
       CBO.TIS_CBO_VL_IDADE_LIMITE_ESP,
       CBO.TIS_CBO_CD_CBOS_NOVO,
       CBO.TIS_CBO_CD_CBOS_V3,
       CBO.TIS_CBO_FL_STATUS

  FROM TB_AGE_ESM_ESCALA_MEDICA     ESM
  JOIN TB_TIS_CBO_CBOS              CBO ON CBO.TIS_CBO_CD_CBOS              = ESM.TIS_CBO_CD_CBOS
  JOIN TB_ASS_PLC_PLANO_CBOS        PLC ON PLC.TIS_CBO_CD_CBOS              = ESM.TIS_CBO_CD_CBOS

 WHERE ESM.AGE_ESM_FL_SITUACAO          = 'A'
   AND ESM.AGE_ESM_FL_AGENDAGERADA_OK   = 'S'
   AND (ESM.AGE_ESM_DT_FIM_ESCALA IS NULL OR ESM.AGE_ESM_DT_FIM_ESCALA >= TRUNC(SYSDATE))
   AND ESM.CAD_UNI_ID_UNIDADE           = pCAD_UNI_ID_UNIDADE
   AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO
   AND PLC.CAD_PLA_ID_PLANO             = pCAD_PLA_ID_PLANO
   AND PLC.ASS_PLC_FL_STATUS            = 'A'

ORDER BY CBO.TIS_CBO_DS_CBOS_HAC;

    io_cursor := v_cursor;
    end PRC_TIS_CBO_ESM_PLC;