CREATE OR REPLACE PROCEDURE "PRC_CTS_REL_09_GRAFICO"
(
  IO_CURSOR OUT PKG_CURSOR.T_CURSOR,
  pCTS_RES_RESU_MES       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_MES_PAGTO%type,
  pCTS_RES_RESU_ANO       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_ANO_PAGTO%type
)
IS
  V_CURSOR PKG_CURSOR.T_CURSOR;
BEGIN
  
DECLARE
  V_MES  NUMBER;
  V_ANO  NUMBER;
  V_DATA DATE;
  C_MES  VARCHAR(2);
  C_ANO  VARCHAR(4);
  C_DATA VARCHAR(10);
BEGIN
  V_MES := pCTS_RES_RESU_MES;
  V_ANO := pCTS_RES_RESU_ANO;
  C_MES := TO_CHAR(V_MES);
  C_ANO := TO_CHAR(V_ANO);
  C_DATA:= '01/' || LPAD(C_MES, 2, '0') || '/' || C_ANO;
  V_DATA := TO_DATE(C_DATA, 'DD/MM/YYYY');
  
BEGIN
  OPEN V_CURSOR FOR
      SELECT RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI DESCRICAO,
             (SUM(MES.PERCENTUAL_DIRETO) * 100) PERCENTUAL_DIRETO,
             (SUM(MES.PERCENTUAL_TOTAL) * 100) PERCENTUAL_TOTAL,
             RES.CTS_RES_RESU_ANO || '/' || LPAD(RES.CTS_RES_RESU_MES,2,'0') ANOMES
  FROM TB_CTS_RES_RESUMO_GERAL RES,
       (SELECT SEQ_CTS_RES_RESUMO_01,
               (CASE WHEN CTS_RES_RESU_VL_DESP_DIRETA = 0 THEN
                  0
                 ELSE
                  ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA / RES.CTS_RES_RESU_VL_DESP_DIRETA, 4) - 1
               END) PERCENTUAL_DIRETO,
               (CASE WHEN (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA) = 0 THEN
                  0
                 ELSE
                  ROUND(((RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA) / 
                         (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA)), 4) - 1
               END) PERCENTUAL_TOTAL
          FROM TB_CTS_RES_RESUMO_GERAL RES
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA LIKE '130%'
           AND RES.CTS_RES_RESU_TIPO = 'D'
           AND TO_DATE('01/' || LPAD(RES.CTS_RES_RESU_MES, 2, '0') || '/' || RES.CTS_RES_RESU_ANO, 'DD/MM/YYYY') 
           BETWEEN TRUNC(ADD_MONTHS(V_DATA, -12)) 
           AND TRUNC(ADD_MONTHS(V_DATA, -1))
         ORDER BY RES.CTS_RES_RESU_ANO || RES.CTS_RES_RESU_MES) MES
 WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
   AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA IN ('130', '130001', '1300060007')
   AND RES.SEQ_CTS_RES_RESUMO_01 = MES.SEQ_CTS_RES_RESUMO_01(+)
   AND TO_DATE('01/' || LPAD(RES.CTS_RES_RESU_MES, 2, '0') || '/' || RES.CTS_RES_RESU_ANO, 'DD/MM/YYYY') 
   BETWEEN TRUNC(ADD_MONTHS(V_DATA, -12)) 
   AND TRUNC(ADD_MONTHS(V_DATA, -1))
 GROUP BY RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI,
          RES.CTS_RES_RESU_ANO || '/' || LPAD(RES.CTS_RES_RESU_MES,2,'0')        
 ORDER BY RES.CTS_RES_RESU_ANO || '/' || LPAD(RES.CTS_RES_RESU_MES,2,'0');
    IO_CURSOR := V_CURSOR;
    END;
  END;
END  PRC_CTS_REL_09_GRAFICO;
