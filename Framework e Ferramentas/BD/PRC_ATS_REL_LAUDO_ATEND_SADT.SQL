CREATE OR REPLACE PROCEDURE "PRC_ATS_REL_LAUDO_ATEND_SADT" (
     pATS_ATE_CD_INTLIB   IN TB_ATS_ATE_ATENDIMENTO_SADT.Ats_Ate_Cd_Intlib%type DEFAULT NULL,
     pCAD_PRD_ID          IN TB_ATS_ATE_ATENDIMENTO_SADT.CAD_PRD_ID%TYPE DEFAULT NULL,
     pATS_APR_NR_SEQ_LOTE IN TB_ATS_ARP_ATEN_RESULT_PROCED.ATS_APR_NR_SEQ_LOTE%TYPE DEFAULT NULL,
     pATS_ATE_ID IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_ID%TYPE DEFAULT NULL,
     pTIS_MED_CD_TABELAMEDICA IN TB_ATS_ATE_ATENDIMENTO_SADT.TIS_MED_CD_TABELAMEDICA%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_ATS_REL_ATENDIMENTO_SADT
  *
  *    Data Criacao:                       Por: Fabiola Lopes
  *    Data Alteracao:  01/04/2009         Por: Bruno Costa
  *    REFIZ A PROCEDURE PARA MENOR CUSTO, FICAR LEGIVEL E RETORNAR OS DADOS CORRETAMENTE
  *
  *    Data Alteracao:  27/03/2010  Por: Pedro
  *    Alterac?o: JOIN ATS.TIS_MED_CD_TABELAMEDICA E fnc_cad_pes_endereco_s E fnc_cad_pes_municipio_s
  *
  *    Funcao: Relatorio de Laudo do Atendimentos SADT
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
 OPEN v_cursor FOR
SELECT
      EPP.AUX_EPP_DS_DESCRICAO ESPECIALIDADE,
      EPP.AUX_EPP_CD_ESPECPROC CD_ESPECIALIDADE,
      EPP.TIS_MED_CD_TABELAMEDICA,
      PES_UNID.CAD_PES_NM_PESSOA UNIDADE,
      APL.ATS_ATE_CD_INTLIB IDENTIFICACAO,
      PAC.CAD_PAC_NR_PRONTUARIO RG,
      PES_PAC.CAD_PES_NM_PESSOA NOME,
      CNV.CAD_CNV_CD_HAC_PRESTADOR CODIGO_CONVENIO,
      PES_CNV.CAD_PES_NM_PESSOA NOME_CONVENIO,
      fnc_cad_pes_endereco_s(UNI.CAD_PES_ID_PESSOA,2) END_EMPRESA,
      '' NUM_EMPRESA, --NAO RETIRAR
      fnc_cad_pes_municipio_s(UNI.CAD_PES_ID_PESSOA,12) AUX_MUN_NM_MUNICIPIO,
      TEL.CAD_TEL_NR_NUM_TEL,
      ATS.ATS_ATE_DT_REALIZ_PROCED DATA_LAUDO,
      PRD.CAD_PRD_ID CODIGO_PRODUTO,
      PRD.CAD_PRD_DS_DESCRICAO PRODUTO,
      PES_PRO.CAD_PES_NM_PESSOA MEDICO,
      USU.SEG_USU_DS_NOME,
      PRO.CAD_PRO_NR_CONSELHO NUMEROCONSELHO,
      APL.ATS_APL_TEXTO_LAUDO LAUDO,
      ATS.ATS_ATE_ID NUMERO_EXAME,
      PLA.CAD_PLA_CD_PLANO_HAC CODIGO_PLANO,
      PLA.CAD_PLA_NM_NOME_PLANO NOME_PLANO,
      ATS.ATS_ATE_FL_RN RN,
    --  APL.ATS_APL_DS_DIAGNOSTICO DIAGNOSTICO,
      Floor(Months_Between(ATS.ATS_ATE_DT_REALIZ_PROCED, PES_PAC.CAD_PES_DT_NASCIMENTO) / 12) IDADE
FROM TB_ATS_ATE_ATENDIMENTO_SADT ATS
LEFT JOIN TB_ATS_APL_ATEN_PROCED_LAUDO APL
 ON  APL.ATS_ATE_ID = ATS.ATS_ATE_ID
 AND APL.ATS_ATE_CD_INTLIB = ATS.ATS_ATE_CD_INTLIB
 AND APL.ATS_ATE_IN_INTLIB = ATS.ATS_ATE_IN_INTLIB
 AND APL.AUX_EPP_CD_ESPECPROC = ATS.AUX_EPP_CD_ESPECPROC
 AND APL.CAD_PRD_ID = ATS.CAD_PRD_ID
 AND APL.TIS_MED_CD_TABELAMEDICA = ATS.TIS_MED_CD_TABELAMEDICA
INNER JOIN TB_ATS_ARP_ATEN_RESULT_PROCED ARP
 ON  ARP.ATS_ATE_ID = ATS.ATS_ATE_ID
 AND ARP.ATS_ATE_CD_INTLIB = ATS.ATS_ATE_CD_INTLIB
 AND ARP.ATS_ATE_IN_INTLIB = ATS.ATS_ATE_IN_INTLIB
 AND ARP.ATS_EPP_CD_ESPECPROC = ATS.AUX_EPP_CD_ESPECPROC
 AND ARP.CAD_PRD_ID = ATS.CAD_PRD_ID
 AND ARP.TIS_MED_CD_TABELAMEDICA = ATS.TIS_MED_CD_TABELAMEDICA
INNER JOIN TB_CAD_PAC_PACIENTE PAC
 ON PAC.CAD_PAC_ID_PACIENTE = ATS.CAD_PAC_ID_PACIENTE_INT
INNER JOIN TB_CAD_PES_PESSOA PES_PAC
 ON PES_PAC.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
INNER JOIN TB_CAD_PLA_PLANO PLA
 ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
INNER JOIN TB_CAD_CNV_CONVENIO CNV
 ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
INNER JOIN TB_CAD_PES_PESSOA PES_CNV
 ON PES_CNV.CAD_PES_ID_PESSOA = CNV.CAD_PES_ID_PESSOA
INNER JOIN TB_CAD_PRO_PROFISSIONAL PRO
 ON PRO.CAD_PRO_ID_PROFISSIONAL = APL.CAD_PRO_ID_PROF
INNER JOIN TB_CAD_PES_PESSOA PES_PRO
 ON PES_PRO.CAD_PES_ID_PESSOA = PRO.CAD_PES_ID_PESSOA
INNER JOIN TB_SEG_USU_USUARIO USU
 ON USU.SEG_USU_ID_USUARIO = APL.SEG_USU_ID_USUARIO
INNER JOIN TB_CAD_PRD_PRODUTO PRD
 ON PRD.CAD_PRD_ID = APL.CAD_PRD_ID
INNER JOIN TB_CAD_UNI_UNIDADE UNI
 ON UNI.CAD_UNI_ID_UNIDADE = ARP.CAD_UNI_ID_UNIDADE
INNER JOIN TB_CAD_PES_PESSOA PES_UNID
 ON PES_UNID.CAD_PES_ID_PESSOA = UNI.CAD_PES_ID_PESSOA
INNER JOIN TB_AUX_EPP_ESPECPROC EPP
 ON EPP.AUX_EPP_CD_ESPECPROC = ARP.ATS_EPP_CD_ESPECPROC
 AND EPP.TIS_MED_CD_TABELAMEDICA = ARP.TIS_MED_CD_TABELAMEDICA
LEFT JOIN TB_CAD_TEL_TELEFONE TEL
 ON TEL.CAD_PES_ID_PESSOA = UNI.CAD_PES_ID_PESSOA
WHERE
      (pCAD_PRD_ID IS NULL OR APL.CAD_PRD_ID = pCAD_PRD_ID)
  AND (pATS_APR_NR_SEQ_LOTE IS NULL OR ARP.ATS_APR_NR_SEQ_LOTE = pATS_APR_NR_SEQ_LOTE)
  AND (pATS_ATE_ID IS NULL OR ATS.ATS_ATE_ID = pATS_ATE_ID)
  AND (pATS_ATE_CD_INTLIB IS NULL OR APL.ATS_ATE_CD_INTLIB = pATS_ATE_CD_INTLIB)
  AND (pTIS_MED_CD_TABELAMEDICA IS NULL OR APL.TIS_MED_CD_TABELAMEDICA = pTIS_MED_CD_TABELAMEDICA)
  -- AND (:B1 IS NULL OR APL.ATS_ATE_IN_INTLIB = :B1 )
 -- AND (:B1 IS NULL OR APL.TIS_MED_CD_TABELAMEDICA = :B1 )
 and rownum  =1
  AND (ATS.ATS_ATE_FL_STATUS = 'A')
  ;
  io_cursor := v_cursor;
  end prc_ats_rel_laudo_atend_sadt;
