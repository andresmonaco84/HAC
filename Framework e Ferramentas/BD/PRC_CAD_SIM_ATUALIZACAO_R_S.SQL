CREATE OR REPLACE PROCEDURE "PRC_CAD_SIM_ATUALIZACAO_R_S"
(
     pCAD_SIM_DS_PRODUTO IN TB_CAD_SIM_SIMPRO.CAD_SIM_DS_PRODUTO%type default null,
     pVAL_ZERADO IN NUMBER default null, --0 ou 1 
     io_cursor OUT PKG_CURSOR.t_cursor
)
is
/********************************************************************
*    Procedure: PRC_CAD_SIM_ATUALIZACAO_R_S
*
*    Data Criacao:   02/08/2010   Por: Rafael Coimbra
*
*    Funcao: Seleciona os registros da Tabela que tem mnemonico
*            cadastrado e CAD_SIM_ID_IDENTIFICACAO <> 'L' ou e nulo e
*            CAD_SIM_TP_ALTERACAO <> 'L' ou e nulo e filtra ou n?o
*            por descric?o.
*
*    Data Alteracao:  17/07/2014   Por: Andrea Cazuca
*    Alteracao:  Inclusao do campo CAD_SIM_FL_RESTRITO
*
*    Data Alteracao:  31/01/2017  Por: Andre S. Monaco
*    Alteracao:    Inclusao do param. pVAL_ZERADO
*******************************************************************/
v_cursor PKG_CURSOR.t_cursor;
begin
IF (NVL(pVAL_ZERADO,0) = 0) THEN
    OPEN v_cursor FOR
    SELECT SIM.CAD_SIM_ID,
           SIM.CAD_SIM_CD_SIMPRO,
           SIM.CAD_SIM_NM_MNEMONICO,
           SIM.CAD_SIM_DS_PRODUTO,
           SIM.CAD_SIM_DT_VIGENCIA,
           SIM.CAD_SIM_ID_IDENTIFICACAO,
           NVL(SIM.CAD_SIM_VL_PRECO_FABRICA,0) AS CAD_SIM_VL_PRECO_FABRICA,
           NVL(SIM.CAD_SIM_VL_PRECO_VENDA,0) AS CAD_SIM_VL_PRECO_VENDA,
           NVL(SIM.CAD_SIM_VL_FRACAO_FABRICA,0) AS CAD_SIM_VL_FRACAO_FABRICA,
           NVL(SIM.CAD_SIM_VL_FRACAO_VENDA,0) AS CAD_SIM_VL_FRACAO_VENDA,
           SIM.CAD_SIM_TP_EMBALAGEM,
           SIM.CAD_SIM_TP_FRACAO,
           NVL(SIM.CAD_SIM_QT_EMBALAGEM,0) AS CAD_SIM_QT_EMBALAGEM,
           NVL(SIM.CAD_SIM_QT_FRACAO,0) AS CAD_SIM_QT_FRACAO,
           SIM.CAD_SIM_TP_ALTERACAO,
           SIM.CAD_SIM_TP_FABRICANTE,
           SIM.CAD_SIM_ID_INTEIRO,
           DECODE(SIM.CAD_SIM_ID_INTEIRO, 'N', 'NAO', 'S', 'SIM', '') AS DescricaoInteiro,
           SIM.CAD_SIM_ID_FRACIONADO,
           DECODE(SIM.CAD_SIM_ID_FRACIONADO, 'N', 'NAO', 'S', 'SIM', '') AS DescricaoFracionado,
           NVL(SIM.CAD_SIM_QT_FRACIONADO,0) AS CAD_SIM_QT_FRACIONADO,
           SIM.CAD_SIM_DT_ULTIMA_ATUALIZACAO,
           SIM.SEG_USU_ID_USUARIO,
           PRD.CAD_PRD_DS_DESCRICAO,
           PRD.CAD_PRD_ID,
           PRD.CAD_PRD_FL_FRACIONADO,
           NVL(PRD.CAD_PRD_VL_PRODUTO,0) AS CAD_PRD_VL_PRODUTO,
           PRD.CAD_TAP_TP_ATRIBUTO,
           DECODE(SIM.CAD_CME_CLASSIF_MED,'1','NEGATIVA','2','POSITIVA','3','NEUTRA') AS Lista,
           sim.cad_sim_pc_ipi,
           SIM.CAD_CME_CLASSIF_MED,
           SIM.CAD_SIM_CD_TUSS,
           SIM.CAD_SIM_FL_RESTRITO,
           PRD.CAD_PRD_DT_ULTIMA_ATUALIZACAO,
           SIM.CAD_SIM_ED_EDICAO
    FROM TB_CAD_SIM_SIMPRO SIM, TB_CAD_PRD_PRODUTO PRD
    WHERE PRD.CAD_PRD_DS_DESCRICAO LIKE '%' || pCAD_SIM_DS_PRODUTO|| '%'
     AND (SIM.CAD_SIM_ID_IDENTIFICACAO <> 'L' OR SIM.CAD_SIM_ID_IDENTIFICACAO IS NULL)
     AND (SIM.CAD_SIM_TP_ALTERACAO <> 'L' OR SIM.CAD_SIM_TP_ALTERACAO IS NULL)
     AND  SIM.CAD_SIM_NM_MNEMONICO = PRD.CAD_PRD_NM_MNEMONICO
     AND  PRD.TIS_MED_CD_TABELAMEDICA = '12'
    ORDER BY PRD.CAD_PRD_DS_DESCRICAO;
ELSE
    OPEN v_cursor FOR
    SELECT
           SIM.CAD_SIM_ID,
           SIM.CAD_SIM_CD_SIMPRO,
           SIM.CAD_SIM_NM_MNEMONICO,
           SIM.CAD_SIM_DS_PRODUTO,
           SIM.CAD_SIM_DT_VIGENCIA,
           SIM.CAD_SIM_ID_IDENTIFICACAO,
           NVL(SIM.CAD_SIM_VL_PRECO_FABRICA,0) AS CAD_SIM_VL_PRECO_FABRICA,
           NVL(SIM.CAD_SIM_VL_PRECO_VENDA,0) AS CAD_SIM_VL_PRECO_VENDA,
           NVL(SIM.CAD_SIM_VL_FRACAO_FABRICA,0) AS CAD_SIM_VL_FRACAO_FABRICA,
           NVL(SIM.CAD_SIM_VL_FRACAO_VENDA,0) AS CAD_SIM_VL_FRACAO_VENDA,
           SIM.CAD_SIM_TP_EMBALAGEM,
           SIM.CAD_SIM_TP_FRACAO,
           NVL(SIM.CAD_SIM_QT_EMBALAGEM,0) AS CAD_SIM_QT_EMBALAGEM,
           NVL(SIM.CAD_SIM_QT_FRACAO,0) AS CAD_SIM_QT_FRACAO,
           SIM.CAD_SIM_TP_ALTERACAO,
           SIM.CAD_SIM_TP_FABRICANTE,
           SIM.CAD_SIM_ID_INTEIRO,
           DECODE(SIM.CAD_SIM_ID_INTEIRO, 'N', 'NAO', 'S', 'SIM', '') AS DescricaoInteiro,
           SIM.CAD_SIM_ID_FRACIONADO,
           DECODE(SIM.CAD_SIM_ID_FRACIONADO, 'N', 'NAO', 'S', 'SIM', '') AS DescricaoFracionado,
           NVL(SIM.CAD_SIM_QT_FRACIONADO,0) AS CAD_SIM_QT_FRACIONADO,
           SIM.CAD_SIM_DT_ULTIMA_ATUALIZACAO,
           SIM.SEG_USU_ID_USUARIO,
           PRD.CAD_PRD_DS_DESCRICAO,
           PRD.CAD_PRD_ID,
           PRD.CAD_PRD_FL_FRACIONADO,
           NVL(PRD.CAD_PRD_VL_PRODUTO,0) AS CAD_PRD_VL_PRODUTO,
           PRD.CAD_TAP_TP_ATRIBUTO,
           DECODE(SIM.CAD_CME_CLASSIF_MED,'1','NEGATIVA','2','POSITIVA','3','NEUTRA') AS Lista,
         sim.cad_sim_pc_ipi,
         SIM.CAD_CME_CLASSIF_MED,
         SIM.CAD_SIM_CD_TUSS,
         SIM.CAD_SIM_FL_RESTRITO,
         PRD.CAD_PRD_DT_ULTIMA_ATUALIZACAO,
         SIM.CAD_SIM_ED_EDICAO
    FROM TB_CAD_SIM_SIMPRO SIM, TB_CAD_PRD_PRODUTO PRD
    WHERE PRD.TIS_MED_CD_TABELAMEDICA = '12'
      AND PRD.CAD_PRD_DS_DESCRICAO LIKE '%' || pCAD_SIM_DS_PRODUTO|| '%'
      AND (SIM.CAD_SIM_CD_SIMPRO = PRD.CAD_PRD_CD_TABELA_MATMED)
      AND ((NVL(SIM.CAD_SIM_VL_PRECO_FABRICA,0) = 0 AND NVL(SIM.CAD_SIM_VL_FRACAO_FABRICA,0) = 0 AND 
          NVL(SIM.CAD_SIM_VL_FRACAO_VENDA,0) = 0 AND NVL(SIM.CAD_SIM_VL_PRECO_VENDA,0) = 0 AND 
          PRD.CAD_PRD_FL_STATUS = 'A'))
    ORDER BY PRD.CAD_PRD_DS_DESCRICAO;
END IF;
io_cursor := v_cursor;
end PRC_CAD_SIM_ATUALIZACAO_R_S;
