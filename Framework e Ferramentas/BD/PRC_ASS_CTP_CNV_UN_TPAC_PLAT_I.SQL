create or replace procedure PRC_ASS_CTP_CNV_UN_TPAC_PLAT_I
  (
     pASS_CUT_ID IN TB_ASS_CTP_CNV_UN_TPACOM_PLA.ASS_CUT_ID%type,
     pASS_CTP_DT_INI_VIGENCIA IN TB_ASS_CTP_CNV_UN_TPACOM_PLA.ASS_CTP_DT_INI_VIGENCIA%type,
     pASS_CTP_DT_FIM_VIGENCIA IN TB_ASS_CTP_CNV_UN_TPACOM_PLA.ASS_CTP_DT_FIM_VIGENCIA%type DEFAULT NULL,
     pSEG_USU_ID_USUARIO IN TB_ASS_CTP_CNV_UN_TPACOM_PLA.SEG_USU_ID_USUARIO%type,
     pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%type,
     pASS_CTP_PC_HM_ACOMODACAO IN TB_ASS_CTP_CNV_UN_TPACOM_PLA.ASS_CTP_PC_HM_ACOMODACAO%type DEFAULT NULL,
     pASS_CTP_PC_HM_ARTROSCOPIA IN TB_ASS_CTP_CNV_UN_TPACOM_PLA.ASS_CTP_PC_HM_ARTROSCOPIA%type DEFAULT NULL,
     pASS_CTP_PC_HM_LAPAROSCOPIA IN TB_ASS_CTP_CNV_UN_TPACOM_PLA.ASS_CTP_PC_HM_LAPAROSCOPIA%type DEFAULT NULL
  )
  is

    lIdtRetorno integer;
    nCount integer;
    V_IDT_PLANO NUMBER;

  CURSOR cursor_planos is
   SELECT
    PLA.CAD_PLA_ID_PLANO
    FROM TB_CAD_PLA_PLANO PLA
    WHERE PLA.CAD_PLA_FL_SITUACAO_PLANO = 'A'
    AND PLA.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO;

  begin

   FOR X IN cursor_planos LOOP
    V_IDT_PLANO := X.CAD_PLA_ID_PLANO;


    SELECT COUNT(*)
    INTO   nCount
    FROM   TB_ASS_CTP_CNV_UN_TPACOM_PLA
    WHERE  ((pASS_CTP_DT_INI_VIGENCIA >= ASS_CTP_DT_INI_VIGENCIA
             AND ASS_CTP_DT_FIM_VIGENCIA IS NULL)
    OR     (pASS_CTP_DT_INI_VIGENCIA BETWEEN ASS_CTP_DT_INI_VIGENCIA AND ASS_CTP_DT_FIM_VIGENCIA))
    AND    ASS_CUT_ID = pASS_CUT_ID
    AND    CAD_PLA_ID_PLANO = V_IDT_PLANO;

     IF (nCount = 0) then

        SELECT SEQ_ASS_CTP_01.NextVal INTO lIdtRetorno FROM DUAL;

        INSERT INTO TB_ASS_CTP_CNV_UN_TPACOM_PLA
        (
           ASS_CTP_ID,
           ASS_CUT_ID,
           ASS_CTP_DT_INI_VIGENCIA,
           ASS_CTP_DT_FIM_VIGENCIA,
           CAD_PLA_ID_PLANO,
           ASS_CTP_DT_ULTIMA_ATUALIZACAO,
           SEG_USU_ID_USUARIO,
           ASS_CTP_PC_HM_ACOMODACAO,
           ASS_CTP_PC_HM_ARTROSCOPIA,
           ASS_CTP_PC_HM_LAPAROSCOPIA
        )
        VALUES
        (
           lIdtRetorno,
           pASS_CUT_ID,
           pASS_CTP_DT_INI_VIGENCIA,
           pASS_CTP_DT_FIM_VIGENCIA,
           V_IDT_PLANO,
           sysdate,
           pSEG_USU_ID_USUARIO,
           pASS_CTP_PC_HM_ACOMODACAO,
           pASS_CTP_PC_HM_ARTROSCOPIA,
           pASS_CTP_PC_HM_LAPAROSCOPIA
        );

    end if;

    end loop;

 exception
    when others then

      raise_application_error(SQLCODE, SQLERRM);

  end PRC_ASS_CTP_CNV_UN_TPAC_PLAT_I;
