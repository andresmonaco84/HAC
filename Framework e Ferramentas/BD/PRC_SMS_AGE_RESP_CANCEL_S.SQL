CREATE OR REPLACE PROCEDURE PRC_SMS_AGE_RESP_CANCEL_S
(
     pSMS_MRE_TELEFONE_RECEBIMENTO IN TB_SMS_MRE_MENSAGEM_RECEBIDA.SMS_MRE_TELEFONE_RECEBIMENTO%type,
     pAGE_AGD_FL_STATUS IN TB_AGE_AGD_AGENDA.AGE_AGD_FL_STATUS%type default null,
     io_cursor OUT PKG_CURSOR.t_cursor
)
IS
  /********************************************************************
  *    Procedure: PRC_SMS_AGE_RESP_CANCEL_S
  *
  *    Data Criacao:   05/11/2008        Por: Davi Silvestre M. dos Reis
  *
  *    Funcao: recuperar as consultas agendadas para determinado
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  v_AGD_DT_ATENDIMENTO DATE;
  v_AGD_DT_ATENDIMENTO_FUTURO DATE;

  BEGIN

  v_AGD_DT_ATENDIMENTO := TO_DATE(TO_CHAR(CURRENT_DATE, 'DD-MON-YYYY'), 'dd/MM/yyyy');
  v_AGD_DT_ATENDIMENTO_FUTURO := v_AGD_DT_ATENDIMENTO + 2;

    OPEN v_cursor FOR

    SELECT DISTINCT
            SMSR.SMS_MRE_TELEFONE_RECEBIMENTO,
            AGD.AGE_AGD_DT_ATENDIMENTO,
            AGD.AGE_AGD_HR_ATENDIMENTO,
            CBO.TIS_CBO_DS_CBOS DS_ESPECIALIDADE,
            PES_PRO.CAD_PES_NM_PESSOA NM_MEDICO,
            AGD.AGE_AGD_FL_STATUS STATUS,
            PES_UNI.CAD_PES_NM_PESSOA DS_UNIDADE,
            LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO DS_LOCAL,
            ESM.AGE_ESM_ID,
            AGD.AGE_AGD_ID,
            AGD.AGE_AGG_ID
           FROM
                TB_SMS_MRE_MENSAGEM_RECEBIDA SMSR
     INNER JOIN TB_SMS_MEN_MENSAGEM_ENVIADA SMSE
             ON SMSE.SMS_MEN_TELEFONE_ENVIO = SMSR.SMS_MRE_TELEFONE_RECEBIMENTO
     INNER JOIN TB_AGE_AGD_AGENDA AGD
             ON AGD.AGE_AGD_ID = SMSE.SMS_MEN_ID_TB_MODULO_ENVIO
            AND AGD.AGE_AGD_FL_STATUS = pAGE_AGD_FL_STATUS
     INNER JOIN TB_AGE_ESM_ESCALA_MEDICA ESM
             ON ESM.AGE_ESM_ID = AGD.AGE_ESM_ID
     INNER JOIN TB_CAD_UNI_UNIDADE UNI
             ON UNI.CAD_UNI_ID_UNIDADE = ESM.CAD_UNI_ID_UNIDADE
     INNER JOIN TB_CAD_PES_PESSOA PES_UNI
             ON PES_UNI.CAD_PES_ID_PESSOA = UNI.CAD_PES_ID_PESSOA
     INNER JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT
             ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO
     INNER JOIN TB_CAD_PRO_PROFISSIONAL PRO
             ON PRO.CAD_PRO_ID_PROFISSIONAL = ESM.CAD_PRO_ID_PROFISSIONAL
     INNER JOIN TB_CAD_PES_PESSOA PES_PRO
             ON PES_PRO.CAD_PES_ID_PESSOA = PRO.CAD_PES_ID_PESSOA
     INNER JOIN TB_TIS_CBO_CBOS CBO
             ON CBO.TIS_CBO_CD_CBOS = ESM.TIS_CBO_CD_CBOS
     WHERE
             SMSR.SMS_MRE_TELEFONE_RECEBIMENTO = pSMS_MRE_TELEFONE_RECEBIMENTO
         AND AGD.AGE_AGD_DT_ATENDIMENTO BETWEEN v_AGD_DT_ATENDIMENTO AND v_AGD_DT_ATENDIMENTO_FUTURO;

io_cursor := v_cursor;

END PRC_SMS_AGE_RESP_CANCEL_S;
/
