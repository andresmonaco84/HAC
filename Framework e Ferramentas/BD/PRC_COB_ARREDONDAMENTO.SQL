CREATE OR REPLACE PROCEDURE "PRC_COB_ARREDONDAMENTO"
  (
    pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    pCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
    pDATA_EMISSAO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_INI  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_CONTAB_INI     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pDATA_CONTAB_FIM     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pCAD_BAN_ID IN TB_CAD_BAN_BANCO.CAD_BAN_ID%TYPE DEFAULT NULL,
    pASS_BCT_ID IN TB_COB_MGC_MOV_GUIA_COBRANCA.ASS_BCT_ID%TYPE DEFAULT NULL,
    pFAT_NOF_NR_NOTAFISCAL   IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_NR_NOTAFISCAL%TYPE DEFAULT NULL,
    pFAT_NOF_TP_SERIEFISCAL  IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_TP_SERIEFISCAL%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
     --   ,TESTE OUT LONG
  )
  is
  /********************************************************************
  *    Procedure: PRC_COB_ARREDONDAMENTO
  *
  *    Data Criac?o: 19/11/2014  Por: PEDRO
  *    Alteracao:
  *
  *
  *******************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
 begin
 OPEN v_cursor FOR

SELECT CAD_CNV_NM_FANTASIA,
       COB_MGC_DT_MOVIMENTO, 
       FAT_NOF_NR_NOTAFISCAL,
       FAT_NOF_TP_SERIEFISCAL, 
       CAD_BAN_NM_BANCO,
       ASS_BCT_NR_CONTA,
       NVL(SUM(VALOR_MOVIMENTO_2),0) VALOR_MOVIMENTO_2,
       NVL(SUM(VALOR_MOVIMENTO_4),0) VALOR_MOVIMENTO_4,
       NVL(SUM(VALOR_MOVIMENTO_DIF),0) VALOR_MOVIMENTO_DIF,
       
       NVL(SUM(VALOR_ISS_2),0) VALOR_ISS_2,
       NVL(SUM(VALOR_ISS_4),0) VALOR_ISS_4,
       NVL(SUM(VALOR_ISS_DIF),0) VALOR_ISS_DIF,
       
       NVL(SUM(VALOR_IR_2),0) VALOR_IR_2,
       NVL(SUM(VALOR_IR_4),0) VALOR_IR_4,
       NVL(SUM(VALOR_IR_DIF),0) VALOR_IR_DIF,
       
       NVL(SUM(VALOR_CSLL_2),0) VALOR_CSLL_2,
       NVL(SUM(VALOR_CSLL_4),0) VALOR_CSLL_4,
       NVL(SUM(VALOR_CSLL_DIF),0) VALOR_CSLL_DIF,
       
       NVL(SUM(VALOR_COFINS_2),0) VALOR_COFINS_2,
       NVL(SUM(VALOR_COFINS_4),0) VALOR_COFINS_4,
       NVL(SUM(VALOR_COFINS_DIF),0) VALOR_COFINS_DIF,
       
       NVL(SUM(VALOR_PIS_2),0) VALOR_PIS_2,
       NVL(SUM(VALOR_PIS_4),0) VALOR_PIS_4,
       NVL(SUM(VALOR_PIS_DIF),0) VALOR_PIS_DIF,
       -----ANTEC_
       NVL(SUM(VALOR_ANTEC_ISS_2),0) VALOR_ANTEC_ISS_2,
       NVL(SUM(VALOR_ANTEC_ISS_4),0) VALOR_ANTEC_ISS_4,
       NVL(SUM(VALOR_ANTEC_ISS_DIF),0) VALOR_ANTEC_ISS_DIF,
       
       NVL(SUM(VALOR_ANTEC_IR_2),0) VALOR_ANTEC_IR_2,
       NVL(SUM(VALOR_ANTEC_IR_4),0) VALOR_ANTEC_IR_4,
       NVL(SUM(VALOR_ANTEC_IR_DIF),0) VALOR_ANTEC_IR_DIF,
       
       NVL(SUM(VALOR_ANTEC_CSLL_2),0) VALOR_ANTEC_CSLL_2,
       NVL(SUM(VALOR_ANTEC_CSLL_4),0) VALOR_ANTEC_CSLL_4,
       NVL(SUM(VALOR_ANTEC_CSLL_DIF),0) VALOR_ANTEC_CSLL_DIF,
       
       NVL(SUM(VALOR_ANTEC_COFINS_2),0) VALOR_ANTEC_COFINS_2,
       NVL(SUM(VALOR_ANTEC_COFINS_4),0) VALOR_ANTEC_COFINS_4,
       NVL(SUM(VALOR_ANTEC_COFINS_DIF),0) VALOR_ANTEC_COFINS_DIF,
       
       NVL(SUM(VALOR_ANTEC_PIS_2),0) VALOR_ANTEC_PIS_2,
       NVL(SUM(VALOR_ANTEC_PIS_4),0) VALOR_ANTEC_PIS_4,
       NVL(SUM(VALOR_ANTEC_PIS_DIF),0) VALOR_ANTEC_PIS_DIF,
       NVL(SUM(EXISTE_ACERTO_ANTECIPACAO),0) EXISTE_ACERTO_ANTECIPACAO,
       FAT_NOF_ID,ASS_BCT_ID


FROM (

 SELECT
       CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA CAD_CNV_NM_FANTASIA,
       TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy')  COB_MGC_DT_MOVIMENTO, 
       NOF.FAT_NOF_NR_NOTAFISCAL, NOF.FAT_NOF_TP_SERIEFISCAL, 
       BAN.CAD_BAN_CD_BANCO || '' - '' || BAN.CAD_BAN_NM_BANCO CAD_BAN_NM_BANCO,
       BCT.ASS_BCT_CD_AGENCIA || '' / '' || BCT.ASS_BCT_NR_CONTA || '' - '' || BCT.ASS_BCT_CD_CTA_CAIXA_RM ASS_BCT_NR_CONTA,
       to_char(SUM(MGC.COB_MGC_VL_MOVIMENTO),'99999999999990.00')   VALOR_MOVIMENTO_2,
       SUM(MGC.COB_MGC_VL_MOVIMENTO) VALOR_MOVIMENTO_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_MOVIMENTO),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_MOVIMENTO) VALOR_MOVIMENTO_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_ISS),'99999999999990.00') VALOR_ISS_2,
       SUM(MGC.COB_MGC_VL_ISS) VALOR_ISS_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_ISS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_ISS) VALOR_ISS_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990.00') VALOR_IR_2,
       SUM(MGC.COB_MGC_VL_IR) VALOR_IR_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_IR) VALOR_IR_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990.00') VALOR_CSLL_2,
       SUM(MGC.COB_MGC_VL_CSLL) VALOR_CSLL_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_CSLL) VALOR_CSLL_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990.00') VALOR_COFINS_2,
       SUM(MGC.COB_MGC_VL_COFINS) VALOR_COFINS_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_COFINS) VALOR_COFINS_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990.00') VALOR_PIS_2,
       SUM(MGC.COB_MGC_VL_PIS) VALOR_PIS_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_PIS) VALOR_PIS_DIF,
       
       NULL VALOR_ANTEC_ISS_2,
       NULL VALOR_ANTEC_ISS_4,
       NULL VALOR_ANTEC_ISS_DIF,
       
       NULL VALOR_ANTEC_IR_2,
       NULL VALOR_ANTEC_IR_4,
       NULL VALOR_ANTEC_IR_DIF,
       
       NULL VALOR_ANTEC_CSLL_2,
       NULL VALOR_ANTEC_CSLL_4,
       NULL VALOR_ANTEC_CSLL_DIF,
       
       NULL VALOR_ANTEC_COFINS_2,
       NULL VALOR_ANTEC_COFINS_4,
       NULL VALOR_ANTEC_COFINS_DIF,
       
       NULL VALOR_ANTEC_PIS_2,
       NULL VALOR_ANTEC_PIS_4,
       NULL VALOR_ANTEC_PIS_DIF,
       
       NULL EXISTE_ACERTO_ANTECIPACAO,
              
       NOF.FAT_NOF_ID,MGC.ASS_BCT_ID

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID

WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          NOT IN (2,7,8,9,15)--2
  AND (MGC.COB_MGC_VL_MOVIMENTO >= 0 )--OR MGC.CAD_TMC_ID=15) -- SO PODE SER NEGATIVO QUANDO FOR ARREDONDAMENTO
 AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND (pDATA_CONTAB_INI IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI)
 AND (pDATA_CONTAB_FIM IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM)
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
 AND (pCAD_UNI_ID_UNIDADE IS NULL OR NOF.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE)

     -- ' || V_WHERE_NOTA || '
     -- ' || V_WHERE_MGC || ' ;
GROUP BY  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),
          CNV.CAD_CNV_CD_HAC_PRESTADOR, CNV.CAD_CNV_NM_FANTASIA , NOF.FAT_NOF_NR_NOTAFISCAL, NOF.FAT_NOF_TP_SERIEFISCAL,
          BAN.CAD_BAN_CD_BANCO || '' - '' || BAN.CAD_BAN_NM_BANCO ,
       BCT.ASS_BCT_CD_AGENCIA || '' / '' || BCT.ASS_BCT_NR_CONTA || '' - '' || BCT.ASS_BCT_CD_CTA_CAIXA_RM,
       NOF.FAT_NOF_ID ,MGC.ASS_BCT_ID
/*HAVING TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_MOVIMENTO),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_MOVIMENTO) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_ISS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_ISS) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_IR) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_CSLL) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_PIS) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_COFINS) != 0 */
       
UNION

SELECT
       CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA CAD_CNV_NM_FANTASIA,
       TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy')  COB_MGC_DT_MOVIMENTO, 
       NOF.FAT_NOF_NR_NOTAFISCAL, NOF.FAT_NOF_TP_SERIEFISCAL, 
       BAN.CAD_BAN_CD_BANCO || '' - '' || BAN.CAD_BAN_NM_BANCO CAD_BAN_NM_BANCO,
       BCT.ASS_BCT_CD_AGENCIA || '' / '' || BCT.ASS_BCT_NR_CONTA || '' - '' || BCT.ASS_BCT_CD_CTA_CAIXA_RM ASS_BCT_NR_CONTA,
       
       NULL VALOR_MOVIMENTO_2,
       NULL VALOR_MOVIMENTO_4,
       NULL VALOR_MOVIMENTO_DIF,
       
       NULL VALOR_ISS_2,
       NULL VALOR_ISS_4,
       NULL VALOR_ISS_DIF,
       
       NULL VALOR_IR_2,
       NULL VALOR_IR_4,
       NULL VALOR_IR_DIF,
       
       NULL VALOR_CSLL_2,
       NULL VALOR_CSLL_4,
       NULL VALOR_CSLL_DIF,
       
       NULL VALOR_COFINS_2,
       NULL VALOR_COFINS_4,
       NULL VALOR_COFINS_DIF,
       
       NULL VALOR_PIS_2,
       NULL VALOR_PIS_4,
       NULL VALOR_PIS_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_ISS),'99999999999990.00') VALOR_ANTEC_ISS_2,
       SUM(MGC.COB_MGC_VL_ISS) VALOR_ANTEC_ISS_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_ISS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_ISS) VALOR_ANTEC_ISS_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990.00') VALOR_ANTEC_IR_2,
       SUM(MGC.COB_MGC_VL_IR) VALOR_ANTEC_IR_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_IR) VALOR_ANTEC_IR_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990.00') VALOR_ANTEC_CSLL_2,
       SUM(MGC.COB_MGC_VL_CSLL) VALOR_ANTEC_CSLL_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_CSLL) VALOR_ANTEC_CSLL_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990.00') VALOR_ANTEC_COFINS_2,
       SUM(MGC.COB_MGC_VL_COFINS) VALOR_ANTEC_COFINS_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_COFINS) VALOR_ANTEC_COFINS_DIF,
       
       to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990.00') VALOR_ANTEC_PIS_2,
       SUM(MGC.COB_MGC_VL_PIS) VALOR_ANTEC_PIS_4,
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_PIS) VALOR_ANTEC_PIS_DIF,

       NULL EXISTE_ACERTO_ANTECIPACAO,
       NOF.FAT_NOF_ID,MGC.ASS_BCT_ID

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          = 8
 
 AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND (pDATA_CONTAB_INI IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI)
 AND (pDATA_CONTAB_FIM IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM)
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
 AND (pCAD_UNI_ID_UNIDADE IS NULL OR NOF.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE)
     -- ' || V_WHERE_NOTA || '
     -- ' || V_WHERE_MGC || ' ;
GROUP BY  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),
          CNV.CAD_CNV_CD_HAC_PRESTADOR, CNV.CAD_CNV_NM_FANTASIA , NOF.FAT_NOF_NR_NOTAFISCAL, NOF.FAT_NOF_TP_SERIEFISCAL,
          BAN.CAD_BAN_CD_BANCO || '' - '' || BAN.CAD_BAN_NM_BANCO ,
       BCT.ASS_BCT_CD_AGENCIA || '' / '' || BCT.ASS_BCT_NR_CONTA || '' - '' || BCT.ASS_BCT_CD_CTA_CAIXA_RM,
       NOF.FAT_NOF_ID ,MGC.ASS_BCT_ID
/*HAVING TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_ISS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_ISS) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_IR) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_CSLL) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_PIS) != 0 OR
       TO_NUMBER(to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990.00')) - SUM(MGC.COB_MGC_VL_COFINS) != 0  */
UNION 
SELECT
       CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA CAD_CNV_NM_FANTASIA,
       TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy')  COB_MGC_DT_MOVIMENTO, 
       NOF.FAT_NOF_NR_NOTAFISCAL, NOF.FAT_NOF_TP_SERIEFISCAL, 
       BAN.CAD_BAN_CD_BANCO || '' - '' || BAN.CAD_BAN_NM_BANCO CAD_BAN_NM_BANCO,
       BCT.ASS_BCT_CD_AGENCIA || '' / '' || BCT.ASS_BCT_NR_CONTA || '' - '' || BCT.ASS_BCT_CD_CTA_CAIXA_RM ASS_BCT_NR_CONTA,
       
       NULL VALOR_MOVIMENTO_2,
       NULL VALOR_MOVIMENTO_4,
       NULL VALOR_MOVIMENTO_DIF,
       
       NULL VALOR_ISS_2,
       NULL VALOR_ISS_4,
       NULL VALOR_ISS_DIF,
       
       NULL VALOR_IR_2,
       NULL VALOR_IR_4,
       NULL VALOR_IR_DIF,
       
       NULL VALOR_CSLL_2,
       NULL VALOR_CSLL_4,
       NULL VALOR_CSLL_DIF,
       
       NULL VALOR_COFINS_2,
       NULL VALOR_COFINS_4,
       NULL VALOR_COFINS_DIF,
       
       NULL VALOR_PIS_2,
       NULL VALOR_PIS_4,
       NULL VALOR_PIS_DIF,
       
       NULL VALOR_ANTEC_ISS_2,
       NULL VALOR_ANTEC_ISS_4,
       NULL VALOR_ANTEC_ISS_DIF,
       
       NULL VALOR_ANTEC_IR_2,
       NULL VALOR_ANTEC_IR_4,
       NULL VALOR_ANTEC_IR_DIF,
       
       NULL VALOR_ANTEC_CSLL_2,
       NULL VALOR_ANTEC_CSLL_4,
       NULL VALOR_ANTEC_CSLL_DIF,
       
       NULL VALOR_ANTEC_COFINS_2,
       NULL VALOR_ANTEC_COFINS_4,
       NULL VALOR_ANTEC_COFINS_DIF,
       
       NULL  VALOR_ANTEC_PIS_2,
       NULL  VALOR_ANTEC_PIS_4,
       NULL VALOR_ANTEC_PIS_DIF,
       
       1 EXISTE_ACERTO_ANTECIPACAO,
       NOF.FAT_NOF_ID,MGC.ASS_BCT_ID
        
FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          = 9
 AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND (pDATA_CONTAB_INI IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI)
 AND (pDATA_CONTAB_FIM IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM)
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
 AND (pCAD_UNI_ID_UNIDADE IS NULL OR NOF.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE)
     -- ' || V_WHERE_NOTA || '
     -- ' || V_WHERE_MGC || ' ;
GROUP BY  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),
          CNV.CAD_CNV_CD_HAC_PRESTADOR, CNV.CAD_CNV_NM_FANTASIA , NOF.FAT_NOF_NR_NOTAFISCAL, NOF.FAT_NOF_TP_SERIEFISCAL,
          BAN.CAD_BAN_CD_BANCO || '' - '' || BAN.CAD_BAN_NM_BANCO ,
       BCT.ASS_BCT_CD_AGENCIA || '' / '' || BCT.ASS_BCT_NR_CONTA || '' - '' || BCT.ASS_BCT_CD_CTA_CAIXA_RM,
       NOF.FAT_NOF_ID ,MGC.ASS_BCT_ID
                   
) 
GROUP BY CAD_CNV_NM_FANTASIA,
       COB_MGC_DT_MOVIMENTO, 
       FAT_NOF_NR_NOTAFISCAL,
       FAT_NOF_TP_SERIEFISCAL, 
       CAD_BAN_NM_BANCO,
       ASS_BCT_NR_CONTA,
       FAT_NOF_ID ,
       ASS_BCT_ID

ORDER BY FAT_NOF_NR_NOTAFISCAL       
;
    io_cursor := v_cursor;
  end PRC_COB_ARREDONDAMENTO;
