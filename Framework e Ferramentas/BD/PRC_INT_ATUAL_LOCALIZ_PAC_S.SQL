CREATE OR REPLACE PROCEDURE SGS.PRC_INT_ATUAL_LOCALIZ_PAC_S
(
  pATD_ATE_ID          IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_ID%TYPE DEFAULT NULL,
  pCAD_PAC_ID_PACIENTE IN TB_CAD_PAC_PACIENTE.CAD_PAC_ID_PACIENTE%TYPE DEFAULT NULL,
  IO_CURSOR            OUT PKG_CURSOR.T_CURSOR
) 
  IS
  /********************************************************************
  *    Procedure: PRC_INT_ATUAL_LOCALIZ_PAC_S
  *
  *    Data Criacao:   data da  criação   Por: Nome do Analista
  *    Data Alteracao:  7/05/2012  Por: PEDRO
  *    Alteração: comentado( AND PAT.CAD_PAC_ID_PACIENTE = IML.CAD_PAC_ID_PACIENTE) pois existem 2 pats e o id_pac é diferente,
  *    o pac mudou credencial e não achava mais pesquisando na movimentação
  *
  *    Funcao: Descrição da funcionalidade da Stored Procedure
  *
  *******************************************************************/
  V_CURSOR PKG_CURSOR.T_CURSOR;
BEGIN
  OPEN V_CURSOR FOR
    SELECT PES.CAD_PES_NM_PESSOA,
           SETOR.CAD_SET_DS_SETOR,
           QLE.CAD_QLE_NR_QUARTO,
           QLE.CAD_QLE_NR_LEITO,
           PAC.CAD_PAC_ID_PACIENTE,
           PAC.CAD_PES_ID_PESSOA,
           'L' LOCAL_ATUAL,
           QLE.CAD_QLE_ID,
           IML.ATD_IML_ID IDMOVIMENTACAO,
           ATE.ATD_ATE_ID,
           SETOR.CAD_SET_ID,
           0 TEM_QL_ANT,
           ATE.ATD_ATE_FL_STATUS,
           QLE.TIS_TAC_CD_TIPO_ACOM_PROV
      FROM TB_ATD_ATE_ATENDIMENTO   ATE,
           TB_ASS_PAT_PACIEATEND    PAT,
           TB_CAD_PAC_PACIENTE      PAC,
           TB_CAD_PES_PESSOA        PES,
           TB_ATD_IML_INT_MOV_LEITO IML,
           TB_CAD_SET_SETOR         SETOR,
           TB_CAD_QLE_QUARTO_LEITO  QLE
     WHERE (pATD_ATE_ID IS NULL OR IML.ATD_ATE_ID = pATD_ATE_ID)
       AND IML.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND ATE.ATD_ATE_TP_PACIENTE = 'I'
       AND PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
     --  AND PAT.CAD_PAC_ID_PACIENTE = IML.CAD_PAC_ID_PACIENTE
       AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
       AND IML.ATD_IML_DT_SAIDA IS NULL
       AND IML.ATD_IML_HR_SAIDA IS NULL
       AND IML.CAD_CAD_QLE_ID = QLE.CAD_QLE_ID
       AND QLE.CAD_SET_ID = SETOR.CAD_SET_ID
       AND (pCAD_PAC_ID_PACIENTE IS NULL OR PAC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE)
       AND IML.ATD_IML_FL_STATUS = 'A'
       AND (((FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_ENTRADA, PAT.ASS_PAT_HR_ENTRADA) <=
           FNC_JUNTAR_DATA_HORA(IML.ATD_IML_DT_ENTRADA, IML.ATD_IML_HR_ENTRADA)) AND
           (PAT.ASS_PAT_DT_SAIDA IS NULL AND PAT.ASS_PAT_HR_SAIDA IS NULL)) 
         OR
           ((FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_ENTRADA, PAT.ASS_PAT_HR_ENTRADA) <=
           FNC_JUNTAR_DATA_HORA(IML.ATD_IML_DT_ENTRADA, IML.ATD_IML_HR_ENTRADA)) AND
           (FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_SAIDA, PAT.ASS_PAT_HR_SAIDA) >=
           FNC_JUNTAR_DATA_HORA(IML.ATD_IML_DT_SAIDA, IML.ATD_IML_HR_SAIDA))))
    UNION ALL
    SELECT PES.CAD_PES_NM_PESSOA,
           SETOR.CAD_SET_DS_SETOR,
           NULL,
           NULL,
           PAC.CAD_PAC_ID_PACIENTE,
           PAC.CAD_PES_ID_PESSOA,
           'S' LOCAL_ATUAL,
           NULL,
           IMS.ATD_IMS_ID IDMOVIMENTACAO,
           ATE.ATD_ATE_ID,
           SETOR.CAD_SET_ID,
           NVL(QL_ANT.ATD_IML_ID, 0) TEM_QL_ANT,
           ATE.ATD_ATE_FL_STATUS,
           NULL
      FROM TB_ATD_ATE_ATENDIMENTO ATE,
           TB_ASS_PAT_PACIEATEND PAT,
           TB_CAD_PAC_PACIENTE PAC,
           TB_CAD_PES_PESSOA PES,
           TB_ATD_IMS_INT_MOV_SETOR IMS,
           TB_CAD_SET_SETOR SETOR,
           (SELECT IML.ATD_ATE_ID ATD_ATE_ID, IML.ATD_IML_ID ATD_IML_ID
              FROM TB_ATD_IML_INT_MOV_LEITO IML,
                   TB_ATD_IMS_INT_MOV_SETOR IMS
             WHERE IML.ATD_ATE_ID = pATD_ATE_ID
               AND IMS.ATD_ATE_ID = IML.ATD_ATE_ID
               AND IMS.ATD_IMS_DT_SAIDA IS NULL
               AND IMS.ATD_IMS_HR_SAIDA IS NULL
               AND IML.ATD_IML_DT_SAIDA = IMS.ATD_IMS_DT_ENTRADA
               AND IML.ATD_IML_HR_SAIDA = IMS.ATD_IMS_HR_ENTRADA) QL_ANT
     WHERE (pATD_ATE_ID IS NULL OR IMS.ATD_ATE_ID = pATD_ATE_ID)
       AND IMS.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND ATE.ATD_ATE_TP_PACIENTE = 'I'
       AND PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
       AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
       AND IMS.ATD_IMS_DT_SAIDA IS NULL
       AND IMS.ATD_IMS_HR_SAIDA IS NULL
       AND IMS.CAD_SET_ID_SETOR = SETOR.CAD_SET_ID
       AND (pCAD_PAC_ID_PACIENTE IS NULL OR PAC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE)
       AND QL_ANT.ATD_ATE_ID(+) = IMS.ATD_ATE_ID
       AND IMS.ATD_IMS_FL_STATUS = 'A'
       AND (((FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_ENTRADA, PAT.ASS_PAT_HR_ENTRADA) <=
           FNC_JUNTAR_DATA_HORA(IMS.ATD_IMS_DT_ENTRADA, IMS.ATD_IMS_HR_ENTRADA)) AND
           (PAT.ASS_PAT_DT_SAIDA IS NULL AND PAT.ASS_PAT_HR_SAIDA IS NULL)) 
         OR
           ((FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_ENTRADA, PAT.ASS_PAT_HR_ENTRADA) <=
           FNC_JUNTAR_DATA_HORA(IMS.ATD_IMS_DT_ENTRADA, IMS.ATD_IMS_HR_ENTRADA)) AND
           (FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_SAIDA, PAT.ASS_PAT_HR_SAIDA) >=
           FNC_JUNTAR_DATA_HORA(IMS.ATD_IMS_DT_SAIDA, IMS.ATD_IMS_HR_SAIDA))))
    UNION ALL
    SELECT PES.CAD_PES_NM_PESSOA,
           PES_CLI.CAD_PES_NM_PESSOA CAD_SET_DS_SETOR,
           NULL,
           NULL,
           PAC.CAD_PAC_ID_PACIENTE,
           PAC.CAD_PES_ID_PESSOA,
           'C' LOCAL_ATUAL,
           NULL,
           IMC.ATD_IMC_ID IDMOVIMENTACAO,
           ATE.ATD_ATE_ID,
           CLC.CAD_CLC_ID,
           0 TEM_QL_ANT,
           ATE.ATD_ATE_FL_STATUS,
           NULL
      FROM TB_ATD_ATE_ATENDIMENTO         ATE,
           TB_ASS_PAT_PACIEATEND          PAT,
           TB_CAD_PAC_PACIENTE            PAC,
           TB_CAD_PES_PESSOA              PES,
           TB_ATD_IMC_INT_MOV_CLINICA     IMC,
           TB_CAD_CLC_CLINICA_CREDENCIADA CLC,
           TB_CAD_PES_PESSOA              PES_CLI
     WHERE (pATD_ATE_ID IS NULL OR IMC.ATD_ATE_ID = pATD_ATE_ID)
       AND IMC.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND ATE.ATD_ATE_TP_PACIENTE = 'I'
       AND PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
       AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
       AND IMC.ATD_IMC_DT_SAIDA IS NULL
       AND IMC.ATD_IMC_HR_SAIDA IS NULL
       AND IMC.CAD_CLC_ID = CLC.CAD_CLC_ID
       AND CLC.CAD_PES_ID_PESSOA = PES_CLI.CAD_PES_ID_PESSOA
       AND (pCAD_PAC_ID_PACIENTE IS NULL OR PAC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE)
       AND (((FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_ENTRADA, PAT.ASS_PAT_HR_ENTRADA) <=
           FNC_JUNTAR_DATA_HORA(IMC.ATD_IMC_DT_ENTRADA, IMC.ATD_IMC_HR_ENTRADA)) AND
           (PAT.ASS_PAT_DT_SAIDA IS NULL AND PAT.ASS_PAT_HR_SAIDA IS NULL)) 
         OR
           ((FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_ENTRADA, PAT.ASS_PAT_HR_ENTRADA) <=
           FNC_JUNTAR_DATA_HORA(IMC.ATD_IMC_DT_ENTRADA, IMC.ATD_IMC_HR_ENTRADA)) AND
           (FNC_JUNTAR_DATA_HORA(PAT.ASS_PAT_DT_SAIDA, PAT.ASS_PAT_HR_SAIDA) >=
           FNC_JUNTAR_DATA_HORA(IMC.ATD_IMC_DT_SAIDA, IMC.ATD_IMC_HR_SAIDA))));
  IO_CURSOR := V_CURSOR;
END PRC_INT_ATUAL_LOCALIZ_PAC_S;
