create or replace procedure PRC_ASS_CLP_CNV_UND_LOC_PLAT_I
  (
     pASS_CUL_ID IN TB_ASS_CLP_CNV_UND_LOC_PLANO.ASS_CUL_ID%type,
     pASS_CLP_DT_INI_VIGENCIA IN TB_ASS_CLP_CNV_UND_LOC_PLANO.ASS_CLP_DT_INI_VIGENCIA%type,
     pASS_CLP_DT_FIM_VIGENCIA IN TB_ASS_CLP_CNV_UND_LOC_PLANO.ASS_CLP_DT_FIM_VIGENCIA%type DEFAULT NULL,
     pASS_CLP_FL_BLOQUEIA_UNID_OK IN TB_ASS_CLP_CNV_UND_LOC_PLANO.ASS_CLP_FL_BLOQUEIA_UNIDADE_OK%type,
     pSEG_USU_ID_USUARIO IN TB_ASS_CLP_CNV_UND_LOC_PLANO.SEG_USU_ID_USUARIO%type,
     pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%type
  )
  is
    lIdtRetorno integer;
    nCount integer;
    V_IDT_PLANO NUMBER;

  CURSOR cursor_planos is
   SELECT
    PLA.CAD_PLA_ID_PLANO
    FROM TB_CAD_PLA_PLANO PLA
    WHERE PLA.CAD_PLA_FL_SITUACAO_PLANO = 'A'
    AND PLA.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO;

   begin

--  begin transaction;
   FOR X IN cursor_planos LOOP
    V_IDT_PLANO := X.CAD_PLA_ID_PLANO;


    SELECT COUNT(*)
    INTO   nCount
    FROM   TB_ASS_CLP_CNV_UND_LOC_PLANO
    WHERE  ((pASS_CLP_DT_INI_VIGENCIA >= ASS_CLP_DT_INI_VIGENCIA
             AND ASS_CLP_DT_FIM_VIGENCIA IS NULL)
    OR     (pASS_CLP_DT_INI_VIGENCIA BETWEEN ASS_CLP_DT_INI_VIGENCIA AND ASS_CLP_DT_FIM_VIGENCIA))
    AND    ASS_CUL_ID = pASS_CUL_ID
    AND    CAD_PLA_ID_PLANO = V_IDT_PLANO;

    IF (nCount = 0) then

      SELECT SEQ_ASS_CLP_01.NextVal INTO lIdtRetorno FROM DUAL;

      INSERT INTO TB_ASS_CLP_CNV_UND_LOC_PLANO
      (
         ASS_CLP_ID,
         ASS_CUL_ID,
         ASS_CLP_DT_INI_VIGENCIA,
         ASS_CLP_DT_FIM_VIGENCIA,
         CAD_PLA_ID_PLANO,
         ASS_CLP_FL_BLOQUEIA_UNIDADE_OK,
         ASS_CLP_DT_ULTIMA_ATUALIZACAO,
         SEG_USU_ID_USUARIO
      )
      VALUES
      (
         lIdtRetorno,
         pASS_CUL_ID,
         pASS_CLP_DT_INI_VIGENCIA,
         pASS_CLP_DT_FIM_VIGENCIA,
         V_IDT_PLANO,
         pASS_CLP_FL_BLOQUEIA_UNID_OK,
         SYSDATE,
         pSEG_USU_ID_USUARIO
      );

    END IF;

   END LOOP;

--  commit;
  EXCEPTION
  WHEN OTHERS THEN

--  ROLLBACK;
  raise_application_error(SQLCODE, SQLERRM);

  
  end PRC_ASS_CLP_CNV_UND_LOC_PLAT_I;
