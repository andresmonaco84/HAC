CREATE OR REPLACE PROCEDURE "PRC_CTS_RES_AGRUPA_RECEITA"
-- agrupa_receita_despesa_modelo3_cc_proced.txt
(
    P_CTS_RES_MES IN TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_MES%TYPE,
    P_CTS_RES_ANO IN TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_ANO%TYPE
)
IS
/********************************************************************
*
*    PROCEDURE: PRC_CTS_RES_AGRUPA_RECEITA
*    DATA:13/08/2013          POR: Neide
*
*********************************************************************/
BEGIN
  DECLARE
    CURSOR ATU IS
      --- SOMAR TODA RECEITA DIFERENTE DE DIARIA
      --- E MOVER PARA RECEITA INTERNEDIARIA DO ATRIBUTO DIARIA
      SELECT RES.ATD_ATE_TP_PACIENTE,
             RES.CAD_CEC_ID_CCUSTO_RECEITA,
             CEC.CAD_CEC_DS_CCUSTO,
             --RES.CAD_CEC_ID_CC_PROCEDIMENTO,
             RES.CAD_UNI_ID_UNIDADE,
             RES.CTS_RES_MES,
             RES.CTS_RES_ANO,
             SUM(NVL(RES.CTS_RES_VL_RECEITA_DIRETA, 0)) VL_RECEITA_DIRETA,
             SUM(NVL(RES.CTS_RES_VL_RECEITA_INDIRETA, 0)) VL_RECEITA_INDIRETA,
             SUM(NVL(RES.CTS_RES_VL_DESPESA_DIRETA, 0)) VL_DESPESA_DIRETA,
             SUM(NVL(RES.CTS_RES_VL_DESPESA_INDIRETA, 0)) VL_DESPESA_INDIRETA
        FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
             TB_CAD_CEC_CENTRO_CUSTO CEC
       WHERE RES.CTS_RES_MES = P_CTS_RES_MES
         AND RES.CTS_RES_ANO = P_CTS_RES_ANO
         AND RES.CAD_CTS_PLC_ID NOT IN (1, 2)
         --AND RES.CTS_RES_TP_RELATORIO = 1
         AND RES.CAD_TAP_TP_ATRIBUTO NOT IN ('DIA')
         --AND RES.CAD_CEC_ID_CCUSTO_RECEITA = 65
         AND RES.ATD_ATE_TP_PACIENTE = 'I'
         AND RES.CAD_CEC_ID_CCUSTO_RECEITA = CEC.CAD_CEC_ID_CCUSTO
       GROUP BY RES.ATD_ATE_TP_PACIENTE,
                RES.CAD_CEC_ID_CCUSTO_RECEITA,
                --RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                RES.CAD_UNI_ID_UNIDADE,
                RES.CTS_RES_MES,
                RES.CTS_RES_ANO,
                CEC.CAD_CEC_DS_CCUSTO
       ORDER BY 3, 2;
  BEGIN
    --- MOVER COLUNAS PARA RELATORIO RESUMO DESPESA DIRETA PARA DESPESA DIRETA RESUMO
    --- PARA TODOS OS TIPOS DE PACIENTE
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RESU
       SET RESU.CTS_RES_VL_REC_DIRETA_RESU = RESU.CTS_RES_VL_RECEITA_DIRETA
     WHERE RESU.CTS_RES_MES = P_CTS_RES_MES
       AND RESU.CTS_RES_ANO = P_CTS_RES_ANO;
    ----
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RESU
       SET RESU.CTS_RES_VL_DESP_DIRETA_RESU   = RESU.CTS_RES_VL_DESPESA_DIRETA,
           RESU.CTS_RES_VL_REC_INDIRETA_RESU  = RESU.CTS_RES_VL_RECEITA_INDIRETA,
           RESU.CTS_RES_VL_DESP_INDIRETA_RESU = RESU.CTS_RES_VL_DESPESA_INDIRETA
     WHERE RESU.CTS_RES_MES = P_CTS_RES_MES
       AND RESU.CTS_RES_ANO = P_CTS_RES_ANO
       AND RESU.CAD_TAP_TP_ATRIBUTO = 'DIA';
    --- MOVER COLUNAS PARA RELATORIO RESUMO
    --- RECEITA INTERMEDIARIA , INDIRETA
    --- DESPESA DIRETA, INTERMEDIARIA, INDIRETA
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RESU
       SET RESU.CTS_RES_VL_REC_INTERMED_RESU  = RESU.CTS_RES_VL_RECEITA_INTERMEDIAR,
           RESU.CTS_RES_VL_REC_INDIRETA_RESU  = RESU.CTS_RES_VL_RECEITA_INDIRETA,
           RESU.CTS_RES_VL_DESP_DIRETA_RESU   = RESU.CTS_RES_VL_DESPESA_DIRETA,
           RESU.CTS_RES_VL_DESP_INTERMED_RESU = RESU.CTS_RES_VL_DESPESA_INTERMEDIAR,
           RESU.CTS_RES_VL_DESP_INDIRETA_RESU = RESU.CTS_RES_VL_DESPESA_INDIRETA
     WHERE RESU.CTS_RES_MES = P_CTS_RES_MES
       AND RESU.CTS_RES_ANO = P_CTS_RES_ANO
       AND RESU.ATD_ATE_TP_PACIENTE <> 'I';
    FOR A IN ATU LOOP
      --- RECEITA DIRETA PARA RECEITA INTERMEDIARIA DO RESUMO
      UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
         SET RES.CTS_RES_VL_REC_INTERMED_RESU = NVL(RES.CTS_RES_VL_REC_INTERMED_RESU, 0) + (A.VL_RECEITA_DIRETA * RES.CTS_RES_PERCENT_1) / 100
       WHERE RES.CAD_CEC_ID_CCUSTO_RECEITA = A.CAD_CEC_ID_CCUSTO_RECEITA
         AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
         AND RES.CTS_RES_MES = A.CTS_RES_MES
         AND RES.CTS_RES_ANO = A.CTS_RES_ANO
         AND RES.ATD_ATE_TP_PACIENTE = A.ATD_ATE_TP_PACIENTE
         AND RES.CAD_TAP_TP_ATRIBUTO = 'DIA';
      --- RECEITA INDIRETA PARA RECEITA INDIRETA DO RESUMO
      UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
         SET RES.CTS_RES_VL_REC_INDIRETA_RESU = NVL(RES.CTS_RES_VL_REC_INDIRETA_RESU, 0) + (A.VL_RECEITA_INDIRETA * RES.CTS_RES_PERCENT_1) / 100
       WHERE RES.CAD_CEC_ID_CCUSTO_RECEITA = A.CAD_CEC_ID_CCUSTO_RECEITA
         AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
         AND RES.CTS_RES_MES = A.CTS_RES_MES
         AND RES.CTS_RES_ANO = A.CTS_RES_ANO
         AND RES.ATD_ATE_TP_PACIENTE = A.ATD_ATE_TP_PACIENTE
         AND RES.CAD_TAP_TP_ATRIBUTO = 'DIA';
      --- DESPESA DIRETA PARA DESPESA INTERMEDIARIA
      UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
         SET RES.CTS_RES_VL_DESP_INTERMED_RESU = NVL(RES.CTS_RES_VL_DESP_INTERMED_RESU, 0) + (A.VL_DESPESA_DIRETA * RES.CTS_RES_PERCENT_1) / 100
       WHERE RES.CAD_CEC_ID_CCUSTO_RECEITA = A.CAD_CEC_ID_CCUSTO_RECEITA
         AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
         AND RES.CTS_RES_MES = A.CTS_RES_MES
         AND RES.CTS_RES_ANO = A.CTS_RES_ANO
         AND RES.ATD_ATE_TP_PACIENTE = A.ATD_ATE_TP_PACIENTE
         AND RES.CAD_TAP_TP_ATRIBUTO = 'DIA';
      --- DESPESA INDIRETA  PARA DESPESA INDIRETA DO RESUMO
      UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
         SET RES.CTS_RES_VL_DESP_INDIRETA_RESU = NVL(RES.CTS_RES_VL_DESP_INDIRETA_RESU, 0) + (A.VL_DESPESA_INDIRETA * RES.CTS_RES_PERCENT_1) / 100
       WHERE RES.CAD_CEC_ID_CCUSTO_RECEITA = A.CAD_CEC_ID_CCUSTO_RECEITA
         AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
         AND RES.CTS_RES_MES = A.CTS_RES_MES
         AND RES.CTS_RES_ANO = A.CTS_RES_ANO
         AND RES.ATD_ATE_TP_PACIENTE = A.ATD_ATE_TP_PACIENTE
         AND RES.CAD_TAP_TP_ATRIBUTO = 'DIA';
    END LOOP;
    COMMIT;
  END;
END PRC_CTS_RES_AGRUPA_RECEITA;
