CREATE OR REPLACE PROCEDURE "PRC_FAT_INDIVIDUAL_NEMITIDA_L"
(
  pATD_ATE_ID          IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_ID%TYPE DEFAULT NULL,
  pCAD_PAC_ID_PACIENTE IN TB_CAD_PAC_PACIENTE.CAD_PAC_ID_PACIENTE%TYPE DEFAULT NULL,
  pDATA_CONSULTA       IN TB_FAT_CCI_CONTA_CONSU_ITEM.FAT_CCI_DT_FIM_CONSUMO%TYPE DEFAULT NULL,
  pHORA_CONSULTA       IN TB_FAT_CCI_CONTA_CONSU_ITEM.FAT_CCI_HR_FIM_CONSUMO%TYPE DEFAULT NULL,
  IO_CURSOR            OUT PKG_CURSOR.T_CURSOR
)
  IS
 /********************************************************************
  *    Procedure: PRC_FAT_INDIVIDUAL_NEMITIDA_L
  *
  *    Data Criacao:   data da criac?o   Por: Nome do Analista
  *
  *    Data Alteracao: 20/08/2010    Por: PEDRO
  *    Alteracao: AND CCI.FAT_CCI_TP_DESTINO_ITEM <> 'H'
  *
  *    Funcao: Descric?o da funcionalidade da Stored Procedure
  *
  *******************************************************************/
  V_CURSOR PKG_CURSOR.T_CURSOR;
  SD01 CONSTANT NUMBER := 281;
  GG05 CONSTANT NUMBER := 283;
  NR14 CONSTANT NUMBER := 1022;
  NP01 CONSTANT NUMBER := 1021;
  S006 CONSTANT NUMBER := 512;
  S189 CONSTANT NUMBER := 2762;
  TIPO_ATENDIMENTO_CONSULTA CONSTANT NUMBER := 4;
  SETOR_HEMODIALISE CONSTANT NUMBER         := 114;
BEGIN
  OPEN V_CURSOR FOR
    SELECT DISTINCT ATE.ATD_ATE_ID,
                    ATE.ATD_ATE_TP_PACIENTE,
                    PES.CAD_PES_NM_PESSOA,
                    ATE.ATD_ATE_DT_ATENDIMENTO,
                    ATE.ATD_ATE_HR_ATENDIMENTO,
                    NULL AS ATD_INA_DT_ALTA_ADM,
                    NULL AS ATD_INA_HR_ALTA_ADM,
                    NULL AS TIS_MSI_CD_MOTIVOSAIDAINT,
                    SUM(CCI.FAT_CCI_VL_PRODUTO),
                    SUM(CCI.FAT_CCI_VL_FATURADO),
                    PAC.CAD_PAC_ID_PACIENTE,
                    PAC.CAD_CNV_ID_CONVENIO,
                    CCI.FAT_CCP_ID,
                    1 AS FAT_COC_ID,
                    CID10.CAD_CID_DS_CID10,
                    PLA.CAD_PLA_CD_TIPOPLANO,
                    CNV.CAD_CNV_FL_ENV_ENVIOONLINE,
                    ATE.CAD_UNI_ID_UNIDADE,
					PLA.CAD_PLA_ID_PLANO,
					CNV.CAD_TPE_CD_CODIGO,
					ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO
      FROM TB_ATD_ATE_ATENDIMENTO      ATE,
           TB_FAT_MCC_MOV_COM_CONSUMO  MCC,
           TB_FAT_CCI_CONTA_CONSU_ITEM CCI,
           TB_CAD_PAC_PACIENTE         PAC,
           TB_CAD_PES_PESSOA           PES,
           TB_CAD_CID_CID10            CID10,
           TB_CAD_PLA_PLANO            PLA,
           TB_CAD_CNV_CONVENIO         CNV,
           TB_CAD_MPF_MOTI_PEND_FATURAR MPF
     WHERE ATE.ATD_ATE_ID = pATD_ATE_ID
       AND PAC.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO
       AND PAC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE
       AND ATE.CAD_CID_CD_CID10 = CID10.CAD_CID_CD_CID10(+)
       AND MCC.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND CCI.FAT_MCC_ID = MCC.FAT_MCC_ID
       AND CCI.ATD_ATE_ID = MCC.ATD_ATE_ID
       AND CCI.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
       AND CCI.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
       AND FNC_JUNTAR_DATA_HORA(CCI.FAT_CCI_DT_INICIO_CONSUMO, CCI.FAT_CCI_HR_INICIO_CONSUMO)
           <= FNC_JUNTAR_DATA_HORA(pDATA_CONSULTA, pHORA_CONSULTA)
       AND ((PAC.CAD_CNV_ID_CONVENIO IN (SD01, GG05, NR14, NP01, S006, S189)
             AND ((ATE.CAD_SET_ID = SETOR_HEMODIALISE
             AND ATE.TIS_TAT_CD_TPATENDIMENTO <> TIPO_ATENDIMENTO_CONSULTA
             AND ATE.ATD_ATE_FL_LIBERA_EMISSAO = 'S') OR (ATE.CAD_SET_ID <> SETOR_HEMODIALISE)))
       OR (ATE.ATD_ATE_FL_LIBERA_EMISSAO = 'S'))
       AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
       AND ATE.ATD_ATE_TP_PACIENTE IN ('A', 'U')
       AND ATE.ATD_ATE_FL_STATUS = 'A'
       AND MCC.FAT_MCC_FL_STATUS = 'A'
       AND CCI.FAT_CCI_FL_STATUS = 'A'
--       AND CCI.FAT_CCI_FL_FATURADO = 'N'
       --AND (CCI.FAT_FL_PENDENTE_AUTORIZA = 'A' OR CCI.FAT_FL_PENDENTE_AUTORIZA IS NULL)
       AND CCI.FAT_CCI_TP_DESTINO_ITEM NOT IN ('H','T')
       AND CCI.FAT_CCP_ID IS NULL
     AND (CCI.CAD_MPF_ID IS NULL OR MPF.CAD_MPF_FL_MOTIVO = 'J')
     AND CCI.CAD_MPF_ID       = MPF.CAD_MPF_ID(+)
     GROUP BY ATE.ATD_ATE_TP_PACIENTE,
              ATE.ATD_ATE_ID,
              PES.CAD_PES_NM_PESSOA,
              ATE.ATD_ATE_DT_ATENDIMENTO,
              ATE.ATD_ATE_HR_ATENDIMENTO,
              NULL,
              NULL,
              NULL,
              PAC.CAD_PAC_ID_PACIENTE,
              PAC.CAD_CNV_ID_CONVENIO,
              CCI.FAT_CCP_ID,
              1,
              CID10.CAD_CID_DS_CID10,
              PLA.CAD_PLA_CD_TIPOPLANO,
              CNV.CAD_CNV_FL_ENV_ENVIOONLINE,
              ATE.CAD_UNI_ID_UNIDADE,
				PLA.CAD_PLA_ID_PLANO,
				CNV.CAD_TPE_CD_CODIGO,
				ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO
    UNION ALL
    SELECT DISTINCT ATE.ATD_ATE_ID,
                    ATE.ATD_ATE_TP_PACIENTE,
                    PES.CAD_PES_NM_PESSOA,
                    ATE.ATD_ATE_DT_ATENDIMENTO,
                    ATE.ATD_ATE_HR_ATENDIMENTO,
                    case when MSI.TIS_MSI_CD_TIPOALTA = 4 then INA.Atd_Ina_Dt_Alta_Clinica  
                    else         INA.ATD_INA_DT_ALTA_ADM
                    end ATD_INA_DT_ALTA_ADM,                     
                    case when MSI.TIS_MSI_CD_TIPOALTA = 4 then INA.ATD_INA_HR_ALTA_CLINICA  
                    else         INA.ATD_INA_HR_ALTA_ADM end ATD_INA_HR_ALTA_ADM,
                    INA.TIS_MSI_CD_MOTIVOSAIDAINT,
                    SUM(CCI.FAT_CCI_VL_PRODUTO),
                    SUM(CCI.FAT_CCI_VL_FATURADO),
                    PAC.CAD_PAC_ID_PACIENTE,
                    PAC.CAD_CNV_ID_CONVENIO,
                    CCI.FAT_CCP_ID,
                    1 AS FAT_COC_ID,
                    CID10.CAD_CID_DS_CID10,
                    PLA.CAD_PLA_CD_TIPOPLANO,
                    CNV.CAD_CNV_FL_ENV_ENVIOONLINE,
                    ATE.CAD_UNI_ID_UNIDADE,
					PLA.CAD_PLA_ID_PLANO,
					CNV.CAD_TPE_CD_CODIGO,
					ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO
      FROM TB_ATD_ATE_ATENDIMENTO      ATE,
           TB_ATD_AIC_ATE_INT_COMPL    AIC,
           TB_ATD_INA_INT_ALTA         INA,
           TB_FAT_MCC_MOV_COM_CONSUMO  MCC,
           TB_FAT_CCI_CONTA_CONSU_ITEM CCI,
           TB_CAD_PAC_PACIENTE         PAC,
           TB_CAD_PES_PESSOA           PES,
           TB_CAD_CID_CID10            CID10,
           TB_CAD_PLA_PLANO            PLA,
           TB_CAD_CNV_CONVENIO         CNV,
           TB_CAD_MPF_MOTI_PEND_FATURAR MPF,
           TB_TIS_MSI_MOTIVO_SAIDA_INT MSI
     WHERE ATE.ATD_ATE_ID = pATD_ATE_ID
       AND PAC.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO
       AND PAC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE
       AND ATE.CAD_CID_CD_CID10 = CID10.CAD_CID_CD_CID10(+)
       AND MSI.TIS_MSI_CD_MOTIVOSAIDAINT(+) = INA.TIS_MSI_CD_MOTIVOSAIDAINT
       AND AIC.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND INA.ATD_ATE_ID(+) = AIC.ATD_ATE_ID
       AND MCC.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND CCI.FAT_MCC_ID = MCC.FAT_MCC_ID
       AND CCI.ATD_ATE_ID = MCC.ATD_ATE_ID
       AND CCI.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
       AND CCI.ATD_ATE_ID = ATE.ATD_ATE_ID
       AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
       AND FNC_JUNTAR_DATA_HORA(CCI.FAT_CCI_DT_INICIO_CONSUMO, CCI.FAT_CCI_HR_INICIO_CONSUMO)
           <= FNC_JUNTAR_DATA_HORA(pDATA_CONSULTA, pHORA_CONSULTA)
       AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
       AND ATE.ATD_ATE_TP_PACIENTE IN ('I', 'E')
       AND ATE.ATD_ATE_FL_STATUS = 'A'
       AND MCC.FAT_MCC_FL_STATUS = 'A'
       AND CCI.FAT_CCI_FL_STATUS = 'A'
--       AND CCI.FAT_CCI_FL_FATURADO = 'N'
       --AND (CCI.FAT_FL_PENDENTE_AUTORIZA = 'A' OR CCI.FAT_FL_PENDENTE_AUTORIZA IS NULL)
       AND CCI.FAT_CCI_TP_DESTINO_ITEM <> 'H'
       AND CCI.FAT_CCP_ID IS NULL
     AND (CCI.CAD_MPF_ID IS NULL OR MPF.CAD_MPF_FL_MOTIVO = 'J')
     AND CCI.CAD_MPF_ID       = MPF.CAD_MPF_ID(+)
     GROUP BY ATE.ATD_ATE_TP_PACIENTE,
              ATE.ATD_ATE_ID,
              PES.CAD_PES_NM_PESSOA,
              ATE.ATD_ATE_DT_ATENDIMENTO,
              ATE.ATD_ATE_HR_ATENDIMENTO,
              INA.ATD_INA_DT_ALTA_ADM,
              INA.ATD_INA_HR_ALTA_ADM,
              INA.Atd_Ina_Dt_Alta_Clinica,
              INA.ATD_INA_HR_ALTA_CLINICA,
              MSI.TIS_MSI_CD_TIPOALTA,
              INA.TIS_MSI_CD_MOTIVOSAIDAINT,
              PAC.CAD_PAC_ID_PACIENTE,
              PAC.CAD_CNV_ID_CONVENIO,
              CCI.FAT_CCP_ID,
              1,
              CID10.CAD_CID_DS_CID10,
              PLA.CAD_PLA_CD_TIPOPLANO,
              CNV.CAD_CNV_FL_ENV_ENVIOONLINE,
              ATE.CAD_UNI_ID_UNIDADE,
				PLA.CAD_PLA_ID_PLANO,
				CNV.CAD_TPE_CD_CODIGO,
				ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO;
  IO_CURSOR := V_CURSOR;
END PRC_FAT_INDIVIDUAL_NEMITIDA_L;

 