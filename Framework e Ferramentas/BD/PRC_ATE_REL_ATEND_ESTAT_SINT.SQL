create or replace procedure PRC_ATE_REL_ATEND_ESTAT_SINT
  (
     pCAD_UNI_ID_UNIDADE in TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%type,
     pCAD_LAT_ID_LOCAL_ATENDIMENTO in TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE,
     pCAD_SET_ID IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,
     pCAD_SET_NR_ANDAR in TB_CAD_SET_SETOR.CAD_SET_NR_ANDAR%type default null,
     pCAD_CNV_ID_CONVENIO in TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%type default null,
     pCAD_PLA_ID_PLANO in TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%type default null,
     pTIS_CBO_CD_CBOS in TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%type default null,
     pCAD_PRO_ID_PROFISSIONAL in TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%type default null,
     pATD_DT_INICIO in TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE,
     pATD_DT_FIM in TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE,
     pATD_HR_INICIO in TB_ATD_ATE_ATENDIMENTO.ATD_ATE_HR_ATENDIMENTO%type default null,
     pATD_HR_FIM in TB_ATD_ATE_ATENDIMENTO.ATD_ATE_HR_ATENDIMENTO%type default null,
     pTIS_TAT_CD_TPATENDIMENTO  in TB_TIS_TAT_TP_ATENDIMENTO.TIS_TAT_CD_TPATENDIMENTO%type default null,
     pCAD_PLA_CD_TIPOPLANO in TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%type default null,
     pATD_ATE_FL_INDIC_RN_OK in TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_INDIC_RN_OK%type default null,
     pATD_ATE_FL_RETORNO_OK in TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_RETORNO_OK%type default null,
     pATD_ATE_FL_STATUS in TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_STATUS%type default null,
          pCAD_CGC_ID IN tb_cad_cnv_convenio.cad_cgc_id%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
      --,TESTE OUT LONG
  )
  is
  /********************************************************************
  *    Procedure: PRC_ATE_REL_ATEND_ESTAT_SINT
  *
  *    Data Alteracao: 13/08/2015  Por: Pedro
  *    Alterac?o:  -- pCAD_SET_ID retirado por problema de base tb_ass_uss
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  V_WHERE_ESM varchar2(1000);
  V_WHERE_AGG varchar2(1000);
  V_WHERE_AGD varchar2(1000);
  V_WHERE_AGC varchar2(1000);
  V_WHERE_PAC varchar2(1000);
  V_WHERE_ATE varchar2(1500);
  V_SELECT    varchar2(29000);
  begin
    V_WHERE_ESM := NULL;
    IF pTIS_CBO_CD_CBOS IS NOT NULL THEN V_WHERE_ESM := V_WHERE_ESM || ' AND ESM.TIS_CBO_CD_CBOS = ' ||CHR(39)|| pTIS_CBO_CD_CBOS ||CHR(39); END IF;
    IF pCAD_PRO_ID_PROFISSIONAL IS NOT NULL THEN  V_WHERE_ESM := V_WHERE_ESM || ' AND esm.cad_pro_id_profissional = ' || pCAD_PRO_ID_PROFISSIONAL;  END IF;
    IF pATD_DT_FIM IS NOT NULL THEN  V_WHERE_ESM := V_WHERE_ESM || ' AND esm.age_esm_dt_ini_escala <= ' ||CHR(39)|| pATD_DT_FIM ||CHR(39);  END IF;

    V_WHERE_AGG := NULL;
    IF pATD_HR_INICIO IS NOT NULL THEN V_WHERE_AGG := V_WHERE_AGG || ' AND agg.age_agg_hr_agenda >= '|| pATD_HR_INICIO ;    END IF;
    IF pATD_HR_FIM IS NOT NULL THEN V_WHERE_AGG := V_WHERE_AGG || ' AND agg.age_agg_hr_agenda <= ' || pATD_HR_FIM ;    END IF;

    V_WHERE_AGD := NULL;
    IF pATD_HR_INICIO IS NOT NULL THEN V_WHERE_AGD := V_WHERE_AGD || ' AND agd.age_agd_hr_atendimento >= '|| pATD_HR_INICIO ;    END IF;
    IF pATD_HR_FIM IS NOT NULL THEN V_WHERE_AGD := V_WHERE_AGD || ' AND agd.age_agd_hr_atendimento <= ' || pATD_HR_FIM ;    END IF;

    V_WHERE_AGC := NULL;
    IF pATD_HR_INICIO IS NOT NULL THEN V_WHERE_AGC := V_WHERE_AGC || ' AND agc.age_agd_hr_atendimento >= '|| pATD_HR_INICIO ;    END IF;
    IF pATD_HR_FIM IS NOT NULL THEN V_WHERE_AGC := V_WHERE_AGC || ' AND agc.age_agd_hr_atendimento <= ' || pATD_HR_FIM ;    END IF;


    V_WHERE_PAC := NULL;
    IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN V_WHERE_PAC := V_WHERE_PAC || ' AND PAC.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO; END IF;
    IF pCAD_PLA_ID_PLANO IS NOT NULL THEN    V_WHERE_PAC := V_WHERE_PAC || ' AND PAC.CAD_PLA_ID_PLANO = ' || pCAD_PLA_ID_PLANO; END IF;
    IF pCAD_PLA_CD_TIPOPLANO IS NOT NULL THEN V_WHERE_PAC := V_WHERE_PAC || ' AND PLA.CAD_PLA_CD_TIPOPLANO = ' ||CHR(39)|| pCAD_PLA_CD_TIPOPLANO ||CHR(39);    END IF;
    IF pCAD_CGC_ID IS NOT NULL THEN V_WHERE_PAC := V_WHERE_PAC || ' AND CNV.CAD_CGC_ID = ' || pCAD_CGC_ID; END IF;

    V_WHERE_ATE := NULL;
    IF pTIS_TAT_CD_TPATENDIMENTO IS NOT NULL THEN V_WHERE_ATE := V_WHERE_ATE || ' AND ATD.TIS_TAT_CD_TPATENDIMENTO = ' ||CHR(39)|| pTIS_TAT_CD_TPATENDIMENTO ||CHR(39);    END IF;
    IF pATD_ATE_FL_INDIC_RN_OK IS NOT NULL THEN   V_WHERE_ATE := V_WHERE_ATE || ' AND ATD.ATD_ATE_FL_INDIC_RN_OK = ' ||CHR(39)|| pATD_ATE_FL_INDIC_RN_OK ||CHR(39);    END IF;
    IF pATD_ATE_FL_RETORNO_OK IS NOT NULL THEN    V_WHERE_ATE := V_WHERE_ATE || ' AND ATD.ATD_ATE_FL_RETORNO_OK = ' ||CHR(39)|| pATD_ATE_FL_RETORNO_OK ||CHR(39);    END IF;
    IF pATD_HR_INICIO IS NOT NULL THEN            V_WHERE_ATE := V_WHERE_ATE || ' AND atd.atd_ate_hr_atendimento >= ' || pATD_HR_INICIO ;    END IF;
    IF pATD_HR_FIM IS NOT NULL THEN               V_WHERE_ATE := V_WHERE_ATE || ' AND atd.atd_ate_hr_atendimento <= ' || pATD_HR_FIM ;    END IF;
    IF pCAD_PRO_ID_PROFISSIONAL IS NOT NULL THEN  V_WHERE_ATE := V_WHERE_ATE || ' AND atd.cad_pro_id_prof_exec = ' || pCAD_PRO_ID_PROFISSIONAL;  END IF;
    IF pTIS_CBO_CD_CBOS IS NOT NULL THEN           V_WHERE_ATE := V_WHERE_ATE || ' AND atd.TIS_CBO_CD_CBOS = ' ||CHR(39)|| pTIS_CBO_CD_CBOS ||CHR(39); END IF;



 V_SELECT :=
    '
   SELECT ATD.CAD_UNI_ID_UNIDADE ,   UNI.CAD_UNI_DS_UNIDADE,      ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO,
          LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
          CBO.TIS_CBO_DS_CBOS_HAC,
          PRO.CAD_PRO_ID_PROFISSIONAL,
          PRO.CAD_PRO_NR_CONSELHO,
          PES_PROF.CAD_PES_NM_PESSOA,
          NVL(CAPACIDADE_ATENDIMENTO.TOTAL_CAP,0) TOTAL_CAP,
          NVL(FALTAS_PAC.TOTAL_FALTA,0) TOTAL_FALTA,
          NVL(ATENDIDOS.TOTAL_ATEND,0) TOTAL_ATEND,
          NVL(AGENDADOS.TOTAL_AGEND,0) TOTAL_AGEND,
          NVL(ENCAIXE.TOTAL_ENCAIXE,0) TOTAL_ENCAIXE,
          NVL(CANCELADOS.Total_Canc,0) TOTAL_CANC,
          NVL(ROUND((Sum(FALTAS_PAC.TOTAL_FALTA) * 100) / (Sum(AGENDADOS.total_agend) + NVL(Sum(ENCAIXE.total_ENCAIXE),0)),2),0) ABSENTEISMO,
          NVL(HORARIOS_LIVRES.TOTAL_HORA,0) TOTAL_HORA
   FROM

   ( SELECT  ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS,
             ESM.CAD_PRO_ID_PROFISSIONAL, COUNT(AGG.AGE_AGG_HR_AGENDA ) TOTAL_CAP
     FROM TB_AGE_AGG_AGENDA_GERADA AGG,
          TB_AGE_ESM_ESCALA_MEDICA ESM
   WHERE AGG.AGE_AGG_DT_AGENDA BETWEEN ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'
     AND ESM.AGE_ESM_ID                   =    AGG.AGE_ESM_ID
     AND AGG.AGE_AGG_TP_HORARIO          !=    3
   AND esm.cad_uni_id_unidade           =  '|| PCAD_UNI_ID_UNIDADE || '
   AND esm.cad_lat_id_local_atendimento =  '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
       '|| V_WHERE_ESM ||'
       '|| V_WHERE_AGG ||'
--   and (esm.age_esm_dt_fim_escala is null OR (esm.age_esm_dt_fim_escala is not null and esm.age_esm_dt_fim_escala between ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'  ))
     GROUP BY ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS, ESM.CAD_PRO_ID_PROFISSIONAL
   ) CAPACIDADE_ATENDIMENTO,

   ( SELECT ESM.CAD_UNI_ID_UNIDADE , ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS,
            ESM.CAD_PRO_ID_PROFISSIONAL ,   COUNT(AGD.AGE_AGD_CD_INTAMB ) TOTAL_FALTA
     FROM TB_AGE_AGD_AGENDA        AGD,
          TB_AGE_ESM_ESCALA_MEDICA ESM,
          TB_CAD_PAC_PACIENTE      PAC,
          TB_CAD_CNV_CONVENIO      CNV,
          TB_CAD_PLA_PLANO         PLA
   WHERE AGD.AGE_AGD_DT_ATENDIMENTO BETWEEN ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'
   AND AGD.AGE_AGD_FL_STATUS            = ''F''
   AND ESM.AGE_ESM_ID                   =    AGD.AGE_ESM_ID
   AND PAC.CAD_PAC_ID_PACIENTE          =    AGD.CAD_PAC_ID_PACIENTE
   AND CNV.CAD_CNV_ID_CONVENIO          =    PAC.CAD_CNV_ID_CONVENIO
   AND PLA.CAD_PLA_ID_PLANO             =    PAC.CAD_PLA_ID_PLANO
   AND ESM.CAD_UNI_ID_UNIDADE           = '|| PCAD_UNI_ID_UNIDADE || '
   AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO =  '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
   '|| V_WHERE_ESM ||'
   '|| V_WHERE_PAC ||'
   '|| V_WHERE_AGD ||'
--   and (esm.age_esm_dt_fim_escala is null OR (esm.age_esm_dt_fim_escala is not null and esm.age_esm_dt_fim_escala between ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'  ))
   GROUP BY ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,ESM.TIS_CBO_CD_CBOS , ESM.CAD_PRO_ID_PROFISSIONAL

   ) FALTAS_PAC,
       (SELECT ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS,
               ESM.CAD_PRO_ID_PROFISSIONAL,  COUNT(AGD.AGE_AGD_CD_INTAMB ) TOTAL_AGEND
         FROM TB_AGE_AGD_AGENDA        AGD,
              TB_AGE_ESM_ESCALA_MEDICA ESM,
              TB_CAD_PAC_PACIENTE      PAC,
              TB_CAD_CNV_CONVENIO      CNV,
              TB_CAD_PLA_PLANO         PLA
          WHERE AGD.AGE_AGD_DT_ATENDIMENTO     BETWEEN ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'

         AND ESM.AGE_ESM_ID                   = AGD.AGE_ESM_ID
         AND PAC.CAD_PAC_ID_PACIENTE          = AGD.CAD_PAC_ID_PACIENTE
         AND CNV.CAD_CNV_ID_CONVENIO          = PAC.CAD_CNV_ID_CONVENIO
         AND PLA.CAD_PLA_ID_PLANO             = PAC.CAD_PLA_ID_PLANO
         AND (AGD.AGE_AGD_FL_STATUS          != ''C'')
         AND AGE_AGD_TP_AGENDA != 3
         AND ESM.CAD_UNI_ID_UNIDADE           =  '|| PCAD_UNI_ID_UNIDADE || '
         AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO =  '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
         '|| V_WHERE_ESM ||'
         '|| V_WHERE_PAC ||'
         '|| V_WHERE_AGD ||'
--         and (esm.age_esm_dt_fim_escala is null OR (esm.age_esm_dt_fim_escala is not null and esm.age_esm_dt_fim_escala between ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'  ))
         GROUP BY ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,ESM.TIS_CBO_CD_CBOS , ESM.CAD_PRO_ID_PROFISSIONAL

   ) AGENDADOS,
       (SELECT ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,  ESM.TIS_CBO_CD_CBOS,
               ESM.CAD_PRO_ID_PROFISSIONAL,  COUNT(AGD.AGE_AGD_CD_INTAMB ) TOTAL_ENCAIXE
         FROM TB_AGE_AGD_AGENDA        AGD,
              TB_AGE_ESM_ESCALA_MEDICA ESM,
              TB_CAD_PAC_PACIENTE      PAC,
              TB_CAD_CNV_CONVENIO      CNV,
              TB_CAD_PLA_PLANO         PLA
          WHERE AGD.AGE_AGD_DT_ATENDIMENTO     BETWEEN ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'
         AND ESM.AGE_ESM_ID                   = AGD.AGE_ESM_ID
         AND PAC.CAD_PAC_ID_PACIENTE          = AGD.CAD_PAC_ID_PACIENTE
         AND CNV.CAD_CNV_ID_CONVENIO          = PAC.CAD_CNV_ID_CONVENIO
         AND PLA.CAD_PLA_ID_PLANO             = PAC.CAD_PLA_ID_PLANO
         AND (AGD.AGE_AGD_FL_STATUS          != ''C'')
         AND AGE_AGD_TP_AGENDA = 3
         AND ESM.CAD_UNI_ID_UNIDADE           =  '|| PCAD_UNI_ID_UNIDADE || '
         AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO =  '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
         '|| V_WHERE_ESM ||'
         '|| V_WHERE_PAC ||'
         '|| V_WHERE_AGD ||'
--         and (esm.age_esm_dt_fim_escala is null OR (esm.age_esm_dt_fim_escala is not null and esm.age_esm_dt_fim_escala between ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'  ))
         GROUP BY ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,ESM.TIS_CBO_CD_CBOS , ESM.CAD_PRO_ID_PROFISSIONAL
   ) ENCAIXE,

   (SELECT ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS,
           ESM.CAD_PRO_ID_PROFISSIONAL,   COUNT(AGC.AGE_AGD_CD_INTAMB ) TOTAL_CANC
         FROM TB_AGE_AGC_AGENDA_CANCELADA AGC,
              TB_AGE_ESM_ESCALA_MEDICA    ESM,
              TB_CAD_PAC_PACIENTE         PAC,
              TB_CAD_CNV_CONVENIO         CNV,
              TB_CAD_PLA_PLANO            PLA
       WHERE AGC.AGE_AGD_DT_ATENDIMENTO     BETWEEN  ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'
         AND ESM.AGE_ESM_ID                   = AGC.AGE_ESM_ID
         AND PAC.CAD_PAC_ID_PACIENTE          = AGC.CAD_PAC_ID_PACIENTE
         AND CNV.CAD_CNV_ID_CONVENIO          = PAC.CAD_CNV_ID_CONVENIO
         AND PLA.CAD_PLA_ID_PLANO             = PAC.CAD_PLA_ID_PLANO
         AND ESM.CAD_UNI_ID_UNIDADE           =  '|| PCAD_UNI_ID_UNIDADE || '
         AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO =  '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
         '|| V_WHERE_ESM ||'
         '|| V_WHERE_PAC ||'
         '|| V_WHERE_AGC ||'
--         and (esm.age_esm_dt_fim_escala is null OR (esm.age_esm_dt_fim_escala is not null and esm.age_esm_dt_fim_escala between ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'  ))
         GROUP BY ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,ESM.TIS_CBO_CD_CBOS ,  ESM.CAD_PRO_ID_PROFISSIONAL

   ) CANCELADOS,
          ( SELECT  ATD.CAD_UNI_ID_UNIDADE,    ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO,   ATD.TIS_CBO_CD_CBOS,
                    ATD.CAD_PRO_ID_PROF_EXEC,  COUNT(ATD.ATD_ATE_ID ) TOTAL_ATEND
          FROM TB_ATD_ATE_ATENDIMENTO ATD,
               TB_ASS_PAT_PACIEATEND  PAT,
               TB_CAD_PAC_PACIENTE    PAC,
               TB_CAD_CNV_CONVENIO    CNV,
               TB_CAD_PLA_PLANO       PLA
       WHERE ATD.ATD_ATE_DT_ATENDIMENTO     BETWEEN  ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'
         AND ATD.ATD_ATE_FL_STATUS            = ''A''
         AND PAT.ATD_ATE_ID                   = ATD.ATD_ATE_ID
         AND PAC.CAD_PAC_ID_PACIENTE          = PAT.CAD_PAC_ID_PACIENTE
         AND CNV.CAD_CNV_ID_CONVENIO          = PAC.CAD_CNV_ID_CONVENIO
         AND PLA.CAD_PLA_ID_PLANO             = PAC.CAD_PLA_ID_PLANO
         AND ATD.CAD_UNI_ID_UNIDADE           =  '|| PCAD_UNI_ID_UNIDADE || '
         AND ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO =  '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
         '|| V_WHERE_ATe ||'
         '|| V_WHERE_PAC ||'

         AND ATD.TIS_TAT_CD_TPATENDIMENTO = 4
        -- AND NOT EXISTS (SELECT ATS.ATS_ATE_CD_INTLIB FROM TB_ATS_ATE_ATENDIMENTO_SADT ATS WHERE ATS.ATS_ATE_CD_INTLIB = ATD.ATD_ATE_ID)
         GROUP BY   ATD.CAD_UNI_ID_UNIDADE, ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO, ATD.TIS_CBO_CD_CBOS, ATD.CAD_PRO_ID_PROF_EXEC
   )  ATENDIDOS,

           ( SELECT ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO, ESM.TIS_CBO_CD_CBOS, ESM.CAD_PRO_ID_PROFISSIONAL,  COUNT(AGG.AGE_AGG_HR_AGENDA) TOTAL_HORA
             FROM TB_AGE_AGG_AGENDA_GERADA AGG,
                  TB_AGE_ESM_ESCALA_MEDICA ESM
           WHERE AGG.AGE_AGG_DT_AGENDA     BETWEEN  ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'
           AND AGG.AGE_AGG_FL_STATUS_HORARIO    in ( 1,4 )
           AND AGG.AGE_AGG_TP_HORARIO          !=    3
           AND ESM.AGE_ESM_ID                   = AGG.AGE_ESM_ID
           AND ESM.CAD_UNI_ID_UNIDADE           =  '|| PCAD_UNI_ID_UNIDADE || '
           AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO =  '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
           '|| V_WHERE_ESM ||'
          '|| V_WHERE_AGG ||'
--          and (esm.age_esm_dt_fim_escala is null OR (esm.age_esm_dt_fim_escala is not null and esm.age_esm_dt_fim_escala between ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'  ))
         GROUP BY ESM.CAD_UNI_ID_UNIDADE, ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,  ESM.TIS_CBO_CD_CBOS, ESM.CAD_PRO_ID_PROFISSIONAL

          ) HORARIOS_LIVRES,
        TB_ATD_ATE_ATENDIMENTO ATD,
        TB_CAD_UNI_UNIDADE UNI,
        TB_CAD_LAT_LOCAL_ATENDIMENTO LAT,
        TB_TIS_CBO_CBOS CBO,
        TB_CAD_PRO_PROFISSIONAL PRO,
        TB_CAD_PES_PESSOA PES_PROF,
        TB_ASS_PAT_PACIEATEND PAT,
        TB_CAD_PAC_PACIENTE PAC,
        TB_CAD_CNV_CONVENIO CNV,
        TB_CAD_PLA_PLANO PLA
  WHERE ATD.ATD_ATE_DT_ATENDIMENTO            BETWEEN  ' ||CHR(39)|| PATD_DT_INICIO ||CHR(39)||' AND ' ||CHR(39)|| PATD_DT_FIM ||CHR(39)||'
        AND UNI.CAD_UNI_ID_UNIDADE                        = ATD.CAD_UNI_ID_UNIDADE
        AND LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO              = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND CBO.TIS_CBO_CD_CBOS                           = ATD.TIS_CBO_CD_CBOS
        AND PRO.CAD_PRO_ID_PROFISSIONAL                   = ATD.CAD_PRO_ID_PROF_EXEC
        AND PES_PROF.CAD_PES_ID_PESSOA                    = PRO.CAD_PES_ID_PESSOA
        AND ATD.ATD_ATE_ID                                = PAT.ATD_ATE_ID
        AND PAC.CAD_PAC_ID_PACIENTE                       = PAT.CAD_PAC_ID_PACIENTE
        AND CNV.CAD_CNV_ID_CONVENIO                       = PAC.CAD_CNV_ID_CONVENIO
        AND PLA.CAD_PLA_ID_PLANO                          = PAC.CAD_PLA_ID_PLANO
     --   AND NOT EXISTS (SELECT ATS.ATS_ATE_CD_INTLIB FROM TB_ATS_ATE_ATENDIMENTO_SADT ATS WHERE ATS.ATS_ATE_CD_INTLIB = ATD.ATD_ATE_ID)
        AND CAPACIDADE_ATENDIMENTO.CAD_UNI_ID_UNIDADE (+) = ATD.CAD_UNI_ID_UNIDADE
        AND CAPACIDADE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO (+) = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND CAPACIDADE_ATENDIMENTO.TIS_CBO_CD_CBOS (+) =  ATD.TIS_CBO_CD_CBOS
        AND CAPACIDADE_ATENDIMENTO.CAD_PRO_ID_PROFISSIONAL (+) =   ATD.CAD_PRO_ID_PROF_EXEC
        AND FALTAS_PAC.CAD_UNI_ID_UNIDADE (+) = ATD.CAD_UNI_ID_UNIDADE
        AND FALTAS_PAC.CAD_LAT_ID_LOCAL_ATENDIMENTO (+) = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND FALTAS_PAC.TIS_CBO_CD_CBOS (+) = ATD.TIS_CBO_CD_CBOS
        AND FALTAS_PAC.CAD_PRO_ID_PROFISSIONAL (+) = ATD.CAD_PRO_ID_PROF_EXEC
        AND ATENDIDOS.CAD_UNI_ID_UNIDADE (+) = ATD.CAD_UNI_ID_UNIDADE
        AND ATENDIDOS.CAD_LAT_ID_LOCAL_ATENDIMENTO (+) = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND ATENDIDOS.TIS_CBO_CD_CBOS (+) = ATD.TIS_CBO_CD_CBOS
        AND ATENDIDOS.CAD_PRO_ID_PROF_EXEC (+) = ATD.CAD_PRO_ID_PROF_EXEC
        AND AGENDADOS.CAD_UNI_ID_UNIDADE (+) = ATD.CAD_UNI_ID_UNIDADE
        AND AGENDADOS.CAD_LAT_ID_LOCAL_ATENDIMENTO (+) = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND AGENDADOS.TIS_CBO_CD_CBOS (+) = ATD.TIS_CBO_CD_CBOS
        AND AGENDADOS.CAD_PRO_ID_PROFISSIONAL (+) = ATD.CAD_PRO_ID_PROF_EXEC

        AND ENCAIXE.CAD_UNI_ID_UNIDADE (+) = ATD.CAD_UNI_ID_UNIDADE
        AND ENCAIXE.CAD_LAT_ID_LOCAL_ATENDIMENTO (+) = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND ENCAIXE.TIS_CBO_CD_CBOS (+) = ATD.TIS_CBO_CD_CBOS
        AND ENCAIXE.CAD_PRO_ID_PROFISSIONAL (+) = ATD.CAD_PRO_ID_PROF_EXEC

        AND CANCELADOS.CAD_UNI_ID_UNIDADE (+) = ATD.CAD_UNI_ID_UNIDADE
        AND CANCELADOS.CAD_LAT_ID_LOCAL_ATENDIMENTO (+) = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND CANCELADOS.TIS_CBO_CD_CBOS (+) = ATD.TIS_CBO_CD_CBOS
        AND CANCELADOS.CAD_PRO_ID_PROFISSIONAL (+) = ATD.CAD_PRO_ID_PROF_EXEC
        AND HORARIOS_LIVRES.CAD_UNI_ID_UNIDADE (+) = ATD.CAD_UNI_ID_UNIDADE
        AND HORARIOS_LIVRES.CAD_LAT_ID_LOCAL_ATENDIMENTO(+) = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
        AND HORARIOS_LIVRES.TIS_CBO_CD_CBOS (+) = ATD.TIS_CBO_CD_CBOS
        AND HORARIOS_LIVRES.CAD_PRO_ID_PROFISSIONAL (+) = ATD.CAD_PRO_ID_PROF_EXEC

        AND UNI.CAD_UNI_ID_UNIDADE                        = '|| PCAD_UNI_ID_UNIDADE || '
        AND LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO              = '|| PCAD_LAT_ID_LOCAL_ATENDIMENTO  ||'
        '|| V_WHERE_ATe ||'
        '|| V_WHERE_PAC ||'

   GROUP BY ATD.CAD_UNI_ID_UNIDADE ,   UNI.CAD_UNI_DS_UNIDADE ,      ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO ,
          LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO ,
          CBO.TIS_CBO_DS_CBOS_HAC ,
          PRO.CAD_PRO_ID_PROFISSIONAL,
          PRO.CAD_PRO_NR_CONSELHO ,
          PES_PROF.CAD_PES_NM_PESSOA,

          NVL(CAPACIDADE_ATENDIMENTO.TOTAL_CAP,0) ,
          NVL(FALTAS_PAC.TOTAL_FALTA,0) ,
          NVL(ATENDIDOS.TOTAL_ATEND,0) ,
          NVL(AGENDADOS.TOTAL_AGEND,0) ,
          NVL(ENCAIXE.TOTAL_ENCAIXE,0) ,
          NVL(CANCELADOS.Total_Canc,0) ,
          NVL(HORARIOS_LIVRES.TOTAL_HORA,0)

   HAVING NVL(CAPACIDADE_ATENDIMENTO.TOTAL_CAP,0) > 0 OR   NVL(FALTAS_PAC.TOTAL_FALTA,0) > 0 OR  NVL(ATENDIDOS.TOTAL_ATEND,0) > 0 OR  NVL(AGENDADOS.TOTAL_AGEND,0) > 0 OR  NVL(ENCAIXE.TOTAL_ENCAIXE,0) > 0 OR  NVL(CANCELADOS.Total_Canc,0) > 0 OR  NVL(HORARIOS_LIVRES.TOTAL_HORA,0) > 0';
    -- TESTE :=  V_SELECT ;
  OPEN v_cursor FOR
      -- SELECT 1 FROM DUAL;
      V_SELECT ;
    io_cursor := v_cursor;
end PRC_ATE_REL_ATEND_ESTAT_SINT;
