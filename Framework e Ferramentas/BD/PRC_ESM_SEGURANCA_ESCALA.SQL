CREATE OR REPLACE PROCEDURE PRC_ESM_SEGURANCA_ESCALA
(
       pCAD_UNI_ID_UNIDADE IN TB_AGE_ESM_ESCALA_MEDICA.CAD_UNI_ID_UNIDADE%TYPE,
       pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_AGE_ESM_ESCALA_MEDICA.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE,
       pTIS_CBO_CD_CBOS IN TB_AGE_ESM_ESCALA_MEDICA.TIS_CBO_CD_CBOS%TYPE,
       pCAD_PRO_ID_PROFISSIONAL IN TB_AGE_ESM_ESCALA_MEDICA.CAD_PRO_ID_PROFISSIONAL%TYPE, 
       pAGE_ESM_NR_DIA_SEMANA IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_NR_DIA_SEMANA%TYPE,
       pAGE_ESM_DT_INI_ESCALA IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_DT_INI_ESCALA%TYPE, 
       pAGE_ESM_DT_FIM_ESCALA IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_DT_FIM_ESCALA%TYPE DEFAULT NULL,
       pAGE_ESM_HR_INI_ESCALA IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_HR_INI_ESCALA%TYPE,
       pAGE_ESM_HR_FIM_ESCALA IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_HR_FIM_ESCALA%TYPE,
       pAGE_ESM_ID IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_ID%TYPE default null,
       pAGE_ESM_QT_DIAS_INTERVALO IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_QT_DIAS_INTERVALO%TYPE,
       io_cursor OUT PKG_CURSOR.t_cursor
)
IS
/********************************************************************
  *    Procedure: PRC_ESM_SEGURANCA_ESCALA
  *
  *    Data Criacao:  26/02/2008   Por: Bruno
  *    Data Alteracao: 04/04/2008   Por: Silmara
  *    Data Alteacao:  06/11/2008   Por:Silmara
  *    Data Alteracao: 06/01/2009	Por:Silmara
  *    Alteracao: busca da hora inicial e final da escala ja existente
  *    Alterac?o: Parametro data fim de vigencia.
  *    Alterac?o: Incluido =  na comparac?o com data fim vigencia.
  *
  *    Data Alteracao: 24/06/2009              Por: Pedro
  *    Alteracao: Verificar se existe escala no mesmo data inicial/data final/dia da semana/hora/profissional
  * 
  ********************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin  
  if pAGE_ESM_QT_DIAS_INTERVALO = 7
  THEN
    OPEN v_cursor FOR    
 SELECT 
    ESM.AGE_ESM_ID,
    ESM.AGE_SAU_ID,
    ESM.AGE_ESM_DT_INI_ESCALA,
    ESM.AGE_ESM_HR_INI_ESCALA,
    ESM.AGE_ESM_DT_FIM_ESCALA,
    ESM.AGE_ESM_HR_FIM_ESCALA,
    ESM.AGE_ESM_NR_DIA_SEMANA,
    ESM.AGE_ESM_FL_SITUACAO,
    ESM.AGE_ESM_QT_DIAS_CRIACAO,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_ENCAIXE,
    ESM.AGE_ESM_FL_PERM_ENCAIXE_ESP,
    ESM.AGE_ESM_FL_PERM_RETORNO,    
    ESM.AGE_ESM_DT_CRIACAO_ESCALA,
    ESM.AGE_ESM_QT_ENCAIXE,
    ESM.AGE_ESM_QT_ENCAIXE_PHORA,
    ESM.AGE_ESM_QT_ENCAIXE_ESP,
    ESM.AGE_ESM_QT_ENCAIXE_ESP_PHORA,
    ESM.AGE_ESM_DS_OBS,
    ESM.SEG_USU_ID_USUARIO,
    ESM.AGE_ESM_DT_ULTIMA_ATUALIZACAO,
    ESM.AGE_ESM_FL_TRANSF,
    ESM.TIS_CBO_CD_CBOS,
    ESM.CAD_PRO_ID_PROFISSIONAL,
    ESM.CAD_UNI_ID_UNIDADE,
    ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
    ESM.AGE_PEE_ID,
    ESM.AGE_ESM_QT_DIAS_INTERVALO,
    ESM.AGE_ESM_QT_RET_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_AGENDA_SP,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA_SP,
    ESM.AGE_ESM_FL_AGENDAGERADA_OK
FROM TB_AGE_ESM_ESCALA_MEDICA ESM  
WHERE
    ESM.AGE_ESM_FL_SITUACAO IN ('A', 'S')
    AND ESM.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL    
    AND ESM.AGE_ESM_NR_DIA_SEMANA = pAGE_ESM_NR_DIA_SEMANA    
    AND (pAGE_ESM_ID IS NULL OR ESM.AGE_ESM_ID != pAGE_ESM_ID)
    AND (
          ((pAGE_ESM_HR_INI_ESCALA+1) between ESM.AGE_ESM_HR_INI_ESCALA and ESM.AGE_ESM_HR_FIM_ESCALA
            OR (pAGE_ESM_HR_FIM_ESCALA-1)  between ESM.AGE_ESM_HR_INI_ESCALA AND ESM.AGE_ESM_HR_FIM_ESCALA )
        OR
          (ESM.AGE_ESM_HR_INI_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1)
           OR ESM.AGE_ESM_HR_FIM_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1) )
        )
    AND pAGE_ESM_DT_INI_ESCALA >= ESM.AGE_ESM_DT_INI_ESCALA 
    AND (ESM.AGE_ESM_DT_FIM_ESCALA IS NULL OR pAGE_ESM_DT_INI_ESCALA <= ESM.AGE_ESM_DT_FIM_ESCALA)    
    AND pAGE_ESM_DT_INI_ESCALA >= TRUNC(SYSDATE)
UNION
 SELECT 
    ESM.AGE_ESM_ID,
    ESM.AGE_SAU_ID,
    ESM.AGE_ESM_DT_INI_ESCALA,
    ESM.AGE_ESM_HR_INI_ESCALA,
    ESM.AGE_ESM_DT_FIM_ESCALA,
    ESM.AGE_ESM_HR_FIM_ESCALA,
    ESM.AGE_ESM_NR_DIA_SEMANA,
    ESM.AGE_ESM_FL_SITUACAO,
    ESM.AGE_ESM_QT_DIAS_CRIACAO,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_ENCAIXE,
    ESM.AGE_ESM_FL_PERM_ENCAIXE_ESP,
    ESM.AGE_ESM_FL_PERM_RETORNO,    
    ESM.AGE_ESM_DT_CRIACAO_ESCALA,
    ESM.AGE_ESM_QT_ENCAIXE,
    ESM.AGE_ESM_QT_ENCAIXE_PHORA,
    ESM.AGE_ESM_QT_ENCAIXE_ESP,
    ESM.AGE_ESM_QT_ENCAIXE_ESP_PHORA,
    ESM.AGE_ESM_DS_OBS,
    ESM.SEG_USU_ID_USUARIO,
    ESM.AGE_ESM_DT_ULTIMA_ATUALIZACAO,
    ESM.AGE_ESM_FL_TRANSF,
    ESM.TIS_CBO_CD_CBOS,
    ESM.CAD_PRO_ID_PROFISSIONAL,
    ESM.CAD_UNI_ID_UNIDADE,
    ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
    ESM.AGE_PEE_ID,
    ESM.AGE_ESM_QT_DIAS_INTERVALO,
    ESM.AGE_ESM_QT_RET_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_AGENDA_SP,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA_SP,
    ESM.AGE_ESM_FL_AGENDAGERADA_OK
       FROM TB_AGE_ESM_ESCALA_MEDICA ESM  
WHERE
    ESM.AGE_ESM_FL_SITUACAO IN ('A', 'S')
    AND ESM.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL  
    AND ESM.AGE_ESM_NR_DIA_SEMANA = pAGE_ESM_NR_DIA_SEMANA    
    AND (pAGE_ESM_ID IS NULL OR ESM.AGE_ESM_ID != pAGE_ESM_ID)
    AND (
          ((pAGE_ESM_HR_INI_ESCALA+1) between ESM.AGE_ESM_HR_INI_ESCALA and ESM.AGE_ESM_HR_FIM_ESCALA
            OR (pAGE_ESM_HR_FIM_ESCALA-1)  between ESM.AGE_ESM_HR_INI_ESCALA AND ESM.AGE_ESM_HR_FIM_ESCALA )
        OR
          (ESM.AGE_ESM_HR_INI_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1)
           OR ESM.AGE_ESM_HR_FIM_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1) )
        )
        
    AND (ESM.AGE_ESM_DT_FIM_ESCALA IS NULL OR pAGE_ESM_DT_FIM_ESCALA BETWEEN ESM.AGE_ESM_DT_INI_ESCALA AND ESM.AGE_ESM_DT_FIM_ESCALA)   
    AND ((pAGE_ESM_DT_FIM_ESCALA IS NULL) OR NULL >= TRUNC(SYSDATE))  
      ;
io_cursor := v_cursor;
ELSE 
 OPEN v_cursor FOR
SELECT --no caso de escalas intercaladas a query antiga
    ESM.AGE_ESM_ID,
    ESM.AGE_SAU_ID,
    ESM.AGE_ESM_DT_INI_ESCALA,
    ESM.AGE_ESM_HR_INI_ESCALA,
    ESM.AGE_ESM_DT_FIM_ESCALA,
    ESM.AGE_ESM_HR_FIM_ESCALA,
    ESM.AGE_ESM_NR_DIA_SEMANA,
    ESM.AGE_ESM_FL_SITUACAO,
    ESM.AGE_ESM_QT_DIAS_CRIACAO,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_ENCAIXE,
    ESM.AGE_ESM_FL_PERM_ENCAIXE_ESP,
    ESM.AGE_ESM_FL_PERM_RETORNO,    
    ESM.AGE_ESM_DT_CRIACAO_ESCALA,
    ESM.AGE_ESM_QT_ENCAIXE,
    ESM.AGE_ESM_QT_ENCAIXE_PHORA,
    ESM.AGE_ESM_QT_ENCAIXE_ESP,
    ESM.AGE_ESM_QT_ENCAIXE_ESP_PHORA,
    ESM.AGE_ESM_DS_OBS,
    ESM.SEG_USU_ID_USUARIO,
    ESM.AGE_ESM_DT_ULTIMA_ATUALIZACAO,
    ESM.AGE_ESM_FL_TRANSF,
    ESM.TIS_CBO_CD_CBOS,
    ESM.CAD_PRO_ID_PROFISSIONAL,
    ESM.CAD_UNI_ID_UNIDADE,
    ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
    ESM.AGE_PEE_ID,
    ESM.AGE_ESM_QT_DIAS_INTERVALO,
    ESM.AGE_ESM_QT_RET_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_AGENDA_SP,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA_SP,
    ESM.AGE_ESM_FL_AGENDAGERADA_OK
    FROM TB_AGE_ESM_ESCALA_MEDICA ESM
    WHERE AGE_ESM_FL_SITUACAO = 'A'
    AND ESM.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
    AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO
    AND ESM.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS
    AND ESM.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL
    AND ESM.AGE_ESM_NR_DIA_SEMANA = pAGE_ESM_NR_DIA_SEMANA
    AND ((pAGE_ESM_DT_INI_ESCALA = AGE_ESM_DT_FIM_ESCALA
    AND AGE_ESM_DT_FIM_ESCALA >= TRUNC(SYSDATE))
    OR (AGE_ESM_DT_FIM_ESCALA IS NULL
    AND pAGE_ESM_DT_INI_ESCALA >= TRUNC(SYSDATE)))
   AND ((pAGE_ESM_HR_INI_ESCALA+1) between age_esm_hr_ini_escala and age_esm_hr_fim_escala
   OR (pAGE_ESM_HR_FIM_ESCALA-1)  between age_esm_hr_ini_escala and age_esm_hr_fim_escala)
   AND (pAGE_ESM_DT_FIM_ESCALA >= age_esm_dt_ini_escala OR pAGE_ESM_DT_FIM_ESCALA IS NULL)    

UNION

SELECT 
    ESM.AGE_ESM_ID,
    ESM.AGE_SAU_ID,
    ESM.AGE_ESM_DT_INI_ESCALA,
    ESM.AGE_ESM_HR_INI_ESCALA,
    ESM.AGE_ESM_DT_FIM_ESCALA,
    ESM.AGE_ESM_HR_FIM_ESCALA,
    ESM.AGE_ESM_NR_DIA_SEMANA,
    ESM.AGE_ESM_FL_SITUACAO,
    ESM.AGE_ESM_QT_DIAS_CRIACAO,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_ENCAIXE,
    ESM.AGE_ESM_FL_PERM_ENCAIXE_ESP,
    ESM.AGE_ESM_FL_PERM_RETORNO,    
    ESM.AGE_ESM_DT_CRIACAO_ESCALA,
    ESM.AGE_ESM_QT_ENCAIXE,
    ESM.AGE_ESM_QT_ENCAIXE_PHORA,
    ESM.AGE_ESM_QT_ENCAIXE_ESP,
    ESM.AGE_ESM_QT_ENCAIXE_ESP_PHORA,
    ESM.AGE_ESM_DS_OBS,
    ESM.SEG_USU_ID_USUARIO,
    ESM.AGE_ESM_DT_ULTIMA_ATUALIZACAO,
    ESM.AGE_ESM_FL_TRANSF,
    ESM.TIS_CBO_CD_CBOS,
    ESM.CAD_PRO_ID_PROFISSIONAL,
    ESM.CAD_UNI_ID_UNIDADE,
    ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
    ESM.AGE_PEE_ID,
    ESM.AGE_ESM_QT_DIAS_INTERVALO,
    ESM.AGE_ESM_QT_RET_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_AGENDA_SP,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA_SP,
    ESM.AGE_ESM_FL_AGENDAGERADA_OK
       FROM TB_AGE_ESM_ESCALA_MEDICA ESM  
WHERE
    ESM.AGE_ESM_FL_SITUACAO IN ('A', 'S')
    AND ESM.AGE_ESM_QT_DIAS_INTERVALO = 7
    AND ESM.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL    
    AND ESM.AGE_ESM_NR_DIA_SEMANA = pAGE_ESM_NR_DIA_SEMANA    
    AND (pAGE_ESM_ID IS NULL OR ESM.AGE_ESM_ID != pAGE_ESM_ID)
        AND (
          ((pAGE_ESM_HR_INI_ESCALA+1) between ESM.AGE_ESM_HR_INI_ESCALA and ESM.AGE_ESM_HR_FIM_ESCALA
            OR (pAGE_ESM_HR_FIM_ESCALA-1)  between ESM.AGE_ESM_HR_INI_ESCALA AND ESM.AGE_ESM_HR_FIM_ESCALA )
        OR
          (ESM.AGE_ESM_HR_INI_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1)
           OR ESM.AGE_ESM_HR_FIM_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1) )
        )
    AND pAGE_ESM_DT_INI_ESCALA >= ESM.AGE_ESM_DT_INI_ESCALA 
    AND (ESM.AGE_ESM_DT_FIM_ESCALA IS NULL OR pAGE_ESM_DT_INI_ESCALA <= ESM.AGE_ESM_DT_FIM_ESCALA)    
    AND pAGE_ESM_DT_INI_ESCALA >= TRUNC(SYSDATE)
UNION
 SELECT 
    ESM.AGE_ESM_ID,
    ESM.AGE_SAU_ID,
    ESM.AGE_ESM_DT_INI_ESCALA,
    ESM.AGE_ESM_HR_INI_ESCALA,
    ESM.AGE_ESM_DT_FIM_ESCALA,
    ESM.AGE_ESM_HR_FIM_ESCALA,
    ESM.AGE_ESM_NR_DIA_SEMANA,
    ESM.AGE_ESM_FL_SITUACAO,
    ESM.AGE_ESM_QT_DIAS_CRIACAO,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_ENCAIXE,
    ESM.AGE_ESM_FL_PERM_ENCAIXE_ESP,
    ESM.AGE_ESM_FL_PERM_RETORNO,    
    ESM.AGE_ESM_DT_CRIACAO_ESCALA,
    ESM.AGE_ESM_QT_ENCAIXE,
    ESM.AGE_ESM_QT_ENCAIXE_PHORA,
    ESM.AGE_ESM_QT_ENCAIXE_ESP,
    ESM.AGE_ESM_QT_ENCAIXE_ESP_PHORA,
    ESM.AGE_ESM_DS_OBS,
    ESM.SEG_USU_ID_USUARIO,
    ESM.AGE_ESM_DT_ULTIMA_ATUALIZACAO,
    ESM.AGE_ESM_FL_TRANSF,
    ESM.TIS_CBO_CD_CBOS,
    ESM.CAD_PRO_ID_PROFISSIONAL,
    ESM.CAD_UNI_ID_UNIDADE,
    ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
    ESM.AGE_PEE_ID,
    ESM.AGE_ESM_QT_DIAS_INTERVALO,
    ESM.AGE_ESM_QT_RET_PERM_PHORA,
    ESM.AGE_ESM_FL_PERM_AGENDA_SP,
    ESM.AGE_ESM_QT_AGE_PERM_PHORA_SP,
    ESM.AGE_ESM_FL_AGENDAGERADA_OK
FROM TB_AGE_ESM_ESCALA_MEDICA ESM  
WHERE
    ESM.AGE_ESM_FL_SITUACAO IN ('A', 'S')
    AND ESM.AGE_ESM_QT_DIAS_INTERVALO = 7
    AND ESM.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL  
    AND ESM.AGE_ESM_NR_DIA_SEMANA = pAGE_ESM_NR_DIA_SEMANA    
    AND (pAGE_ESM_ID IS NULL OR ESM.AGE_ESM_ID != pAGE_ESM_ID)
    AND (
          ((pAGE_ESM_HR_INI_ESCALA+1) between ESM.AGE_ESM_HR_INI_ESCALA and ESM.AGE_ESM_HR_FIM_ESCALA
            OR (pAGE_ESM_HR_FIM_ESCALA-1)  between ESM.AGE_ESM_HR_INI_ESCALA AND ESM.AGE_ESM_HR_FIM_ESCALA )
        OR
          (ESM.AGE_ESM_HR_INI_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1)
           OR ESM.AGE_ESM_HR_FIM_ESCALA BETWEEN (pAGE_ESM_HR_INI_ESCALA+1) AND  (pAGE_ESM_HR_FIM_ESCALA-1) )
        )
    
    AND (ESM.AGE_ESM_DT_FIM_ESCALA IS NULL OR pAGE_ESM_DT_FIM_ESCALA BETWEEN ESM.AGE_ESM_DT_INI_ESCALA AND ESM.AGE_ESM_DT_FIM_ESCALA)
    AND ((pAGE_ESM_DT_FIM_ESCALA IS NULL) OR null >= TRUNC(SYSDATE))     
 ;
    io_cursor := v_cursor;
    end if;
    END PRC_ESM_SEGURANCA_ESCALA;
 