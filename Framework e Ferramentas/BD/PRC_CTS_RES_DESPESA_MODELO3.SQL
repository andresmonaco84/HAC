CREATE OR REPLACE PROCEDURE "PRC_CTS_RES_RECEITA_MODELO3"
--receita_janeiro_modelo3_cc_proced_recindireta
(
    P_MESFAT  IN TB_FAT_UCA_UNID_CONV_ACU_RESU.FAT_UCA_NR_MES_FAT%TYPE,
    P_ANOFAT  IN TB_FAT_UCA_UNID_CONV_ACU_RESU.FAT_UCA_NR_ANO_FAT%TYPE,
    P_USUARIO IN TB_CTS_MOV_MOVIMENTACAO_RM.SEG_USU_ID_INCLUSAO%TYPE
)
IS
/********************************************************************
*
*    PROCEDURE: PRC_CTS_RES_RECEITA_MODELO3
*    DATA:13/08/2013          POR: Neide
*
* externinho ( ATD_ATE_TP_PACIENTE = E ) quando tem diaria TROCAR PARA ATD_ATE_TP_PACIENTE = I somente o atributo DIARIA  
*
*********************************************************************/
BEGIN
DECLARE
-----
-----
----- RECEITA COM % DE CALCULO USANDO CCUSTO DO PROCEDIMENTO
-----
 AUX_VL_RECEITA               TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_VL_RECEITA_DIRETA%TYPE;
 PARA_AUX_VL_RECEITA          TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_VL_RECEITA_DIRETA%TYPE;
 PARA_AUX_VL_DESPESA          TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_VL_RECEITA_DIRETA%TYPE;
 PERCENT_RECEITA              TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_PC_RECEITA_DIRETA%TYPE;
 --AUX_VL_DESPESA_TOTAL         TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_VL_DESPESA_TOTAL%TYPE;
 --AUX_VL_DESPESA_DIRETA        TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_VL_DESPESA_DIRETA%TYPE;
 --AUX_VL_DESPESA_INDIRETA      TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_VL_DESPESA_INDIRETA%TYPE;
 --AUX_VL_DESPESA_INTERMEDIARIA TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_VL_DESPESA_INTERMEDIAR%TYPE;
--------
BEGIN
---------
--
--
--
---------------------------------------------------------
---------------------------------------------------------
--
--
--
--
DECLARE
CURSOR ATU IS
SELECT
UCA.CAD_CEC_ID_CCUSTO ,
CEC.CAD_CEC_CD_CCUSTO,
UCA.CAD_CEC_ID_CCUSTO_RECEITA ,
CEC_RECEITA.CAD_CEC_CD_CCUSTO   CAD_CEC_CD_CCUSTO_RECEITA ,
UCA.FAT_UCA_NR_MES_FAT   CTS_RES_MES,
UCA.FAT_UCA_NR_ANO_FAT   CTS_RES_ANO ,
DECODE(UCA.CAD_UNI_ID_UNIDADE , 248, 244 , UCA.CAD_UNI_ID_UNIDADE ) CAD_UNI_ID_UNIDADE,
 0        CAD_UNI_ID_UNIDADE_ORIGEM,
 NULL   CAD_LAT_ID_LOCAL_ATENDIMENTO ,   ------ UCA.CAD_LAT_ID_LOCAL_ATENDIMENTO,
DECODE ( PLC.CAD_TAP_TP_ATRIBUTO , 'DIA' , 'I' ,   UCA.ATD_ATE_TP_PACIENTE )    ATD_ATE_TP_PACIENTE ,
---- UCA.ATD_ATE_TP_PACIENTE,
UCA.CAD_CTS_PLC_ID,
SUM(UCA.FAT_UCA_VL_FATURADO ) VL_FATURADO ,
PLC.CAD_TAP_TP_ATRIBUTO,
1  TIPO_RELATORIO_DETALHADO,
DECODE ( PLC.CAD_TAP_TP_ATRIBUTO , 'DIA' , UCA.CAD_CTS_PLC_ID ,
                    DECODE(  UCA.ATD_ATE_TP_PACIENTE  , 'A'  , 219 ,
                                                        'E'  , 220 ,
                                                        'U'  , 221  ) ) CAD_CTS_PLC_ID_RESUMO
---
FROM TB_FAT_UCA_UNID_CONV_ACU_RESU UCA,
     TB_CAD_CEC_CENTRO_CUSTO CEC,
     TB_CAD_CEC_CENTRO_CUSTO CEC_RECEITA,
     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
WHERE UCA.FAT_UCA_NR_MES_FAT  = P_MESFAT
AND UCA.FAT_UCA_NR_ANO_FAT    = P_ANOFAT     and nvl(UCA.FAT_UCA_VL_FATURADO,0 )  > 0
AND UCA.CAD_PLA_CD_TIPOPLANO NOT IN ( 'FU', 'NP' )
AND UCA.CAD_CEC_ID_CCUSTO = CEC.CAD_CEC_ID_CCUSTO
AND UCA.CAD_CEC_ID_CCUSTO_RECEITA = CEC_RECEITA.CAD_CEC_ID_CCUSTO
AND UCA.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
GROUP BY
   UCA.CAD_CEC_ID_CCUSTO ,
   CEC.CAD_CEC_CD_CCUSTO,
   UCA.FAT_UCA_NR_MES_FAT ,
   UCA.FAT_UCA_NR_ANO_FAT ,
   DECODE(UCA.CAD_UNI_ID_UNIDADE , 248, 244 , UCA.CAD_UNI_ID_UNIDADE ),
    0 ,
   NULL , ----UCA.CAD_LAT_ID_LOCAL_ATENDIMENTO,
   DECODE ( PLC.CAD_TAP_TP_ATRIBUTO , 'DIA' , 'I' ,   UCA.ATD_ATE_TP_PACIENTE )  , 
   ----UCA.ATD_ATE_TP_PACIENTE,
   UCA.CAD_CTS_PLC_ID ,
   UCA.CAD_CEC_ID_CCUSTO_RECEITA ,
   CEC_RECEITA.CAD_CEC_CD_CCUSTO, PLC.CAD_TAP_TP_ATRIBUTO ,
   DECODE ( PLC.CAD_TAP_TP_ATRIBUTO , 'DIA' , UCA.CAD_CTS_PLC_ID ,
                    DECODE(  UCA.ATD_ATE_TP_PACIENTE  , 'A'  , 219 ,
                                                        'E'  , 220 ,
                                                        'U'  , 221  ) ) ;
-----
-----
-----
-----
BEGIN
---
DELETE FROM TB_CTS_RES_RESULTADO_CUSTOS RES
WHERE RES.CTS_RES_MES = P_MESFAT
AND RES.CTS_RES_ANO = P_ANOFAT
AND CAD_CTS_PLC_ID NOT IN ( 1, 2 ) ;
--
COMMIT;
--
--
FOR A IN ATU LOOP
INSERT INTO TB_CTS_RES_RESULTADO_CUSTOS RES
(CTS_RES_ID        ,
CAD_CEC_ID_CCUSTO_RECEITA  ,
CAD_CEC_CD_CCUSTO_RECEITA  ,
CAD_CEC_ID_CC_PROCEDIMENTO  ,
CAD_CEC_CD_CC_PROCEDIMENTO  ,
CTS_RES_MES        ,
CTS_RES_ANO        ,
CAD_UNI_ID_UNIDADE ,
CAD_LAT_ID_LOCAL_ATENDIMENTO,
ATD_ATE_TP_PACIENTE         ,
CTS_RES_VL_RECEITA_DIRETA   ,
CTS_RES_VL_RECEITA_INDIRETA ,
CTS_RES_VL_RECEITA_INTERMEDIAR,
SEG_USU_ID_INCLUSAO           ,
CTS_RES_DT_INCLUSAO           ,
SEG_USU_ID_ALTERACAO          ,
CTS_RES_DT_ALTERACAO          ,
CTS_RES_PC_RECEITA_DIRETA     ,
CTS_RES_PC_RECEITA_TOTAL      ,
CTS_RES_VL_RECEITA_TOTAL,
CAD_UNI_ID_UNIDADE_ORIGEM ,
CAD_CTS_PLC_ID ,
CAD_TAP_TP_ATRIBUTO,
CAD_CTS_PLC_ID_RESUMO )
VALUES
(SEQ_CTS_RES_01.NEXTVAL    ,
-----
A.CAD_CEC_ID_CCUSTO_RECEITA  ,
A.CAD_CEC_CD_CCUSTO_RECEITA  ,
---
A.CAD_CEC_ID_CCUSTO  ,
A.CAD_CEC_CD_CCUSTO  ,
A.CTS_RES_MES        ,
A.CTS_RES_ANO        ,
A.CAD_UNI_ID_UNIDADE ,
A.CAD_LAT_ID_LOCAL_ATENDIMENTO,
A.ATD_ATE_TP_PACIENTE         ,
A.VL_FATURADO    ,  --- VL RECEITA DIRETA
0                ,  --- VL_RECEITA_INDIRETA
0                ,  --- VL_RECEITA_INTERMEDIARIA
P_USUARIO            ,
SYSDATE          ,
P_USUARIO            ,
SYSDATE         ,
0                ,  ---  PC_RECEITA_DIRETA
0                         ,
0 ,
A.CAD_UNI_ID_UNIDADE_ORIGEM,
A.CAD_CTS_PLC_ID ,
A.CAD_TAP_TP_ATRIBUTO,
A.CAD_CTS_PLC_ID_RESUMO );
END LOOP;
COMMIT;
-----
END;  ------ FIM DO INSERT DA RECEITA
----
----
--*****************************************************************************
--*
--*     INICIO PARA CALCULO DO % DA RECEITA TOTAL
--*
--*****************************************************************************
---
BEGIN
--- SOMA RECEITA TOTAL
SELECT  SUM(RES.CTS_RES_VL_RECEITA_DIRETA)  INTO  AUX_VL_RECEITA
FROM TB_CTS_RES_RESULTADO_CUSTOS RES
WHERE RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO = P_ANOFAT;
---
--- CALCULA % SOBRE RECEITA TOTAL
UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
SET RES.CTS_RES_PC_RECEITA_TOTAL =  TO_NUMBER( TO_CHAR( ( (RES.CTS_RES_VL_RECEITA_DIRETA * 100) / AUX_VL_RECEITA) , '999.999999' ))
WHERE RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO = P_ANOFAT;
---
--- VERIFICA SE DEU 100%
SELECT ( 100 - SUM(RES.CTS_RES_PC_RECEITA_TOTAL)) * -1  INTO  PERCENT_RECEITA
FROM TB_CTS_RES_RESULTADO_CUSTOS RES
WHERE RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO = P_ANOFAT;
---
--- AJUSTA PARA 100%
IF  PERCENT_RECEITA <> 0 THEN
  UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
  SET RES.CTS_RES_PC_RECEITA_TOTAL =  RES.CTS_RES_PC_RECEITA_TOTAL -  PERCENT_RECEITA
  WHERE  RES.CTS_RES_ID = ( SELECT RESM.CTS_RES_ID
                            FROM TB_CTS_RES_RESULTADO_CUSTOS RESM
                            WHERE RESM.CTS_RES_MES = P_MESFAT
                              AND RESM.CTS_RES_ANO = P_ANOFAT
                              AND ROWNUM = 1
                              AND RESM.CTS_RES_PC_RECEITA_TOTAL = (  SELECT MAX(CTS_RES_PC_RECEITA_TOTAL)
                                                                       FROM TB_CTS_RES_RESULTADO_CUSTOS MAIOR
                                                                       WHERE  MAIOR.CTS_RES_MES = P_MESFAT
                                                                         AND MAIOR.CTS_RES_ANO = P_ANOFAT )  ) ;
END IF;
--
COMMIT;
--
--
END;
---- FIM DO CALCULO DA % DA RECEITA TOTAL
--
--*****************************************************************************
--*
--* INICIO DA DISTRIBUICAO DA RECEITA INDIRETA QUE VEIO DO RM
--*
--* REUNIAO 24/04/2013
--* QUANDO SALDO DA CONTAS FOR MAIOR QUE ZERO DISTRIBUIR PARA RECEITA INDIRETA
--* QUANDO SALDO FOR NEGATIVO DISTRIBUIR PARA DESPESA INDIRETA
--*
--******************************************************************************
--
BEGIN
SELECT  (  SUM(MV.CTS_MOV_RM_VL_SALDO)  )  INTO PARA_AUX_VL_RECEITA
FROM TB_CTS_MOV_MOVIMENTACAO_RM MV,
     TB_CAD_CCR_CCONTA_RM CCR
WHERE MV.CTS_MOV_RM_MES = P_MESFAT
AND MV.CTS_MOV_RM_ANO   = P_ANOFAT
AND MV.CAD_CCR_ID = CCR.CAD_CCR_ID
AND CCR.CAD_CCR_CD_COLIGADA = 1
AND CCR.CAD_CCR_ID NOT IN ( 6,7,8 ) ---- NAO PODE INTERFACE DO SGS PARA RM
AND CCR.CAD_CCR_CD_CONTA LIKE '3%'
AND MV.CTS_MOV_RM_VL_SALDO > 0;
--
--
SELECT  (  SUM(MV.CTS_MOV_RM_VL_SALDO) * -1  )  INTO PARA_AUX_VL_DESPESA
FROM TB_CTS_MOV_MOVIMENTACAO_RM MV,
     TB_CAD_CCR_CCONTA_RM CCR
WHERE MV.CTS_MOV_RM_MES = P_MESFAT
AND MV.CTS_MOV_RM_ANO   = P_ANOFAT
AND MV.CAD_CCR_ID = CCR.CAD_CCR_ID
AND CCR.CAD_CCR_CD_COLIGADA = 1
AND CCR.CAD_CCR_ID NOT IN ( 6,7,8 ) ---- NAO PODE INTERFACE DO SGS PARA RM
AND CCR.CAD_CCR_CD_CONTA LIKE '3%'
AND MV.CTS_MOV_RM_VL_SALDO < 0;
--
-- QUANDO POSITIVO COLOCAR NA RECEITA
UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
SET CTS_RES_VL_RECEITA_INDIRETA = (PARA_AUX_VL_RECEITA * RES.CTS_RES_PC_RECEITA_TOTAL) / 100
WHERE  RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO = P_ANOFAT;
--
-- QUANDO NEGATIVO COLOCAR NA DESPESA
UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
SET CTS_RES_VL_DESPESA_INDIRETA = (PARA_AUX_VL_DESPESA * RES.CTS_RES_PC_RECEITA_TOTAL) / 100
WHERE  RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO  = P_ANOFAT;
--
--
COMMIT;
END;
---
--- FIM DA DISTRIBUICAO DA RECEITA INDIRETA QUE VEIO DA RM
---
--******************************************************************************
--
--*****************************************************************************
--*
--*  INICIO DO % DO GRUPO DA RECEITA
--*  ATRIBUTO (GRUPO) , CCUSTO PROCEDIMENTO, UNIDADE HOSPITALAR,  MESFAT,  ANOFAT
--*
--*****************************************************************************
--
--
 BEGIN
 DECLARE
 CURSOR ATU IS
 SELECT RES.CTS_RES_ID  ,
      RES.CTS_RES_MES ,
      RES.CTS_RES_ANO ,
      RES.CAD_CEC_ID_CC_PROCEDIMENTO,
      RES.CAD_UNI_ID_UNIDADE  ,
      RES.CAD_CTS_PLC_ID,
      RES.CTS_RES_VL_RECEITA_DIRETA , GRUPO.AUX_VL_RECEITA,  GRUPO.CAD_TAP_TP_ATRIBUTO,
     TO_NUMBER( TO_CHAR (  (RES.CTS_RES_VL_RECEITA_DIRETA * 100 / GRUPO.AUX_VL_RECEITA ), '999.999999' ))  PERC_GRUPO
     FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
          TB_CAD_CTS_PLC_PLANO_CONTAS PLC,
               ---- SOMAR TOTAL DOS GRUPO  POR MESFAT, ANOFAT, UNIDADEHOSP, CCUSTO
               (SELECT  PLC.CAD_TAP_TP_ATRIBUTO  ,
                    RES.CTS_RES_MES ,
                    RES.CTS_RES_ANO ,
                    RES.CAD_CEC_ID_CC_PROCEDIMENTO, RES.CAD_UNI_ID_UNIDADE  ,
                    SUM(RES.CTS_RES_VL_RECEITA_DIRETA)   AUX_VL_RECEITA
                FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
                     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                AND RES.CTS_RES_MES = P_MESFAT
                AND RES.CTS_RES_ANO = P_ANOFAT
               GROUP BY  PLC.CAD_TAP_TP_ATRIBUTO  ,
                        RES.CTS_RES_MES,
                        RES.CTS_RES_ANO ,
                        RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                       RES.CAD_UNI_ID_UNIDADE ) GRUPO
     WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
     AND RES.CTS_RES_MES = P_MESFAT
     AND RES.CTS_RES_ANO = P_ANOFAT
     AND NVL(RES.CTS_RES_VL_RECEITA_DIRETA,0)  > 0
     AND PLC.CAD_TAP_TP_ATRIBUTO = GRUPO.CAD_TAP_TP_ATRIBUTO
     AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
     AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
     AND RES.CAD_CEC_ID_CC_PROCEDIMENTO   = GRUPO.CAD_CEC_ID_CC_PROCEDIMENTO
     AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
   ORDER BY 4, 5;
 BEGIN
 FOR A IN ATU LOOP
    ----
    ----
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
    SET RES.CTS_RES_PC_RECEITA_DIRETA =  A.PERC_GRUPO
    WHERE RES.CTS_RES_MES = A.CTS_RES_MES
      AND RES.CTS_RES_ANO = A.CTS_RES_ANO
      AND RES.CAD_CEC_ID_CC_PROCEDIMENTO = A.CAD_CEC_ID_CC_PROCEDIMENTO
      AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
      AND RES.CTS_RES_ID = A.CTS_RES_ID;
 END LOOP;
 COMMIT;
 END;
----
----- AJUSTAR GRUPOS QUE ESTA COM PERCENTUAL DIFERENTE DE 100%
DECLARE
CURSOR ATU IS
SELECT
PLC.CAD_TAP_TP_ATRIBUTO,
     RES.CTS_RES_ID  ,
     RES.CTS_RES_MES ,
     RES.CTS_RES_ANO ,
     RES.CAD_CEC_ID_CC_PROCEDIMENTO,
     RES.CAD_UNI_ID_UNIDADE  ,
     RES.CAD_CTS_PLC_ID,
     RES.CTS_RES_VL_RECEITA_DIRETA ,   GRUPO.DIFERENCA_PERCENT
    FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
         TB_CAD_CTS_PLC_PLANO_CONTAS PLC,
          ---- PROCURAR GRUPO COM PERCENTUAL DIFERENTE DE 100%
         (SELECT  PLC.CAD_TAP_TP_ATRIBUTO  ,
            RES.CTS_RES_MES ,
            RES.CTS_RES_ANO ,
            RES.CAD_CEC_ID_CC_PROCEDIMENTO, RES.CAD_UNI_ID_UNIDADE  ,
            ( 100 - SUM(RES.CTS_RES_PC_RECEITA_DIRETA) ) * -1    DIFERENCA_PERCENT
          FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
               TB_CAD_CTS_PLC_PLANO_CONTAS PLC
          WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
          AND RES.CTS_RES_MES = P_MESFAT
          AND RES.CTS_RES_ANO = P_ANOFAT
         GROUP BY  PLC.CAD_TAP_TP_ATRIBUTO  ,RES.CTS_RES_MES,RES.CTS_RES_ANO ,
                   RES.CAD_CEC_ID_CC_PROCEDIMENTO,  RES.CAD_UNI_ID_UNIDADE
         HAVING SUM(RES.CTS_RES_PC_RECEITA_DIRETA) <> 100            ) GRUPO
    WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
    AND RES.CTS_RES_MES = P_MESFAT
    AND RES.CTS_RES_ANO = P_ANOFAT
    AND PLC.CAD_TAP_TP_ATRIBUTO = GRUPO.CAD_TAP_TP_ATRIBUTO
    AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
    AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
    AND RES.CAD_CEC_ID_CC_PROCEDIMENTO   = GRUPO.CAD_CEC_ID_CC_PROCEDIMENTO
    AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
    AND RES.CTS_RES_ID = (   SELECT RES_PRI.CTS_RES_ID
                            FROM TB_CTS_RES_RESULTADO_CUSTOS RES_PRI,
                                 TB_CAD_CTS_PLC_PLANO_CONTAS PLC_PRI
                            WHERE RES_PRI.CTS_RES_MES = RES.CTS_RES_MES
                             AND RES_PRI.CTS_RES_ANO  = RES.CTS_RES_ANO
                             AND RES_PRI.CAD_CTS_PLC_ID = PLC_PRI.CAD_CTS_PLC_ID
                             AND PLC_PRI.CAD_TAP_TP_ATRIBUTO = PLC.CAD_TAP_TP_ATRIBUTO
                             AND RES_PRI.CAD_CEC_ID_CC_PROCEDIMENTO =  RES.CAD_CEC_ID_CC_PROCEDIMENTO
                             AND RES_PRI.CAD_UNI_ID_UNIDADE = RES.CAD_UNI_ID_UNIDADE
                             AND ROWNUM = 1      ---ACHAR O PRIMEIRO REGISTRO DO MAIOR VALOR
                             AND RES_PRI.CTS_RES_VL_RECEITA_DIRETA =  (  SELECT MAX(CTS_RES_VL_RECEITA_DIRETA)
                                                 FROM TB_CTS_RES_RESULTADO_CUSTOS MAIOR,--- ACHAR O MAIOR VALOR
                                                      TB_CAD_CTS_PLC_PLANO_CONTAS MAIOR_PLC
                                                 WHERE MAIOR.CTS_RES_MES        = RES_PRI.CTS_RES_MES
                                                   AND MAIOR.CTS_RES_ANO        = RES_PRI.CTS_RES_ANO
                                                   AND MAIOR.CAD_CEC_ID_CC_PROCEDIMENTO  = RES_PRI.CAD_CEC_ID_CC_PROCEDIMENTO
                                                   AND MAIOR.CAD_UNI_ID_UNIDADE = RES_PRI.CAD_UNI_ID_UNIDADE
                                                   AND MAIOR.CAD_CTS_PLC_ID     = MAIOR_PLC.CAD_CTS_PLC_ID
                                                   AND MAIOR_PLC.CAD_TAP_TP_ATRIBUTO = PLC_PRI.CAD_TAP_TP_ATRIBUTO ) );
BEGIN
FOR A IN ATU LOOP
---
UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
SET RES.CTS_RES_PC_RECEITA_DIRETA= RES.CTS_RES_PC_RECEITA_DIRETA - A.DIFERENCA_PERCENT
WHERE RES.CTS_RES_ID = A.CTS_RES_ID;
---
---
END LOOP;
COMMIT;
END;
END; ---- FIM DO % PARA O GRUPO DA RECEITA
----
----
--***********************************************************************************
--*
--*  INICIO DO %   CCUSTO, UNIDADE HOSPITALAR,  MESFAT,  ANOFAT
--*
--*
--***********************************************************************************
 BEGIN
 DECLARE
 CURSOR ATU IS
 SELECT RES.CTS_RES_ID  ,
      RES.CTS_RES_MES ,
      RES.CTS_RES_ANO ,
      RES.CAD_CEC_ID_CC_PROCEDIMENTO,
      RES.CAD_UNI_ID_UNIDADE  ,
      RES.CAD_CTS_PLC_ID,
      RES.CTS_RES_VL_RECEITA_DIRETA ,
      CC.AUX_VL_RECEITA,
     TO_NUMBER( TO_CHAR (  (RES.CTS_RES_VL_RECEITA_DIRETA * 100 / CC.AUX_VL_RECEITA ), '999.999999' ))  PERC_CC
     FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
               ---- SOMAR TOTAL POR CCUSTO,  MESFAT, ANOFAT, UNIDADEHOSP
               (SELECT RES.CTS_RES_MES ,
                       RES.CTS_RES_ANO ,
                       RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                       RES.CAD_UNI_ID_UNIDADE  ,
                       SUM(RES.CTS_RES_VL_RECEITA_DIRETA)   AUX_VL_RECEITA
                FROM TB_CTS_RES_RESULTADO_CUSTOS RES
                WHERE RES.CTS_RES_MES = P_MESFAT
                  AND RES.CTS_RES_ANO = P_ANOFAT
               GROUP BY RES.CTS_RES_MES,
                        RES.CTS_RES_ANO ,
                        RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                       RES.CAD_UNI_ID_UNIDADE ) CC
     WHERE  RES.CTS_RES_MES = P_MESFAT
     AND RES.CTS_RES_ANO = P_ANOFAT
     AND NVL(RES.CTS_RES_VL_RECEITA_DIRETA,0)  > 0
     AND RES.CTS_RES_MES         = CC.CTS_RES_MES
     AND RES.CTS_RES_ANO         = CC.CTS_RES_ANO
     AND RES.CAD_CEC_ID_CC_PROCEDIMENTO   = CC.CAD_CEC_ID_CC_PROCEDIMENTO
     AND RES.CAD_UNI_ID_UNIDADE  = CC.CAD_UNI_ID_UNIDADE
   ORDER BY 4, 5;
----
----
 BEGIN
 FOR A IN ATU LOOP
    ----
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
    SET RES.CTS_RES_PC_RECEITA_CCUSTO =  A.PERC_CC
    WHERE RES.CTS_RES_MES = A.CTS_RES_MES
      AND RES.CTS_RES_ANO = A.CTS_RES_ANO
      AND RES.CAD_CEC_ID_CC_PROCEDIMENTO = A.CAD_CEC_ID_CC_PROCEDIMENTO
      AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
      AND RES.CTS_RES_ID = A.CTS_RES_ID;
 END LOOP;
 COMMIT;
 END;
-----
----- VERIFICAR SE EXISTE DIFERENCA PARA COMPLETAR O % PARA CENTRO CUSTO
DECLARE
CURSOR ATU IS
SELECT
     RES.CTS_RES_ID  ,
     RES.CTS_RES_MES ,
     RES.CTS_RES_ANO ,
     RES.CAD_CEC_ID_CC_PROCEDIMENTO,
     RES.CAD_UNI_ID_UNIDADE  ,
     RES.CAD_CTS_PLC_ID,
     RES.CTS_RES_VL_RECEITA_DIRETA ,   GRUPO.DIFERENCA_PERCENT
    FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
          ---- PROCURAR QUAL CCUSTO NAO ESTA COM 100% NO PERCENTUAL
         ( SELECT  RES.CTS_RES_MES ,
            RES.CTS_RES_ANO ,
            RES.CAD_CEC_ID_CC_PROCEDIMENTO, RES.CAD_UNI_ID_UNIDADE  ,
            ( 100 - SUM(RES.CTS_RES_PC_RECEITA_CCUSTO) ) * -1    DIFERENCA_PERCENT
          FROM TB_CTS_RES_RESULTADO_CUSTOS RES
          WHERE RES.CTS_RES_MES = P_MESFAT
            AND RES.CTS_RES_ANO = P_ANOFAT
         GROUP BY RES.CTS_RES_MES,RES.CTS_RES_ANO ,
                   RES.CAD_CEC_ID_CC_PROCEDIMENTO,  RES.CAD_UNI_ID_UNIDADE
         HAVING SUM(RES.CTS_RES_PC_RECEITA_CCUSTO) <> 100            ) GRUPO
    WHERE RES.CTS_RES_MES = P_MESFAT
    AND  RES.CTS_RES_ANO = P_ANOFAT
    AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
    AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
    AND RES.CAD_CEC_ID_CC_PROCEDIMENTO   = GRUPO.CAD_CEC_ID_CC_PROCEDIMENTO
    AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
    AND RES.CTS_RES_ID = (   SELECT RES_PRI.CTS_RES_ID
                            FROM TB_CTS_RES_RESULTADO_CUSTOS RES_PRI
                            WHERE RES_PRI.CTS_RES_MES = RES.CTS_RES_MES
                             AND RES_PRI.CTS_RES_ANO  = RES.CTS_RES_ANO
                             AND RES_PRI.CAD_CEC_ID_CC_PROCEDIMENTO =  RES.CAD_CEC_ID_CC_PROCEDIMENTO
                             AND RES_PRI.CAD_UNI_ID_UNIDADE = RES.CAD_UNI_ID_UNIDADE
                             AND ROWNUM = 1      ---ACHAR O PRIMEIRO REGISTRO DO MAIOR VALOR
                             AND RES_PRI.CTS_RES_VL_RECEITA_DIRETA =  (  SELECT MAX(CTS_RES_VL_RECEITA_DIRETA)
                                                 FROM TB_CTS_RES_RESULTADO_CUSTOS MAIOR--- ACHAR O MAIOR VALOR
                                                 WHERE MAIOR.CTS_RES_MES        = RES_PRI.CTS_RES_MES
                                                   AND MAIOR.CTS_RES_ANO        = RES_PRI.CTS_RES_ANO
                                                   AND MAIOR.CAD_CEC_ID_CC_PROCEDIMENTO  = RES_PRI.CAD_CEC_ID_CC_PROCEDIMENTO
                                                   AND MAIOR.CAD_UNI_ID_UNIDADE = RES_PRI.CAD_UNI_ID_UNIDADE ) ) ;
BEGIN
FOR A IN ATU LOOP
---
UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
SET RES.CTS_RES_PC_RECEITA_CCUSTO= RES.CTS_RES_PC_RECEITA_CCUSTO - A.DIFERENCA_PERCENT
WHERE RES.CTS_RES_ID = A.CTS_RES_ID;
---
---
END LOOP;
COMMIT;
END;
END;
---   FIM DO PERCENTUAL PARA CENTRO DE CUSTO
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
--- % DA RECEITA GERAL SEM CONSIDERAR DIARIA PARA AMBULATORIO E PS
---
BEGIN
--- SOMA RECEITA GERAL SEM DIARIA
SELECT  SUM(RES.CTS_RES_VL_RECEITA_DIRETA)  INTO  AUX_VL_RECEITA
FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
WHERE RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO = P_ANOFAT
  AND RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
  AND PLC.CAD_TAP_TP_ATRIBUTO <> 'DIA' ;  --- TOTAL SEM DIARIA
---
--- CALCULA % SOBRE RECEITA GERAL
 UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
SET RES.CTS_RES_PC_RECTOTAL_SEM_DIARIA  =  TO_NUMBER( TO_CHAR( ( (RES.CTS_RES_VL_RECEITA_DIRETA * 100) / AUX_VL_RECEITA) , '999.999999' ))
WHERE RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO = P_ANOFAT
  AND RES.CAD_CTS_PLC_ID = ( SELECT PLC.CAD_CTS_PLC_ID FROM TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                                 WHERE PLC.CAD_CTS_PLC_ID = RES.CAD_CTS_PLC_ID
                                 AND PLC.CAD_TAP_TP_ATRIBUTO <> 'DIA' ) ;
  ---
--- VERIFICA SE DEU 100%
SELECT ( 100 - SUM(RES.CTS_RES_PC_RECTOTAL_SEM_DIARIA)) * -1  INTO  PERCENT_RECEITA
FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
WHERE RES.CTS_RES_MES = P_MESFAT
  AND RES.CTS_RES_ANO = P_ANOFAT
  AND RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
  AND PLC.CAD_TAP_TP_ATRIBUTO <> 'DIA' ;  --- TOTAL SEM DIARIA
---
--- AJUSTA PARA 100%
IF  PERCENT_RECEITA <> 0 THEN
  UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
  SET RES.CTS_RES_PC_RECTOTAL_SEM_DIARIA =  RES.CTS_RES_PC_RECTOTAL_SEM_DIARIA -  PERCENT_RECEITA
  WHERE  RES.CTS_RES_ID = ( SELECT RESM.CTS_RES_ID
                            FROM TB_CTS_RES_RESULTADO_CUSTOS RESM,
                                 TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                            WHERE RESM.CTS_RES_MES = P_MESFAT
                              AND RESM.CTS_RES_ANO = P_ANOFAT
                              AND RESM.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                              AND PLC.CAD_TAP_TP_ATRIBUTO <> 'DIA'
                              AND ROWNUM = 1
                              AND RESM.CTS_RES_PC_RECEITA_TOTAL = (  SELECT MAX(CTS_RES_PC_RECEITA_TOTAL)
                                                                       FROM TB_CTS_RES_RESULTADO_CUSTOS MAIOR,
                                                                            TB_CAD_CTS_PLC_PLANO_CONTAS PLMAIOR
                                                                       WHERE  MAIOR.CTS_RES_MES = P_MESFAT
                                                                         AND MAIOR.CTS_RES_ANO  = P_ANOFAT
                                                                         AND MAIOR.CAD_CTS_PLC_ID = PLMAIOR.CAD_CTS_PLC_ID
                                                                         AND PLMAIOR.CAD_TAP_TP_ATRIBUTO <> 'DIA'  )  ) ;
END IF;
--
COMMIT;
--
--
END;
---- FIM DO % DA RECEITA GERAL SEM CONSIDERAR DIARIA
-----------------
-----------------
-----------------
BEGIN  ------ % PARA SUBGRUPO MEDICAMENTO
 DECLARE
 CURSOR ATU IS
SELECT RES.CTS_RES_ID  ,
      RES.CTS_RES_MES ,
      RES.CTS_RES_ANO ,
      RES.CAD_CEC_ID_CC_PROCEDIMENTO,
      RES.CAD_UNI_ID_UNIDADE  ,
      RES.CAD_CTS_PLC_ID,
      RES.CTS_RES_VL_RECEITA_DIRETA , GRUPO.AUX_VL_RECEITA,  GRUPO.CAD_TAP_TP_ATRIBUTO,
     TO_NUMBER( TO_CHAR (  (RES.CTS_RES_VL_RECEITA_DIRETA * 100 / GRUPO.AUX_VL_RECEITA ), '999.999999' ))  PERC_GRUPO
     FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
          TB_CAD_CTS_PLC_PLANO_CONTAS PLC,
               ---- SOMAR TOTAL DOS GRUPO  POR MESFAT, ANOFAT, UNIDADEHOSP, CCUSTO
               (SELECT  PLC.CAD_TAP_TP_ATRIBUTO  ,
                    RES.CTS_RES_MES ,
                    RES.CTS_RES_ANO ,
                    RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                    RES.CAD_UNI_ID_UNIDADE  ,
                    SUM(RES.CTS_RES_VL_RECEITA_DIRETA)   AUX_VL_RECEITA
                FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
                     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                AND RES.CTS_RES_MES = P_MESFAT
                AND RES.CTS_RES_ANO = P_ANOFAT AND PLC.CAD_CTS_PLC_ID IN ( 215, 216 ) ----- MEDICAMENTO DIVERSOS E QUIMIO
               GROUP BY  PLC.CAD_TAP_TP_ATRIBUTO  ,
                        RES.CTS_RES_MES,
                        RES.CTS_RES_ANO,
                        RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                        RES.CAD_UNI_ID_UNIDADE   ) GRUPO
     WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
     AND RES.CTS_RES_MES = P_MESFAT
     AND RES.CTS_RES_ANO = P_ANOFAT  AND PLC.CAD_CTS_PLC_ID IN ( 215, 216 )
     AND NVL(RES.CTS_RES_VL_RECEITA_DIRETA,0)  > 0
     AND PLC.CAD_TAP_TP_ATRIBUTO = GRUPO.CAD_TAP_TP_ATRIBUTO
     AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
     AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
     AND RES.CAD_CEC_ID_CC_PROCEDIMENTO   = GRUPO.CAD_CEC_ID_CC_PROCEDIMENTO
     AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
  ORDER BY 5, 4, 6 ;
 BEGIN
 FOR A IN ATU LOOP
    ----
    ----  CALCULAR % DA RECEITA TOTAL PARA O SUBGRUPO MEDICAMENTO
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
    SET RES.CTS_RES_PC_RECEITA_TOTAL_NIVEL =  A.PERC_GRUPO
    WHERE RES.CTS_RES_MES = A.CTS_RES_MES
      AND RES.CTS_RES_ANO = A.CTS_RES_ANO
      AND RES.CAD_CEC_ID_CC_PROCEDIMENTO = A.CAD_CEC_ID_CC_PROCEDIMENTO
      AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
      AND RES.CTS_RES_ID = A.CTS_RES_ID;
 END LOOP;
 COMMIT;
 END;
 --- FALTA AJUSTA DIFERENCA PARA 100%
 END;
 ------888888888888888888888888888888888888888888888888888
----
---- % PARA SUBGRUPO TX GASOTERAPIA 141 , MATERIAL MEDICO 186 ,
----                      PROTESE 193, LABORATORIO(95), BCOSANGUE(100)
---- SE PRECISAR DISTRIBUIR O RESTANTE DOS VALORES DO ESTOQUE
BEGIN
 DECLARE
 CURSOR ATU IS
SELECT RES.CTS_RES_ID  ,
      RES.CTS_RES_MES ,
      RES.CTS_RES_ANO ,
      RES.CAD_CEC_ID_CC_PROCEDIMENTO,
      RES.CAD_UNI_ID_UNIDADE  ,
      RES.CAD_CTS_PLC_ID,
      RES.CTS_RES_VL_RECEITA_DIRETA , GRUPO.AUX_VL_RECEITA,  GRUPO.CAD_TAP_TP_ATRIBUTO,
     TO_NUMBER( TO_CHAR (  (RES.CTS_RES_VL_RECEITA_DIRETA * 100 / GRUPO.AUX_VL_RECEITA ), '999.999999' ))  PERC_GRUPO
     FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
          TB_CAD_CTS_PLC_PLANO_CONTAS PLC,
               ---- SOMAR TOTAL DOS GRUPO  POR MESFAT, ANOFAT, UNIDADEHOSP, CCUSTO
               (SELECT  PLC.CAD_TAP_TP_ATRIBUTO  , PLC.CAD_CTS_PLC_ID,
                    RES.CTS_RES_MES ,
                    RES.CTS_RES_ANO ,
                    RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                    RES.CAD_UNI_ID_UNIDADE  ,
                    SUM(RES.CTS_RES_VL_RECEITA_DIRETA)   AUX_VL_RECEITA
                FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
                     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                AND RES.CTS_RES_MES = P_MESFAT
                AND RES.CTS_RES_ANO = P_ANOFAT AND PLC.CAD_CTS_PLC_ID IN ( 141 , 186, 193 , 95, 100)
                GROUP BY  PLC.CAD_TAP_TP_ATRIBUTO  ,
                        RES.CTS_RES_MES,
                        RES.CTS_RES_ANO ,PLC.CAD_CTS_PLC_ID,
                        RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                       RES.CAD_UNI_ID_UNIDADE
                       ) GRUPO
     WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
     AND RES.CTS_RES_MES = P_MESFAT
     AND RES.CTS_RES_ANO = P_ANOFAT  AND PLC.CAD_CTS_PLC_ID IN ( 141 , 186, 193 , 95, 100 )
     AND NVL(RES.CTS_RES_VL_RECEITA_DIRETA,0)  > 0
     AND PLC.CAD_TAP_TP_ATRIBUTO = GRUPO.CAD_TAP_TP_ATRIBUTO
     AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
     AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
     AND RES.CAD_CTS_PLC_ID      = GRUPO.CAD_CTS_PLC_ID
     AND RES.CAD_CEC_ID_CC_PROCEDIMENTO   = GRUPO.CAD_CEC_ID_CC_PROCEDIMENTO
    AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
  ORDER BY 9 , 6 ;
 BEGIN
 FOR A IN ATU LOOP
    ----
    ----  CALCULAR % DA RECEITA TOTAL PARA O SUBGRUPO GASES MEDICINAIS,
    ----       MATERIAL MEDICO , PROTESE , LABORATORIO E BCO SANGUE
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
    SET RES.CTS_RES_PC_RECEITA_TOTAL_NIVEL =  A.PERC_GRUPO
    WHERE RES.CTS_RES_MES = A.CTS_RES_MES
      AND RES.CTS_RES_ANO = A.CTS_RES_ANO
      AND RES.CAD_CEC_ID_CC_PROCEDIMENTO = A.CAD_CEC_ID_CC_PROCEDIMENTO
      AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
      AND RES.CTS_RES_ID = A.CTS_RES_ID;
 END LOOP;
 COMMIT;
 END;
 --- FALTA AJUSTA DIFERENCA PARA 100%
 END;
 ------888888888888888888888888888888888888888888888888888
----
----
---- % HM DE CLINICA 23/04/2013
BEGIN
---- % PARA HM DE CLINICA  CODIGO 53, 54, 55, 56
---- CALCULADO SEM CONSIDERAR O CCUSTO ONDE FOI REALIZADO O PROCEDIMENTO
---  MES , ANO, HOSPITAL, CODIGO DO PLANO DE CTAS (53,54,55,56 ), HM
 DECLARE
 CURSOR ATU IS
SELECT RES.CTS_RES_ID  ,
      RES.CTS_RES_MES ,
      RES.CTS_RES_ANO ,
      RES.CAD_CEC_ID_CC_PROCEDIMENTO,
      RES.CAD_UNI_ID_UNIDADE  ,
      RES.CAD_CTS_PLC_ID,
      RES.CTS_RES_VL_RECEITA_DIRETA , GRUPO.AUX_VL_RECEITA,  GRUPO.CAD_TAP_TP_ATRIBUTO,
     TO_NUMBER( TO_CHAR (  (RES.CTS_RES_VL_RECEITA_DIRETA * 100 / GRUPO.AUX_VL_RECEITA ), '999.999999' ))  PERC_GRUPO
     FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
          TB_CAD_CTS_PLC_PLANO_CONTAS PLC,
               ---- SOMAR TOTAL DOS GRUPO  POR MESFAT, ANOFAT, UNIDADEHOSP
               (SELECT  PLC.CAD_TAP_TP_ATRIBUTO  , PLC.CAD_CTS_PLC_ID,
                    RES.CTS_RES_MES ,
                    RES.CTS_RES_ANO ,
                    ----RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                    RES.CAD_UNI_ID_UNIDADE  ,
                    SUM(RES.CTS_RES_VL_RECEITA_DIRETA)   AUX_VL_RECEITA
                FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
                     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                AND RES.CTS_RES_MES = P_MESFAT
                AND RES.CTS_RES_ANO = P_ANOFAT AND PLC.CAD_CTS_PLC_ID IN ( 53, 54, 55, 56 )
                GROUP BY  PLC.CAD_TAP_TP_ATRIBUTO  ,
                        RES.CTS_RES_MES,
                        RES.CTS_RES_ANO ,
                        PLC.CAD_CTS_PLC_ID,
                        ----RES.CAD_CEC_ID_CC_PROCEDIMENTO,
                       RES.CAD_UNI_ID_UNIDADE
                       ) GRUPO
     WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
     AND RES.CTS_RES_MES = P_MESFAT   ----AND RES.CAD_UNI_ID_UNIDADE = 244 AND PLC.CAD_CTS_PLC_ID = 53
     AND RES.CTS_RES_ANO = P_ANOFAT  AND PLC.CAD_CTS_PLC_ID IN (  53, 54, 55, 56  )
     AND NVL(RES.CTS_RES_VL_RECEITA_DIRETA,0)  > 0
     AND PLC.CAD_TAP_TP_ATRIBUTO = GRUPO.CAD_TAP_TP_ATRIBUTO
     AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
     AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
     AND RES.CAD_CTS_PLC_ID      = GRUPO.CAD_CTS_PLC_ID
     ----AND RES.CAD_CEC_ID_CC_PROCEDIMENTO   = GRUPO.CAD_CEC_ID_CC_PROCEDIMENTO
    AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
  ORDER BY 4, 5 ;
 BEGIN
 FOR A IN ATU LOOP
    ----
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
    SET RES.CTS_RES_PC_RECEITA_TOTAL_NIVEL =  A.PERC_GRUPO
    WHERE RES.CTS_RES_MES = A.CTS_RES_MES
      AND RES.CTS_RES_ANO = A.CTS_RES_ANO
    -----  AND RES.CAD_CEC_ID_CC_PROCEDIMENTO = A.CAD_CEC_ID_CC_PROCEDIMENTO
      AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
      AND RES.CTS_RES_ID = A.CTS_RES_ID;
 END LOOP;
 COMMIT;
 END;
 --- FALTA AJUSTA DIFERENCA PARA 100%
 END;
 ----FIM DO % DO HM  23/04/2013
--------------------------------
------------------------------------
--------------------------------
BEGIN  ------ % PARA UNIDADE HOSPITALAR E ATRIBUTO
 DECLARE
 CURSOR ATU IS
SELECT RES.CTS_RES_ID  ,
      RES.CTS_RES_MES ,
      RES.CTS_RES_ANO ,
      RES.CAD_CEC_ID_CC_PROCEDIMENTO,
      RES.CAD_UNI_ID_UNIDADE  ,
      RES.CAD_CTS_PLC_ID,
      RES.CTS_RES_VL_RECEITA_DIRETA , GRUPO.AUX_VL_RECEITA,  GRUPO.CAD_TAP_TP_ATRIBUTO,
     TO_NUMBER( TO_CHAR (  (RES.CTS_RES_VL_RECEITA_DIRETA * 100 / GRUPO.AUX_VL_RECEITA ), '999.999999' ))  PERC_GRUPO
     FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
          TB_CAD_CTS_PLC_PLANO_CONTAS PLC,
               ---- SOMAR TOTAL DOS GRUPO  POR MESFAT, ANOFAT, UNIDADEHOSP, CCUSTO
               (SELECT  PLC.CAD_TAP_TP_ATRIBUTO  ,
                    RES.CTS_RES_MES ,
                    RES.CTS_RES_ANO ,
                    RES.CAD_UNI_ID_UNIDADE  ,
                    SUM(RES.CTS_RES_VL_RECEITA_DIRETA)   AUX_VL_RECEITA
                FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
                     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                AND RES.CTS_RES_MES = P_MESFAT
                AND RES.CTS_RES_ANO = P_ANOFAT ---- AND RES.CAD_CTS_PLC_ID NOT IN ( 3, 14, 25, 40, 52 )
               GROUP BY  PLC.CAD_TAP_TP_ATRIBUTO  ,
                        RES.CTS_RES_MES,
                        RES.CTS_RES_ANO,
                        RES.CAD_UNI_ID_UNIDADE
                       ) GRUPO
     WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
     AND RES.CTS_RES_MES = P_MESFAT
     AND RES.CTS_RES_ANO = P_ANOFAT
     AND NVL(RES.CTS_RES_VL_RECEITA_DIRETA,0)  > 0
     AND PLC.CAD_TAP_TP_ATRIBUTO = GRUPO.CAD_TAP_TP_ATRIBUTO
     AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
     AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
     AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
  ORDER BY 5, 4, 6 ;
 BEGIN
 FOR A IN ATU LOOP
    ----
    ----
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
    SET RES.CTS_RES_PERCENT_2 =  A.PERC_GRUPO
    WHERE RES.CTS_RES_MES = A.CTS_RES_MES
      AND RES.CTS_RES_ANO = A.CTS_RES_ANO
      AND RES.CAD_CEC_ID_CC_PROCEDIMENTO = A.CAD_CEC_ID_CC_PROCEDIMENTO
      AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
      AND RES.CTS_RES_ID = A.CTS_RES_ID;
 END LOOP;
 COMMIT;
 END;
 --- FALTA AJUSTA DIFERENCA PARA 100%
 END;
 ------8888888888888888888888888888888888888888888888
---
---
---
--*****************************************************************************
--*
--*  INICIO DO % DO GRUPO DA RECEITA
--*  ATRIBUTO (GRUPO) , CCUSTO DA RECEITA, UNIDADE HOSPITALAR,  MESFAT,  ANOFAT
--*  GRAVADO NO CTS_RES_PERCENT_1
--*
--*****************************************************************************
--
--
 BEGIN
 DECLARE
 CURSOR ATU IS
 SELECT RES.CTS_RES_ID  ,
      RES.CTS_RES_MES ,
      RES.CTS_RES_ANO ,
      RES.CAD_CEC_ID_CCUSTO_RECEITA,
      RES.CAD_UNI_ID_UNIDADE  ,
      RES.CAD_CTS_PLC_ID,
      RES.CTS_RES_VL_RECEITA_DIRETA , GRUPO.AUX_VL_RECEITA,  GRUPO.CAD_TAP_TP_ATRIBUTO,
     TO_NUMBER( TO_CHAR (  (RES.CTS_RES_VL_RECEITA_DIRETA * 100 / GRUPO.AUX_VL_RECEITA ), '999.999999' ))  PERC_GRUPO
     FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
          TB_CAD_CTS_PLC_PLANO_CONTAS PLC,
               ---- SOMAR TOTAL DOS GRUPO  POR MESFAT, ANOFAT, UNIDADEHOSP, CCUSTO
               (SELECT  PLC.CAD_TAP_TP_ATRIBUTO  ,
                    RES.CTS_RES_MES ,
                    RES.CTS_RES_ANO ,
                    RES.CAD_CEC_ID_CCUSTO_RECEITA, RES.CAD_UNI_ID_UNIDADE  ,
                    SUM(RES.CTS_RES_VL_RECEITA_DIRETA)   AUX_VL_RECEITA
                FROM TB_CTS_RES_RESULTADO_CUSTOS RES,
                     TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                AND RES.CTS_RES_MES = P_MESFAT
                AND RES.CTS_RES_ANO = P_ANOFAT
               GROUP BY  PLC.CAD_TAP_TP_ATRIBUTO  ,
                        RES.CTS_RES_MES,
                        RES.CTS_RES_ANO ,
                        RES.CAD_CEC_ID_CCUSTO_RECEITA,
                       RES.CAD_UNI_ID_UNIDADE ) GRUPO
     WHERE RES.CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
     AND RES.CTS_RES_MES = P_MESFAT
     AND RES.CTS_RES_ANO = P_ANOFAT
     AND NVL(RES.CTS_RES_VL_RECEITA_DIRETA,0)  > 0
     AND PLC.CAD_TAP_TP_ATRIBUTO = GRUPO.CAD_TAP_TP_ATRIBUTO
     AND RES.CTS_RES_MES         = GRUPO.CTS_RES_MES
     AND RES.CTS_RES_ANO         = GRUPO.CTS_RES_ANO
     AND RES.CAD_CEC_ID_CCUSTO_RECEITA   = GRUPO.CAD_CEC_ID_CCUSTO_RECEITA
     AND RES.CAD_UNI_ID_UNIDADE  = GRUPO.CAD_UNI_ID_UNIDADE
   ORDER BY 4, 5;
 BEGIN
 FOR A IN ATU LOOP
    ----
    ----
    ----
    UPDATE TB_CTS_RES_RESULTADO_CUSTOS RES
    SET RES.CTS_RES_PERCENT_1 =  A.PERC_GRUPO
    WHERE RES.CTS_RES_MES = A.CTS_RES_MES
      AND RES.CTS_RES_ANO = A.CTS_RES_ANO
      AND RES.CAD_CEC_ID_CCUSTO_RECEITA = A.CAD_CEC_ID_CCUSTO_RECEITA
      AND RES.CAD_UNI_ID_UNIDADE = A.CAD_UNI_ID_UNIDADE
      AND RES.CTS_RES_ID = A.CTS_RES_ID;
 END LOOP;
 COMMIT;
 END;
END;
---------------------------------------------------------------------------------
----
---- END DO PRIMEIRO BEGIN DO PARAMETRO DO MESFAT ANOFAT
END;
END PRC_CTS_RES_RECEITA_MODELO3;