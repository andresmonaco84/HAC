-- ALTER TABLE SGS.TB_CAD_MTMD_MAT_MED ADD CAD_MTMD_FATOR_CONVERSAO NUMBER(3)
-- DROP TABLE SGS.TB_CAD_MTMD_MAT_MED
-- ALTER TABLE SGS.TB_CAD_MTMD_MAT_MED DROP COLUMN CAD_MTMD_FATOR_CONVERSAO
CREATE TABLE SGS.TB_CAD_MTMD_MAT_MED (
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_FILIAL_ID NUMERIC(1) NOT NULL,
  CODGRUMAT NUMBER NULL,
  CAD_MTMD_PRIATI_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_GRUPO_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_SUBGRUPO_ID NUMERIC(10) NOT NULL,
  TIS_MED_CD_TABELAMEDICA VARCHAR2(2) NOT NULL,
  CAD_MTMD_NOMEFANTASIA VARCHAR2(100) NULL,
  CAD_MTMD_DESCRICAO VARCHAR2(50) NOT NULL,
  CAD_MTMD_UNIDADE_VENDA NUMERIC(10) NULL,
  CAD_MTMD_UNID_VENDA_DS VARCHAR2(100) NULL,
  CAD_MTMD_UNIDADE_COMPRA NUMERIC(10) NULL,
  CAD_MTMD_UNID_COMPRA_DS VARCHAR2(100) NULL,
  CAD_MTMD_UNIDADE_CONTROLE NUMERIC(10) NULL,
  CAD_MTMD_UNID_CONTROLE_DS VARCHAR2(100) NULL,
  CAD_MTMD_UNIDADE_CONSUMO NUMERIC(10) NULL,
  CAD_MTMD_CODMNE VARCHAR(10) NULL,
  CAD_MTMD_CURVA_ABC CHAR(1) NULL,
  CAD_MTMD_CD_FABRICANTE VARCHAR2(15) NULL,
  CAD_MTMD_FL_FRACIONA NUMERIC(1) NULL,
  CAD_MTMD_FL_ATIVO NUMERIC(1) NULL,
  CAD_MTMD_FL_MANTER_ESTOQUE NUMERIC(1) NULL,
  CAD_MTMD_FL_REUTILIZAVEL NUMERIC(1) NULL,
  CAD_MTMD_DT_ATUALIZACAO DATE NULL,
  CAD_MTMD_CD_RM VARCHAR2(30) NULL,
  CAD_MTMD_FL_PADRAO NUMERIC(1) NULL,
  CAD_MTMD_FL_CONSIGNADO NUMERIC(1) NULL,
  CAD_MTMD_FL_BAIXA_AUTOMATICA NUMERIC(1) NULL,
  CAD_MTMD_FL_IMOBILIZADO NUMERIC(1) NULL,
  CAD_MTMD_FL_CONTROLA_LOTE NUMBER(1) NULL, -- NAO TEM DTO, ACRESCENTAR NO SCRIPT DE IMPORTAÇÃO DE DADOS RM
  PRIMARY KEY(CAD_MTMD_ID)
);

-- ALTER TABLE SGS.TB_CAD_MTMD_MAT_MED ADD CAD_MTMD_FL_CONTROLA_LOTE NUMBER(1);
-- ALTER TABLE SGS.TB_CAD_MTMD_MAT_MED ADD CAD_MTMD_UNIDADE_CONSUMO NUMBER(10) NULL
 --ALTER TABLE SGS.TB_CAD_MTMD_MAT_MED ADD (
--  CAD_MTMD_UNID_COMPRA_DS VARCHAR2(100) NULL,
--  CAD_MTMD_UNID_CONTROLE_DS VARCHAR2(100) NULL,  
--  CAD_MTMD_UNID_VENDA_DS VARCHAR2(100) NULL)

CREATE SEQUENCE SGS.SEQ_MATMED
GRANT SELECT, ALTER ON SGS.SEQ_MATMED TO SGS
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_MAT_MED TO SGS


COMMENT ON TABLE SGS.tb_cad_mtmd_mat_med                               IS 'MaterialMedicamento';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_cd_fabricante       IS 'CdFabricante';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_cd_rm               IS 'CdRm';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_codmne              IS 'CodMne';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_curva_abc           IS 'CurvaAbc';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_descricao           IS 'Descricao';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_dt_atualizacao      IS 'DtAtualizacao';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_filial_id           IS 'IdtFilial';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_ativo            IS 'FlAtivo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_baixa_automatica IS 'FlBaixaAtuomatica';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_consignado       IS 'FlConsignado';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_fraciona         IS 'FlFracionado';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_imobilizado      IS 'FlImobilizado';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_manter_estoque   IS 'FlManterEstoque';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_padrao           IS 'FlPadrao';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_fl_reutilizavel     IS 'FlReutilizavel';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_grupo_id            IS 'IdtGrupo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_id                  IS 'Idt';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_nomefantasia        IS 'NomeFantasia';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_priati_id           IS 'IdtPrincipioAtivo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_subgrupo_id         IS 'IdtSubGrupo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_unidade_compra      IS 'UnidadeCompra';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_unidade_controle    IS 'UnidadeControle';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.cad_mtmd_unidade_venda       IS 'UnidadeVenda';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.codgrumat                    IS 'CodGruMat';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.tis_med_cd_tabelamedica      IS 'Tabelamedica';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.CAD_MTMD_UNID_COMPRA_DS      IS 'DsUnidadeCompra';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.CAD_MTMD_UNID_CONTROLE_DS    IS 'DsUnidadeControle';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.CAD_MTMD_UNID_VENDA_DS       IS 'DsUnidadeVenda';
COMMENT ON COLUMN SGS.tb_cad_mtmd_mat_med.CAD_MTMD_UNIDADE_CONSUMO     IS 'UnidadeConsumo';


--==================================================================================================
-- DROP TABLE SGS.TB_CAD_MTMD_GRUPO
CREATE TABLE SGS.TB_CAD_MTMD_GRUPO (
  CAD_MTMD_GRUPO_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_GRUPO_DESCRICAO VARCHAR2(30) NULL,
  CAD_MTMD_FL_ATIVO NUMERIC(1) NULL,
  PRIMARY KEY(CAD_MTMD_GRUPO_ID)
);

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_GRUPO TO SGS

COMMENT ON TABLE SGS.tb_cad_mtmd_grupo                           IS 'Grupo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_grupo.cad_mtmd_fl_ativo        IS 'FlAtivo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_grupo.cad_mtmd_grupo_descricao IS 'DsGrupo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_grupo.cad_mtmd_grupo_id        IS 'Idt';


--=============================================
-- SELECT * FROM SGS.TB_CAD_MTMD_SUBGRUPO
-- DROP TABLE SGS.TB_CAD_MTMD_SUBGRUPO
CREATE TABLE SGS.TB_CAD_MTMD_SUBGRUPO (
  CAD_MTMD_SUBGRUPO_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_GRUPO_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_SUBGRUPO_DESCRICAO VARCHAR2(30) NULL,
  PRIMARY KEY(CAD_MTMD_SUBGRUPO_ID, CAD_MTMD_GRUPO_ID) );

ALTER TABLE SGS.TB_CAD_MTMD_SUBGRUPO
 ADD CONSTRAINT SGS_TB_CAD_MTMD_GRUPO FOREIGN KEY (CAD_MTMD_GRUPO_ID)
  REFERENCES SGS.TB_CAD_MTMD_GRUPO (CAD_MTMD_GRUPO_ID);
  
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_SUBGRUPO TO SGS

COMMENT ON TABLE SGS.tb_cad_mtmd_subgrupo                              IS 'SubGrupoMatMed';
COMMENT ON COLUMN SGS.tb_cad_mtmd_subgrupo.cad_mtmd_grupo_id           IS 'Idt';
COMMENT ON COLUMN SGS.tb_cad_mtmd_subgrupo.cad_mtmd_subgrupo_descricao IS 'DsSubGrupo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_subgrupo.cad_mtmd_subgrupo_id        IS 'IdtGrupo';

--==================================================================================================
  
CREATE TABLE SGS.TB_CAD_MTMD_PRIATI_PRINC_ATIVO (
  CAD_MTMD_PRIATI_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_PRIATI_DESCRICAO VARCHAR2(50) NULL,
  SEG_USU_ID_USUARIO NUMBER NULL,
  PRIMARY KEY(CAD_MTMD_PRIATI_ID)
);


CREATE SEQUENCE SGS.SEQ_PRINCIPIO_ATIVO;
GRANT SELECT, ALTER ON SGS.SEQ_PRINCIPIO_ATIVO TO SGS;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_PRIATI_PRINC_ATIVO TO SGS;

ALTER TABLE SGS.TB_CAD_MTMD_PRIATI_PRINC_ATIVO
 ADD CONSTRAINT SEG_USU_PRIATI FOREIGN KEY (SEG_USU_ID_USUARIO)
  REFERENCES SGS.TB_SEG_USU_USUARIO (SEG_USU_ID_USUARIO);


COMMENT ON TABLE SGS.tb_cad_mtmd_priati_princ_ativo                            IS 'PrincipioAtivo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_priati_princ_ativo.cad_mtmd_priati_descricao IS 'DsPrincipioAtivo';
COMMENT ON COLUMN SGS.tb_cad_mtmd_priati_princ_ativo.cad_mtmd_priati_id        IS 'Idt';


--=================================================================================================
DROP TABLE SGS.TB_MTMD_REQ_REQUISICAO
CREATE TABLE SGS.TB_MTMD_REQ_REQUISICAO (
  MTMD_REQ_ID NUMERIC(10) NOT NULL,
  CAD_SET_ID NUMERIC NOT NULL, -- FALTA CRIAR DTO
  CAD_LAT_ID_LOCAL_ATENDIMENTO NUMERIC NOT NULL, -- FALTA CRIAR DTO
  CAD_UNI_ID_UNIDADE NUMERIC NOT NULL, -- FALTA CRIAR DTO
--  NR_SEQINTER NUMBER(10),
  ATD_ATE_ID NUMBER, -- NÃO PODE TER REFERENCIA COM A TABELA TB_ATD_ATE_ATENDIMENTO, AINDA VAI TER NUMERO DO LEGADO
  ATD_ATE_TP_PACIENTE VARCHAR2(1),
  MTMD_REQ_FL_STATUS NUMERIC(1) NULL,
  MTMD_REQ_DT_ATUALIZACAO DATE NULL,
  MTM_TIPO_REQUISICAO NUMERIC(1) NOT NULL,  
  CAD_MTMD_FILIAL_ID NUMERIC(1) NOT NULL,
  SEG_USU_ID_USUARIO NUMERIC NULL,
  MTMD_DATA_REQUISICAO DATE NULL,
  MTMD_ID_USUARIO_REQUISICAO NUMERIC NULL,
  MTMD_DATA_DISPENSACAO DATE NULL,
  MTMD_ID_USUARIO_DISPENSACAO NUMERIC,
  MTMD_FL_PENDENTE NUMERIC(1) NULL,
  MTMD_REQ_ID_REF NUMERIC(10) NULL,
  PRIMARY KEY(MTMD_REQ_ID)
);

ALTER TABLE SGS.TB_MTMD_REQ_REQUISICAO
 ADD CONSTRAINT SGS_REQUISICAO_SETOR FOREIGN KEY (CAD_SET_ID)
  REFERENCES SGS.TB_CAD_SET_SETOR (CAD_SET_ID);

ALTER TABLE SGS.TB_MTMD_REQ_REQUISICAO
 ADD CONSTRAINT SGS_REQUISICAO_LOCAL FOREIGN KEY (CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_UNI_ID_UNIDADE)
  REFERENCES SGS.TB_ASS_ULO_UNID_LOCAL (CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_UNI_ID_UNIDADE);

-- ALTER TABLE SGS.TB_MTMD_REQ_REQUISICAO
-- ADD CONSTRAINT SGS_REQUISICAO_SEQ_LEGADO FOREIGN KEY (NR_SEQINTER)
--  REFERENCES HOSPITAL.TB_INTERNADO (NR_SEQINTER);

ALTER TABLE SGS.TB_MTMD_REQ_REQUISICAO
 ADD CONSTRAINT SEG_USU_USUARIO FOREIGN KEY (SEG_USU_ID_USUARIO)
  REFERENCES SGS.TB_SEG_USU_USUARIO (SEG_USU_ID_USUARIO);


COMMENT ON TABLE SGS.tb_mtmd_req_requisicao                               IS 'Requisicao';
COMMENT ON COLUMN SGS.tb_mtmd_req_requisicao.cad_lat_id_local_atendimento IS 'IdtLocal';
COMMENT ON COLUMN SGS.tb_mtmd_req_requisicao.cad_set_id                   IS 'IdtSetor';
COMMENT ON COLUMN SGS.tb_mtmd_req_requisicao.cad_uni_id_unidade           IS 'IdtUnidade';
COMMENT ON COLUMN SGS.tb_mtmd_req_requisicao.mtmd_req_dt_atualizacao      IS 'DataAtualizacao';
COMMENT ON COLUMN SGS.tb_mtmd_req_requisicao.mtmd_req_fl_status           IS 'Status';
COMMENT ON COLUMN SGS.tb_mtmd_req_requisicao.mtmd_req_id                  IS 'Idt';
-- COMMENT ON COLUMN SGS.TB_MTMD_REQ_REQUISICAO.nr_seqinter                  IS 'NrInternacaoLegado';
COMMENT ON COLUMN SGS.TB_MTMD_REQ_REQUISICAO.ATD_ATE_ID                   IS 'IdtAtendimento';
COMMENT ON COLUMN SGS.TB_MTMD_REQ_REQUISICAO.ATD_ATE_TP_PACIENTE          IS 'TpAtendimento';

-- DROP SEQUENCE SGS.SEQ_MTMD_REQUISICAO
CREATE SEQUENCE SGS.SEQ_MTMD_REQUISICAO
GRANT SELECT, ALTER ON SGS.SEQ_MTMD_REQUISICAO TO SGS
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_REQ_REQUISICAO TO SGS
--==================================================================================================

-- DROP TABLE SGS.TB_MTMD_REQUISICAO_ITEM
CREATE TABLE SGS.TB_MTMD_REQUISICAO_ITEM (
  MTMD_REQ_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  MTMD_REQITEM_QTD_SOLICITADA NUMERIC(5) NOT NULL,
  MTMD_REQITEM_QTD_FORNECIDA NUMERIC(5) NULL,
  PRIMARY KEY(MTMD_REQ_ID, CAD_MTMD_ID)
);

ALTER TABLE SGS.TB_MTMD_REQUISICAO_ITEM
 ADD CONSTRAINT SGS_REQUISICAO FOREIGN KEY (MTMD_REQ_ID)
  REFERENCES SGS.TB_MTMD_REQ_REQUISICAO (MTMD_REQ_ID);

-- ALTER TABLE SGS.tb_mtmd_requisicao_item DROP CONSTRAINT sgs_matmed

ALTER TABLE SGS.TB_MTMD_REQUISICAO_ITEM
 ADD CONSTRAINT SGS_MATMED FOREIGN KEY (CAD_MTMD_ID)
  REFERENCES SGS.TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);

COMMENT ON TABLE SGS.tb_mtmd_requisicao_item                              IS 'RequisicaoItens';
COMMENT ON COLUMN SGS.tb_mtmd_requisicao_item.cad_mtmd_id                 IS 'ProdutoIdt';
COMMENT ON COLUMN SGS.tb_mtmd_requisicao_item.mtmd_req_id                 IS 'Idt';
COMMENT ON COLUMN SGS.tb_mtmd_requisicao_item.mtmd_reqitem_qtd_fornecida  IS 'QtdFornecida';
COMMENT ON COLUMN SGS.tb_mtmd_requisicao_item.mtmd_reqitem_qtd_solicitada IS 'QtdSolicitada';

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_REQUISICAO_ITEM TO SGS

--==================================================================================================
-- DROP TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO
CREATE TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO (
  MTMD_MOV_ID NUMERIC(10) NOT NULL,
  CAD_LAT_ID_LOCAL_ATENDIMENTO NUMERIC NOT NULL,
  CAD_UNI_ID_UNIDADE NUMERIC NOT NULL,
  CAD_SET_ID NUMERIC NOT NULL,
  MTMD_REQ_ID NUMBER(10),
  MTMD_LOTEST_ID NUMERIC(10) NULL,
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_TPMOV_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_SUBTP_ID NUMERIC(10) NOT NULL,
  MTMD_MOV_DATA DATE NULL,
  MTMD_MOV_QTDE NUMERIC(15) NULL,
  MTMD_MOV_FL_FINALIZADO NUMERIC(1) NULL,
  -- NR_SEQINTER NUMBER , NAO VAI MAIS SER UTILIZADO
  ATD_ATE_ID NUMBER, -- NÃO PODE TER REFERENCIA COM A TABELA TB_ATD_ATE_ATENDIMENTO, AINDA VAI TER NUMERO DO LEGADO
  ATD_ATE_TP_PACIENTE VARCHAR2(1),
  CAD_MTMD_FILIAL_ID NUMBER(1),
  MTMD_MOV_FL_FATURADO NUMERIC(1) NULL,
  SEG_USU_ID_USUARIO NUMERIC NOT NULL,
  PRIMARY KEY(MTMD_MOV_ID)
);


-- 
-- ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO MODIFY CAD_MTMD_FILIAL_ID NUMBER(1)
-- ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO ADD CAD_MTMD_FILIAL_ID NUMBER
-- ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO ADD MTMD_REQ_ID NUMBER(10)
-- drop sequence SGS.SEQ_MTMD_MOVIMENTACAO;
CREATE SEQUENCE SGS.SEQ_MTMD_MOVIMENTACAO;

GRANT SELECT, ALTER ON SGS.SEQ_MTMD_MOVIMENTACAO TO SGS

ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO
 ADD CONSTRAINT SGS_MOV_REQUISICAO FOREIGN KEY (MTMD_REQ_ID)
  REFERENCES SGS.TB_MTMD_REQ_REQUISICAO (MTMD_REQ_ID);

ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO
 ADD CONSTRAINT MTMD_FILIAL_MOV FOREIGN KEY (CAD_MTMD_FILIAL_ID)
  REFERENCES SGS.TB_CAD_MTMD_FILIAL (CAD_MTMD_FILIAL_ID);

ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO
 ADD CONSTRAINT SGS_MOVIMENTO_SETOR FOREIGN KEY (CAD_SET_ID)
  REFERENCES SGS.TB_CAD_SET_SETOR (CAD_SET_ID);

ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO
 ADD CONSTRAINT SGS_MOVIMENTO_LOC_UNI FOREIGN KEY (CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_UNI_ID_UNIDADE)
  REFERENCES SGS.TB_ASS_ULO_UNID_LOCAL (CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_UNI_ID_UNIDADE);

-- ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO
-- ADD CONSTRAINT SGS_MOVIMENTO_SEQ_LEGADO FOREIGN KEY (NR_SEQINTER)
--  REFERENCES HOSPITAL.TB_INTERNADO (NR_SEQINTER);

ALTER TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO
 ADD CONSTRAINT SGS_MOVIMENTO_TIPO FOREIGN KEY (CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_ID)
  REFERENCES SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO (CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_ID);

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_MOV_MOVIMENTACAO TO SGS;


-- truncate TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO

COMMENT ON TABLE SGS.TB_MTMD_MOV_MOVIMENTACAO                               IS 'Movimentacao';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.CAD_LAT_ID_LOCAL_ATENDIMENTO IS 'IdtLocal';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.CAD_MTMD_ID                  IS 'IdtProduto';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.CAD_MTMD_SUBTP_ID            IS 'IdtSubTipo';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.CAD_MTMD_TPMOV_ID            IS 'IdtTipo';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.CAD_SET_ID                   IS 'IdtSetor';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.CAD_UNI_ID_UNIDADE           IS 'IdtUnidade';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.MTMD_LOTEST_ID               IS 'IdtLote';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.MTMD_MOV_DATA                IS 'dataMovimento';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.MTMD_MOV_FL_FINALIZADO       IS 'FlFinalizado';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.MTMD_MOV_ID                  IS 'Idt';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.MTMD_MOV_QTDE                IS 'Qtde';
-- COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.NR_SEQINTER                  IS 'IdtInternado';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.CAD_MTMD_FILIAL_ID           IS 'IdtFilial';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.MTMD_REQ_ID                  IS 'IdtRequisicao';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.ATD_ATE_ID                   IS 'IdtAtendimento';
COMMENT ON COLUMN SGS.TB_MTMD_MOV_MOVIMENTACAO.ATD_ATE_TP_PACIENTE          IS 'TpAtendimento';

--------------------------------------------------------------------------------

CREATE TABLE TB_MTMD_MOV_COMPLEMENTO (
  MTMD_MOV_ID NUMERIC(10) NOT NULL,
  MTMD_MOV_OBS VARCHAR(100) NULL,
  MTMD_MOV_USU_RELATADO VARCHAR(50) NULL,
  PRIMARY KEY(MTMD_MOV_ID)
);

alter table TB_MTMD_MOV_COMPLEMENTO
  add constraint SGS_MOV_ID foreign key (MTMD_MOV_ID)
  references TB_MTMD_MOV_MOVIMENTACAO (MTMD_MOV_ID);
  
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_MOV_COMPLEMENTO TO SGS;

--------------------------------------------------------------------------------

CREATE TABLE SGS.TB_CAD_MTMD_FILIAL (
  CAD_MTMD_FILIAL_ID NUMERIC(1) NOT NULL,
  CAD_MTMD_FILIAL_DESCRICAO VARCHAR(30) NULL,
  PRIMARY KEY(CAD_MTMD_FILIAL_ID)
);
-- ALTER TABLE SGS.TB_CAD_MTMD_FILIAL MODIFY CAD_MTMD_FILIAL_ID NUMBER(1)
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_FILIAL TO SGS

COMMENT ON TABLE tb_cad_mtmd_filial                            IS 'FilialMatMed';
COMMENT ON COLUMN tb_cad_mtmd_filial.cad_mtmd_filial_descricao IS 'DsFilial';
COMMENT ON COLUMN tb_cad_mtmd_filial.cad_mtmd_filial_id        IS 'Idt';


INSERT INTO SGS.TB_CAD_MTMD_FILIAL
(CAD_MTMD_FILIAL_ID,CAD_MTMD_FILIAL_DESCRICAO)
VALUES
(1,'HAC');
INSERT INTO SGS.TB_CAD_MTMD_FILIAL
(CAD_MTMD_FILIAL_ID,CAD_MTMD_FILIAL_DESCRICAO)
VALUES
(2,'ACS');
INSERT INTO SGS.TB_CAD_MTMD_FILIAL
(CAD_MTMD_FILIAL_ID,CAD_MTMD_FILIAL_DESCRICAO)
VALUES
(3,'AMBOS');


--========= CONTROLE DE ESTOQUE ================================================
-- 23/01 
-- DROP TABLE SGS.TB_MTMD_ESTOQUE_LOCAL
CREATE TABLE SGS.TB_MTMD_ESTOQUE_LOCAL (
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  CAD_UNI_ID_UNIDADE NUMERIC NOT NULL,  
  CAD_LAT_ID_LOCAL_ATENDIMENTO NUMERIC NOT NULL,  
  CAD_SET_ID NUMERIC NOT NULL,
  CAD_MTMD_FILIAL_ID NUMERIC(1) NOT NULL,  
  MTMD_ESTLOC_DATA DATE NOT NULL,
  MTMD_ESTLOC_QTDE NUMBER(15) NULL,
  MTMD_ESTLOC_QTDE_FRACIONADA NUMBER NULL,
  MTMD_LOTEST_ID NUMERIC(10) ,  
  MTMD_ESTLOC_FL_PADRAO NUMBER(1),
  PRIMARY KEY(CAD_MTMD_ID, CAD_UNI_ID_UNIDADE, CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_SET_ID, CAD_MTMD_FILIAL_ID )
);
-- ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL MODIFY CAD_MTMD_FILIAL_ID NUMBER(1)
-- ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL ADD MTMD_ESTLOC_QTDE_FRACIONADA NUMBER
-- ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL ADD MTMD_ESTLOC_FL_PADRAO NUMBER(1)
-- ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL
-- ADD CONSTRAINT SGS_ESTLOCAL_LOTE FOREIGN KEY (MTMD_LOTEST_ID, CAD_MTMD_ID)
-- REFERENCES SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE (MTMD_LOTEST_ID, CAD_MTMD_ID);

ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL
 ADD CONSTRAINT SGS_ESTLOCAL_MATMED FOREIGN KEY (CAD_MTMD_ID)
  REFERENCES SGS.TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);

ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL
 ADD CONSTRAINT SGS_ESTLOCAL_FILIAL FOREIGN KEY (CAD_MTMD_FILIAL_ID)
  REFERENCES SGS.TB_CAD_MTMD_FILIAL (CAD_MTMD_FILIAL_ID);

ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL
 ADD CONSTRAINT SGS_ESTLOC_SETOR FOREIGN KEY (CAD_SET_ID)
  REFERENCES SGS.TB_CAD_SET_SETOR (CAD_SET_ID);

ALTER TABLE SGS.TB_MTMD_ESTOQUE_LOCAL
 ADD CONSTRAINT SGS_ESTLOC_LOC_UNI FOREIGN KEY (CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_UNI_ID_UNIDADE)
  REFERENCES SGS.TB_ASS_ULO_UNID_LOCAL (CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_UNI_ID_UNIDADE);
  


COMMENT ON TABLE SGS.TB_MTMD_ESTOQUE_LOCAL                               IS 'EstoqueLocal';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.CAD_LAT_ID_LOCAL_ATENDIMENTO IS 'IdtLocal';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.CAD_MTMD_FILIAL_ID           IS 'IdtFilial';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.CAD_MTMD_ID                  IS 'IdtProduto';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.CAD_SET_ID                   IS 'IdtSetor';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.CAD_UNI_ID_UNIDADE           IS 'IdtUnidade';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.MTMD_ESTLOC_DATA             IS 'DataAtualizacao';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.MTMD_ESTLOC_QTDE             IS 'Qtde';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.MTMD_LOTEST_ID               IS 'IdtLote';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_LOCAL.MTMD_ESTLOC_FL_PADRAO        IS 'FlProdutoPadrao';
  

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_ESTOQUE_LOCAL TO SGS  
--==================================================================================================
-- drop table SGS.TB_MTMD_ESTOQUE_CONTABIL
CREATE TABLE SGS.TB_MTMD_ESTOQUE_CONTABIL (
  CAD_MTMD_ID NUMBER(10) NOT NULL,
  CAD_MTMD_FILIAL_ID NUMBER(1) NOT NULL,
  MTMD_ESTCON_DT_ATUALIZACAO DATE NOT NULL,
  MTMD_ESTCON_QTDE NUMBER(15) NULL,
  MTMD_CUSTO_MEDIO NUMBER(15,2),
  PRIMARY KEY(CAD_MTMD_ID, CAD_MTMD_FILIAL_ID)
);  

-- ALTER TABLE TB_MTMD_ESTOQUE_CONTABIL ADD MTMD_CUSTO_MEDIO NUMBER(15,2)
-- ALTER TABLE SGS.TB_MTMD_ESTOQUE_CONTABIL MODIFY CAD_MTMD_FILIAL_ID NUMBER(1)
ALTER TABLE SGS.TB_MTMD_ESTOQUE_CONTABIL
 ADD CONSTRAINT SGS_ESTCONT_FILIAL FOREIGN KEY (CAD_MTMD_FILIAL_ID)
  REFERENCES SGS.TB_CAD_MTMD_FILIAL (CAD_MTMD_FILIAL_ID);

ALTER TABLE SGS.TB_MTMD_ESTOQUE_CONTABIL
 ADD CONSTRAINT SGS_ESTCON_MATMED FOREIGN KEY (CAD_MTMD_ID)
  REFERENCES SGS.TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);
  
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_ESTOQUE_CONTABIL TO SGS

COMMENT ON TABLE SGS.TB_MTMD_ESTOQUE_CONTABIL                             IS 'EstoqueContabil';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_CONTABIL.CAD_MTMD_FILIAL_ID         IS 'IdtFilial';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_CONTABIL.CAD_MTMD_ID                IS 'IdtProduto';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_CONTABIL.MTMD_ESTCON_DT_ATUALIZACAO IS 'DtAtualizacao';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_CONTABIL.MTMD_ESTCON_QTDE           IS 'EstoqueQtde';
COMMENT ON COLUMN SGS.TB_MTMD_ESTOQUE_CONTABIL.MTMD_CUSTO_MEDIO           IS 'CustoMedio';

--==================================================================================================
-- DROP TABLE SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE
CREATE TABLE SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE (
  MTMD_LOTEST_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  MTMD_NUM_LOTE VARCHAR2(50) NOT NULL,
  MTMD_DT_VALIDADE DATE NULL,
  MTMD_DT_ENTRADA DATE NULL,
  MTMD_DT_FABRICACAO DATE NULL,
  MTMD_IDLOTE_RM NUMERIC NULL,
--   MTMD_NOTA_FISCAL VARCHAR2(35),
  MTMD_DATA_ATUALIZADO DATE
  PRIMARY KEY(MTMD_LOTEST_ID, CAD_MTMD_ID)
);
-- NAO EXISTE CONTROLE DE NOTA FISCAL NO LOTE 


-- ALTER TABLE SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE ADD MTMD_NOTA_FISCAL VARCHAR2(35)
-- ALTER TABLE SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE ADD MTMD_DATA_ATUALIZADO DATE

CREATE Unique INDEX SGS.MTMD_LOTE_FARICANTE ON SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE (  CAD_MTMD_ID ASC ,  MTMD_NUM_LOTE ASC  ) 

ALTER TABLE SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE
 ADD CONSTRAINT SGS_LOTE_MATMED FOREIGN KEY (CAD_MTMD_ID)
  REFERENCES SGS.TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);

CREATE SEQUENCE SGS.SEQ_MTMD_LOTE
GRANT SELECT, ALTER ON SGS.SEQ_MTMD_LOTE TO SGS

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE TO SGS


COMMENT ON TABLE SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE                     IS 'LoteMatMed';
COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.CAD_MTMD_ID        IS 'IdtProduto';
COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.MTMD_DT_ENTRADA    IS 'DtEntrada';
COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.MTMD_DT_FABRICACAO IS 'DtFabricacao';
COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.MTMD_DT_VALIDADE   IS 'DtValidade';
COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.MTMD_IDLOTE_RM     IS 'IdtLoteRm';
COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.MTMD_LOTEST_ID     IS 'Idt';
COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.MTMD_NUM_LOTE      IS 'NumLote';
-- COMMENT ON COLUMN SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE.MTMD_NOTA_FISCAL   IS 'NumNotaFiscal';

--=================================================================================================

CREATE TABLE SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO (
  CAD_MTMD_TPMOV_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_TPMOV_DESCRICAO VARCHAR2(15) NULL,
  PRIMARY KEY(CAD_MTMD_TPMOV_ID)
);

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO TO SGS


COMMENT ON TABLE SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO                           IS 'TipoMovimentoMatMed'
COMMENT ON COLUMN SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO.CAD_MTMD_TPMOV_DESCRICAO IS 'DsTipoMovimento'
COMMENT ON COLUMN SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO.CAD_MTMD_TPMOV_ID        IS 'Idt'

INSERT INTO SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO
(CAD_MTMD_TPMOV_ID,CAD_MTMD_TPMOV_DESCRICAO)
VALUES
(1,'ENTRADA');

INSERT INTO SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO
(CAD_MTMD_TPMOV_ID,CAD_MTMD_TPMOV_DESCRICAO)
VALUES
(2,'SAIDA');

-- =====================================================
-- drop table SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO
CREATE TABLE SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO (
  CAD_MTMD_SUBTP_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_TPMOV_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_SUBTP_DESCRICAO VARCHAR2(50) NULL,
  PRIMARY KEY(CAD_MTMD_SUBTP_ID, CAD_MTMD_TPMOV_ID)
);

ALTER TABLE SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO
 ADD CONSTRAINT SGS_TIPO_MOVIMENTACAO FOREIGN KEY (CAD_MTMD_TPMOV_ID)
  REFERENCES SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO (CAD_MTMD_TPMOV_ID);
  
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO TO SGS  


COMMENT ON TABLE SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO IS 'SubTipoMovimentoMatMed';
COMMENT ON COLUMN SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO.CAD_MTMD_SUBTP_DESCRICAO IS 'DsSubTipoMovimento';
COMMENT ON COLUMN SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO.CAD_MTMD_SUBTP_ID        IS 'Idt';
COMMENT ON COLUMN SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO.CAD_MTMD_TPMOV_ID        IS 'TipoMovimentoIdt';


INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(7,1,'ENTRADA RESSUP.EST. CENTRAL -> SETOR (PED. PADRAO)')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(8,2,'BAIXA RESSUP. EST. CENTRAL-> SETOR (PED. PADRAO)')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(9,1,'ENTRADA PED. PERSONALIZADO EST. CENTRAL -> SETOR')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(10,2,'BAIXA PED. PERSONALIZADO EST. CENTRAL -> SETOR')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(11,2,'BAIXA NO SETOR CONSUMO PACIENTE')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(12,2,'BAIXA EST. CENTRAL. APLICAÇÃO DIRETA')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(13,1,'ENTRADA ESTORNO LANÇAMENTO')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(14,2,'MOVIMENTAÇÃO FRACIONADA')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(1,1,'ENTRADA MERCADORIA FORNECEDOR')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(2,1,'TRANSFERÊNCIA - ENTRADA')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(3,2,'TRANSFERÊNCIA - SAIDA')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(4,1,'RESSUPRIMENTO EST.  CENTRAL->SETOR (REQ AVULSO)')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(5,2,'BAIXA RESSUP. EST. CENTRAL-> SETOR (PED. AVULSO)')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(6,2,'BAIXA POR PERDA/QUEBRA')
/
INSERT INTO TB_CAD_MTMD_SUBTP_MOVIMENTACAO
(CAD_MTMD_SUBTP_ID,CAD_MTMD_TPMOV_ID,CAD_MTMD_SUBTP_DESCRICAO)
VALUES
(15,2,'BAIXA ESTORNO NOTA FISCAL')
/



--=================================================================================================
-- DROP TABLE SGS.TB_MTMD_PEDIDO_PADRAO

CREATE TABLE SGS.TB_MTMD_PEDIDO_PADRAO (
  MTMD_PEDPAD_ID NUMERIC NOT NULL,
  CAD_MTMD_FILIAL_ID NUMERIC(1) NOT NULL,
  CAD_SET_ID NUMERIC NOT NULL,
  CAD_LAT_ID_LOCAL_ATENDIMENTO NUMERIC NOT NULL,
  CAD_UNI_ID_UNIDADE NUMERIC NOT NULL,
  SEG_USU_ID_USUARIO NUMERIC NOT NULL,
  MTMD_FL_STATUS NUMERIC(1) NULL,
  MTMD_PERIODO_DIAS NUMERIC NULL,
  MTMD_DT_RESSUPRIMENTO DATE NULL,
  PRIMARY KEY(MTMD_PEDPAD_ID)
);

-- ALTER TABLE SGS.TB_MTMD_PEDIDO_PADRAO MODIFY CAD_MTMD_FILIAL_ID NUMBER(1)
-- alter table SGS.TB_MTMD_PEDIDO_PADRAO add MTMD_DT_RESSUPRIMENTO DATE

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_PEDIDO_PADRAO TO SGS

COMMENT ON TABLE SGS.TB_MTMD_PEDIDO_PADRAO                               IS 'PedidoPadrao';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.MTMD_PEDPAD_ID               IS 'Idt';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.CAD_LAT_ID_LOCAL_ATENDIMENTO IS 'IdtLocal';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.CAD_MTMD_FILIAL_ID           IS 'IdtFilial';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.CAD_SET_ID                   IS 'Idtsetor';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.CAD_UNI_ID_UNIDADE           IS 'IdtUnidade';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.MTMD_PERIODO_DIAS            IS 'Periodo';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.MTMD_DT_RESSUPRIMENTO        IS 'DataDispensado';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.MTMD_FL_STATUS               IS 'Status';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO.SEG_USU_ID_USUARIO           IS 'IdtUsuario';


--=============================
DROP TABLE SGS.TB_MTMD_PEDIDO_PADRAO_ITENS
CREATE TABLE SGS.TB_MTMD_PEDIDO_PADRAO_ITENS (
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  MTMD_PEDPAD_ID NUMERIC NOT NULL,
  MTMD_PEDPAD_QTDE NUMERIC(10) NULL,
  MTMD_PEDPAD_PERCENT_RESSUP NUMERIC(3) NULL,
  PRIMARY KEY(CAD_MTMD_ID, MTMD_PEDPAD_ID)
);

COMMENT ON TABLE SGS.TB_MTMD_PEDIDO_PADRAO_ITENS                               IS 'PedidoPadraoItens';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO_ITENS.MTMD_PEDPAD_ID               IS 'IdtPedidoPadrao';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO_ITENS.CAD_MTMD_ID                  IS 'IdtProduto';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO_ITENS.MTMD_PEDPAD_QTDE             IS 'Qtde';
COMMENT ON COLUMN SGS.TB_MTMD_PEDIDO_PADRAO_ITENS.MTMD_PEDPAD_PERCENT_RESSUP   IS 'PercentualRessuprimento';


ALTER TABLE SGS.TB_MTMD_PEDIDO_PADRAO_ITENS
 ADD CONSTRAINT SGS_PEDIDO_PADRAO FOREIGN KEY (MTMD_PEDPAD_ID)
  REFERENCES SGS.TB_MTMD_PEDIDO_PADRAO (MTMD_PEDPAD_ID);
  
ALTER TABLE SGS.TB_MTMD_PEDIDO_PADRAO_ITENS
 ADD CONSTRAINT SGS_PRODUTO FOREIGN KEY (CAD_MTMD_ID)
  REFERENCES SGS.TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);
  
--=================================================================================================  
  
-- DROP TABLE TB_MTMD_HISTORICO_NOTA_FISCAL;
CREATE TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL (
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_FILIAL_ID NUMERIC(1) NOT NULL,
  MTMD_LOTEST_ID NUMBER(10) NOT NULL,
  MTMD_NR_NOTA VARCHAR(35) NOT NULL,
  MTMD_CUSTO_MEDIO NUMERIC(15,2) NULL,
  MTMD_DATA_PRC_MEDIO DATE NOT NULL,
  MTMD_QTDE NUMERIC NULL,
  MTMD_PRECO_UNITARIO NUMERIC(15,2) NULL,
  MTMD_ESTCON_QTDE_ANTERIOR NUMBER(15),
  IDMOV       NUMBER(10),      -- IDENTIFICAÇÃO DO MOVIMENTO
  CODCOLIGADA NUMBER(5), -- COLIGADA RM
  IDSEQMOVRM  NUMBER      -- SEQUENCIA DO ITEM NO LANÇAMENTO DO RM
  DTMOV       DATE,            -- DATA DO MOVIMENTO RM  
-- PRIMARY KEY(CAD_MTMD_ID, CAD_MTMD_FILIAL_ID, MTMD_NR_NOTA)  
PRIMARY KEY(CAD_MTMD_ID, CAD_MTMD_FILIAL_ID, MTMD_NR_NOTA, MTMD_LOTEST_ID )
);


ALTER TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL
 ADD CONSTRAINT SGS_HIST_NOTA_LOTE FOREIGN KEY (MTMD_LOTEST_ID, CAD_MTMD_ID)
  REFERENCES SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE (MTMD_LOTEST_ID, CAD_MTMD_ID);

ALTER TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL
 ADD CONSTRAINT SGS_HIST_NOTA_FILIAL FOREIGN KEY (CAD_MTMD_FILIAL_ID)
  REFERENCES SGS.TB_CAD_MTMD_FILIAL (CAD_MTMD_FILIAL_ID);

ALTER TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL
 ADD CONSTRAINT SGS_PRODUTO_HIST_NOTA FOREIGN KEY (CAD_MTMD_ID)
  REFERENCES SGS.TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);
  
CREATE Unique INDEX SGS.HIST_NOTA_ITENS_RM  ON SGS.TB_MTMD_HISTORICO_NOTA_FISCAL ( CAD_MTMD_ID, CAD_MTMD_FILIAL_ID, IDMOV, CODCOLIGADA, IDSEQMOVRM, MTMD_NR_NOTA  ) 
-- ALTER TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL RENAME COLUMN MTMD_ESTCON_QTDE TO MTMD_ESTCON_QTDE_ANTERIOR
-- DROP INDEX SGS.HIST_NOTA_ITENS_RM
-- ALTER TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL ADD MTMD_ESTCON_QTDE NUMBER(15)
-- ALTER TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL ADD IDSEQMOVRM NUMBER
-- ALTER TABLE SGS.TB_MTMD_HISTORICO_NOTA_FISCAL RENAME COLUMN MTMD_PRECO_MEDIO TO MTMD_CUSTO_MEDIO
--=================================================================================================
CREATE TABLE SGS.TB_ASS_MTMD_CODIGO_BARRA (
  CAD_MTMD_ID NUMERIC(10) NOT NULL,
  CAD_MTMD_FILIAL_ID NUMERIC(1) NOT NULL,
  MTMD_LOTEST_ID NUMERIC(10) NOT NULL,
  MTM_CD_BARRA VARCHAR(60) NOT NULL,
  PRIMARY KEY(CAD_MTMD_ID, CAD_MTMD_FILIAL_ID, MTMD_LOTEST_ID)
);

-- ALTER TABLE SGS.TB_ASS_MTMD_CODIGO_BARRA MODIFY CAD_MTMD_FILIAL_ID NUMBER(1)
ALTER TABLE SGS.TB_ASS_MTMD_CODIGO_BARRA
 ADD CONSTRAINT SGS_ESTLOCAL_CDBARRA FOREIGN KEY (CAD_MTMD_ID)
  REFERENCES SGS.TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);


ALTER TABLE SGS.TB_ASS_MTMD_CODIGO_BARRA
 ADD CONSTRAINT SGS_ESTLOC_FILIAL FOREIGN KEY (CAD_MTMD_FILIAL_ID)
  REFERENCES SGS.TB_CAD_MTMD_FILIAL (CAD_MTMD_FILIAL_ID);


ALTER TABLE SGS.TB_ASS_MTMD_CODIGO_BARRA
 ADD CONSTRAINT SGS_LOTE FOREIGN KEY (MTMD_LOTEST_ID, CAD_MTMD_ID )
  REFERENCES SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE (MTMD_LOTEST_ID, CAD_MTMD_ID);


COMMENT ON TABLE SGS.TB_ASS_MTMD_CODIGO_BARRA                         IS 'CodigoBarra';
COMMENT ON COLUMN SGS.TB_ASS_MTMD_CODIGO_BARRA.CAD_MTMD_FILIAL_ID     IS 'IdtFilial';
COMMENT ON COLUMN SGS.TB_ASS_MTMD_CODIGO_BARRA.CAD_MTMD_ID            IS 'IdtProduto';
COMMENT ON COLUMN SGS.TB_ASS_MTMD_CODIGO_BARRA.MTM_CD_BARRA           IS 'CdBarra';
COMMENT ON COLUMN SGS.TB_ASS_MTMD_CODIGO_BARRA.MTMD_LOTEST_ID         IS 'IdtLote';


GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_ASS_MTMD_CODIGO_BARRA TO SGS


-- GERADOR =========================================================================================

CREATE TABLE SGS.TB_XGERADOR (
   ID_GERADOR NUMBER NOT NULL,
   NM_GERADOR VARCHAR 
);

CREATE TABLE SGS.XGERADOR_ITENS (
   ID_GERADOR NUMBER NOT NULL,
   ID_ITEM_GERADOR NUMBER NOT NULL,
   MODELO NUMBER(1), -- DTO, INTERFACE, CONTROL, MODEL,
   FIELDNAME VARCHAR2(50), -- 
   ATRIBUTO VARCHAR2(50), -- nome da coluna
   TIPO_DADO NUMBER(1) -- Decimal,String,Date
   );
--=================================================================================================

--=================================================================================================

create table SGS.TB_MTMD_MATMED_CONFIG
(
  CAD_LAT_ID_LOCAL_ATENDIMENTO INTEGER not null,
  CAD_UNI_ID_UNIDADE           INTEGER not null,
  CAD_SET_ID                   INTEGER not null,
  CAD_MTMD_SUBGRUPO_ID         NUMBER(10) not null,
  CAD_MTMD_GRUPO_ID            NUMBER(10) not null
);

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_MATMED_CONFIG TO SGS;

comment on table SGS.TB_MTMD_MATMED_CONFIG is 'MatMedSetorConfig';
comment on column SGS.TB_MTMD_MATMED_CONFIG.CAD_LAT_ID_LOCAL_ATENDIMENTO is 'IdtLocal';
comment on column SGS.TB_MTMD_MATMED_CONFIG.CAD_UNI_ID_UNIDADE is 'IdtUnidade';
comment on column SGS.TB_MTMD_MATMED_CONFIG.CAD_SET_ID is 'Idtsetor';
comment on column SGS.TB_MTMD_MATMED_CONFIG.CAD_MTMD_SUBGRUPO_ID is 'IdtSubGrupo';
comment on column SGS.TB_MTMD_MATMED_CONFIG.CAD_MTMD_GRUPO_ID is 'IdtGrupo';  
  
alter table TB_MTMD_MATMED_CONFIG
add primary key (CAD_LAT_ID_LOCAL_ATENDIMENTO, CAD_UNI_ID_UNIDADE, CAD_SET_ID, CAD_MTMD_SUBGRUPO_ID, CAD_MTMD_GRUPO_ID)
using index 
tablespace SGS_DADOS
pctfree 10
initrans 2
maxtrans 255
storage
(
initial 64K
minextents 1
maxextents unlimited
);
alter table TB_MTMD_MATMED_CONFIG
  add constraint SGS_SETOR_ID foreign key (CAD_SET_ID)
  references TB_CAD_SET_SETOR (CAD_SET_ID);
alter table TB_MTMD_MATMED_CONFIG
  add constraint SGS_SUBGRUPO_ID foreign key (CAD_MTMD_SUBGRUPO_ID, CAD_MTMD_GRUPO_ID)
  references TB_CAD_MTMD_SUBGRUPO (CAD_MTMD_SUBGRUPO_ID, CAD_MTMD_GRUPO_ID);

--=================================================================================================

ALTER TABLE SGS.TB_CAD_SET_SETOR ADD CAD_SET_UNIDADE_ALMOX NUMBER
ALTER TABLE SGS.TB_CAD_SET_SETOR ADD CAD_SET_LOCAL_ALMOX NUMBER
ALTER TABLE SGS.TB_CAD_SET_SETOR ADD CAD_SET_SETOR_ALMOX NUMBER
ALTER TABLE SGS.TB_CAD_SET_SETOR ADD CAD_SET_ALMOX_CENTRAL NUMBER DEFAULT 0;


ALTER TABLE TB_CAD_UNI_UNIDADE ADD CAD_UNI_DS_UNIDADE VARCHAR2(100)


GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON HOSPITAL.TB_INTERNADO TO SGS
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON HOSPITAL.TB_TRANSFERENCIA TO SGS
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON HOSPITAL.TCONTROLE_LOTE TO SGS

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_MAT_MED TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_SET_SETOR TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_HISTORICO_NOTA_FISCAL TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_ESTOQUE_CONTABIL TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_MOV_MOVIMENTACAO TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_ESTOQUE_LOCAL TO RM;
GRANT SELECT, ALTER ON SGS.SEQ_MTMD_LOTE TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_LOTEST_LOTE_ESTOQUE TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_TIPO_MOVIMENTACAO TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_CAD_MTMD_SUBTP_MOVIMENTACAO TO RM;
GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON TB_MTMD_HISTORICO_NOTA_FISCAL TO RM

GRANT EXECUTE ON SGS.PRC_MTMD_MOV_ESTOQUE_ENTRADA TO RM;
GRANT EXECUTE ON FNC_MTMD_CALCULA_CUSTO_MEDIO TO RM;
GRANT EXECUTE ON PRC_MTMD_MOV_ESTOQUE_ESTORNONF TO RM;
SELECT * FROM ALL_TABLES WHERE TABLE_NAME LIKE '%MTMD%'

--=================================================================================================

-- Create table
create table TB_MTMD_MOV_INTERNADO
(
  ATD_ATE_ID   NUMBER not null,
  SEQ_PACIENTE NUMBER(4) not null,
  MTMD_MOV_ID  NUMBER(10) not null,
  CAD_MTMD_ID  NUMBER(10) not null,
  CAD_MTMD_FL_EXCLUIDO NUMBER(1) not null
)
tablespace SGS_DADOS
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    minextents 1
    maxextents unlimited
  );
-- Add comments to the table 
comment on table TB_MTMD_MOV_INTERNADO
  is 'MovimentoInternado';
-- Add comments to the columns 
comment on column TB_MTMD_MOV_INTERNADO.ATD_ATE_ID
  is 'IdtAtendimento';
comment on column TB_MTMD_MOV_INTERNADO.SEQ_PACIENTE
  is 'SeqPaciente';
comment on column TB_MTMD_MOV_INTERNADO.MTMD_MOV_ID
  is 'IdtMovimento';
comment on column TB_MTMD_MOV_INTERNADO.CAD_MTMD_ID
  is 'IdtProduto';
comment on column TB_MTMD_MOV_INTERNADO.CAD_MTMD_FL_EXCLUIDO
  is 'FlExcluido';
-- Create/Recreate primary, unique and foreign key constraints 
alter table TB_MTMD_MOV_INTERNADO
  add constraint PRIM_MOV_INTERNADO primary key (ATD_ATE_ID, SEQ_PACIENTE)
  using index 
  tablespace SGS_DADOS
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    minextents 1
    maxextents unlimited
  );
alter table TB_MTMD_MOV_INTERNADO
  add constraint FOR_MOV_INTERNADO1 foreign key (MTMD_MOV_ID)
  references TB_MTMD_MOV_MOVIMENTACAO (MTMD_MOV_ID);
alter table TB_MTMD_MOV_INTERNADO
  add constraint FOR_MOV_INTERNADO2 foreign key (CAD_MTMD_ID)
  references TB_CAD_MTMD_MAT_MED (CAD_MTMD_ID);

GRANT SELECT, UPDATE, DELETE, INSERT, REFERENCES ON SGS.TB_MTMD_MOV_INTERNADO TO SGS;