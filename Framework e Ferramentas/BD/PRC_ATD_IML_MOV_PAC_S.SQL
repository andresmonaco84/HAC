create or replace procedure PRC_ATD_IML_MOV_PAC_S
(
  pATD_ATE_ID                         IN TB_ATD_IML_INT_MOV_LEITO.ATD_ATE_ID%TYPE,
  pTIS_TAC_CD_TIPO_ACOMODACAO         IN TB_ATD_IML_INT_MOV_LEITO.TIS_TAC_CD_TIPO_ACOMODACAO%TYPE DEFAULT NULL,
  pCAD_PAC_ID_PACIENTE                IN TB_ATD_IML_INT_MOV_LEITO.CAD_PAC_ID_PACIENTE%TYPE DEFAULT NULL,
  io_cursor                     OUT PKG_CURSOR.t_cursor
)
  is
  /********************************************************************
  *    Procedure: PRC_ATD_IML_MOV_PAC_S
  *
  *    Data Criacao:   02/06/2011          Por: Fabiola Lopes
  *    Data Alteracao:                     Por:
  *
  *    Funcao: Listar a movimentacao do paciente atual
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
BEGIN
  OPEN V_CURSOR FOR
 SELECT IML.ATD_ATE_ID,
        IML.ATD_IML_DT_ENTRADA,
        IML.ATD_IML_HR_ENTRADA,
        IML.ATD_IML_DT_SAIDA,
        IML.ATD_IML_HR_SAIDA,
        IML.CAD_CAD_QLE_ID,
        IML.ATD_IML_DT_ULTIMA_ATUALIZACAO,
        IML.SEG_USU_ID_USUARIO,
        IML.CAD_PAC_ID_PACIENTE,
        IML.TIS_TAC_CD_TIPO_ACOMODACAO,
        IML.ATD_IML_FL_STATUS,
        IML.ATD_IML_FL_CORTESIA,
        IML.ATD_IML_FL_DIF_CLASSE,
        IML.ATD_IML_ID,
        IML.ATD_IML_FL_FALTA_VAGA,
        IML.TIS_TAC_CD_TIPO_ACOMOD_AUT,
        IML.ATD_IML_DT_INI_ACOMOD_AUT,
        IML.ATD_IML_HR_INI_ACOMOD_AUT

   FROM TB_ATD_IML_INT_MOV_LEITO IML,
        TB_ASS_PAT_PACIEATEND PAT

  WHERE IML.ATD_ATE_ID = PAT.ATD_ATE_ID
    AND PAT.ASS_PAT_DT_SAIDA IS NULL
    AND PAT.ASS_PAT_HR_SAIDA IS NULL
    AND IML.ATD_IML_DT_ENTRADA >= PAT.ASS_PAT_DT_ENTRADA
    AND (IML.ATD_IML_DT_SAIDA >= PAT.ASS_PAT_DT_ENTRADA OR IML.ATD_IML_DT_SAIDA IS NULL)
    AND IML.ATD_IML_HR_ENTRADA >= PAT.ASS_PAT_HR_ENTRADA
    AND (IML.ATD_IML_HR_SAIDA >= PAT.ASS_PAT_HR_ENTRADA OR IML.ATD_IML_HR_SAIDA IS NULL)
    AND IML.ATD_ATE_ID = pATD_ATE_ID
    AND (pTIS_TAC_CD_TIPO_ACOMODACAO IS NULL OR IML.TIS_TAC_CD_TIPO_ACOMODACAO = pTIS_TAC_CD_TIPO_ACOMODACAO)
    AND IML.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE;

  IO_CURSOR := V_CURSOR;
END PRC_ATD_IML_MOV_PAC_S;