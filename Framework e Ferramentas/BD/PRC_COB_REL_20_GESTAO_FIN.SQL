CREATE OR REPLACE PROCEDURE PRC_COB_REL_20_GESTAO_FIN
  (
    PCAD_UNI_ID_UNIDADE IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
    PCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
    PCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    PCAD_PLA_ID_PLANO IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%TYPE DEFAULT NULL,
    PDATA_EMISSAO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    PDATA_EMISSAO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    PDATA_VENCIMENTO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    PDATA_VENCIMENTO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    PDATA_PAGTO_INI  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    PDATA_PAGTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    PCAD_BAN_ID IN TB_CAD_BAN_BANCO.CAD_BAN_ID%TYPE DEFAULT NULL,
    PASS_BCT_ID IN TB_COB_MGC_MOV_GUIA_COBRANCA.ASS_BCT_ID%TYPE DEFAULT NULL,
    PPENDETE_CONTABILIDADE   VARCHAR2 DEFAULT NULL,
    PENVIADO_CONTABILIDADE   VARCHAR2 DEFAULT NULL,
    PCAD_TPE_CD_CODIGO_ACS IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    PCAD_TPE_CD_CODIGO_FU IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    PCAD_TPE_CD_CODIGO_PA IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    PCAD_TPE_CD_CODIGO_SP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    PCAD_TPE_CD_CODIGO_NP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
     PDATA_CONTAB_INI     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    PDATA_CONTAB_FIM     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    PDATA_MOVIMENTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    PFAT_NOF_NR_NOTAFISCAL   IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_NR_NOTAFISCAL%TYPE DEFAULT NULL,
    PFAT_NOF_TP_SERIEFISCAL  IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_TP_SERIEFISCAL%TYPE DEFAULT NULL,
     IO_CURSOR OUT PKG_CURSOR.T_CURSOR
  )
  IS
  /********************************************************************
  *    PROCEDURE: PRC_COB_REL_20_GESTAO_FIN
  *
  *    DATA CRIAC?O: 07/10/2013  POR: PEDRO
  *    ALTERACAO:
  * AND    (PDATA_CONTAB_INI IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI)
  * AND    (PDATA_CONTAB_FIM IS NULL OR MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM)
  *******************************************************************/
  V_CURSOR PKG_CURSOR.T_CURSOR;
  -- A     CONSTANT VARCHAR2(3) := '410';
  BEGIN
    OPEN V_CURSOR FOR
----*********************************************************************
----==================================================================
--- sgs
-- NF SGS CARTEIRA
SELECT 'SGS FATURAMENTO NF' SISTEMA,
       SUM( CCP.COB_CCP_VL_TOT_CONTA )  VALORENTRADA , 0.00 VALORSAIDA
  FROM TB_COB_CCP_CONTA_CONS_PARC CCP,
       TB_FAT_NOF_NOTA_FISCAL NOF
 WHERE CCP.FAT_NOF_ID = NOF.FAT_NOF_ID
   AND NOF.FAT_NFO_DT_EMISSAO  >= PDATA_CONTAB_INI
   AND NOF.FAT_NFO_DT_EMISSAO <= PDATA_CONTAB_FIM
UNION ALL
--ISS SGS CARTEIRA
SELECT 'SGS FATURAMENTO ISS NF' SISTEMA,
       0.00 VALORENTRADA,
       SUM(  NVL(CCP.COB_CCP_VL_ISS_FATURADO ,0) ) VL_ISS
 FROM TB_COB_CCP_CONTA_CONS_PARC CCP,
      TB_FAT_NOF_NOTA_FISCAL     NOF
WHERE CCP.FAT_NOF_ID = NOF.FAT_NOF_ID
  AND NOF.FAT_NFO_DT_EMISSAO  >= PDATA_CONTAB_INI
  AND NOF.FAT_NFO_DT_EMISSAO <= PDATA_CONTAB_FIM
---------------------------------------------
UNION ALL
----------------------------------------------------------------------------------------
--- PAGTO CARTEIRA SGS
 SELECT SISTEMA,VALORENTRADA,  SUM(VLRECEBIDO)
--- foi o reprocessamento do fusex solicitado pelo financeiro 10-07-2014
--- case  --   when sistema = 'SGS CARTEIRA BX NAO IDENT MESES ANTERIORES'
---         then  ---              879563.67
---   else
---        SUM(VLRECEBIDO)
---    end     VLRECEBIDO
FROM (
---------------------------------------------------------------------------------------------
--- essas notas eram de vencto 2011 e teve movimento normal  em julho/2014
--- o saldo dessas notas foram baixas autorizadas e foram movidas para o historico
SELECT CASE WHEN TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO, 'MMYYYY') = TO_CHAR(MGC.COB_MGC_DT_LIBERACAO_CONTAB, 'MMYYYY') THEN 'SGS CARTEIRA BX NAO IDENT MES' ELSE
                                                                             'SGS CARTEIRA BX NAO IDENT MESES ANTERIORES' END SISTEMA,
      0.00 VALORENTRADA,
      SUM(  NVL( MGC.COB_MGC_VL_MOVIMENTO,0) )  VLRECEBIDO
FROM TB_COB_MGC_COBRANCA_HISTORICO MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
     and to_date('31-07-2014', 'dd-mm-yyyy' ) =  PDATA_CONTAB_FIM -- para o mes de julho/2014
  AND MGC.CAD_TMC_ID IN (  1 , 6, 18 )
AND mgc.fat_nof_id  in ( 41706,
      21848, 52036, 52037, 19944, 34558, 39082, 48107, 41939,
     44424, 44655, 30485, 31836, 44657, 52038, 48085 )
GROUP BY CASE WHEN TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO, 'MMYYYY') = TO_CHAR(MGC.COB_MGC_DT_LIBERACAO_CONTAB, 'MMYYYY') THEN 'SGS CARTEIRA BX NAO IDENT MES' ELSE
                                                                              'SGS CARTEIRA BX NAO IDENT MESES ANTERIORES' END
--------------------------------------------------------------------------------------------------
union all
SELECT CASE WHEN TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO, 'MMYYYY') = TO_CHAR(MGC.COB_MGC_DT_LIBERACAO_CONTAB, 'MMYYYY') THEN 'SGS CARTEIRA BX NAO IDENT MES' ELSE
                                                                             'SGS CARTEIRA BX NAO IDENT MESES ANTERIORES' END SISTEMA,
      0.00 VALORENTRADA,
      SUM(  NVL( MGC.COB_MGC_VL_MOVIMENTO,0) )  VLRECEBIDO
 FROM TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  AND MGC.CAD_TMC_ID IN (  1 , 6, 18 )
GROUP BY CASE WHEN TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO, 'MMYYYY') = TO_CHAR(MGC.COB_MGC_DT_LIBERACAO_CONTAB, 'MMYYYY') THEN 'SGS CARTEIRA BX NAO IDENT MES' ELSE
                                                                               'SGS CARTEIRA BX NAO IDENT MESES ANTERIORES' END
UNION  ALL           ------------------------DIMINUI O VALOR ANTECIPADO
SELECT A.SISTEMA,
       0.00 VALORENTRADA,
       SUM(A.VALOR_ANTECIPADO) VLRECEBIDO
FROM
(SELECT CASE WHEN TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO, 'MMYYYY') = TO_CHAR(MGC.COB_MGC_DT_LIBERACAO_CONTAB, 'MMYYYY') THEN 'SGS CARTEIRA BX NAO IDENT MES' ELSE
                                                                               'SGS CARTEIRA BX NAO IDENT MESES ANTERIORES' END SISTEMA,
       SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0)) - (SUM(NVL(MGC.COB_MGC_VL_ISS,0))+SUM(NVL(MGC.COB_MGC_VL_IR,0))+SUM(NVL(MGC.COB_MGC_VL_CSLL,0))+SUM(NVL(MGC.COB_MGC_VL_PIS,0))+SUM(NVL(MGC.COB_MGC_VL_COFINS,0))) VALOR_ANTECIPADO
FROM   TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE  MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
AND    MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
AND    MGC.CAD_TMC_ID = 8
/*and   (NVL(MGC.COB_MGC_VL_MOVIMENTO,0)) = 0
AND  ((NVL(MGC.COB_MGC_VL_ISS,0))+(NVL(MGC.COB_MGC_VL_IR,0))+(NVL(MGC.COB_MGC_VL_CSLL,0))+(NVL(MGC.COB_MGC_VL_PIS,0))+(NVL(MGC.COB_MGC_VL_COFINS,0))) > 0*/
GROUP BY MGC.FAT_NOF_ID, CASE WHEN TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO, 'MMYYYY') = TO_CHAR(MGC.COB_MGC_DT_LIBERACAO_CONTAB, 'MMYYYY') THEN 'SGS CARTEIRA BX NAO IDENT MES' ELSE
                                                                               'SGS CARTEIRA BX NAO IDENT MESES ANTERIORES' END
--HAVING SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0)) = 0 AND (SUM(NVL(MGC.COB_MGC_VL_ISS,0))+SUM(NVL(MGC.COB_MGC_VL_IR,0))+SUM(NVL(MGC.COB_MGC_VL_CSLL,0))+SUM(NVL(MGC.COB_MGC_VL_PIS,0))+SUM(NVL(MGC.COB_MGC_VL_COFINS,0)) > 0)
)   A
GROUP BY A.SISTEMA
)GROUP BY SISTEMA,VALORENTRADA
-----------------------------------------------------------------------------------
UNION ALL
------------------------------------------------------------------------------------
--- GLOSAS SGS
SELECT 'SGS GLOSAS DESCONTADAS' TIPO ,
       0.00 VALORENTRADA,
       SUM( NVL(MGC.COB_MGC_VL_MOVIMENTO,0) ) VALOR
 FROM TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  AND MGC.CAD_TMC_ID = 2  --- NOTA DE CREDITO
  -----------------------------------------------------------------------------------
UNION ALL
------------------------------------------------------------------------------------
---  SGS ISS NAO RETIDO  codigo 7
SELECT 'SGS ISS NAO RETIDO' TIPO ,
       nvl(SUM( nvl (MGC.COB_MGC_VL_MOVIMENTO,0)),0) VALORENTRADA,
       0.00 VALOR
 FROM TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  AND MGC.CAD_TMC_ID = 7
---------------------------------------------------------------------
UNION ALL
---------------------------------------------------------------------
--- SGS RETENCAO DE ORGAOS PUBLICOS TEM SOMENTE NO SGS
SELECT 'SGS RETENCAO ORGAO PUBLICO -  IR' TIPO ,
        0.00  VALORENTRADA,
        SUM (   NVL(MGC.COB_MGC_VL_IR,0))  RETENCAO
 FROM TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  AND MGC.CAD_TMC_ID not in ( 9, 12 )
UNION ALL
SELECT 'SGS RETENCAO ORGAO PUBLICO - CSLL' TIPO ,
        0.00  VALORENTRADA,
          SUM( NVL(MGC.COB_MGC_VL_CSLL,0) ) RETENCAO
 FROM TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  AND MGC.CAD_TMC_ID not in ( 9, 12)
UNION ALL
SELECT 'SGS RETENCAO ORGAO PUBLICO - COFINS' TIPO ,
        0.00  VALORENTRADA,
        SUM ( NVL(MGC.COB_MGC_VL_COFINS,0)  ) RETENCAO
 FROM TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  AND MGC.CAD_TMC_ID not in ( 9, 12 )
UNION ALL
SELECT 'SGS RETENCAO ORGAO PUBLICO - PIS' TIPO ,
        0.00  VALORENTRADA,
        SUM ( NVL(MGC.COB_MGC_VL_PIS,0)) RETENCAO
 FROM TB_COB_MGC_MOV_GUIA_COBRANCA MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  AND MGC.CAD_TMC_ID not in ( 9, 12 )
-----------------------------------
----UNION ALL
----SELECT 'RM ISS NAO RETIDO' ,
----       NVL(SUM( F.VALORBAIXADO),0)  VALORBAIXADO,
----      0.00  VALORSAIDA
----FROM FLAN@@RMDB F
----WHERE F.DATABAIXA >= PDATA_CONTAB_INI
----  AND F.DATABAIXA <= PDATA_CONTAB_FIM
----AND UPPER(F.HISTORICO) LIKE '%REEMBOLSO%ISS%'
----AND F.CODCOLIGADA = 1
----AND F.CODCXA <> 'X-CPD'
----AND F.CODTB2FLX IN (  '01.01' )
------------------------------------------
UNION ALL
 -------
select 'SGS BAIXA ISS NAO RETIDO PELO CONV',sum(VALORENTRADA), sum(saida)
 from(
 select 'SGS BAIXA ISS NAO RETIDO PELO CONV',
  nvl(sum(nvl(mgc.cob_mgc_vl_iss,0)),0)  VALORENTRADA,
  0  saida
  from tb_cob_mgc_mov_guia_cobranca mgc
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  and mgc.cad_tmc_id = 10 --- BAIXA DE ISS NAO RETIDO pelo conv
 union all
 select 'SGS BAIXA ISS NAO RETIDO PELO CONV',
  nvl(sum(nvl(mgc.cob_mgc_vl_iss,0)),0) VALORENTRADA ,
  nvl(sum(nvl(mgc.cob_mgc_vl_iss,0)),0) saida  ---repetir vl na saida solicitacao Antonieta 25/11/2015
----  0   saida
  from tb_cob_mgc_mov_guia_cobranca mgc
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  and MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  and mgc.cad_tmc_id = 11 --- BAIXA DE ISS NAO RETIDO no pagto e baixa do codigo 7
  )
--------
---
/*union all
 select 'SGS BAIXA ISS NAO RETIDO NO PAGTO',
  0 entrada ,
  nvl(sum(nvl(mgc.cob_mgc_vl_iss,0)),0)   saida
  from tb_cob_mgc_mov_guia_cobranca mgc
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  and MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  and mgc.cad_tmc_id = 11 --- BAIXA DE ISS NAO RETIDO no pagto e baixa do codigo 7
*/
union all
 select 'SGS BAIXA DE VALOR PAGO A MAIOR',
  NVL(SUM(MGC.COB_MGC_VL_MOVIMENTO),0)*-1 entrada ,
  0   saida
  from tb_cob_mgc_mov_guia_cobranca mgc
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  and MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  and mgc.cad_tmc_id = 13
---
union all
--- no mes de julho2014 ajustado o valor 0.96 que nao apreceia no relatorio
--- qdo separava os valores a mario e a menor nos relatorios da contabilidade
--- comparava 0.01 ate junho em julho2014 passou a comparar omc 0.0001
-------
---APOS BAIXA DE 2011 PASSOU PARA 0.37 NO VALOR DE ENTRADA
select 'SGS CARTEIRA ARREDONDAMENTO' ,
    0.37 entrada,
    0.00 saida
from dual
where to_date('31-07-2014', 'dd-mm-yyyy' ) =  PDATA_CONTAB_FIM
----
union all
select  'SGS BAIXA AUTORIZADA'  BXAUTORIZADA,
0.00 ENTRADA,
NVL( SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0) +
                                    ----- NVL(MGC.COB_MGC_VL_ISS,0) +
                                     NVL(MGC.COB_MGC_VL_IR,0) +
                                     NVL(MGC.COB_MGC_VL_CSLL,0) +
                                     NVL(MGC.COB_MGC_VL_PIS,0) +
                                     NVL(MGC.COB_MGC_VL_COFINS,0)),0) bx_movtoSAIDA
 from tb_cob_mgc_mov_guia_cobranca mgc
-------FROM TB_COB_MGC_COBRANCA_HISTORICO MGC
WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB >= PDATA_CONTAB_INI
  and MGC.COB_MGC_DT_LIBERACAO_CONTAB <= PDATA_CONTAB_FIM
  and mgc.cad_tmc_id = 12 ---- BAIXA AUTORIZADA PELO COMERCIAL
  AND NVL( (NVL(MGC.COB_MGC_VL_MOVIMENTO,0) +
                                     NVL(MGC.COB_MGC_VL_IR,0) +
                                     NVL(MGC.COB_MGC_VL_CSLL,0) +
                                     NVL(MGC.COB_MGC_VL_PIS,0) +
                                     NVL(MGC.COB_MGC_VL_COFINS,0)),0) <> 0
UNION ALL
-------------------------------
SELECT  'SGS BAIXA N/C ISS NAO RETIDO'   ,
     0 entrada,
     1.30   saida
from dual
where to_date('31-07-2014', 'dd-mm-yyyy' ) =  PDATA_CONTAB_FIM
------------------------------
UNION ALL
---==============>  RM
---- nota fiscal
SELECT 'RM FATURAMENTO NF' SISTEMA,
       SUM(NVL(F.VALORORIGINAL,0)) VALORENTRADA , 0.00 VALORSAIDA
  FROM FLAN@RMDB F ,
       TMOV@RMDB T
WHERE F.DATAEMISSAO  >= PDATA_CONTAB_INI
  AND F.DATAEMISSAO <= PDATA_CONTAB_FIM
  AND nvl(F.CODCXA,0) <> 'X-CPD'
  AND F.CODCOLIGADA = 1
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND F.CODTB2FLX IN ('01.01' ,    ---- RECEBIMENTO DE CLIENTES CONVENIOS
                      '01.24' ,    ---- BAIXA DE CREDITO A IDENTIFICAR CONVENIO
                      '23.30' ,     ---- GLOSA DEDUZIDA EM NOTA FISCAL
                      '01.34' ,     ---- Baixa de Adiant.de Conv?nios - ACS
                      '01.32' ,      ---- Baixa de Adiant.de Conv?nios;
                      '01.35'  ,
                      '23.32'        )
AND F.CODCOLIGADA = T.CODCOLIGADA (+)
AND F.IDMOV = T.IDMOV(+)
AND T.STATUS <> 'C'
AND F.IDLAN = ( SELECT MIN(IDLAN) FROM FLAN@RMDB FF
                WHERE FF.IDMOV = T.IDMOV AND FF.CODCOLIGADA = T.CODCOLIGADA)
-------------------------------------------------
UNION ALL
-------------------------------------------------
----  NOTA FISCAL ISS
SELECT 'RM FATURAMENTO ISS NF'  SISTEMA,
       0.00 VALORENTRADA,
       SUM(NVL(F.VALOROP2,0)) VALOR_ISS
  FROM FLAN@RMDB F ,
       TMOV@RMDB T
WHERE F.DATAEMISSAO  >= PDATA_CONTAB_INI
  AND F.DATAEMISSAO <= PDATA_CONTAB_FIM
  AND nvl(F.CODCXA,0)  <> 'X-CPD'
  AND F.CODCOLIGADA = 1
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND F.CODTB2FLX IN ('01.01' ,    ---- RECEBIMENTO DE CLIENTES CONVENIOS
                      '01.24' ,    ---- BAIXA DE CREDITO A IDENTIFICAR CONVENIO
                      '23.30',      ---- GLOSA DEDUZIDA EM NOTA FISCAL
                      '01.34' ,     ---- Baixa de Adiant.de Conv?nios - ACS
                      '01.32' ,       ---- Baixa de Adiant.de Conv?nios;
                      '01.35' ,
                      '23.32'        )
AND F.IDMOV = T.IDMOV(+)
AND F.CODCOLIGADA = T.CODCOLIGADA  (+)
AND T.STATUS <> 'C'
AND F.IDLAN = ( SELECT MIN(IDLAN) FROM FLAN@RMDB FF
                WHERE FF.IDMOV = T.IDMOV AND FF.CODCOLIGADA = T.CODCOLIGADA)
----------------------------------------------------------------
UNION ALL
--- PAGTO BOLETO
SELECT 'RM BOLETO' ,
      0.00 VALORENTRADA,
      SUM( FB.VALORBAIXA) VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB, fxcx@RMDB fx
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.01' )    ---- RECEBIMENTO DE CLIENTES CONVENIOS
  and (FB.DATACANCELBAIXA IS NULL )
  and Fb.IDXCX = Fx.IDXCX
  AND FX.HISTORICO NOT LIKE 'REF.ESTORNO DE JUROS%'
  and fb.statuscontabil <> 0  ----- contabil
union all
SELECT 'RM BAIXA NAO CONTABIL( 636 )'  ,
      0.00 VALORENTRADA,
      SUM( FB.VALORBAIXA) VALORBAIXADO
---De: Walter Ricardo da Silva
---Enviada em: quinta-feira, 5 de abril de 2018 15:58
---Para: Nina Maria Bueno <nina.bueno@anacosta.com.br>;Maria da Concei??o dos Santos <maria.santos@anacosta.com.br>
---Cc: Sergio Portes <Sergio.Portes@anacosta.com.br>; Neilson Pereira Barros - Financeiro/SP <Neilson.Barros@amil.com.br>;
---Maria Aparecida Vieira de Melo <Maria.Melo@anacosta.com.br>; Amanda Tavares Passos <amanda.passos@anacosta.com.br>;
---Lourdes Del Rosso Pires <Lourdes.Pires@anacosta.com.br>
---Assunto: ACERTO DE RELATaRIOS - SALDO AMIL
---Prioridade: Alta
---Boa tarde !
---Informamos que efetuaremos "BAIXA NCO CONT?BIL" nos registros do Sistema RM Fluxus (Cobran?a-Amil)
---para regularizar relat?rios de concilia??o com a Contabilidade. Compet?ncia JAN a MAR/2018
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB, fxcx@RMDB fx , TMOV@RMDB T
WHERE F.CODCOLIGADA = 1
  AND F.IDMOV = T.IDMOV AND F.CODCOLIGADA = T.CODCOLIGADA
  AND T.CODCFO IN ('R000636','C002006')  ----- ajuste somente para Amil
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA =  'X-CPD'
  AND FB.CODTB2FLX IN (  '01.01' )
  and (FB.DATACANCELBAIXA IS NULL )
  and Fb.IDXCX = Fx.IDXCX
  AND FX.HISTORICO NOT LIKE 'REF.ESTORNO DE JUROS%'
  and fb.statuscontabil = 0   --- nao contabil
union all
SELECT 'RM ESTORNO DE JUROS' ,
      0.00 VALORENTRADA,
      nvl(SUM( FB.VALORBAIXA),0) VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB , fxcx@rmdb fx
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >=  PDATA_CONTAB_INI
  AND FB.DATABAIXA <=  PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.01' )    ---- recebimento de CLIENTES CONVENIOS com historico estorno de juros
  and (FB.DATACANCELBAIXA IS NULL )
  and Fb.IDXCX = Fx.IDXCX
  and FX.HISTORICO  LIKE 'REF.ESTORNO DE JUROS%'
----------------------------------------------------
UNION ALL
----------------------------------------------------------------------------
--- PAGTO JUROS BOLETO
SELECT 'RM JUROS BOLETO' ,
       NVL(SUM( FB.VALORJUROS),0)  VALORJUROS ,
       0.00 VALORSAIDA
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.01' )    ---- RECEBIMENTO DE CLIENTES CONVENIOS
    and (FB.DATACANCELBAIXA IS NULL )
---------------------------------------------------------------------
UNION ALL
----------------------------------------------------------------------
--- GLOSAS RM
SELECT 'RM GLOSAS DESCONTADAS' TIPO,
       0.00 VALORENTRADA,
      nvl( SUM( FB.VALORBAIXA) ,0) VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN ( '23.30' )  ----  GLOSA DEDUZIDA EM NOTA FISCAL
    and (FB.DATACANCELBAIXA IS NULL )
------
UNION ALL
------
SELECT 'RM BAIXA DE ADIANTAMENTO DE CONVENIOS'  TIPO,
      0.00 VALORENTRADA,
      SUM( FB.VALORBAIXA)  VALORBAIXADO
 FROM FLAN@RMDB F, FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA  >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND FB.CODCOLIGADA = 1
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.32','01.34' )
      and (FB.DATACANCELBAIXA IS NULL )
---
union all
----
SELECT 'RM MULTA DE BOLETO'  TIPO,
      nvl(SUM( FB.VALORMULTA),0)  ENTRADAMULTA,
      0.00 saida
 FROM FLAN@RMDB F, FLANBAIXA@RMDB FB
WHERE  F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA= FB.CODCOLIGADA
  AND FB.DATABAIXA  >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO   IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.01'  ) and nvl(fB.valormulta,0) > 0
      and (FB.DATACANCELBAIXA IS NULL )
--------------------------
UNION ALL
-- PAGTO BOLETO DESCONTOS
SELECT 'RM DESCONTOS' ,
      0.00 VALORENTRADA,
     nvl(  SUM( fB.valordesconto) ,0 )   VALORdesconto
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA =FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.01' , '01.24' , '01.34' )  ---- RECEBIMENTO DE CLIENTES CONVENIOS
  and fB.valordesconto > 0
      and (FB.DATACANCELBAIXA IS NULL )
 -------
union all
SELECT 'RM BAIXA DE CONVENIO CHEQUE PRE-DATADO'  TIPO,
      0.00 VALORENTRADA,
      SUM( FB.VALORBAIXA)  VALORBAIXADO
FROM FLAN@RMDB F , FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA =FB.CODCOLIGADA
  AND FB.DATABAIXA  >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO  NOT  IN   ( 'CD'  ) -- diferente de CONFISSAO DE DIVIDA
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.35' ) ---bx cheque pre-datado
      and (FB.DATACANCELBAIXA IS NULL )
UNION ALL
SELECT 'RM BXA CONV.ACIMA DE 15MIL VC.MAIS12M-Inded' TIPO,
      0.00 VALORENTRADA,
     nvl( SUM( FB.VALORBAIXA),0)  VALORBAIXADO
 FROM FLAN@RMDB F, FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
 AND F.IDLAN = FB.IDLAN
 AND F.CODCOLIGADA = FB.CODCOLIGADA
 AND  FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN ( '23.35' )  ----  perdas valor financeiro
      and (FB.DATACANCELBAIXA IS NULL )
  having nvl( SUM( FB.VALORBAIXA),0) <> 0
-------------------------------
UNION ALL
----------------------------------------
SELECT 'RM REEMBOLSO ISS' ,
       0.00 VALORENTRADA,
       NVL(SUM( FB.VALORBAIXA),0) VALORBAIXADO
FROM FLAN@RMDB F, flanbaixa@rmdb fb, FXCX@RMDB FX
WHERE  F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.IDXCX = FX.IDXCX
  AND FB.CODCOLIGADA = FX.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND UPPER(FX.HISTORICO) LIKE '%REEMBOLSO%ISS%'
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.01' )
      and (FB.DATACANCELBAIXA IS NULL )
      -----------------------------------------------------------------------------------
UNION ALL
------------------------------------------------------------------------------------
---  RM perdas
SELECT 'RM PERDA' TIPO,
      0.00 VALORENTRADA,
     nvl( SUM( FB.VALORPERDAFINANCEIRA),0)  VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN ( '23.32','23.33','23.34' )  ----  perdas valor financeiro
    and (FB.DATACANCELBAIXA IS NULL )
  having nvl( SUM( FB.VALORPERDAFINANCEIRA),0) <> 0
----------------------------------------------------------
UNION ALL
--- baixa autorizada RM PERDAS
SELECT 'RM PERDAS'   TIPO,
       0.00 VALORENTRADA,
       nvl( SUM(FB.Valorbaixa),0)  VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA   <= PDATA_CONTAB_FIM
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN ( '23.32','23.33','23.34' )   --- esse tipo serve para baixa autorizada e perdas
  AND to_date('31-07-2014', 'dd-mm-yyyy' ) <>  PDATA_CONTAB_FIM
      and (FB.DATACANCELBAIXA IS NULL )
GROUP BY   'RM PERDAS'
having nvl( SUM(FB.Valorbaixa),0) <> 0
union all
----01.37 - Negocia??o de Conv?nio - Acordo Tacito coluna saida
SELECT 'RM Negociacao de Convenio - Acordo Tacito' ,
       0.00 VALORENTRADA,
       NVL(SUM( FB.VALORBAIXA),0) VALORBAIXADO
FROM FLAN@RMDB F, flanbaixa@rmdb fb, FXCX@RMDB FX
WHERE  F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.IDXCX = FX.IDXCX
  AND FB.CODCOLIGADA = FX.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND FB.CODCXA = 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.37' ) ----01.37 - Negocia??o de Conv?nio - Acordo Tacito
  and (FB.DATACANCELBAIXA IS NULL )
union all
------
------
----   01.37 - Negocia??o de Conv?nio - Acordo Tacito coluna saida
SELECT 'RM Negociacao de Convenio - Acordo Tacito' ,
       0.00 VALORENTRADA,
       NVL(SUM( FB.VALORBAIXA),0) VALORBAIXADO
FROM FLAN@RMDB F, flanbaixa@rmdb fb, FXCX@RMDB FX
WHERE  F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.IDXCX = FX.IDXCX
  AND FB.CODCOLIGADA = FX.CODCOLIGADA
  and fb.codtb1flx = '007'     --- deposito Amanda email 17032017 para bx 01fevereiro 2017
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND  to_date('28-02-2017', 'dd-mm-yyyy' ) =  PDATA_CONTAB_FIM
  AND FB.CODCXA <> 'X-CPD'        ------ diferente de x-cpd
  AND FB.CODTB2FLX IN (  '01.37' ) ----01.37 - Negocia??o de Conv?nio - Acordo Tacito
  and (FB.DATACANCELBAIXA IS NULL )
---------------------------------------------------------------
UNION ALL
--- baixa autorizada RM BAIXA AUTORIZADA
SELECT 'RM BAIXA AUTORIZADA'    TIPO,
       0.00 VALORENTRADA,
       nvl( SUM(FB.Valorbaixa),0)  VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.DATABAIXA >= PDATA_CONTAB_INI
  AND FB.DATABAIXA   <= PDATA_CONTAB_FIM
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN ( '23.32','23.33' )   --- esse tipo serve para baixa autorizada e perdas
  AND  to_date('31-07-2014', 'dd-mm-yyyy' ) =  PDATA_CONTAB_FIM
      and (FB.DATACANCELBAIXA IS NULL )
GROUP BY 'RM BAIXA AUTORIZADA'
having nvl( SUM(FB.Valorbaixa),0) <> 0
----------------------------------------------------------------
UNION ALL
--- PAGTO CARTEIRA RM IDENTIFICADO NO MES
SELECT
      'RM CARTEIRA BX NAO IDENT MES' TIPO,
      0.00 VALORENTRADA,
      SUM( FB.VALORBAIXA)  VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB , FXCX@RMDB FX
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.IDXCX =  FX.IDXCX
  AND FB.CODCOLIGADA= FX.CODCOLIGADA
  AND FB.DATABAIXA  >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.24' )  ---- BAIXA DE CREDITO A IDENTIFICAR CONVENIO
  AND FX.HISTORICO  LIKE '%'||TO_CHAR(FB.DATABAIXA, 'MM.YYYY')||'%'
      and (FB.DATACANCELBAIXA IS NULL )
UNION ALL
SELECT  --- PAGTO CARTEIRA RM IDENTIFICADO NO MES ANTERIOR
     'RM CARTEIRA BX NAO IDENT MESES ANTERIORES' TIPO,
      sum( fb.valorjuros)  VALORENTRADA, ---  0.00 VALORENTRADA, ate marco2021 (ajuste amanda 04 05 2021 )
      SUM( FB.VALORBAIXA)  VALORBAIXADO
 FROM FLAN@RMDB F , FLANBAIXA@RMDB FB , FXCX@RMDB FX
WHERE F.CODCOLIGADA = 1
  AND F.IDLAN = FB.IDLAN
  AND F.CODCOLIGADA = FB.CODCOLIGADA
  AND FB.IDXCX =  FX.IDXCX
  AND FB.CODCOLIGADA= FX.CODCOLIGADA
  AND FB.DATABAIXA  >= PDATA_CONTAB_INI
  AND FB.DATABAIXA <= PDATA_CONTAB_FIM
  AND F.CODTDO    IN   ( 'COB' , 'NF' )
  AND FB.CODCXA <> 'X-CPD'
  AND FB.CODTB2FLX IN (  '01.24' )  ---- BAIXA DE CREDITO A IDENTIFICAR CONVENIO
  AND FX.HISTORICO NOT  LIKE '%'||TO_CHAR(FB.DATABAIXA, 'MM.YYYY')||'%'
      and (FB.DATACANCELBAIXA IS NULL )
-----------------------------------------------------------------
union all
 select  'RM ACERTO DE ISS Cubatao' acerto , 0 entrada , valorop2 saida
 from  flanbaixa@rmdb fb
 where fb.idlan = 1080923 and fb.idbaixa = 22969
   and to_date('30-JUN-2015', 'dd-mm-yyyy' ) =  PDATA_CONTAB_FIM
   and FB.DATABAIXA >= PDATA_CONTAB_INI
   AND FB.DATABAIXA <= PDATA_CONTAB_FIM
UNION ALL
---- SOLICITACAO AMANDA E-MAIL 05/09/2016
select 'RM BAIXA AUTORIZADA' ,      0.00 entrada,  5534.66 saida
from dual
where to_date('31-08-2016', 'dd-mm-yyyy' ) =  PDATA_CONTAB_FIM
ORDER BY 1 ;
----*********************************************************************
             IO_CURSOR := V_CURSOR;
  END PRC_COB_REL_20_GESTAO_FIN;