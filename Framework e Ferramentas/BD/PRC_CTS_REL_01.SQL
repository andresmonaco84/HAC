CREATE OR REPLACE PROCEDURE "PRC_CTS_REL_01"
  (
     pCTS_RES_RESU_MES       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_MES_PAGTO%type,
     pCTS_RES_RESU_ANO       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_ANO_PAGTO%type,
     IO_CURSOR               OUT PKG_CURSOR.T_CURSOR
  )
  IS
v_cursor PKG_CURSOR.t_cursor;
BEGIN
  OPEN v_cursor FOR

SELECT RES.CTS_RES_RESU_TIPO              TIPO,
       RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL  NIVEL,
       RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI DESCRICAO,
       RES.CTS_RES_RESU_CAD_CTS_CD_CONTA  CONTA,

       --RECEITA
       SUM(RES.CTS_RES_RESU_PC_RATEIO_RECEITA) PERCENTUAL_RECEITA,
       PERC_RATEIO_RECEITA.TOTAL_PERC_RAT_RECEITA,

       SUM(RES.CTS_RES_RESU_VL_REC_DIRETA)    VL_RECEITA_DIRETA,
       SUM(TOTAL_RECEITA.TOTAL_DIRETA_RECEITA)        VL_TOTAL_RECEITA_DIRETA,

       SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI) VL_RECEITA_INTERMEDIARIA,
       SUM(TOTAL_RECEITA.TOTAL_INTERMEDIARIA_RECEITA) VL_TOTAL_RECEITA_INTERMEDIARIA,

       SUM(RES.CTS_RES_RESU_VL_REC_INDIRETA)  VL_RECEITA_INDIRETA,
       SUM(TOTAL_RECEITA.TOTAL_INDIRETA_RECEITA)      VL_TOTAL_RECEITA_INDIRETA,

       --DESPESA
       SUM(RES.CTS_RES_RESU_PC_RATEIO_DESPESA) PERCENTUAL_DESPESA,
       PERC_RATEIO_DESPESA.TOTAL_PERC_RAT_DESPESA,

       SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA)    VL_DESPESA_DIRETA,
       SUM(TOTAL_DESPESA.TOTAL_DIRETA_DESPESA)        VL_TOTAL_DESPESA_DIRETA,

       SUM(RES.CTS_RES_RESU_VL_DESP_INTERMEDI) VL_DESPESA_INTERMEDIARIA,
       SUM(TOTAL_DESPESA.TOTAL_INTERMEDIARIA_DESPESA) VL_TOTAL_DESPESA_INTERMEDIARIA,

       SUM(RES.CTS_RES_RESU_VL_DESP_INDIRETA)  VL_DESPESA_INDIRETA,
       SUM(TOTAL_DESPESA.TOTAL_INDIRETA_DESPESA)      VL_TOTAL_DESPESA_INDIRETA,

       --
       TOTAL_RECEITA_DI.TOT_RECEITA_DI TOTAL_DIRETA_INTERMEDIARIA_REC,
       TOTAL_DESPESA_DI.TOT_DESPESA_DI TOTAL_DIRETA_INTERMEDIARIA_DES,
       --

       SUM(RES.CTS_RES_RESU_PC_DIRETO) PERCENTUAL_DIRETO,
       TOTAL_PERCENTUAL_DIRETO.PERC_DIRETO,

       SUM(RES.CTS_RES_RESU_PC_TOTAL) PERCENTUAL_TOTAL,
       PERCENTUAL_TOTAL.PERC_TOTAL

  FROM TB_CTS_RES_RESUMO_GERAL RES,

       --RECEITA
       (SELECT SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) + SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI) TOT_RECEITA_DI
              FROM TB_CTS_RES_RESUMO_GERAL RES
             WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
               AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
               AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
               AND RES.CTS_RES_RESU_TIPO = 'R'
               AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1)                                                 TOTAL_RECEITA_DI,

     /*  (SELECT SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) + SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI)                DIV_RECEITA
          FROM TB_CTS_RES_RESUMO_GERAL RES
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
           AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
           AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
           AND RES.CTS_RES_RESU_TIPO = 'R'
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1)                                                     TOTAL_DIVISOR_RECEITA,*/

       (SELECT SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) TOTAL_DIRETA_RECEITA,
               SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI) TOTAL_INTERMEDIARIA_RECEITA,
               SUM(RES.CTS_RES_RESU_VL_REC_INDIRETA)                                                       TOTAL_INDIRETA_RECEITA
          FROM TB_CTS_RES_RESUMO_GERAL RES
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
           AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
           AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
           AND RES.CTS_RES_RESU_TIPO = 'R'
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1)                                                      TOTAL_RECEITA,

       (SELECT SUM(((RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INTERMEDI) / T.S)) TOTAL_PERC_RAT_RECEITA
          FROM TB_CTS_RES_RESUMO_GERAL RES, ( SELECT SUM(RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INTERMEDI) S
                                                FROM TB_CTS_RES_RESUMO_GERAL RES
                                               WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
                                                 AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
                                                 AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
                                                 AND RES.CTS_RES_RESU_TIPO = 'R'
                                                 AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1 ) T
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
           AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
           AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
           AND RES.CTS_RES_RESU_TIPO = 'R'
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1)                                                      PERC_RATEIO_RECEITA,

        --DESPESA
       (SELECT SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA) + SUM(RES.CTS_RES_RESU_VL_DESP_INTERMEDI) TOT_DESPESA_DI
              FROM TB_CTS_RES_RESUMO_GERAL RES
             WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
               AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
               AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
               AND RES.CTS_RES_RESU_TIPO = 'R'
               AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1) TOTAL_DESPESA_DI,

     /*  (SELECT SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA) + SUM(RES.CTS_RES_RESU_VL_DESP_INTERMEDI)               DIV_DESPESA
          FROM TB_CTS_RES_RESUMO_GERAL RES
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
           AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
           AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
           AND RES.CTS_RES_RESU_TIPO = 'R'
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1)                                                      TOTAL_DIVISOR_DESPESA,*/

       (SELECT SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA) TOTAL_DIRETA_DESPESA,
               SUM(RES.CTS_RES_RESU_VL_DESP_INTERMEDI) TOTAL_INTERMEDIARIA_DESPESA,
               SUM(RES.CTS_RES_RESU_VL_DESP_INDIRETA) TOTAL_INDIRETA_DESPESA
          FROM TB_CTS_RES_RESUMO_GERAL RES
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
           AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
           AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
           AND RES.CTS_RES_RESU_TIPO = 'R'
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1)                                                      TOTAL_DESPESA,

       (SELECT SUM(((RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INTERMEDI) / T.S)) TOTAL_PERC_RAT_DESPESA
          FROM TB_CTS_RES_RESUMO_GERAL RES, ( SELECT SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INTERMEDI) S
                                                FROM TB_CTS_RES_RESUMO_GERAL RES
                                               WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
                                                 AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
                                                 AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
                                                 AND RES.CTS_RES_RESU_TIPO = 'R'
                                                 AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1 ) T
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
           AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
           AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
           AND RES.CTS_RES_RESU_TIPO = 'R'
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1)                                                      PERC_RATEIO_DESPESA,


       (SELECT ROUND((SUM (NVL(RES.CTS_RES_RESU_VL_REC_DIRETA,0) + NVL(RES.CTS_RES_RESU_VL_REC_INTERMEDI,0)) /
               SUM (NVL(RES.CTS_RES_RESU_VL_DESP_DIRETA,0) + NVL(RES.CTS_RES_RESU_VL_DESP_INTERMEDI,0)) - 1), 4) PERC_DIRETO
          FROM TB_CTS_RES_RESUMO_GERAL RES
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
           AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
           AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
           AND RES.CTS_RES_RESU_TIPO = 'R'
           AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1) TOTAL_PERCENTUAL_DIRETO,

      (SELECT ROUND((SUM (NVL(RES.CTS_RES_RESU_VL_REC_DIRETA,0) + NVL(RES.CTS_RES_RESU_VL_REC_INTERMEDI,0) + NVL(RES.CTS_RES_RESU_VL_REC_INDIRETA,0)) /
              SUM (NVL(RES.CTS_RES_RESU_VL_DESP_DIRETA,0) + NVL(RES.CTS_RES_RESU_VL_DESP_INTERMEDI,0) + CTS_RES_RESU_VL_DESP_INDIRETA) - 1),4) PERC_TOTAL
         FROM TB_CTS_RES_RESUMO_GERAL RES
        WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
          AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
          AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
          AND RES.CTS_RES_RESU_TIPO = 'R'
          AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1) PERCENTUAL_TOTAL

 WHERE RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
   AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
   AND RES.CTS_RES_RESU_TIPO = 'R'
   AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1

 GROUP BY RES.CTS_RES_RESU_TIPO,
          RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL,
          RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI,
          CTS_RES_RESU_CAD_CTS_CD_CONTA,

          --TOTAL_DIVISOR_RECEITA.DIV_RECEITA,
          --TOTAL_DIVISOR_DESPESA.DIV_DESPESA,

          PERC_RATEIO_RECEITA.TOTAL_PERC_RAT_RECEITA,
          PERC_RATEIO_DESPESA.TOTAL_PERC_RAT_DESPESA,

          TOTAL_RECEITA_DI.TOT_RECEITA_DI,
          TOTAL_DESPESA_DI.TOT_DESPESA_DI,

          TOTAL_PERCENTUAL_DIRETO.PERC_DIRETO,
          PERCENTUAL_TOTAL.PERC_TOTAL

 ORDER BY RES.CTS_RES_RESU_TIPO, CTS_RES_RESU_CAD_CTS_CD_CONTA;

    IO_CURSOR := V_CURSOR;
 END PRC_CTS_REL_01;
