CREATE OR REPLACE PROCEDURE "PRC_ASS_CPR_CLINICA_PROF_PER_L" (
  pCAD_CLC_ID IN TB_CAD_CLC_CLINICA_CREDENCIADA.CAD_CLC_ID%TYPE DEFAULT NULL,
  pCAD_PRO_ID_PROFISSIONAL IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%TYPE DEFAULT NULL,
  pCAD_UNI_ID_UNIDADE IN TB_ASS_CPR_CLINICA_PROF.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
  pCAD_LAT_DS_LOCAL_ATENDIMENTO IN TB_ASS_CPR_CLINICA_PROF.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
  pCAD_CNV_ID_CONVENIO IN TB_ASS_CPR_CLINICA_PROF.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
  pFLAGATIVO IN STRING DEFAULT NULL,
  IO_CURSOR   OUT PKG_CURSOR.T_CURSOR) IS
  /********************************************************************
  *    Procedure: PRC_ASS_CPR_CLINICA_PROF_PER_L
  *
  *    Data Criacao:   data da  criac?o   Por: Nome do Analista
  *    Data Alteracao:  data da alterac?o  Por: Nome do Analista
  *
  *    Funcao: Descric?o da funcionalidade da Stored Procedure
  *
  *******************************************************************/
 V_CURSOR PKG_CURSOR.T_CURSOR;
 V_WHERE  VARCHAR2(10000);
 V_SELECT VARCHAR2(10000);
 BEGIN

    IF pFLAGATIVO = 'S' THEN
      V_WHERE := V_WHERE || ' AND (CPR.ASS_CPR_DT_FIM_VIGENCIA IS NULL OR TRUNC(CPR.ASS_CPR_DT_FIM_VIGENCIA) >= TRUNC(SYSDATE))';
    ELSE IF pFLAGATIVO = 'N' THEN
      V_WHERE := V_WHERE || ' AND (CPR.ASS_CPR_DT_FIM_VIGENCIA IS NOT NULL AND TRUNC(CPR.ASS_CPR_DT_FIM_VIGENCIA) <= TRUNC(SYSDATE))';
    END IF;
    END IF;

    IF pCAD_CLC_ID IS NOT NULL THEN 
      V_WHERE := V_WHERE || ' AND CPR.CAD_CLC_ID = ' ||pCAD_CLC_ID;
    END IF;

    IF pCAD_PRO_ID_PROFISSIONAL IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND PRO.CAD_PRO_ID_PROFISSIONAL = ' || pCAD_PRO_ID_PROFISSIONAL;
    END IF;

    IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND CPR.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE;
    END IF;

    IF pCAD_LAT_DS_LOCAL_ATENDIMENTO IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND CAD_LAT_DS_LOCAL_ATENDIMENTO = ' || pCAD_LAT_DS_LOCAL_ATENDIMENTO;
    END IF;

    IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO;
    END IF;
    
    V_SELECT := 'SELECT CPR.ASS_CPR_ID,

           CPR.CAD_UNI_ID_UNIDADE,
           DECODE(UNI.CAD_UNI_DS_UNIDADE, NULL, ''TODAS'', UNI.CAD_UNI_DS_UNIDADE) CAD_UNI_DS_UNIDADE,

           CPR.CAD_LAT_ID_LOCAL_ATENDIMENTO,
           DECODE(LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO, NULL, ''TODOS'', LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO) CAD_LAT_DS_LOCAL_ATENDIMENTO,

           CPR.CAD_SET_ID,
           DECODE(SETOR.CAD_SET_DS_SETOR, NULL, ''TODOS'', SETOR.CAD_SET_DS_SETOR) CAD_SET_DS_SETOR,

           CPR.CAD_PRO_ID_PROFISSIONAL,
           PRO.CAD_PRO_SG_UF_CONSELHO,
           PRO.TIS_CPR_CD_CONSELHOPROF,
           PRO.CAD_PRO_NR_CONSELHO,
           DECODE(PRO.CAD_PRO_NM_NOME, NULL, ''TODOS'', PRO.CAD_PRO_NM_NOME) CAD_PRO_NM_NOME,

           CPR.TIS_CBO_CD_CBOS,
           DECODE(CBOS.TIS_CBO_DS_CBOS, NULL, ''TODAS'', CBOS.TIS_CBO_DS_CBOS) TIS_CBO_DS_CBOS,

           CPR.CAD_PRD_ID,
           DECODE(PRD.CAD_PRD_DS_DESCRICAO, NULL, ''TODOS'', PRD.CAD_PRD_DS_DESCRICAO) CAD_PRD_DS_DESCRICAO,

           CPR.TIS_MED_CD_TABELAMEDICA,
           DECODE(TIS.TIS_MED_DS_TABELAMEDICA, NULL, ''TODAS'', TIS.TIS_MED_DS_TABELAMEDICA) TIS_MED_DS_TABELAMEDICA,

           CPR.AUX_EPP_CD_ESPECPROC,
           DECODE(EPP.AUX_EPP_DS_DESCRICAO, NULL, ''TODOS'', EPP.AUX_EPP_DS_DESCRICAO) AUX_EPP_DS_DESCRICAO,

           CPR.AUX_GPC_CD_GRUPOPROC,
           DECODE(GPC.AUX_GPC_DS_DESCRICAO, NULL, ''TODOS'', GPC.AUX_GPC_DS_DESCRICAO) AUX_GPC_DS_DESCRICAO,

           CPR.CAD_PLA_ID_PLANO,
           PLA.CAD_PLA_CD_PLANO_HAC,
           DECODE(PLA.CAD_PLA_NM_NOME_PLANO, NULL, ''TODOS'', PLA.CAD_PLA_NM_NOME_PLANO) CAD_PLA_NM_NOME_PLANO,

           CPR.CAD_CNV_ID_CONVENIO,
           CNV.CAD_CNV_CD_HAC_PRESTADOR,
           DECODE(CNV.CAD_CNV_DS_RAZAOSOCIAL, NULL, ''TODOS'', CNV.CAD_CNV_DS_RAZAOSOCIAL) CAD_CNV_DS_RAZAOSOCIAL,

           CPR.CAD_TPE_CD_CODIGO,
           DECODE(TPE.CAD_TPE_DS_DESCRICAO, NULL, ''TODOS'', TPE.CAD_TPE_DS_DESCRICAO) CAD_TPE_DS_DESCRICAO,

           CPR.CAD_CLC_ID,
           CLC.CAD_CLC_CD_CLINICA,
           CLC.CAD_CLC_DS_DESCRICAO,

           CPR.ASS_CPR_DT_INICIO_VIGENCIA,
           CPR.ASS_CPR_DT_FIM_VIGENCIA

      FROM TB_ASS_CPR_CLINICA_PROF        CPR,
           TB_CAD_PRO_PROFISSIONAL        PRO,
           TB_CAD_PRD_PRODUTO             PRD,
           TB_CAD_CNV_CONVENIO            CNV,
           TB_CAD_PLA_PLANO               PLA,
           TB_CAD_UNI_UNIDADE             UNI,
           TB_CAD_LAT_LOCAL_ATENDIMENTO   LAT,
           TB_CAD_SET_SETOR               SETOR,
           TB_TIS_CBO_CBOS                CBOS,
           TB_CAD_TPE_TIPOEMPRESA         TPE,
           TB_CAD_CLC_CLINICA_CREDENCIADA CLC,
           TB_TIS_MED_TABELAMEDICA        TIS,
           TB_AUX_EPP_ESPECPROC           EPP,
           TB_AUX_GPC_GRUPOPROC           GPC

     WHERE CPR.CAD_PRO_ID_PROFISSIONAL = PRO.CAD_PRO_ID_PROFISSIONAL(+)
       AND CPR.TIS_CBO_CD_CBOS = CBOS.TIS_CBO_CD_CBOS(+)
       AND CPR.CAD_PRD_ID = PRD.CAD_PRD_ID(+)
       AND CPR.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO(+)
       AND CPR.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO(+)
       AND CPR.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE(+)
       AND CPR.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO(+)
       AND CPR.CAD_SET_ID = SETOR.CAD_SET_ID(+)
       AND CPR.CAD_TPE_CD_CODIGO = TPE.CAD_TPE_CD_CODIGO(+)
       AND CPR.CAD_CLC_ID = CLC.CAD_CLC_ID(+)
       AND CPR.TIS_MED_CD_TABELAMEDICA = TIS.TIS_MED_CD_TABELAMEDICA(+)
       AND CPR.AUX_EPP_CD_ESPECPROC = EPP.AUX_EPP_CD_ESPECPROC(+)
       AND CPR.TIS_MED_CD_TABELAMEDICA = EPP.TIS_MED_CD_TABELAMEDICA(+)
       AND CPR.AUX_GPC_CD_GRUPOPROC = GPC.AUX_GPC_CD_GRUPOPROC(+)
       AND CPR.AUX_EPP_CD_ESPECPROC = GPC.AUX_EPP_CD_ESPECPROC(+)
       AND CPR.TIS_MED_CD_TABELAMEDICA = GPC.TIS_MED_CD_TABELAMEDICA(+) ';
     
  DBMS_OUTPUT.put_line(V_SELECT || V_WHERE || ' ORDER BY 1 ');

  OPEN v_cursor FOR
         V_SELECT || V_WHERE ;
    
  IO_CURSOR := V_CURSOR;

END PRC_ASS_CPR_CLINICA_PROF_PER_L;
