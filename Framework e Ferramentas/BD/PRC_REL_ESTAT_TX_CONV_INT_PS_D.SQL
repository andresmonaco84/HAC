CREATE OR REPLACE PROCEDURE PRC_REL_ESTAT_TX_CONV_INT_PS_D
(
     PCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE %TYPE DEFAULT NULL,
    -- PCAD_SET_CD_SETOR   IN TB_CAD_SET_SETOR.CAD_SET_CD_SETOR%TYPE,
     PTIS_CBO_CD_CBOS    IN TB_ATD_ATE_ATENDIMENTO.TIS_CBO_CD_CBOS%TYPE,
     PATD_DT_INICIO      IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
     PATD_DT_FIM         IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
      PGRUPO                 VARCHAR2 DEFAULT NULL,
     io_cursor           OUT PKG_CURSOR.t_cursor
  )
  is
/********************************************************************
*    Procedure: PRC_REL_ESTAT_TX_CONV_INT_PS_D
*
*    Data Criacao:    data da  cria??o   Por: Nome do Analista
*    Data Alteracao:  data da altera??o  Por: Nome do Analista
*
*    Funcao: Descri??o da funcionalidade da Stored Procedure
*
*******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR

     -- SELECT * FROM TB_TIS_CBO_CBOS A WHERE A.TIS_CBO_CD_CBOS_V3='225124'

  --  90023,06155,90029,90030,90036,90053

SELECT  TB_DIA.DIA DIA,
           TB_CLASSIF.GRUPO,
           TB_CLASSIF.CLASSIF,
           NVL(ATEND_PS.TOTAL,0) TOTAL_PS,
           NVL(INTERNACAO.TOTAL,0) TOTAL_INT,
           NVL(ROUND(((INTERNACAO.TOTAL/ATEND_PS.TOTAL) * 100),2),0) TAXA_CONVERSAO,

           NVL(PS_TOT.TOTAL_CLASSIF,0) TOTAL_PS_CLASSIF,
           NVL(INT_TOT.TOTAL_CLASSIF,0) TOTAL_INT_CLASSIF,
           NVL(ROUND(((INT_TOT.TOTAL_CLASSIF/PS_TOT.TOTAL_CLASSIF) * 100),2),0) TAXA_CONVERSAO_CLASSIF,

           NVL(PS_TOT.TOTAL_CLASSIF_GRUPO,0) TOTAL_PS_CLASSIF_GRUPO,
           NVL(INT_TOT.TOTAL_CLASSIF_GRUPO,0) TOTAL_INT_CLASSIF_GRUPO,
           NVL(ROUND(((INT_TOT.TOTAL_CLASSIF_GRUPO/PS_TOT.TOTAL_CLASSIF_GRUPO) * 100),2),0) TAXA_CONVERSAO_CLASSIF_GRUPO,

           NVL(PS_TOT_EXTRAGRUPO.TOTAL,0) TOTAL_PS_CLASSIF_EXTRAGRUPO,
           NVL(INT_TOT_EXTRAGRUPO.TOTAL,0) TOTAL_INT_CLASSIF_EXTRAGRUPO,
           NVL(ROUND(((INT_TOT_EXTRAGRUPO.TOTAL/PS_TOT_EXTRAGRUPO.TOTAL) * 100),2),0) TAXA_CONVER_CLASSIF_EXTRAGRUPO,


           NVL(PS_TOT.TOTAL_GERAL,0) TOTAL_GERAL_PS,
           NVL(INT_TOT.TOTAL_GERAL,0) TOTAL_GERAL_INT,
           NVL(ROUND(((INT_TOT.TOTAL_GERAL/PS_TOT.TOTAL_GERAL) * 100),2),0) TAXA_CONVERSAO_GERAL



FROM
   (SELECT '01' DIA FROM DUAL
     UNION SELECT '02' DIA FROM DUAL
     UNION SELECT '03' DIA FROM DUAL
     UNION SELECT '04' DIA FROM DUAL
     UNION SELECT '05' DIA FROM DUAL
     UNION SELECT '06' DIA FROM DUAL
     UNION SELECT '07' DIA FROM DUAL
     UNION SELECT '08' DIA FROM DUAL
     UNION SELECT '09' DIA FROM DUAL
     UNION SELECT '10' DIA FROM DUAL
     UNION SELECT '11' DIA FROM DUAL
     UNION SELECT '12' DIA FROM DUAL
     UNION SELECT '13' DIA FROM DUAL
     UNION SELECT '14' DIA FROM DUAL
     UNION SELECT '15' DIA FROM DUAL
     UNION SELECT '16' DIA FROM DUAL
     UNION SELECT '17' DIA FROM DUAL
     UNION SELECT '18'  DIA FROM DUAL
     UNION SELECT '19' DIA FROM DUAL
     UNION SELECT '20' DIA FROM DUAL
     UNION SELECT '21' DIA FROM DUAL
     UNION SELECT '22' DIA FROM DUAL
     UNION SELECT '23' DIA FROM DUAL
     UNION SELECT '24' DIA FROM DUAL
     UNION SELECT '25' DIA FROM DUAL
     UNION SELECT '26' DIA FROM DUAL
     UNION SELECT '27' DIA FROM DUAL
     UNION SELECT '28' DIA FROM DUAL
     UNION SELECT '29' DIA FROM DUAL
     UNION SELECT '30' DIA FROM DUAL
     UNION SELECT '31'  DIA FROM DUAL
     ) TB_DIA
 CROSS JOIN (SELECT 'GRUPO' CLASSIF, 'GRUPO' GRUPO  FROM DUAL
     UNION SELECT 'EXTRA GRUPO/MERCADO' CLASSIF, 'EXTRA GRUPO/MERCADO + PARTICULAR' GRUPO FROM DUAL
     UNION SELECT 'EXTRA GRUPO/PARTICULAR' CLASSIF, 'EXTRA GRUPO/MERCADO + PARTICULAR' GRUPO FROM DUAL
 ) TB_CLASSIF
 /* CROSS JOIN (SELECT 'GRUPO' GRUPO FROM DUAL
     UNION SELECT 'EXTRA GRUPO/PARTICULAR' DIA FROM DUAL
 ) TB_GRUPO*/
 LEFT JOIN (
      SELECT
        'EXTRA GRUPO/MERCADO + PARTICULAR' GRUPO,
       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID))   TOTAL

       FROM TB_ATD_ATE_ATENDIMENTO ATD,
       TB_ASS_PAT_PACIEATEND PAT,
       TB_CAD_PAC_PACIENTE PAC,
       TB_CAD_UNI_UNIDADE UNI,
       TB_CAD_PES_PESSOA PES,
       TB_CAD_CNV_CONVENIO CNV,
       TB_CAD_PLA_PLANO PLA,
       (SELECT PATPS.CAD_PAC_ID_PACIENTE,
               ATDPS.ATD_ATE_DT_ATENDIMENTO,
               ATDPS.ATD_ATE_HR_ATENDIMENTO,
               ATDPS.ATD_ATE_ID,
               PACPS.CAD_PES_ID_PESSOA
          FROM TB_ASS_PAT_PACIEATEND  PATPS,
               TB_ATD_ATE_ATENDIMENTO ATDPS,
               TB_CAD_PAC_PACIENTE    PACPS,
               TB_CAD_CNV_CONVENIO    CNVPS,
               TB_CAD_PLA_PLANO       PLAPS
         WHERE PATPS.ATD_ATE_ID = ATDPS.ATD_ATE_ID
           AND PATPS.CAD_PAC_ID_PACIENTE = PACPS.CAD_PAC_ID_PACIENTE
           AND ATDPS.TIS_TAT_CD_TPATENDIMENTO = 4 --- CONSULTA
           AND ATDPS.CAD_LAT_ID_LOCAL_ATENDIMENTO IN (30, 34) --- NO PS
           AND (PTIS_CBO_CD_CBOS  IS NULL OR ATDPS.Tis_Cbo_Cd_Cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS  ))))
           AND ATDPS.ATD_ATE_FL_STATUS = 'A'
           AND PATPS.CAD_CNV_ID_CONVENIO = CNVPS.CAD_CNV_ID_CONVENIO
           AND PACPS.CAD_PLA_ID_PLANO = PLAPS.CAD_PLA_ID_PLANO
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO-1
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
       AND ATDPS.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE) INT_VIAPS

 WHERE ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND ATD.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO
   AND ATD.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
   AND ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
   AND ATD.ATD_ATE_FL_STATUS = 'A'
   AND ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
   AND PAC.CAD_PES_ID_PESSOA = INT_VIAPS.CAD_PES_ID_PESSOA
   AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
   AND FNC_JUNTAR_DATA_HORA(ATD.ATD_ATE_DT_ATENDIMENTO, ATD.ATD_ATE_HR_ATENDIMENTO) > FNC_JUNTAR_DATA_HORA(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO, INT_VIAPS.ATD_ATE_HR_ATENDIMENTO)
   AND (TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) OR TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = (TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) + 1))
   AND ATD.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
   AND ATD.ATD_ATE_FL_CARATER_SOLIC = 'U'
   AND PAC.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO
   
   AND ((PGRUPO IS NULL AND  CNV.CAD_CGC_ID = 2) OR
                (PGRUPO = '5' AND CNV.CAD_CGC_ID = 2  ) OR
                ( CNV.CAD_CGC_ID = 0)
                )

 GROUP BY 'EXTRA GRUPO/MERCADO + PARTICULAR'
 ) INT_TOT_EXTRAGRUPO ON  INT_TOT_EXTRAGRUPO.GRUPO = TB_CLASSIF.GRUPO


  LEFT JOIN (
   SELECT
      'EXTRA GRUPO/MERCADO + PARTICULAR' GRUPO,
       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID))  TOTAL

  FROM   TB_ATD_ATE_ATENDIMENTO ATD
  JOIN TB_CAD_UNI_UNIDADE UNI    ON UNI.CAD_UNI_ID_UNIDADE = ATD.CAD_UNI_ID_UNIDADE
  JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT    ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
  JOIN TB_ASS_PAT_PACIEATEND PAT    ON ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
  JOIN TB_CAD_PAC_PACIENTE PAC    ON PAC.CAD_PAC_ID_PACIENTE = PAT.CAD_PAC_ID_PACIENTE
  JOIN TB_CAD_CNV_CONVENIO CNV    ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
 JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 WHERE ATD.TIS_TAT_CD_TPATENDIMENTO = 4  
 AND ((PGRUPO IS NULL AND  CNV.CAD_CGC_ID = 2) OR
                (PGRUPO = '5' AND CNV.CAD_CGC_ID = 2  ) OR
                ( CNV.CAD_CGC_ID = 0)
                )

       AND (ATD.ATD_ATE_DT_ATENDIMENTO BETWEEN PATD_DT_INICIO AND PATD_DT_FIM)
       AND (ATD.ATD_ATE_FL_STATUS = 'A')
       AND ATD.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE
       AND (PTIS_CBO_CD_CBOS  IS NULL OR atd.tis_cbo_cd_cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS  ))))
     group by 'EXTRA GRUPO/MERCADO + PARTICULAR'
  )  PS_TOT_EXTRAGRUPO ON PS_TOT_EXTRAGRUPO.GRUPO = TB_CLASSIF.GRUPO

 LEFT JOIN (  SELECT TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'DD') DIA,
       CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END CLASSIF,
        CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END GRUPO,
         SUM(COUNT(distinct ATD.ATD_ATE_ID)) OVER(PARTITION BY TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'DD')||CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END ) TOTAL

  FROM   TB_ATD_ATE_ATENDIMENTO ATD

  JOIN TB_CAD_UNI_UNIDADE UNI    ON UNI.CAD_UNI_ID_UNIDADE = ATD.CAD_UNI_ID_UNIDADE
  JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT    ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
  JOIN TB_ASS_PAT_PACIEATEND PAT    ON ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
  JOIN TB_CAD_PAC_PACIENTE PAC    ON PAC.CAD_PAC_ID_PACIENTE = PAT.CAD_PAC_ID_PACIENTE
  JOIN TB_CAD_CNV_CONVENIO CNV    ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
  JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 WHERE ATD.TIS_TAT_CD_TPATENDIMENTO = 4
       AND (ATD.ATD_ATE_DT_ATENDIMENTO BETWEEN PATD_DT_INICIO AND PATD_DT_FIM)
       AND (ATD.ATD_ATE_FL_STATUS = 'A')
       AND ATD.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE
       AND (PTIS_CBO_CD_CBOS  IS NULL OR atd.tis_cbo_cd_cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS  ))))
 AND (PGRUPO IS NULL OR 
       PGRUPO = '1' AND (CNV.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
       PGRUPO = '2' AND (PLA.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNV.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
       PGRUPO = '3' AND (CNV.CAD_CGC_ID = 1   AND CNV.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
      PGRUPO = '4' AND (CNV.CAD_CGC_ID = 1  AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNV.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
   PGRUPO = '5' AND (CNV.CAD_CGC_ID = 2  )  
       )  
         GROUP BY
          TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'DD'),
         CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END
         ,
         CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END
  ) ATEND_PS ON ATEND_PS.DIA = TB_DIA.DIA
  AND ATEND_PS.CLASSIF = TB_CLASSIF.CLASSIF
 -- AND ATEND_PS.GRUPO = TB_GRUPO.GRUPO
 LEFT JOIN (
   SELECT
       CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END CLASSIF,
        CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END GRUPO,
        SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF,

        SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF_GRUPO,

       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER() TOTAL_GERAL

  FROM   TB_ATD_ATE_ATENDIMENTO ATD

  JOIN TB_CAD_UNI_UNIDADE UNI    ON UNI.CAD_UNI_ID_UNIDADE = ATD.CAD_UNI_ID_UNIDADE
  JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT    ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
  JOIN TB_ASS_PAT_PACIEATEND PAT    ON ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
  JOIN TB_CAD_PAC_PACIENTE PAC    ON PAC.CAD_PAC_ID_PACIENTE = PAT.CAD_PAC_ID_PACIENTE
  JOIN TB_CAD_CNV_CONVENIO CNV    ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
 JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 WHERE ATD.TIS_TAT_CD_TPATENDIMENTO = 4
       AND (ATD.ATD_ATE_DT_ATENDIMENTO BETWEEN PATD_DT_INICIO AND PATD_DT_FIM)
       AND (ATD.ATD_ATE_FL_STATUS = 'A')
       AND ATD.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE
       AND (PTIS_CBO_CD_CBOS  IS NULL OR atd.tis_cbo_cd_cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS  ))))
 AND (PGRUPO IS NULL OR 
       PGRUPO = '1' AND (CNV.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
       PGRUPO = '2' AND (PLA.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNV.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
       PGRUPO = '3' AND (CNV.CAD_CGC_ID = 1   AND CNV.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
      PGRUPO = '4' AND (CNV.CAD_CGC_ID = 1  AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNV.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
   PGRUPO = '5' AND (CNV.CAD_CGC_ID = 2  )  
       )  
         GROUP BY
         CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END
         ,
         CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END
  )  PS_TOT ON PS_TOT.CLASSIF = TB_CLASSIF.CLASSIF

 LEFT JOIN (
      SELECT
         CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END GRUPO,
         CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END CLASSIF,

         SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF,

        SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF_GRUPO,

       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER() TOTAL_GERAL

       FROM TB_ATD_ATE_ATENDIMENTO ATD,
       TB_ASS_PAT_PACIEATEND PAT,
       TB_CAD_PAC_PACIENTE PAC,
       TB_CAD_UNI_UNIDADE UNI,
       TB_CAD_PES_PESSOA PES,
       TB_CAD_CNV_CONVENIO CNV,
       TB_CAD_PLA_PLANO PLA,
       (SELECT PATPS.CAD_PAC_ID_PACIENTE,
               ATDPS.ATD_ATE_DT_ATENDIMENTO,
               ATDPS.ATD_ATE_HR_ATENDIMENTO,
               ATDPS.ATD_ATE_ID,
               PACPS.CAD_PES_ID_PESSOA
          FROM TB_ASS_PAT_PACIEATEND  PATPS,
               TB_ATD_ATE_ATENDIMENTO ATDPS,
               TB_CAD_PAC_PACIENTE    PACPS,
               TB_CAD_CNV_CONVENIO    CNVPS,
               TB_CAD_PLA_PLANO PLAPS
         WHERE PATPS.ATD_ATE_ID = ATDPS.ATD_ATE_ID
           AND PATPS.CAD_PAC_ID_PACIENTE = PACPS.CAD_PAC_ID_PACIENTE
           AND ATDPS.TIS_TAT_CD_TPATENDIMENTO = 4 --- CONSULTA
           AND ATDPS.CAD_LAT_ID_LOCAL_ATENDIMENTO IN (30, 34) --- NO PS
           AND (PTIS_CBO_CD_CBOS  IS NULL OR ATDPS.Tis_Cbo_Cd_Cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS  ))))
           AND ATDPS.ATD_ATE_FL_STATUS = 'A'
           AND PATPS.CAD_CNV_ID_CONVENIO = CNVPS.CAD_CNV_ID_CONVENIO
           AND PACPS.CAD_PLA_ID_PLANO = PLAPS.CAD_PLA_ID_PLANO
         --   AND (PGRUPO IS NULL OR 
     --  PGRUPO = '1' AND (CNVPS.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLAPS.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
     --  PGRUPO = '2' AND (PLAPS.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNVPS.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
     --  PGRUPO = '3' AND (CNVPS.CAD_CGC_ID = 1   AND CNVPS.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
    --   PGRUPO = '4' AND (CNVPS.CAD_CGC_ID = 1  AND PLAPS.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNVPS.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
 --  PGRUPO = '5' AND (CNVPS.CAD_CGC_ID = 2  )  
   --    )  
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO-1
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
       AND ATDPS.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE) INT_VIAPS

 WHERE ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND ATD.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO
   AND ATD.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
   AND ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
   AND ATD.ATD_ATE_FL_STATUS = 'A'
   AND ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
   AND PAC.CAD_PES_ID_PESSOA = INT_VIAPS.CAD_PES_ID_PESSOA
   AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
   AND FNC_JUNTAR_DATA_HORA(ATD.ATD_ATE_DT_ATENDIMENTO, ATD.ATD_ATE_HR_ATENDIMENTO) > FNC_JUNTAR_DATA_HORA(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO, INT_VIAPS.ATD_ATE_HR_ATENDIMENTO)
   AND (TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) OR TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = (TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) + 1))
   AND ATD.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
   AND ATD.ATD_ATE_FL_CARATER_SOLIC = 'U'
   AND PAC.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO
   AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
    AND (PGRUPO IS NULL OR 
       PGRUPO = '1' AND (CNV.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
       PGRUPO = '2' AND (PLA.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNV.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
       PGRUPO = '3' AND (CNV.CAD_CGC_ID = 1   AND CNV.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
      PGRUPO = '4' AND (CNV.CAD_CGC_ID = 1  AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNV.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
   PGRUPO = '5' AND (CNV.CAD_CGC_ID = 2  )  
       )  
 GROUP BY CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END,
         CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END
 ) INT_TOT ON  INT_TOT.CLASSIF = TB_CLASSIF.CLASSIF
 AND INT_TOT.GRUPO = TB_CLASSIF.GRUPO


LEFT JOIN   (SELECT TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'DD') DIA,
            CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END GRUPO,
           CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END CLASSIF,
       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'DD')|| CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END ) TOTAL



  FROM TB_ATD_ATE_ATENDIMENTO ATD,
       TB_ASS_PAT_PACIEATEND PAT,
       TB_CAD_PAC_PACIENTE PAC,
       TB_CAD_UNI_UNIDADE UNI,
       TB_CAD_PES_PESSOA PES,
       TB_CAD_CNV_CONVENIO CNV,
       TB_CAD_PLA_PLANO PLA,
       (SELECT PATPS.CAD_PAC_ID_PACIENTE,
               ATDPS.ATD_ATE_DT_ATENDIMENTO,
               ATDPS.ATD_ATE_HR_ATENDIMENTO,
               ATDPS.ATD_ATE_ID,
               PACPS.CAD_PES_ID_PESSOA
          FROM TB_ASS_PAT_PACIEATEND  PATPS,
               TB_ATD_ATE_ATENDIMENTO ATDPS,
               TB_CAD_PAC_PACIENTE    PACPS,
               TB_CAD_CNV_CONVENIO    CNVPS,
               TB_CAD_PLA_PLANO       PLAPS
         WHERE PATPS.ATD_ATE_ID = ATDPS.ATD_ATE_ID
           AND PATPS.CAD_PAC_ID_PACIENTE = PACPS.CAD_PAC_ID_PACIENTE
           AND ATDPS.TIS_TAT_CD_TPATENDIMENTO = 4 --- CONSULTA
           AND ATDPS.CAD_LAT_ID_LOCAL_ATENDIMENTO IN (30, 34) --- NO PS
           AND (PTIS_CBO_CD_CBOS  IS NULL OR ATDPS.Tis_Cbo_Cd_Cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS  ))))
           AND ATDPS.ATD_ATE_FL_STATUS = 'A'
           AND PATPS.CAD_CNV_ID_CONVENIO = CNVPS.CAD_CNV_ID_CONVENIO
           AND PACPS.CAD_PLA_ID_PLANO = PLAPS.CAD_PLA_ID_PLANO
       --     AND (PGRUPO IS NULL OR 
     --  PGRUPO = '1' AND (CNVPS.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLAPS.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
    --   PGRUPO = '2' AND (PLAPS.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNVPS.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
    --   PGRUPO = '3' AND (CNVPS.CAD_CGC_ID = 1   AND CNVPS.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
   --   PGRUPO = '4' AND (CNVPS.CAD_CGC_ID = 1  AND PLAPS.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNVPS.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
  -- PGRUPO = '5' AND (CNVPS.CAD_CGC_ID = 2  )  
    --   )
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO-1
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
       AND ATDPS.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE) INT_VIAPS

 WHERE ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND ATD.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO
   AND ATD.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
   AND ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
   AND ATD.ATD_ATE_FL_STATUS = 'A'
   AND ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
   AND PAC.CAD_PES_ID_PESSOA = INT_VIAPS.CAD_PES_ID_PESSOA
   AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
   AND FNC_JUNTAR_DATA_HORA(ATD.ATD_ATE_DT_ATENDIMENTO, ATD.ATD_ATE_HR_ATENDIMENTO) > FNC_JUNTAR_DATA_HORA(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO, INT_VIAPS.ATD_ATE_HR_ATENDIMENTO)
   AND (TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) OR TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = (TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) + 1))
   AND ATD.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
   AND ATD.ATD_ATE_FL_CARATER_SOLIC = 'U'
   AND PAC.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO
   AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
    AND (PGRUPO IS NULL OR 
       PGRUPO = '1' AND (CNV.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
       PGRUPO = '2' AND (PLA.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNV.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
       PGRUPO = '3' AND (CNV.CAD_CGC_ID = 1   AND CNV.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
      PGRUPO = '4' AND (CNV.CAD_CGC_ID = 1  AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNV.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
   PGRUPO = '5' AND (CNV.CAD_CGC_ID = 2  )  
       )

 GROUP BY TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'DD'),
          CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END,
         CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END
 ) INTERNACAO ON INTERNACAO.DIA  = TB_DIA.DIA
 AND INTERNACAO.CLASSIF = TB_CLASSIF.CLASSIF
 --  AND ATEND_PS.GRUPO = TB_GRUPO.GRUPO
where  TB_DIA.dia between to_number(TO_CHAR(PATD_DT_INICIO,'DD')) and to_number(TO_CHAR(PATD_DT_FIM,'DD'))
ORDER BY 1 ASC,3 DESC;

  io_cursor := v_cursor;
  end PRC_REL_ESTAT_TX_CONV_INT_PS_D;
