CREATE OR REPLACE PROCEDURE "PRC_INT_REL_PAC_14_DIAS_SETOR"
  (

pCAD_UNI_ID_UNIDADE IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
pCAD_SET_ID IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,
pQT_DIAS IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,

  --  TESTE OUT LONG,
   io_cursor              OUT PKG_CURSOR.t_cursor) is
   /********************************************************************
  *    Procedure: PRC_INT_REL_PAC_14_DIAS_SETOR
  *
  *    Data Criacao:  28/11/2013      Por: Pedro
 *
 *******************************************************************/
v_cursor PKG_CURSOR.t_cursor;

  begin
    OPEN v_cursor FOR

SELECT ATE.ATD_ATE_ID IDENTIFICACAO,
       PES.CAD_PES_NM_PESSOA PACIENTE,
       SETOR.CAD_SET_DS_SETOR SETOR,
       QLE.CAD_QLE_NR_QUARTO || ' / ' || QLE.CAD_QLE_NR_LEITO QUARTO_LEITO,
       IML.ATD_IML_DT_ENTRADA || ' - ' ||
       TO_CHAR(TO_DATE(LPAD(TO_CHAR(IML.ATD_IML_HR_ENTRADA), 4, '0'), 'HH24:MI'), 'HH24:MI') DT_HR_QLE, TRUNC(SYSDATE) - TRUNC(IML.ATD_IML_DT_ENTRADA) PERMANENCIA

  FROM TB_ATD_ATE_ATENDIMENTO   ATE
  JOIN TB_CAD_PAC_PACIENTE      PAC   ON PAC.CAD_PAC_ID_PACIENTE = FNC_BUSCAR_PACIENTE_ATUAL(ATE.ATD_ATE_ID)
  JOIN TB_ASS_PAT_PACIEATEND    PAT   ON PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
                                     AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
  JOIN TB_CAD_PES_PESSOA        PES   ON PES.CAD_PES_ID_PESSOA   = PAC.CAD_PES_ID_PESSOA
  JOIN TB_ATD_IML_INT_MOV_LEITO IML   ON IML.ATD_ATE_ID          = ATE.ATD_ATE_ID
  JOIN TB_CAD_QLE_QUARTO_LEITO  QLE   ON QLE.CAD_QLE_ID          = IML.CAD_CAD_QLE_ID
  JOIN TB_CAD_SET_SETOR         SETOR ON SETOR.CAD_SET_ID        = QLE.CAD_SET_ID
 WHERE ATE.ATD_ATE_FL_STATUS    = 'A'
   AND ATE.ATD_ATE_TP_PACIENTE  = 'I'
   AND TRUNC(SYSDATE) - TRUNC(IML.ATD_IML_DT_ENTRADA) >= pQT_DIAS
   AND IML.ATD_IML_DT_SAIDA IS NULL
   AND IML.ATD_IML_FL_STATUS    = 'A'
   AND SETOR.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE
   AND (PCAD_SET_ID IS NULL OR SETOR.CAD_SET_ID = PCAD_SET_ID)


ORDER BY SETOR.CAD_SET_DS_SETOR,
     IML.ATD_IML_DT_ENTRADA || ' - ' || TO_CHAR(TO_DATE(LPAD(TO_CHAR(IML.ATD_IML_HR_ENTRADA), 4, '0'),'HH24:MI'),'HH24:MI'), QLE.CAD_QLE_NR_QUARTO || '/' || QLE.CAD_QLE_NR_LEITO
  ;
  io_cursor := v_cursor;
end PRC_INT_REL_PAC_14_DIAS_SETOR;
