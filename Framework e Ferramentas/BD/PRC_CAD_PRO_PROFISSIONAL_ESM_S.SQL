create or replace procedure PRC_CAD_PRO_PROFISSIONAL_ESM_S
  (
     pCAD_PRO_ID_PROFISSIONAL IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%type DEFAULT NULL,
     pCAD_PRO_NR_CONSELHO IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_NR_CONSELHO%type DEFAULT NULL,
     pCAD_PRO_NM_APELIDO IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_NM_APELIDO%type DEFAULT NULL,
     pCAD_PES_NR_CNPJ_CPF IN TB_CAD_PES_PESSOA.CAD_PES_NR_CNPJ_CPF%type DEFAULT NULL,
     pCAD_PES_NM_PESSOA IN TB_CAD_PES_PESSOA.CAD_PES_NM_PESSOA%type DEFAULT NULL,
     pID_PROFISSIONAL_EXCECAO IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%type DEFAULT NULL,
     pCAD_PRO_FL_ATIVO_OK IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_FL_ATIVO_OK%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Data Alteracao: 12/02/2009  Por: pEDRO
  *    Alteração: Incluindo parametro PRO.CAD_PRO_FL_PERM_EXAME_OK,
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR
    SELECT DISTINCT
       PRO.CAD_PRO_ID_PROFISSIONAL,
       PRO.CAD_PRO_CD_CODCOOMED,
       PRO.CAD_PRO_CD_COD_PRO,
       PRO.CAD_PRO_NR_CONSELHO,
       PRO.CAD_PRO_SG_UF_CONSELHO,
       PRO.CAD_PRO_FL_ATIVO_OK,
       PRO.CAD_PRO_NM_APELIDO,
       PRO.CAD_PRO_DS_BIP_PAGER,
       PRO.CAD_PRO_FL_IMPR_RECIBO_OK,
       PRO.CAD_PRO_FL_STAFF_OK,
       PRO.CAD_PRO_CD_BANCO,
       PRO.CAD_PRO_CD_AGENCIA,
       PRO.CAD_PRO_CD_CONTA,
       PRO.CAD_PRO_FL_PERM_INTERN_OK,
       PRO.CAD_PRO_FL_PERM_ASS_LAUDO_OK,
       PRO.CAD_PRO_CD_MATRICULA,
       PRO.SEG_USU_ID_USUARIO,
       PRO.CAD_PES_ID_PESSOA,
       PRO.TIS_CPR_CD_CONSELHOPROF,
       PRO.CAD_PRO_FL_RESIDENTE_OK,
       PRO.CAD_PRO_NR_ANO_INI_RESIDENCIA,
       PRO.CAD_PRO_DT_INI_RESIDENCIA,
       PRO.CAD_PRO_DT_FIM_RESIDENCIA,
       PRO.CAD_PRO_FL_PERM_EXAME_OK,
       PES.CAD_PES_ID_PESSOA,
       PES.CAD_PES_NR_CNPJ_CPF,
       PES.CAD_PES_FL_JURIDICA_OK,
       PES.CAD_PES_NM_PESSOA,
       PES.CAD_PES_NM_RAZAOSOCIAL,
       PES.CAD_PES_DT_NASCIMENTO,
       PES.CAD_PES_NR_RG,
       PES.CAD_PES_CD_INSCR_MUNIC,
       PES.CAD_PES_CD_INSCR_ESTAD,
  	   PES.CAD_PES_TP_SEXO,
       PES.SEG_USU_ID_USUARIO,
       PES.CAD_PES_CD_ESTADOCIVIL,
       PES.CAD_PES_NM_NOMEMAE,
       PES.CAD_PES_CD_ORGAOEMISSORRG,
       PES.CAD_PES_DT_EXPEDICAORG
    FROM TB_CAD_PRO_PROFISSIONAL PRO,
         TB_CAD_PES_PESSOA PES,
         TB_AGE_ESM_ESCALA_MEDICA ESM
    WHERE
        PRO.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
    AND PRO.CAD_PRO_ID_PROFISSIONAL = ESM.CAD_PRO_ID_PROFISSIONAL
    AND ESM.AGE_ESM_FL_SITUACAO = 'A'
    AND (ESM.AGE_ESM_DT_FIM_ESCALA IS NULL OR ESM.AGE_ESM_DT_FIM_ESCALA >= TRUNC(SYSDATE))
    AND (pCAD_PRO_FL_ATIVO_OK IS NULL OR PRO.CAD_PRO_FL_ATIVO_OK = pCAD_PRO_FL_ATIVO_OK)
    AND (pCAD_PRO_ID_PROFISSIONAL is null OR PRO.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL)
    AND (pCAD_PRO_NR_CONSELHO is null OR PRO.CAD_PRO_NR_CONSELHO = pCAD_PRO_NR_CONSELHO)
    AND (pCAD_PRO_NM_APELIDO is null OR PRO.CAD_PRO_NM_APELIDO = pCAD_PRO_NM_APELIDO)
    AND (pCAD_PES_NM_PESSOA is null OR PES.CAD_PES_NM_PESSOA LIKE UPPER(pCAD_PES_NM_PESSOA))
    AND (pCAD_PES_NR_CNPJ_CPF is null OR PES.CAD_PES_NR_CNPJ_CPF = pCAD_PES_NR_CNPJ_CPF)
    AND (pID_PROFISSIONAL_EXCECAO is null or pro.cad_pro_id_profissional <> pID_PROFISSIONAL_EXCECAO)

    ORDER BY PES.CAD_PES_NM_PESSOA;

    io_cursor := v_cursor;
  end PRC_CAD_PRO_PROFISSIONAL_ESM_S;
/
