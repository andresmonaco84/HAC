CREATE OR REPLACE PROCEDURE "PRC_INT_PERCENTUAL_OCUPACAO_S"
(
  pCAD_UNI_ID_UNIDADE           IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
  pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_CAD_LAT_LOCAL_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
  pTOTAL_PERCENTUAL             OUT NUMBER
)
  IS
  /********************************************************************
  *    Procedure: PRC_INT_PERCENTUAL_OCUPACAO_S
  *
  *    Data Criacao:    03/11/2009     Por: Fabiola
  *    Data Alteracao:  25/11/2010     Por: Pedro
  *    Alteracao:  CASE WHEN TOT_CADASTRO > 0 THEN ROUND(TOT_OCUPADO * 100 / TOT_CADASTRO, 2)
  *
  *    Funcao: Descric?o da funcionalidade da Stored Procedure
  *    Alteracao: Considerar somente leitos oficiais, desconsiderar os desativados e
  *               obter leitos da unidade e local
  *
  *******************************************************************/
  TOT_CADASTRO NUMBER(10, 2);
  TOT_OCUPADO  NUMBER(10, 2);
BEGIN
  SELECT COUNT(*)
    INTO TOT_CADASTRO
    FROM TB_CAD_QLE_QUARTO_LEITO QLE,
         TB_CAD_SET_SETOR SETOR
   WHERE QLE.CAD_SET_ID = SETOR.CAD_SET_ID
     AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
     AND SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO
     AND SETOR.CAD_CSE_ID NOT IN (8,9)
     AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
     AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
     AND QLE.CAD_QLE_TP_QUARTO_LEITO = 'I'
     AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO != 5
;
  SELECT COUNT(*)
    INTO TOT_OCUPADO
    FROM TB_ATD_IML_INT_MOV_LEITO IML,
         TB_CAD_QLE_QUARTO_LEITO  QLE,
         TB_CAD_SET_SETOR         SETOR
   WHERE IML.ATD_IML_DT_SAIDA IS NULL
     AND SETOR.CAD_SET_ID = QLE.CAD_SET_ID
     AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
     AND SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO
     AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
     AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
     AND SETOR.CAD_CSE_ID NOT IN (8,9)
     AND QLE.CAD_QLE_ID = IML.CAD_CAD_QLE_ID
     AND QLE.CAD_QLE_TP_QUARTO_LEITO = 'I'
     AND IML.ATD_IML_FL_STATUS = 'A'
     AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = 2
      ;
  SELECT CASE WHEN TOT_CADASTRO > 0 THEN round( TOT_OCUPADO * 100 / TOT_CADASTRO,2)
         ELSE 0 END
    INTO PTOTAL_PERCENTUAL
    FROM DUAL;
EXCEPTION
  WHEN NO_DATA_FOUND THEN
    PTOTAL_PERCENTUAL := 0;
END PRC_INT_PERCENTUAL_OCUPACAO_S;
