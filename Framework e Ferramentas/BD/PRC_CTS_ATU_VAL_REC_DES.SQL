CREATE OR REPLACE PROCEDURE "PRC_CTS_ATU_VAL_REC_DES" (pCTS_RES_MES IN TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_MES%TYPE,
                                                      pCTS_RES_ANO IN TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_ANO%TYPE) IS
BEGIN
  FOR TEMP_NIVEL IN (SELECT DISTINCT PLC.CAD_CTS_CD_NIVEL
                       FROM TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                      ORDER BY 1 DESC) LOOP
    FOR TEMP IN (SELECT RES.CTS_RES_RESU_TIPO,
                        PLC.CAD_CTS_CD_NIVEL,
                        PLC.CAD_CTS_PLC_REFER_ID,
                        SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) VL_RECEITA_DIRETA,
                        SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI) VL_RECEITA_INTERMEDIARIA,
                        SUM(RES.CTS_RES_RESU_VL_REC_INDIRETA) VL_RECEITA_INDIRETA,
                        SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA) VL_DESPESA_DIRETA,
                        SUM(RES.CTS_RES_RESU_VL_DESP_INTERMEDI) VL_DESPESA_INTERMEDIARIA,
                        SUM(RES.CTS_RES_RESU_VL_DESP_INDIRETA) VL_DESPESA_INDIRETA
                   FROM TB_CTS_RES_RESUMO_GERAL     RES,
                        TB_CAD_CTS_PLC_PLANO_CONTAS PLC
                  WHERE RES.CTS_RES_RESU_MES = pCTS_RES_MES
                    AND RES.CTS_RES_RESU_ANO = pCTS_RES_ANO
                    AND RES.CTS_RES_RESU_CAD_CTS_PLC_ID = PLC.CAD_CTS_PLC_ID
                  GROUP BY RES.CTS_RES_RESU_TIPO,
                           PLC.CAD_CTS_CD_NIVEL,
                           PLC.CAD_CTS_PLC_REFER_ID
                  ORDER BY PLC.CAD_CTS_CD_NIVEL DESC) LOOP
      BEGIN
        UPDATE TB_CTS_RES_RESUMO_GERAL CTS
           SET CTS.CTS_RES_RESU_VL_REC_DIRETA = TEMP.VL_RECEITA_DIRETA,
               CTS.CTS_RES_RESU_VL_REC_INTERMEDI = TEMP.VL_RECEITA_INTERMEDIARIA,
               CTS.CTS_RES_RESU_VL_REC_INDIRETA = TEMP.VL_RECEITA_INDIRETA,
               CTS.CTS_RES_RESU_VL_DESP_DIRETA = TEMP.VL_DESPESA_DIRETA,
               CTS.CTS_RES_RESU_VL_DESP_INTERMEDI = TEMP.VL_DESPESA_INTERMEDIARIA,
               CTS.CTS_RES_RESU_VL_DESP_INDIRETA = TEMP.VL_DESPESA_INDIRETA
         WHERE CTS.CTS_RES_RESU_CAD_CTS_PLC_ID = TEMP.CAD_CTS_PLC_REFER_ID
           AND CTS.CTS_RES_RESU_MES = pCTS_RES_MES
           AND CTS.CTS_RES_RESU_ANO = pCTS_RES_ANO
           AND CTS.CTS_RES_RESU_TIPO = TEMP.CTS_RES_RESU_TIPO;
      END;
      COMMIT;
    END LOOP;
  END LOOP;
END PRC_CTS_ATU_VAL_REC_DES;
