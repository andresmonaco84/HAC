create or replace procedure PRC_MTMD_MOV_MOVIMENTACAO_SID
(
     pMTMD_MOV_ID   IN  TB_MTMD_MOV_MOVIMENTACAO.MTMD_MOV_ID%TYPE,
     io_cursor      OUT PKG_CURSOR.t_cursor
)
  is
  /********************************************************************
  *    Procedure: PRC_MTMD_MOV_HIST_PACIENTE
  *
  *    Data Criacao: 	08/07/2010   Por: RICARDO COSTA
  *    Data Alteracao:27/09/2010   Por: Andre S. Monaco  
  *         Alterac?o: Adic?o do campo SEG_USU_ID_USUARIO
  *    Data Alteracao:01/10/2010   Por: Andre S. Monaco
  *         Alterac?o: Adic?o do campo Data e Hora do Faturamento
  *    Data Alteracao:  24/10/2017  Por: Andre S. Monaco
  *         Alteracao:  Adicao funcao SOUND ALIKE na descricao    
  *  
  *    Funcao: RETORNA MOVIMENTAC?O DE PRODUTOS, POR PACIENTE/SETOR
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  NAO_FRACIONADO CONSTANT NUMBER := 0;
  CONSUMO_FRACIONADO             CONSTANT NUMBER :=14;
  CONSUMO_NAO_FRACIONADO         CONSTANT NUMBER :=11;  
  CONSUMO_NAO_FATURADO           CONSTANT NUMBER :=18;    
  SIM            CONSTANT NUMBER := 1;
  NAO            CONSTANT NUMBER := 0;
BEGIN
    OPEN v_cursor FOR
    SELECT
       MOVIMENTACAO.MTMD_MOV_ID,
       MOVIMENTACAO.CAD_LAT_ID_LOCAL_ATENDIMENTO,
       MOVIMENTACAO.CAD_UNI_ID_UNIDADE,
       MOVIMENTACAO.CAD_SET_ID,
       MOVIMENTACAO.MTMD_REQ_ID,
       MOVIMENTACAO.MTMD_LOTEST_ID,
       MOVIMENTACAO.CAD_MTMD_ID,
       MOVIMENTACAO.CAD_MTMD_TPMOV_ID,
       MOVIMENTACAO.CAD_MTMD_SUBTP_ID,
       MOVIMENTACAO.MTMD_MOV_DATA,
       MOVIMENTACAO.MTMD_MOV_QTDE,
       MOVIMENTACAO.MTMD_MOV_FL_FINALIZADO,
       MOVIMENTACAO.ATD_ATE_ID,
       MOVIMENTACAO.ATD_ATE_TP_PACIENTE,
       MOVIMENTACAO.MTMD_MOV_FL_FATURADO,
       MOVIMENTACAO.CAD_MTMD_FILIAL_ID,
       MOVIMENTACAO.MTMD_TP_FRACAO_ID,
       MOVIMENTACAO.MTMD_MOV_DATA_FATURAMENTO,
       MOVIMENTACAO.MTMD_MOV_HORA_FATURAMENTO,
       CASE
          WHEN ( MOVIMENTACAO.CAD_MTMD_SUBTP_ID = CONSUMO_FRACIONADO AND PRODUTO.CAD_MTMD_FL_FRACIONA = NAO ) THEN FNC_MTMD_SOUNDALIKE(PRODUTO.CAD_MTMD_NOMEFANTASIA,PRODUTO.CAD_MTMD_GRUPO_ID)||' (FRACIONADO) '
          ELSE FNC_MTMD_SOUNDALIKE(PRODUTO.CAD_MTMD_NOMEFANTASIA,PRODUTO.CAD_MTMD_GRUPO_ID)
       END CAD_MTMD_NOMEFANTASIA,
       PRODUTO.CAD_MTMD_UNIDADE_VENDA,
       -- PRODUTO.CAD_MTMD_FL_FRACIONA,
       CASE
             WHEN ( MOVIMENTACAO.CAD_MTMD_SUBTP_ID = CONSUMO_NAO_FRACIONADO AND PRODUTO.CAD_MTMD_FL_FRACIONA = SIM ) THEN ( NAO_FRACIONADO ) -- FRACIONADO PARA INTEIRO 
             ELSE ( PRODUTO.CAD_MTMD_FL_FRACIONA  )
       END CAD_MTMD_FL_FRACIONA,
       CASE
         WHEN (MOVIMENTACAO.MTMD_TP_FRACAO_ID IS NOT NULL) THEN
            TO_CHAR(MOVIMENTACAO.MTMD_QTD_CONVERTIDA)||' '||(SELECT MTMD_DS_TP_FRACAO FROM TB_MTMD_TIPO_FRACAO WHERE MTMD_TP_FRACAO_ID = MOVIMENTACAO.MTMD_TP_FRACAO_ID)
         WHEN ( MOVIMENTACAO.CAD_MTMD_SUBTP_ID = CONSUMO_FRACIONADO AND PRODUTO.CAD_MTMD_FL_FRACIONA = NAO ) THEN 'FRACIONADO'
         WHEN ( MOVIMENTACAO.CAD_MTMD_SUBTP_ID = CONSUMO_NAO_FRACIONADO AND PRODUTO.CAD_MTMD_FL_FRACIONA = SIM ) THEN 'INTEIRO'
         WHEN ( MOVIMENTACAO.CAD_MTMD_SUBTP_ID = CONSUMO_NAO_FATURADO   AND PRODUTO.CAD_MTMD_FL_FRACIONA = SIM ) THEN 'INTEIRO'
         ELSE NULL
       END  DS_QTDE_CONVERTIDA,
       NULL MTMD_DT_RESSUPRIMENTO,
       SETOR.CAD_SET_DS_SETOR,
       UNIDADE.CAD_UNI_DS_UNIDADE,
       SUBTP.CAD_MTMD_SUBTP_DESCRICAO,
       SUBTP.CAD_MTMD_FL_FATURA,
       MOVIMENTACAO.SEG_USU_ID_USUARIO,
       USU_MOV.SEG_USU_DS_NOME DS_USUARIO,
       (CASE
           WHEN PRODUTO.CAD_MTMD_FL_FRACIONA = SIM AND MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN (14, 35 ) THEN 
              TO_CHAR( MOVIMENTACAO.MTMD_MOV_QTDE )||'/'||TO_CHAR( PRODUTO.CAD_MTMD_UNIDADE_VENDA)
           ELSE
              TO_CHAR( MOVIMENTACAO.MTMD_MOV_QTDE )
        END)  DS_QTDE_CONSUMO
    FROM TB_MTMD_MOV_MOVIMENTACAO       MOVIMENTACAO,
         TB_CAD_MTMD_MAT_MED            PRODUTO,
         TB_CAD_SET_SETOR               SETOR,
         TB_CAD_UNI_UNIDADE             UNIDADE,
         TB_CAD_MTMD_SUBTP_MOVIMENTACAO SUBTP,
         TB_SEG_USU_USUARIO             USU_MOV
    WHERE MOVIMENTACAO.MTMD_MOV_ID       = pMTMD_MOV_ID
    AND   PRODUTO.CAD_MTMD_ID            = MOVIMENTACAO.CAD_MTMD_ID 
    AND   SETOR.CAD_SET_ID               = MOVIMENTACAO.CAD_SET_ID 
    AND   UNIDADE.CAD_UNI_ID_UNIDADE     = MOVIMENTACAO.CAD_UNI_ID_UNIDADE 
    AND   SUBTP.CAD_MTMD_SUBTP_ID        = MOVIMENTACAO.CAD_MTMD_SUBTP_ID 
    AND   USU_MOV.SEG_USU_ID_USUARIO(+)  = MOVIMENTACAO.SEG_USU_ID_USUARIO 
    ORDER BY MOVIMENTACAO.MTMD_MOV_DATA DESC, PRODUTO.CAD_MTMD_NOMEFANTASIA ASC;
    io_cursor := v_cursor;
end PRC_MTMD_MOV_MOVIMENTACAO_SID;