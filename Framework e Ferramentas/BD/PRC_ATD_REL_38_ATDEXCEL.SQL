CREATE OR REPLACE PROCEDURE PRC_atd_rel_38_atdexcel
(
    PATD_DT_INICIO IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE,
    PATD_DT_FIM IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE,
    PCAD_UNI_ID_UNIDADE VARCHAR2 DEFAULT NULL,
    PATD_ATE_FL_STATUS  IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_STATUS%TYPE,
    PTIS_TAT_CD_TPATENDIMENTO   IN TB_ATD_ATE_ATENDIMENTO.TIS_TAT_CD_TPATENDIMENTO%TYPE default null,

    io_cursor OUT PKG_CURSOR.t_cursor--,
  -- ,TESTE OUT  LONG
)
IS
/********************************************************************
*    Procedure: PRC_atd_rel_38_atdexcel  ------->>>>>
*
*
*
*    Data Criac?o: 18/1/2020  Por: Pedro H. A. C.
*    Alterac?o:
*
*
*******************************************************************/
v_cursor PKG_CURSOR.t_cursor;


  V_SELECT  varchar2(30000);
  begin


    V_SELECT :=
   '
  SELECT
         UNI.CAD_UNI_DS_UNIDADE UNIDADE,
         LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO LOCAL,
         ATD.ATD_ATE_ID ATENDIMENTO,
         ATD.ATD_ATE_FL_STATUS STATUS_ATENDIMENTO,
         ATD.ATD_ATE_FL_RETORNO_OK RETORNO_ATENDIMENTO,
         S.CAD_SET_DS_SETOR SETOR,
         S.CAD_SET_NR_ANDAR NR_ANDAR,
         trunc(ATD.ATD_ATE_DT_ATENDIMENTO)  DT_ATENDIMENTO,
         ATD.ATD_ATE_HR_ATENDIMENTO HR_ATENDIMENTO,
         TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,''MM'') MES_ATENDIMENTO,
         TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,''yyyy'') ANO_ATENDIMENTO,
          CASE
            WHEN ATD.ATD_ATE_FL_CARATER_SOLIC = ''E'' AND ATD.CAD_UNI_ID_UNIDADE != 250 THEN ''ELETIVO''
            WHEN ATD.ATD_ATE_FL_CARATER_SOLIC = ''E'' AND ATD.CAD_UNI_ID_UNIDADE = 250 THEN ''URGENCIA''
            WHEN ATD.ATD_ATE_FL_CARATER_SOLIC = ''U'' THEN ''URGENCIA''
            END CARATER_SOLICITACAO,
            CASE
            WHEN ATD.ATD_ATE_TP_PACIENTE = ''I'' THEN ''INTERNADO''
            WHEN ATD.ATD_ATE_TP_PACIENTE = ''U'' THEN ''PS''
            WHEN ATD.ATD_ATE_TP_PACIENTE = ''A'' THEN ''AMBULATORIAL''
            WHEN ATD.ATD_ATE_TP_PACIENTE = ''E'' THEN ''INTERNADO_SEM_LEITO''
            END TIPOPACIENTE,
            CASE
            WHEN ATD.ATD_ATE_TP_PACIENTE IN (''I'',''E'') THEN ''I''
            WHEN ATD.ATD_ATE_TP_PACIENTE = ''U'' AND ATD.TIS_TAT_CD_TPATENDIMENTO = 4 THEN ''U''
            WHEN ATD.ATD_ATE_TP_PACIENTE IN (''A'',''U'') AND ATD.TIS_TAT_CD_TPATENDIMENTO != 4 THEN ''E''
            WHEN ATD.ATD_ATE_TP_PACIENTE = ''A'' AND ATD.TIS_TAT_CD_TPATENDIMENTO = 4 THEN ''A''
            END TIPOPACIENTE2,
            CASE
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 1 THEN ''REMOCAO''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 2 THEN ''PEQUENA_CIRURGIA''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 3 THEN ''TERAPIA_TRATAMENTO_PROCEDIMENTO''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 4 THEN ''CONSULTA''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 5 THEN ''EXAME''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 6 THEN ''ATENDIMENTO_DOMICILIAR''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 7 THEN ''INTERNACAO''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 8 THEN ''QUIMIOTERAPIA''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 9 THEN ''RADIOTERAPIA''
            WHEN ATD.TIS_TAT_CD_TPATENDIMENTO = 10 THEN ''TERAPIA_RENAL_SUBSTITUTIVA''
            END TIPOATENDIMENTO,
            CASE WHEN ATD.ATD_ATE_TP_DOMICILIAR = ''A'' THEN ''AUDITORIA ANS''
                 WHEN ATD.ATD_ATE_TP_DOMICILIAR = ''D'' THEN ''DESOSPITALIZA¨¿O''
                 WHEN ATD.ATD_ATE_TP_DOMICILIAR = ''L'' THEN ''LIMINAR''
            END TP_ATEND_DOMICILIAR,
         CID.CAD_CID_CD_CID10 CODIGO_CID, CID.CAD_CID_DS_CID10 CID,

         CASE WHEN CNV.CAD_CGC_ID = 2 THEN ''EXTRA GRUPO'' ELSE ''GRUPO'' END CLASSIF1,

         CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN ''EXTRA GRUPO/MERCADO''
              WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN ''EXTRA GRUPO/PARTICULAR''
         ELSE ''GRUPO'' END classif2,

         CNV.CAD_CNV_CD_HAC_PRESTADOR CD_CONVENIO,
         CNV.CAD_CNV_NM_FANTASIA CONVENIO,
         CNV.CAD_TPE_CD_CODIGO TIPO_CONVENIO,
         PLA.CAD_PLA_CD_PLANO_HAC,
         PLA.CAD_PLA_NM_NOME_PLANO,

         CBO.TIS_CBO_DS_CBOS_HAC ESPECIALIDADE,
         PRO.CAD_PRO_NM_NOME NOME_PROFISSIONAL,
         PRO.CAD_PRO_NR_CONSELHO NR_CONSELHO_PROF,
         PRO.CAD_PRO_SG_UF_CONSELHO UF_CONSELHO_PROF,

         PES_PAC.CAD_PES_NM_PESSOA NOME_PACIENTE,
        trunc( PES_PAC.CAD_PES_DT_NASCIMENTO)  DT_NASC,
         FLOOR(FLOOR(MONTHS_BETWEEN(ATD.ATD_ATE_DT_ATENDIMENTO, PES_PAC.CAD_PES_DT_NASCIMENTO)) / 12) IDADE,
         PES_PAC.CAD_PES_TP_SEXO SEXO,
         NVL(ATD.ATD_ATE_FL_SUSPEITA_COVID19,''N'') ATD_ATE_FL_SUSPEITA_COVID19,

         fnc_cad_pes_municipio_s(PES_PAC.CAD_PES_ID_PESSOA,1) municipio,
         fnc_cad_pes_endereco_s(PES_PAC.CAD_PES_ID_PESSOA,1) ENDERECO,
         NVL(ATD.ATD_ATE_DS_COMPLEMENTO,''PRESENCIAL'') ATD_ATE_DS_COMPLEMENTO
         ,USU.SEG_USU_DS_NOME NOME_USUARIO, ATD.ATD_ATE_DT_ULTIMA_ATUALIZACAO DATA_ATUALIZACAO
         ,ATD.ATD_ATE_IN_TEA
    ,DECODE(AA.ENCAMINHA,''R'',''RETORNO'',''S'',''RETORNO SADT'',''I'',''INTERNACAO'',''A'',''ALTA'',''O'',''OBITO'',''E'',''ESPECIALISTA'',''U'',''URGENTE'',''C'',''CRONICA'') SAIDA
    ,DECODE(TRI.CAD_TRI_FL_ENCAMINHAMENTO,''O'',''ONCOLÓGICO'',''G'',''GERAL'') CAD_TRI_FL_ENCAMINHAMENTO
    ,CASE WHEN QP.DS_REAVALIACAO IS NOT NULL THEN ''S'' WHEN QP.DS_QUEIXA IS NOT NULL THEN ''N'' ELSE NULL END  FL_REAVALIACAO,
    AA.IN_ENXAQUECA,
    AA.IN_CEFALEIA_SALVAS,
    AA.IN_CEFALEIA_TENSAO,
    AA.IN_TOMOGRAFIA,
    AA.IN_OPIOIDE,
    ATD.ATD_ATE_IN_TEA,
    DECODE(ATD.ATD_ATE_ID_PRIORIDADE_ATEND,1,''VERMELHO'',2,''LARANJA'',3,''AMARELO'',4,''VERDE'',5,''AZUL'') PRIORIDADE_ATEND,
    to_char(TRI.CAD_TRI_DT_TRIAGEM,''dd/MM/yyyy'') DATA_TRIAGEM,
    TRI.CAD_TRI_HR_TRIAGEM HORA_TRIAGEM,
    to_char(AA.DATATE,''dd/MM/yyyy'') DATA_MEDICO,
    AA.HORATE HORA_MEDICO,
    to_char(TOTEM.DATA_GERADA,''dd/MM/yyyy'') DATA_TOTEM,
    to_char(TOTEM.DATA_GERADA,''HH24:MI'') HORA_TOTEM,
    to_number(atd.atd_ate_nr_senha_chamada) ATD_ATE_NR_SENHA_CHAMADA,
    CASE WHEN tri.cad_tri_dt_triagem IS NOT NULL AND TOTEM.DATA_GERADA IS NOT NULL THEN
    LPAD(TRUNC(24* (fnc_juntar_data_hora(tri.cad_tri_dt_triagem,tri.cad_tri_hr_triagem) - TOTEM.DATA_GERADA)),2,''0'') ||'':''||
LPAD(TRUNC(MOD(MOD(fnc_juntar_data_hora(tri.cad_tri_dt_triagem,tri.cad_tri_hr_triagem) - TOTEM.DATA_GERADA,1)*24,1)*60),2,''0'') 
    ELSE NULL END  TEMPO_TRIAGEM,
    
   CASE WHEN TOTEM.DATA_GERADA IS NOT NULL AND AA.DATATE IS NOT NULL THEN
  -- fnc_juntar_data_hora(AA.DATATE,REPLACE(AA.HORATE,'':'',''''))
    LPAD(TRUNC(24* (fnc_juntar_data_hora(AA.DATATE,REPLACE(AA.HORATE,'':'','''')) - TOTEM.DATA_GERADA)),2,''0'') ||'':''||
  LPAD(TRUNC(MOD(MOD(fnc_juntar_data_hora(AA.DATATE,REPLACE(AA.HORATE,'':'','''')) - TOTEM.DATA_GERADA,1)*24,1)*60),2,''0'') 
    ELSE NULL END  TEMPO_TOTAL


    FROM TB_ATD_ATE_ATENDIMENTO ATD
    JOIN TB_CAD_UNI_UNIDADE UNI ON ATD.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
    JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO
    JOIN TB_CAD_SET_SETOR S ON ATD.CAD_SET_ID = S.CAD_SET_ID
    JOIN TB_ASS_PAT_PACIEATEND PAT ON PAT.ATD_ATE_ID = ATD.ATD_ATE_ID
    JOIN TB_CAD_PAC_PACIENTE PAC ON PAC.CAD_PAC_ID_PACIENTE = PAT.CAD_PAC_ID_PACIENTE
    JOIN TB_CAD_CNV_CONVENIO CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
    JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
    JOIN TB_CAD_PES_PESSOA PES_PAC ON PES_PAC.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
    LEFT JOIN TB_CAD_CID_CID10 CID ON CID.CAD_CID_CD_CID10 = ATD.CAD_CID_CD_CID10
    JOIN TB_SEG_USU_USUARIO USU ON USU.SEG_USU_ID_USUARIO = ATD.SEG_USU_ID_USUARIO

    LEFT JOIN TB_TIS_CBO_CBOS CBO ON CBO.TIS_CBO_CD_CBOS = ATD.TIS_CBO_CD_CBOS
    LEFT JOIN TB_CAD_PRO_PROFISSIONAL PRO ON PRO.CAD_PRO_ID_PROFISSIONAL = ATD.CAD_PRO_ID_PROF_EXEC
    LEFT JOIN ATENDIMENTO AA ON AA.CODATEAMB = ATD.ATD_ATE_ID
    LEFT JOIN  TB_CAD_TRI_TRIAGEM TRI ON TRI.ATD_ATE_ID = ATD.ATD_ATE_ID
    LEFT JOIN TB_QUEIXA_PS QP ON QP.CODATEAMB = ATD.ATD_ATE_ID AND QP.DS_REAVALIACAO IS NOT NULL
    left join  sgs.TB_HISTORICO_PAINEL TOTEM on TOTEM.SENHA = TRI.CAD_TRI_SENHA
      AND pac.CAD_PES_ID_PESSOA = TRI.CAD_PES_ID_PESSOA
      AND atD.ATD_ATE_ID        = TRI.ATD_ATE_ID
      AND TOTEM.DATA_GERADA >= fnc_juntar_data_hora(tri.cad_tri_dt_triagem,tri.cad_tri_hr_triagem) - INTERVAL ''3'' HOUR
      AND TOTEM.DATA_GERADA <= fnc_juntar_data_hora(tri.cad_tri_dt_triagem,tri.cad_tri_hr_triagem)
   and totem.id_servico=0
   AND TOTEM.ID_UNIDADE = ATD.CAD_UNI_ID_UNIDADE
      AND TOTEM.ID_SETOR = ATD.CAD_SET_ID
      
  WHERE
       (ATD.ATD_ATE_DT_ATENDIMENTO BETWEEN ' ||chr(39)||  PATD_DT_INICIO ||chr(39)|| ' AND ' ||chr(39)||  PATD_DT_FIM ||chr(39)|| ')
 AND UNI.CAD_UNI_ID_UNIDADE in (' ||  PCAD_UNI_ID_UNIDADE || ') -- COMENTAR ESSA LINHA PARA REFRESH NO DATASET DO RELATORIO

       and (' ||chr(39)|| PTIS_TAT_CD_TPATENDIMENTO  ||chr(39)|| ' is null or atd.tIS_TAT_CD_TPATENDIMENTO = ' ||chr(39)|| PTIS_TAT_CD_TPATENDIMENTO  ||chr(39)|| ')
       AND ATD.ATD_ATE_FL_STATUS = ' ||chr(39)||  PATD_ATE_FL_STATUS ||chr(39)|| '';
  -- TESTE :=  V_SELECT ;
OPEN v_cursor FOR
  --   SELECT 1 FROM DUAL;
   V_SELECT ;

    io_cursor := v_cursor;

END PRC_atd_rel_38_atdexcel;
