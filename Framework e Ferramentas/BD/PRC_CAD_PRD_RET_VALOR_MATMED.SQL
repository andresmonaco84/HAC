CREATE OR REPLACE PROCEDURE PRC_CAD_PRD_RET_VALOR_MATMED
(
     pCAD_CNV_ID_CONVENIO        IN TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_CNV_ID_CONVENIO%TYPE,
     pCAD_PRD_ID                 IN TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_PRD_ID%TYPE,
     pTIS_MED_CD_TABELAMEDICA    IN TB_CAD_VCM_VAL_COBR_MAT_MED.TIS_MED_CD_TABELAMEDICA%TYPE, -- SINPOR/BRASINDICE RECUPERADO EM PRC_FAT_TABELA_UTILIZADA
     pCAD_CMM_CD_CARACMATMED     IN TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_CMM_CD_CARACMATMED%TYPE,  -- RECUPERADO DO PRODUTO (TB_CAD_CMM_CARACT_MATMED CARACTERISTICA DO PRODUTO)
     pCAD_TAP_TP_ATRIBUTO        IN TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_TAP_TP_ATRIBUTO%TYPE,     -- MAT/MED
     pDATA                       IN DATE,
     pQTDE                       IN NUMBER,
     pCAD_PRD_FL_FRACIONADO      IN TB_CAD_PRD_PRODUTO.CAD_PRD_FL_FRACIONADO%TYPE,
     pCAD_PRD_QT_APR_MATMED      IN TB_CAD_PRD_PRODUTO.CAD_PRD_QT_APR_MATMED%TYPE,
     pVALOR_CALCULADO            OUT TB_FAT_CCI_CONTA_CONSU_ITEM.FAT_CCI_VL_CALCULADO%TYPE,
     pVALOR_PRODUTO              IN  TB_FAT_CCI_CONTA_CONSU_ITEM.FAT_CCI_VL_PRODUTO%TYPE,
     pCAD_VCM_PC_MARGEM          OUT TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_VCM_PC_MARGEM%TYPE
) IS
   /********************************************************************
   *    Procedure: PRC_CAD_PRD_RET_VALOR_MATMED
   *
   *    Data Criacao:   22/09/2010 Por: ANDREA CAZUCA
   *    Data Alteracao:             Por:
   *    Funcao: RETORNA VALOR DO PRODUTO
   *            BUSCA POR:
   *            CONVENIO + TABELA MEDICA TISS + CARACTERISTICA + TIPO DE ATRIBUTO ( MAT/MED) + ID PRODUTO
   *            CONVENIO + TABELA MEDICA TISS + CARACTERISTICA + TIPO DE ATRIBUTO ( MAT/MED)
   *            CONVENIO + TABELA MEDICA TISS +                + TIPO DE ATRIBUTO ( MAT/MED)
   *******************************************************************/
SIM          CONSTANT NUMBER := 1;
vCAD_VCM_FL_ISENTO_COBRANCA TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_VCM_FL_ISENTO_COBRANCA%TYPE;
vCAD_VCM_VL_FINAL           TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_VCM_VL_FINAL%TYPE;
vCAD_VCM_PC_MARGEM          TB_CAD_VCM_VAL_COBR_MAT_MED.CAD_VCM_PC_MARGEM%TYPE;
BEGIN
   BEGIN
      -- PRIMEIRA REGRA CONVENIO + TABELA MEDICA TISS + CARACTERISTICA + TIPO DE ATRIBUTO ( MAT/MED) + ID PRODUTO
      SELECT   DECODE(VLR.CAD_VCM_FL_ISENTO_COBRANCA,'S',1,'N',0),
               VLR.CAD_VCM_VL_FINAL, VLR.CAD_VCM_PC_MARGEM
      INTO     vCAD_VCM_FL_ISENTO_COBRANCA,
               vCAD_VCM_VL_FINAL,
               vCAD_VCM_PC_MARGEM
      FROM TB_CAD_VCM_VAL_COBR_MAT_MED VLR
      WHERE VLR.CAD_CNV_ID_CONVENIO          = pCAD_CNV_ID_CONVENIO
      AND   VLR.CAD_PRD_ID                   = PCAD_PRD_ID
      AND   VLR.CAD_CMM_CD_CARACMATMED       = pCAD_CMM_CD_CARACMATMED
      AND   VLR.TIS_MED_CD_TABELAMEDICA      = pTIS_MED_CD_TABELAMEDICA
      AND   VLR.CAD_TAP_TP_ATRIBUTO          = pCAD_TAP_TP_ATRIBUTO
      AND   VLR.CAD_VCM_FL_STATUS            = 'A'
      AND   ( (TRUNC(pDATA) BETWEEN CAD_VCM_DT_INICIO_VIGENCIA AND CAD_VCM_DT_FIM_VIGENCIA)
              OR ( CAD_VCM_DT_INICIO_VIGENCIA <= TRUNC(pDATA) AND CAD_VCM_DT_FIM_VIGENCIA IS NULL ) )
      AND ROWNUM = 1;
      -- VALOR DO PRODUTO VOLTA INALTERADO
      -- ACHOU MONTA VALORES
      IF ( pCAD_PRD_FL_FRACIONADO = SIM  ) THEN
         pVALOR_CALCULADO := ((vCAD_VCM_VL_FINAL * pQTDE)/ pCAD_PRD_QT_APR_MATMED);
      ELSE
         pVALOR_CALCULADO := vCAD_VCM_VL_FINAL * pQTDE;
      END IF;
      pCAD_VCM_PC_MARGEM := NVL(vCAD_VCM_PC_MARGEM,0);
   EXCEPTION
   WHEN TOO_MANY_ROWS THEN
      RAISE_APPLICATION_ERROR(-20000,' VARIAS LINHAS ENCONTRADAS NA PESQUISA DE VALOR DO MAT/MED (PRIMEIRA REGRA) '||
                                     ' CONVENIO '||TO_CHAR(pCAD_CNV_ID_CONVENIO)||
                                     ' PRODUTO '||TO_CHAR(pCAD_PRD_ID)||
                                     ' CARACTERISTICA '||TO_CHAR(pCAD_CMM_CD_CARACMATMED)||
                                     ' TABELA USADA '||pTIS_MED_CD_TABELAMEDICA);
   WHEN NO_DATA_FOUND THEN
         BEGIN
            -- SEGUNDA REGRA CONVENIO + TABELA MEDICA TISS + CARACTERISTICA + TIPO DE ATRIBUTO ( MAT/MED) ( SEM PRODUTO )
            SELECT   DECODE(VLR.CAD_VCM_FL_ISENTO_COBRANCA,'S',1,'N',0),
                     VLR.CAD_VCM_VL_FINAL,
                     VLR.CAD_VCM_PC_MARGEM
            INTO     vCAD_VCM_FL_ISENTO_COBRANCA,
                     vCAD_VCM_VL_FINAL,
                     vCAD_VCM_PC_MARGEM
            FROM TB_CAD_VCM_VAL_COBR_MAT_MED VLR
            WHERE VLR.CAD_CNV_ID_CONVENIO     = pCAD_CNV_ID_CONVENIO
            AND   VLR.CAD_TAP_TP_ATRIBUTO     = pCAD_TAP_TP_ATRIBUTO
            AND   VLR.CAD_CMM_CD_CARACMATMED  = pCAD_CMM_CD_CARACMATMED
            AND   VLR.TIS_MED_CD_TABELAMEDICA = pTIS_MED_CD_TABELAMEDICA
            AND   VLR.CAD_VCM_FL_STATUS       = 'A'
            AND   ( (TRUNC(pDATA) BETWEEN VLR.CAD_VCM_DT_INICIO_VIGENCIA AND VLR.CAD_VCM_DT_FIM_VIGENCIA)
                    OR ( VLR.CAD_VCM_DT_INICIO_VIGENCIA <= TRUNC(pDATA) AND VLR.CAD_VCM_DT_FIM_VIGENCIA IS NULL ) )
            AND ROWNUM = 1;
            -- VALOR DO PRODUTO VOLTA INALTERADO
            -- ACHOU MONTA VALORES
            IF ( pCAD_PRD_FL_FRACIONADO = SIM  ) THEN
               pVALOR_CALCULADO := ((NVL(pVALOR_PRODUTO,0) * pQTDE ) * ((vCAD_VCM_PC_MARGEM/100)+1))/ pCAD_PRD_QT_APR_MATMED;
            ELSE
               pVALOR_CALCULADO := (NVL(pVALOR_PRODUTO,0) * pQTDE* ((vCAD_VCM_PC_MARGEM/100)+1));
            END IF;
            pCAD_VCM_PC_MARGEM := NVL(vCAD_VCM_PC_MARGEM,0);
         EXCEPTION
         WHEN TOO_MANY_ROWS THEN
            RAISE_APPLICATION_ERROR(-20000,' VARIAS LINHAS ENCONTRADAS NA PESQUISA DE VALOR DO MAT/MED (SEGUNDA REGRA) '||
                                           ' CONVENIO '||TO_CHAR(pCAD_CNV_ID_CONVENIO)||
--                                           ' PRODUTO '||TO_CHAR(pCAD_PRD_ID)||
                                           ' CARACTERISTICA '||TO_CHAR(pCAD_CMM_CD_CARACMATMED)||
                                           ' TABELA USADA '||pTIS_MED_CD_TABELAMEDICA);
         WHEN NO_DATA_FOUND THEN
            BEGIN
               -- TERCEIRA REGRA CONVENIO + TABELA MEDICA TISS +                + TIPO DE ATRIBUTO ( MAT/MED)
               -- SEM PRODUTO E SEM CARACTERISTICA
               SELECT   DECODE(VLR.CAD_VCM_FL_ISENTO_COBRANCA,'S',1,'N',0),
                        VLR.CAD_VCM_VL_FINAL,
                        VLR.CAD_VCM_PC_MARGEM
               INTO     vCAD_VCM_FL_ISENTO_COBRANCA,
                        vCAD_VCM_VL_FINAL,
                        vCAD_VCM_PC_MARGEM
               FROM TB_CAD_VCM_VAL_COBR_MAT_MED VLR
               WHERE VLR.CAD_CNV_ID_CONVENIO     = pCAD_CNV_ID_CONVENIO
               AND   VLR.CAD_TAP_TP_ATRIBUTO     = pCAD_TAP_TP_ATRIBUTO
               AND   VLR.TIS_MED_CD_TABELAMEDICA = pTIS_MED_CD_TABELAMEDICA
               AND   VLR.CAD_VCM_FL_STATUS       = 'A'
               AND   ( (TRUNC(pDATA) BETWEEN VLR.CAD_VCM_DT_INICIO_VIGENCIA AND VLR.CAD_VCM_DT_FIM_VIGENCIA)
                       OR ( VLR.CAD_VCM_DT_INICIO_VIGENCIA <= TRUNC(pDATA) AND VLR.CAD_VCM_DT_FIM_VIGENCIA IS NULL ) )
               AND ROWNUM = 1;
               -- VALOR DO PRODUTO VOLTA INALTERADO
               -- ACHOU MONTA VALORES
               IF ( pCAD_PRD_FL_FRACIONADO = SIM  ) THEN
                  pVALOR_CALCULADO := ((NVL(pVALOR_PRODUTO,0) * pQTDE ) * ((vCAD_VCM_PC_MARGEM/100)+1))/ pCAD_PRD_QT_APR_MATMED;
               ELSE
                  pVALOR_CALCULADO := (NVL(pVALOR_PRODUTO,0) * pQTDE* ((vCAD_VCM_PC_MARGEM/100)+1));
               END IF;
               pCAD_VCM_PC_MARGEM := NVL(vCAD_VCM_PC_MARGEM,0);
            EXCEPTION
            WHEN TOO_MANY_ROWS THEN
               RAISE_APPLICATION_ERROR(-20000,' VARIAS LINHAS ENCONTRADAS NA PESQUISA DE VALOR DO MAT/MED (TERCEIRA REGRA) '||
                                              ' CONVENIO '||TO_CHAR(pCAD_CNV_ID_CONVENIO)||
   --                                           ' PRODUTO '||TO_CHAR(pCAD_PRD_ID)||
                                              ' CARACTERISTICA '||TO_CHAR(pCAD_CMM_CD_CARACMATMED)||
                                              ' TABELA USADA '||pTIS_MED_CD_TABELAMEDICA);
            WHEN NO_DATA_FOUND THEN
               -- SE NAO ENCONTRAR USA O PADRÃO DA TABELA DE PRODUTO
               pVALOR_CALCULADO := NVL(pVALOR_PRODUTO,0);
               pCAD_VCM_PC_MARGEM := NVL(vCAD_VCM_PC_MARGEM,0);
            END;
         END;
   END;
   
   EXCEPTION
   WHEN NO_DATA_FOUND THEN
   -- SE NAO ENCONTRAR USA O PADRÃO DA TABELA DE PRODUTO
   pVALOR_CALCULADO := NVL(pVALOR_PRODUTO,0);
   pCAD_VCM_PC_MARGEM := NVL(vCAD_VCM_PC_MARGEM,0);
   
END PRC_CAD_PRD_RET_VALOR_MATMED;
