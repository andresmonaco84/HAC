CREATE OR REPLACE PROCEDURE "PRC_CTS_ATUALIZA_DIARIAS"(P_CTS_RES_MES IN TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_MES%TYPE,
                                                       P_CTS_RES_ANO IN TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_ANO%TYPE) IS
  /********************************************************************
  *
  *    PROCEDURE: PRC_CTS_ATUALIZA_DIARIAS
  *    DATA: 31/10/2014       POR: Fabiola
  *
  *********************************************************************/
BEGIN
  DECLARE
    CURSOR ATU IS
      SELECT 'DIARIA DE APARTAMENTO' DESCRICAO,
             '110001' CONTA,
             SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL( QT_PROCED,0)) ) ,0)),
                     0)) QUANTIDADE
      
        FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
       WHERE C.MM_RECEITA = P_CTS_RES_MES
         AND C.AA_RECEITA = P_CTS_RES_ANO
         AND D.CD_GRUPO_CONTABIL = 3
         AND C.CODCLAINT = D.CODCLAINT
         AND C.CODCLAINT IN (32, 33)
       GROUP BY 'DIARIA DE APARTAMENTO', '110001'
      UNION ALL
      SELECT 'DIARIA DE HOSPITAL DAY' DESCRICAO,
             '110005' CONTA,
             SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0))+
                     (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL( QT_PROCED,0)) ) ,0)),
                     0)) QUANTIDADE
        FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
       WHERE C.MM_RECEITA = P_CTS_RES_MES
         AND C.AA_RECEITA = P_CTS_RES_ANO
         AND D.CD_GRUPO_CONTABIL = 3
         AND C.CODCLAINT = D.CODCLAINT
         AND C.CODCLAINT IN (39, 40, 41)
       GROUP BY C.CODCLAINT, D.DESCLAINT
      UNION ALL
      SELECT 'DIARIA DE ENFERMARIA' DESCRICAO,
             '110002' DESCRICAO,
             SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL( QT_PROCED,0)) ) ,0)),
                     0)) QUANTIDADE
        FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
       WHERE C.MM_RECEITA = P_CTS_RES_MES
         AND C.AA_RECEITA = P_CTS_RES_ANO
         AND D.CD_GRUPO_CONTABIL = 3
         AND C.CODCLAINT = D.CODCLAINT
         AND C.CODCLAINT = 34
       GROUP BY 'DIARIA DE ENFERMARIA', '110002'
      UNION ALL
      SELECT 'DIARIA DE BERCARIO' DESCRICAO,
             '110003' CONTA,
             SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL( QT_PROCED,0)) ) ,0)),
                     0)) QUANTIDADE
        FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
       WHERE C.MM_RECEITA = P_CTS_RES_MES
         AND C.AA_RECEITA = P_CTS_RES_ANO
         AND D.CD_GRUPO_CONTABIL = 3
         AND C.CODCLAINT = D.CODCLAINT
         AND C.CODCLAINT = 35
       GROUP BY 'DIARIA DE BERCARIO', '110003'
      UNION ALL
      SELECT 'DIARIA DE UTI ADULTO' DESCRICAO,
             '1100040001' CONTA,
             SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0)) +
                     (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL( QT_PROCED,0)) ) ,0)),
                     0)) QUANTIDADE
        FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
       WHERE C.MM_RECEITA = P_CTS_RES_MES
         AND C.AA_RECEITA = P_CTS_RES_ANO
         AND D.CD_GRUPO_CONTABIL = 3
         AND C.CODCLAINT = D.CODCLAINT
         AND C.CODCLAINT = 36
       GROUP BY 'DIARIA DE UTI ADULTO', '1100040001'
      UNION ALL
      SELECT 'DIARIA DE UTI CARDIOLOGICA' DESCRICAO,
             '1100040004' CONTA,
             SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0))+
                (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL( QT_PROCED,0)) ) ,0)),
                0)) QUANTIDADE
        FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
       WHERE C.MM_RECEITA = P_CTS_RES_MES
         AND C.AA_RECEITA = P_CTS_RES_ANO
         AND D.CD_GRUPO_CONTABIL = 3
         AND C.CODCLAINT = D.CODCLAINT
         AND C.CODCLAINT = 37
       GROUP BY C.CODCLAINT, D.DESCLAINT, C.CODCLAINT
       UNION ALL
       SELECT 'DIARIA DE UTI NEONATAL' DESCRICAO,
       '1100040003' CONTA,
       --SOMA.SOMA_VL_RECEITA_DIRETA,
       --ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA, 2) PERCENTUAL_1,
       --ROUND((100 - (SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA) * 100) / 100, 2) PERCENTUAL_2,
       --DIARIA_UTI_NEONATAL.QUANTIDADE QUANTIDADE,
       ROUND((DIARIA_UTI_NEONATAL.QUANTIDADE * (ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA, 2))), 0) QUANTIDADE--,
       --ROUND((DIARIA_UTI_NEONATAL.QUANTIDADE - (DIARIA_UTI_NEONATAL.QUANTIDADE * (ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA, 2)))), 0) QUANTIDADE_UTI_PED
  FROM TB_CTS_RES_RESUMO_GERAL RES, ( SELECT ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA), 0) SOMA_VL_RECEITA_DIRETA
                                        FROM TB_CTS_RES_RESUMO_GERAL RES
                                       WHERE RES.CTS_RES_RESU_MES = P_CTS_RES_MES
                                         AND RES.CTS_RES_RESU_ANO = P_CTS_RES_ANO
                                         AND RES.CTS_RES_RESU_TIPO = 'R'
                                         AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
                                         AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA IN (1100040002, 1100040003) ) SOMA,
                                    ( SELECT 'DIARIA DE UTI NEONATAL' DESCRICAO,
                                             '1100040003' CONTA,
                                             SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                                             (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0))+
                                              (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL(QT_PROCED,0)) ) ,0)),
                                             0)) QUANTIDADE
                                        FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
                                       WHERE C.MM_RECEITA = P_CTS_RES_MES
                                         AND C.AA_RECEITA = P_CTS_RES_ANO
                                         AND D.CD_GRUPO_CONTABIL = 3
                                         AND C.CODCLAINT = D.CODCLAINT
                                         AND C.CODCLAINT = 38
                                       GROUP BY 'DIARIA DE UTI NEONATAL', '110001' ) DIARIA_UTI_NEONATAL

 WHERE RES.CTS_RES_RESU_MES = P_CTS_RES_MES
   AND RES.CTS_RES_RESU_ANO = P_CTS_RES_ANO
   AND RES.CTS_RES_RESU_TIPO = 'R'
   AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
   AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA IN (1100040003)
 GROUP BY RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI,
          RES.CTS_RES_RESU_CAD_CTS_CD_CONTA,
          SOMA.SOMA_VL_RECEITA_DIRETA,
          DIARIA_UTI_NEONATAL.QUANTIDADE
 UNION ALL
 SELECT 'DIARIA DE UTI PEDIATRICA' DESCRICAO,
        '1100040002' CONTA,
--       SOMA.SOMA_VL_RECEITA_DIRETA,
--       ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA, 2) PERCENTUAL_1,
--       ROUND((100 - (SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA) * 100) / 100, 2) PERCENTUAL_2,
--       DIARIA_UTI_NEONATAL.QUANTIDADE QUANTIDADE,
--       (DIARIA_UTI_NEONATAL.QUANTIDADE * (ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA, 2))) QUANTIDADE_UTI_NEO,
        ROUND((DIARIA_UTI_NEONATAL.QUANTIDADE - (DIARIA_UTI_NEONATAL.QUANTIDADE * (ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SOMA.SOMA_VL_RECEITA_DIRETA, 2)))), 0) QUANTIDADE

  FROM TB_CTS_RES_RESUMO_GERAL RES, ( SELECT ROUND(SUM(RES.CTS_RES_RESU_VL_REC_DIRETA), 0) SOMA_VL_RECEITA_DIRETA
                                        FROM TB_CTS_RES_RESUMO_GERAL RES
                                       WHERE RES.CTS_RES_RESU_MES = P_CTS_RES_MES
                                         AND RES.CTS_RES_RESU_ANO = P_CTS_RES_ANO
                                         AND RES.CTS_RES_RESU_TIPO = 'R'
                                         AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
                                         AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA IN (1100040002, 1100040003) ) SOMA,
                                     ( SELECT 'DIARIA DE UTI NEONATAL' DESCRICAO,
                                              '1100040003' CONTA,
                                              SUM(NVL((NVL(SUM(DECODE(C.CODUNIHOS, 5, NVL(QT_PROCED, 0))), 0)) +
                                              (NVL(SUM(DECODE(C.CODUNIHOS, 2, NVL(QT_PROCED, 0))), 0))+
                                              (NVL(SUM(DECODE(C.CODUNIHOS,3, NVL( QT_PROCED,0)) ) ,0)),
                                              0)) QUANTIDADE
                                         FROM INT_APUR_RECEITA C, CLASSIFICACAO_CONTABIL_INT D
                                        WHERE C.MM_RECEITA = P_CTS_RES_MES
                                          AND C.AA_RECEITA = P_CTS_RES_ANO
                                          AND D.CD_GRUPO_CONTABIL = 3
                                          AND C.CODCLAINT = D.CODCLAINT
                                          AND C.CODCLAINT = 38
                                        GROUP BY 'DIARIA DE UTI NEONATAL', '1100040003' ) DIARIA_UTI_NEONATAL
 WHERE RES.CTS_RES_RESU_MES = P_CTS_RES_MES
   AND RES.CTS_RES_RESU_ANO = P_CTS_RES_ANO
   AND RES.CTS_RES_RESU_TIPO = 'R'
   AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
   AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA IN (1100040003)
 GROUP BY RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI,
          RES.CTS_RES_RESU_CAD_CTS_CD_CONTA,
          SOMA.SOMA_VL_RECEITA_DIRETA,
          DIARIA_UTI_NEONATAL.QUANTIDADE
  UNION ALL 
 SELECT 'AMBULAT?RIO' DESCRICAO,
        '180001' CONTA,
        COUNT(DISTINCT TIG.COD_ATEND) QUANTIDADE
   FROM TIG_CONTA_CONV TIG
  WHERE TIG.MESFAT = P_CTS_RES_MES
    AND TIG.ANOFAT = P_CTS_RES_ANO
    AND TIG.LOCAL = 'AMB'
  UNION ALL
 SELECT 'EXTERNINHO' DESCRICAO,
        '180002' CONTA,
        COUNT(DISTINCT TIG.COD_ATEND) QUANTIDADE
   FROM TIG_CONTA_CONV TIG
  WHERE TIG.MESFAT = P_CTS_RES_MES
    AND TIG.ANOFAT = P_CTS_RES_ANO
    AND TIG.LOCAL = 'INT'
    AND IN_SERVICO = 'E'
  UNION ALL   
 SELECT 'PRONTO SOCORRO + PRONTO ATENDIMENTO' DESCRICAO,
        '180003' CONTA,
        COUNT(DISTINCT TIG.COD_ATEND) QUANTIDADE
   FROM TIG_CONTA_CONV TIG
  WHERE TIG.MESFAT = P_CTS_RES_MES
    AND TIG.ANOFAT = P_CTS_RES_ANO
    AND TIG.LOCAL IN ('PRA', 'PS.')
 ORDER BY 2;
  BEGIN
    FOR A IN ATU LOOP
     UPDATE TB_CTS_RES_RESUMO_GERAL CTS
       SET CTS.CTS_RES_RESU_VL_PACIENTES_DIA = A.QUANTIDADE
     WHERE CTS.CTS_RES_RESU_CAD_CTS_CD_CONTA = A.CONTA
       AND CTS.CTS_RES_RESU_TIPO = 'R'
       AND CTS.CTS_RES_RESU_MES = P_CTS_RES_MES
       AND CTS.CTS_RES_RESU_ANO = P_CTS_RES_ANO;
  END LOOP;
  END;
  COMMIT;

  BEGIN
     UPDATE TB_CTS_RES_RESUMO_GERAL CTS
        SET CTS.CTS_RES_RESU_VL_PACIENTES_DIA = 0
      WHERE CTS.CTS_RES_RESU_CAD_CTS_CD_CONTA IN ('110006', '110007')
        AND CTS.CTS_RES_RESU_MES = P_CTS_RES_MES
        AND CTS.CTS_RES_RESU_ANO = P_CTS_RES_ANO;
  END;
  COMMIT;
    
END PRC_CTS_ATUALIZA_DIARIAS;
/
