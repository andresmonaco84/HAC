CREATE OR REPLACE PROCEDURE PRC_ATD_REL_ATD_SEM_PE
(
    pATD_DT_INICIO IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
    pATD_DT_FIM IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
    pCAD_UNI_ID_UNIDADE IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
    pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
    pCAD_SET_ID IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,
    pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%TYPE DEFAULT NULL,
    pCAD_CNV_ID_CONVENIO     IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    pCAD_PLA_ID_PLANO        IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%TYPE DEFAULT NULL,
    pTIS_TAT_CD_TPATENDIMENTO IN Tb_Tis_Tat_Tp_Atendimento.Tis_Tat_CD_Tpatendimento%TYPE DEFAULT NULL,
    pCAD_PRO_ID_PROFISSIONAL IN TB_ATD_ATE_ATENDIMENTO.CAD_PRO_ID_PROF_EXEC%TYPE DEFAULT NULL,
         pCAD_CGC_ID IN tb_cad_cnv_convenio.cad_cgc_id%TYPE DEFAULT NULL,
    IO_CURSOR OUT PKG_CURSOR.T_CURSOR
     -- TESTE OUT LONG
)
IS
/********************************************************************
*    PROCEDURE: PRC_ATD_REL_ATD_SEM_PE
*
*    ALTERAC?O:
*******************************************************************/
v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(3000);
  V_SELECT  varchar2(20000);
begin
  V_WHERE := NULL;
  IF pATD_DT_INICIO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATE.ATD_ATE_DT_ATENDIMENTO >= ' ||CHR(39)|| pATD_DT_INICIO ||CHR(39);    END IF;
IF pATD_DT_FIM IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATE.ATD_ATE_DT_ATENDIMENTO <= ' ||CHR(39)|| pATD_DT_FIM ||CHR(39);    END IF;
IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE; END IF;
IF pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO = ' || pCAD_LAT_ID_LOCAL_ATENDIMENTO; END IF;
IF pCAD_SET_ID IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.CAD_SET_ID = ' || pCAD_SET_ID; END IF;
IF pTIS_CBO_CD_CBOS IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.TIS_CBO_CD_CBOS = ' ||CHR(39)|| pTIS_CBO_CD_CBOS ||CHR(39); END IF;
IF pCAD_PRO_ID_PROFISSIONAL IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATE.CAD_PRO_ID_PROF_EXEC = ' || pCAD_PRO_ID_PROFISSIONAL;    END IF;
IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PAC.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO;    END IF;
IF pCAD_PLA_ID_PLANO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PAC.CAD_PLA_ID_PLANO = ' || pCAD_PLA_ID_PLANO;    END IF;
IF pTIS_TAT_CD_TPATENDIMENTO IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.TIS_TAT_CD_TPATENDIMENTO = ' ||CHR(39)|| pTIS_TAT_CD_TPATENDIMENTO ||CHR(39); END IF;
    IF pCAD_CGC_ID IS NOT NULL THEN V_WHERE := V_WHERE || ' AND CNV.CAD_CGC_ID = ' || pCAD_CGC_ID; END IF;    
V_SELECT:=
'
    SELECT  ATE.ATD_ATE_ID,
            ATE.ATD_ATE_DT_ATENDIMENTO,
            SUBSTR(LPAD(TO_CHAR(ATE.ATD_ATE_HR_ATENDIMENTO),4,''0''),0,2) || '':'' || SUBSTR(LPAD(TO_CHAR(ATE.ATD_ATE_HR_ATENDIMENTO),4,''0''),3,2)  HORA,
            PES.CAD_PES_NR_RG,
            PES.CAD_PES_NM_PESSOA,
                       PES.CAD_PES_DT_NASCIMENTO,
            TAT.TIS_TAT_DS_TPATENDIMENTO,
            CNV.CAD_CNV_CD_HAC_PRESTADOR,
            CNV.CAD_CNV_NM_FANTASIA,
            ATE.ATD_ATE_FL_PRONT_ELETR_ATIVO,
           -- CASE WHEN ATE.ATD_ATE_FL_PRONT_ELETR_ATIVO IS NULL OR ATE.ATD_ATE_FL_PRONT_ELETR_ATIVO = ''N'' THEN 1 ELSE 0 END PEN,
          --  CASE WHEN ATE.ATD_ATE_FL_PRONT_ELETR_ATIVO = ''S'' THEN 1 ELSE 0 END PES,
            ATE.ATD_ATE_DS_OBSERVACAO,
            CBO.TIS_CBO_CD_CBOS_HAC,
            CBO.TIS_CBO_DS_CBOS_HAC,
            PRO.CAD_PRO_NR_CONSELHO,
            PRO.CAD_PRO_NM_NOME
    FROM    TB_ATD_ATE_ATENDIMENTO ATE
    JOIN    TB_ASS_PAT_PACIEATEND PAT    ON      PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
    JOIN    TB_CAD_PAC_PACIENTE PAC    ON      PAC.CAD_PAC_ID_PACIENTE = PAT.CAD_PAC_ID_PACIENTE
    JOIN    TB_CAD_PES_PESSOA PES    ON      PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
    JOIN    TB_TIS_TAT_TP_ATENDIMENTO TAT    ON      TAT.TIS_TAT_CD_TPATENDIMENTO = ATE.TIS_TAT_CD_TPATENDIMENTO
    JOIN    TB_CAD_CNV_CONVENIO CNV    ON      CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
    JOIN    TB_CAD_PRO_PROFISSIONAL PRO ON     PRO.CAD_PRO_ID_PROFISSIONAL = ATE.CAD_PRO_ID_PROF_EXEC
    JOIN    TB_TIS_CBO_CBOS CBO     ON CBO.TIS_CBO_CD_CBOS = ATE.TIS_CBO_CD_CBOS
    WHERE   (ATE.ATD_ATE_FL_PRONT_ELETR_ATIVO IS NULL OR ATE.ATD_ATE_FL_PRONT_ELETR_ATIVO = ''N'')
   AND      (ATE.ATD_ATE_FL_STATUS = ''A'')
   AND    (ATE.TIS_TAT_CD_TPATENDIMENTO = ''4'')
' || V_WHERE || '
  ' ;
    --   TESTE :=  V_SELECT ;
   --dbms_output.put_line(V_SELECT);
  OPEN v_cursor FOR
   V_SELECT ;
  -- SELECT 1 FROM DUAL;
    io_cursor := v_cursor;
END PRC_ATD_REL_ATD_SEM_PE;
