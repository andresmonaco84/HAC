CREATE OR REPLACE PROCEDURE "PRC_COB_REL_26_RET_SOBRE_REC"
  (
    pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_INI  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_CONTAB_INI     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pDATA_CONTAB_FIM     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pCAD_BAN_ID IN TB_CAD_BAN_BANCO.CAD_BAN_ID%TYPE DEFAULT NULL,
    pASS_BCT_ID IN TB_COB_MGC_MOV_GUIA_COBRANCA.ASS_BCT_ID%TYPE DEFAULT NULL,
    pFAT_NOF_NR_NOTAFISCAL   IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_NR_NOTAFISCAL%TYPE DEFAULT NULL,
    pFAT_NOF_TP_SERIEFISCAL  IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_TP_SERIEFISCAL%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
     --   ,TESTE OUT LONG
  )
  is
  /********************************************************************
  *    Procedure: PRC_COB_REL_26_RET_SOBRE_REC
  *
  *    Data Criac?o: 26/11/2014  Por: PEDRO
  *    Alteracao:
  *
  *
  *******************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
 begin
 OPEN v_cursor FOR
select 
       geral.CAD_CNV_DS_RAZAOSOCIAL ,
       geral.COB_MGC_DT_MOVIMENTO, 
       geral.COB_MGC_DT_LIBERACAO_CONTAB,
       geral.MES_MOVIMENTO, 
     sum(nvl(geral.VL_RENDI_CALCULADO,0) ) VL_RENDI_CALCULADO   ,
     sum(nvl(geral.IR,0) )                 IR,
     sum(nvl(geral.CSLL,0) )               CSLL,
     sum(nvl(geral.COFINS,0) )             COFINS,
     sum(nvl(geral.PIS,0) )                PIS,
     sum(nvl(geral.IMPOSTO,0) )            IMPOSTO,
     sum(nvl(geral.LIQUIDO_CREDITADO,0))   LIQUIDO_CREDITADO
from dual, 
(  SELECT
        ---CNV.CAD_CNV_CD_HAC_PRESTADOR,
        CNV.CAD_CNV_DS_RAZAOSOCIAL ,
        MGC.COB_MGC_DT_MOVIMENTO,
        MGC.COB_MGC_DT_LIBERACAO_CONTAB,
        to_char(MGC.COB_MGC_DT_MOVIMENTO,'MM/yyyy') MES_MOVIMENTO,
        --- sum dos valores tem que ser igual ao do arquivo txt enviado para contabilizar
 (TO_NUMBER(  to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990,00')) * 100 ) VL_RENDI_CALCULADO, ---- CALCULADO SOBRER CSLL
 TO_NUMBER(  to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990,00') )  IR,
 TO_NUMBER(  to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990,00') )  CSLL,
 TO_NUMBER(  to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990,00') )  COFINS,
 TO_NUMBER(  to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990,00') )  PIS,
 TO_NUMBER(  to_char( SUM (MGC.COB_MGC_VL_IR   +
                           MGC.COB_MGC_VL_CSLL  +
                           MGC.COB_MGC_VL_COFINS + 
                           MGC.COB_MGC_VL_PIS  ) ,'99999999999990,00') )  IMPOSTO,
 TO_NUMBER(  to_char(SUM(MGC.COB_MGC_VL_MOVIMENTO ),'99999999999990,00') ) LIQUIDO_CREDITADO,
        MGC.FAT_NOF_ID
FROM TB_FAT_NOF_NOTA_FISCAL NOF
---- CONVENIOS CONTROLADO POR GUIA
JOIN TB_CAD_CNV_CONVENIO CNV ON CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
     AND CNV.CAD_CNV_CD_OPCAO_PAGTO = 1
---- PAGAMENTOS
JOIN TB_COB_MGC_MOV_GUIA_COBRANCA MGC ON MGC.FAT_NOF_ID = NOF.FAT_NOF_ID AND  MGC.COB_MGC_DT_LIBERACAO_CONTAB IS NOT  NULL
    AND MGC.CAD_TMC_ID   NOT  IN ( 2 , 5, 7, 9 , 12, 13 , 14 )  
    AND MGC.COB_MGC_DT_MOVIMENTO >= PDATA_PAGTO_INI AND MGC.COB_MGC_DT_MOVIMENTO <= PDATA_PAGTO_FIM
------
WHERE ( NVL(NOF.FAT_NOF_VL_IR,0) + NVL(NOF.FAT_NOF_VL_CSLL,0) +
        NVL(NOF.FAT_NOF_VL_COFINS,0) + NVL(NOF.FAT_NOF_VL_PIS,0)  ) <> 0 -- RETENCAO ORGAOS PUBLICOS
AND NOF.CAD_CNV_ID_CONVENIO = PCAD_CNV_ID_CONVENIO  --IN ( 2622, 731 ) --- S188  SP33
AND NOF.FAT_NFO_DT_EMISSAO >= pDATA_EMISSAO_INI
AND NOF.FAT_NFO_DT_EMISSAO <= pDATA_EMISSAO_FIM
GROUP BY CNV.CAD_CNV_DS_RAZAOSOCIAL ,
         MGC.COB_MGC_DT_MOVIMENTO,
         to_char(MGC.COB_MGC_DT_MOVIMENTO,'MM/yyyy'),
         MGC.COB_MGC_DT_LIBERACAO_CONTAB, MGC.FAT_NOF_ID 
         order by mgc.fat_nof_id  )  geral
-----    
group by geral.CAD_CNV_DS_RAZAOSOCIAL ,
         geral.COB_MGC_DT_MOVIMENTO,
         geral.COB_MGC_DT_LIBERACAO_CONTAB,
         GERAL.MES_MOVIMENTO
ORDER BY geral.CAD_CNV_DS_RAZAOSOCIAL ,
         geral.COB_MGC_DT_MOVIMENTO,
         geral.COB_MGC_DT_LIBERACAO_CONTAB;
  io_cursor := v_cursor;   
  end PRC_COB_REL_26_RET_SOBRE_REC;