CREATE OR REPLACE PROCEDURE "PRC_REP_REL_PGM_AJUSTE_PGM"
  (
     pREP_PGM_MES_PAGTO_INI 		    IN TB_REP_PGM_PAGTO_MEDICO.REP_PGM_MES_PAGTO%type,
     pREP_PGM_ANO_PAGTO_INI 		    IN TB_REP_PGM_PAGTO_MEDICO.REP_PGM_ANO_PAGTO%type,
     pCAD_CLC_ID 					          IN TB_CAD_CLC_CLINICA_CREDENCIADA.CAD_CLC_ID%TYPE,
     pCAD_UNI_ID_UNIDADE 			      IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE,
     pCAD_LAT_ID_LOCAL_ATENDIMENTO 	IN TB_CAD_LAT_LOCAL_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE,
     pCAD_SET_ID 					          IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE,
     pREP_PGM_TP_CREDENCIA_PROF 	  IN TB_REP_PGM_PAGTO_MEDICO.REP_PGM_TP_CREDENCIA_PROF%TYPE,
     pCAD_PLA_CD_TIPOPLANO 			    IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE,
     pCAD_CNV_ID_CONVENIO 			    IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE,
     pTIS_MED_CD_TABELAMEDICA 		  IN TB_TIS_MED_TABELAMEDICA.TIS_MED_CD_TABELAMEDICA%TYPE,
     pAUX_EPP_CD_ESPECPROC 			    IN TB_AUX_EPP_ESPECPROC.AUX_EPP_CD_ESPECPROC%TYPE,
     pCAD_PRD_ID 					          IN TB_CAD_PRD_PRODUTO.CAD_PRD_ID%TYPE,
     pREP_PGM_CD_JUSTIFICATIVA 		  IN  TB_REP_PGM_PAGTO_MEDICO.REP_PGM_CD_JUSTIFICATIVA%TYPE,
     pREP_PGM_FL_STATUS 			      IN TB_REP_PGM_PAGTO_MEDICO.REP_PGM_FL_STATUS%TYPE,
     pCAD_TAP_TP_ATRIBUTO 			    IN STRING,
     pSEMCONSULTA 					        IN STRING,
     pID_CAD_JPG 					          IN TB_CAD_JPG_JUSTIFICA_PAGTO.ID_CAD_JPG%TYPE,
     pREP_PGM_FL_PAGO 				      IN TB_REP_PGM_PAGTO_MEDICO.REP_PGM_FL_STATUS%TYPE,
     pCAD_TPE_CD_CODIGO             IN TB_REP_PGM_PAGTO_MEDICO.CAD_TPE_CD_CODIGO%TYPE DEFAULT NULL,
	   pORDENACAO						          IN STRING DEFAULT 'A',
     io_cursor                      OUT PKG_CURSOR.t_cursor
  )
  is
/********************************************************************
*    Procedure: PRC_REP_REL_PGM_AJUSTE_PGM
*
*    Data Criacao:    06/02/2012           Por: Fabiola Lopes
*    Data Alteracao:  data da alterac?o  Por: Nome do Analista
*
*    Funcao: Descric?o da funcionalidade da Stored Procedure
*
*******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  VARCHAR2(5000);
  V_SELECT VARCHAR2(5000);
  V_GROUP  VARCHAR2(5000);
  V_ORDER  VARCHAR2(5000);
  BEGIN
    V_WHERE := NULL;
    V_GROUP := NULL;
    IF pCAD_CLC_ID IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.CAD_CLC_ID = ' || pCAD_CLC_ID;
    END IF;
    IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.CAD_UNI_ID_UNIDADE =  ' || pCAD_UNI_ID_UNIDADE;
    END IF;
    IF pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.CAD_LAT_ID_LOCAL_ATENDIMENTO = ' || pCAD_LAT_ID_LOCAL_ATENDIMENTO;
    END IF;
    IF pCAD_SET_ID IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.CAD_SET_ID_REALIZACAO = ' || pCAD_SET_ID;
    END IF;
    IF pREP_PGM_TP_CREDENCIA_PROF IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.REP_PGM_TP_CREDENCIA_PROF = ' || CHR(39) ||  pREP_PGM_TP_CREDENCIA_PROF || CHR(39);
    END IF;
    IF pCAD_PLA_CD_TIPOPLANO IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.CAD_PLA_CD_TIPOPLANO = ' || CHR(39) || pCAD_PLA_CD_TIPOPLANO || CHR(39);
    END IF;
    IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO;
    END IF;
    IF pTIS_MED_CD_TABELAMEDICA IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.TIS_MED_CD_TABELAMEDICA = ' || pTIS_MED_CD_TABELAMEDICA;
    END IF;
    IF pAUX_EPP_CD_ESPECPROC IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.AUX_EPP_CD_ESPECPROC = ' || pAUX_EPP_CD_ESPECPROC;
    END IF;
    IF pCAD_PRD_ID IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.CAD_PRD_ID = ' || pCAD_PRD_ID;
    END IF;
    IF pREP_PGM_CD_JUSTIFICATIVA IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.REP_PGM_CD_JUSTIFICATIVA = ' || pREP_PGM_CD_JUSTIFICATIVA;
    END IF;
    IF pREP_PGM_FL_STATUS IS NOT NULL THEN
       V_WHERE:= V_WHERE || ' AND PGM.REP_PGM_FL_STATUS = ' || CHR(39) || pREP_PGM_FL_STATUS || CHR(39);
    END IF;
    IF pCAD_TAP_TP_ATRIBUTO IS NOT NULL THEN
       V_WHERE := V_WHERE || ' AND PGM.CAD_TAP_TP_ATRIBUTO IN (' || pCAD_TAP_TP_ATRIBUTO || ')';
    END IF;
    IF pSEMCONSULTA = 'S' THEN
       V_WHERE := V_WHERE || ' AND PGM.AUX_EPP_CD_ESPECPROC != 101 ';
    END IF;
    IF pID_CAD_JPG IS NOT NULL THEN
       V_WHERE := V_WHERE || ' AND PGM.REP_PGM_CD_JUSTIFICATIVA = ' || pID_CAD_JPG;
    END IF;
    IF pREP_PGM_FL_PAGO IS NOT NULL THEN
      V_WHERE := V_WHERE || ' AND NVL(REP_PGM_FL_PAGO,  ' || CHR(39) ||'I'|| CHR(39) || ' ) IN ('|| pREP_PGM_FL_PAGO || ')';
    END IF;
    IF pCAD_TPE_CD_CODIGO IS NOT NULL THEN
			V_WHERE:= V_WHERE || ' AND PGM.CAD_TPE_CD_CODIGO = ' || CHR(39) ||  pCAD_TPE_CD_CODIGO || CHR(39);
  	END IF;

    V_SELECT := 'SELECT		PGM.ATD_ATE_ID,
								         	PGM.FAT_CCP_ID,
								          CNV.CAD_CNV_CD_HAC_PRESTADOR,
								         	PES.CAD_PES_NM_PESSOA,
								         	PRD.CAD_PRD_CD_CODIGO,
								         	PRD.CAD_PRD_DS_DESCRICAO,
								         	PGM.REP_PGM_DT_INICIO_REALIZACAO,
								         	SUM(NVL(PGM.REP_PGM_QT_CONSUMO,0)) QTD_CONSUMO,
								         	SUM(NVL(PGM.REP_PGM_VL_FATURADO,0)) VL_FATURADO,
								         	SUM(NVL(PGM.REP_PGM_VL_CALCULADO,0)) VL_CALCULADO,
								         	SUM(NVL(PGM.REP_PGM_VL_PAGO,0)) VL_PAGO,
								         	PGM.REP_PGM_CD_JUSTIFICATIVA,
								         	UNI.CAD_UNI_DS_UNIDADE,
								         	LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
								         	CLC.CAD_CLC_CD_CLINICA,
								         	CLC.CAD_CLC_DS_DESCRICAO,
								         	PRO.CAD_PRO_NR_CONSELHO,
								         	PRO.CAD_PRO_NM_NOME,
								         	PGM.CAD_PLA_CD_TIPOPLANO,
								         	PGM.REP_PGM_MES_PAGTO,
								         	PGM.REP_PGM_ANO_PAGTO,
								         	JPG.CAD_JPG_DS_JUSTIFICATIVA,
                          TO_CHAR(PGM.REP_PGM_MES_FECHAMENTO) || ''/'' || TO_CHAR(PGM.REP_PGM_ANO_FECHAMENTO) MESANOFECHAMENTO

								     FROM TB_REP_PGM_PAGTO_MEDICO PGM,
								          TB_CAD_CNV_CONVENIO CNV,
								          TB_CAD_PAC_PACIENTE PAC,
								          TB_CAD_PES_PESSOA PES,
								          TB_CAD_PRD_PRODUTO PRD,
								          TB_CAD_UNI_UNIDADE UNI,
								          TB_CAD_LAT_LOCAL_ATENDIMENTO LAT,
								          TB_CAD_SET_SETOR SETOR,
								          TB_CAD_CLC_CLINICA_CREDENCIADA CLC,
								          TB_CAD_PRO_PROFISSIONAL PRO,
								          TB_CAD_JPG_JUSTIFICA_PAGTO JPG,
                          TB_TIS_CBO_CBOS CBO

								    WHERE
								          PGM.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO
								     	AND PGM.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
								     	AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
								     	AND PGM.CAD_PRD_ID = PRD.CAD_PRD_ID
								     	AND PGM.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
								     	AND PGM.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO
								     	AND PGM.CAD_SET_ID_REALIZACAO = SETOR.CAD_SET_ID
								     	AND PGM.CAD_CLC_ID = CLC.CAD_CLC_ID
								     	AND PGM.CAD_PRO_ID_PROFISSIONAL = PRO.CAD_PRO_ID_PROFISSIONAL
								     	AND PGM.REP_PGM_CD_JUSTIFICATIVA = JPG.ID_CAD_JPG

                      AND PRO.CAD_PRO_ID_PROFISSIONAL = PGM.CAD_PRO_ID_PROFISSIONAL
                      AND PGM.TIS_CBO_CD_CBOS = CBO.TIS_CBO_CD_CBOS(+)

								     	AND PGM.REP_PGM_MES_PAGTO = ' || pREP_PGM_MES_PAGTO_INI || '
								     	AND PGM.REP_PGM_ANO_PAGTO = ' || pREP_PGM_ANO_PAGTO_INI;
								     	V_GROUP := ' GROUP BY   PGM.ATD_ATE_ID,
								                            	PGM.FAT_CCP_ID,
								                            	CNV.CAD_CNV_CD_HAC_PRESTADOR,
								                            	PES.CAD_PES_NM_PESSOA,
								                            	PRD.CAD_PRD_CD_CODIGO,
								                            	PRD.CAD_PRD_DS_DESCRICAO,
								                            	PGM.REP_PGM_DT_INICIO_REALIZACAO,
								                            	PGM.REP_PGM_CD_JUSTIFICATIVA,
								                            	UNI.CAD_UNI_DS_UNIDADE,
								                            	LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
								                            	CLC.CAD_CLC_CD_CLINICA,
								                            	CLC.CAD_CLC_DS_DESCRICAO,
								                            	PRO.CAD_PRO_NR_CONSELHO,
								                            	PRO.CAD_PRO_NM_NOME,
								                            	PGM.CAD_PLA_CD_TIPOPLANO,
								                            	PGM.REP_PGM_MES_PAGTO,
								                            	PGM.REP_PGM_ANO_PAGTO,
								                            	JPG.CAD_JPG_DS_JUSTIFICATIVA,
                                              TO_CHAR(PGM.REP_PGM_MES_FECHAMENTO) || ''/'' || TO_CHAR(PGM.REP_PGM_ANO_FECHAMENTO) ';
    IF pORDENACAO = 'A' THEN -- ORDENACAO (A)LFABETICA (DEFAULT)
     	V_ORDER := ' ORDER BY CLC.CAD_CLC_DS_DESCRICAO, PRO.CAD_PRO_NM_NOME, CNV.CAD_CNV_CD_HAC_PRESTADOR';
    ELSIF pORDENACAO = 'C' THEN -- ORDENACAO POR (C)ONVENIO
     	V_ORDER := ' ORDER BY CNV.CAD_CNV_CD_HAC_PRESTADOR, CLC.CAD_CLC_DS_DESCRICAO, PRO.CAD_PRO_NM_NOME';
    ELSE -- ORDENACAO POR (T)EMPO
     	V_ORDER := ' ORDER BY PGM.ATD_ATE_ID, CLC.CAD_CLC_DS_DESCRICAO, PRO.CAD_PRO_NM_NOME';
    END IF;
    OPEN v_cursor FOR
         V_SELECT || V_WHERE || V_GROUP || V_ORDER;
    io_cursor := v_cursor;
    DBMS_OUTPUT.put_line(V_SELECT);
end PRC_REP_REL_PGM_AJUSTE_PGM;
