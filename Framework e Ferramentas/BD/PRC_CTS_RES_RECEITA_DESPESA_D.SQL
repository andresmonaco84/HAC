CREATE OR REPLACE PROCEDURE "PRC_CTS_RES_RECEITA_DESPESA_D"
(
  pMESFAT                   TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_MES%TYPE,
  pANOFAT                   TB_CTS_RES_RESULTADO_CUSTOS.CTS_RES_ANO%TYPE,
  IO_CURSOR                 OUT PKG_CURSOR.T_CURSOR
)
  IS
  V_CURSOR PKG_CURSOR.T_CURSOR;
BEGIN
  OPEN V_CURSOR FOR
    SELECT 'D' TIPO,
           --- MODELO3 DETALHADO
           PLC.CAD_CTS_PLC_ID                      IDT_PLANO ,
           PLC.CAD_CTS_CD_CONTA                    CONTA ,
           PLC.CAD_CTS_CD_NIVEL                    NIVEL ,
           PLC.CAD_CTS_DS_DESCRICAO                DESCRICAO,
           NVL(RESULTADO.VL_RECEITA_DIRETA,0)      RE_DIRETA,
           NVL(RESULTADO.VL_RECEITA_INTERMEDIAR,0) RE_INTERMED,
           NVL(RESULTADO.VL_RECEITA_INDIRETA,0)    RE_INDIRETA,
           NVL(RESULTADO.VL_RECEITA_DIRETA,0) + NVL(RESULTADO.VL_RECEITA_INTERMEDIAR,0) TOTAL_REC_DIRETA_INTERMEDIARIA,
           NVL(RESULTADO.VL_RECEITA_DIRETA,0) + NVL(RESULTADO.VL_RECEITA_INTERMEDIAR,0) + NVL(RESULTADO.VL_RECEITA_INDIRETA,0) TOTAL_RECEITA,
           NVL(RESULTADO.VL_DESPESA_DIRETA,0)      DE_DIRETA,
           NVL(RESULTADO.VL_DESPESA_INTERMED,0)    DE_INTERMED,
           NVL(RESULTADO.VL_DESPESA_INDIRETA,0)    DE_INDIRETA,
           NVL(RESULTADO.VL_DESPESA_DIRETA,0) + NVL(RESULTADO.VL_DESPESA_INTERMED,0) TOTAL_DES_DIRETA_INTERMEDIARIA,
           NVL(RESULTADO.VL_DESPESA_DIRETA,0) + NVL(RESULTADO.VL_DESPESA_INTERMED,0) + NVL(RESULTADO.VL_DESPESA_INDIRETA,0) TOTAL_DESPESA
      FROM TB_CAD_CTS_PLC_PLANO_CONTAS PLC, (
                                              SELECT RES.CAD_CTS_PLC_ID                      CAD_CTS_PLC_ID,
                                                     SUM(RES.CTS_RES_VL_RECEITA_DIRETA)      VL_RECEITA_DIRETA,
                                                     SUM(RES.CTS_RES_VL_RECEITA_INTERMEDIAR) VL_RECEITA_INTERMEDIAR,
                                                     SUM(RES.CTS_RES_VL_RECEITA_INDIRETA)    VL_RECEITA_INDIRETA,
                                                     SUM(RES.CTS_RES_VL_DESPESA_DIRETA )     VL_DESPESA_DIRETA,
                                                     SUM(RES.CTS_RES_VL_DESPESA_INTERMEDIAR) VL_DESPESA_INTERMED,
                                                     SUM(RES.CTS_RES_VL_DESPESA_INDIRETA )   VL_DESPESA_INDIRETA
                                                FROM TB_CTS_RES_RESULTADO_CUSTOS RES
                                               WHERE RES.CTS_RES_MES = pMESFAT
                                                 AND RES.CTS_RES_ANO  = pANOFAT
                                                 AND RES.CAD_CTS_PLC_ID NOT IN ( 1, 2 )
                                                 AND RES.CAD_UNI_ID_UNIDADE_ORIGEM <> 99
                                                 AND RES.CAD_UNI_ID_UNIDADE IS NOT NULL
                                                 AND RES.CAD_CEC_ID_CCUSTO_RECEITA IS NOT NULL
                                            GROUP BY RES.CAD_CTS_PLC_ID
                                            ) RESULTADO
     WHERE PLC.CAD_CTS_PLC_ID = RESULTADO.CAD_CTS_PLC_ID (+)
       AND PLC.CAD_CTS_CD_NATUREZA = 1
       AND (PLC.CAD_CTS_CD_CONTA = 1 OR ((NVL(RESULTADO.VL_RECEITA_DIRETA, 0) + NVL(RESULTADO.VL_RECEITA_INTERMEDIAR, 0) + NVL(RESULTADO.VL_RECEITA_INDIRETA, 0) + NVL(RESULTADO.VL_DESPESA_DIRETA, 0) + NVL(RESULTADO.VL_DESPESA_INTERMED, 0) + NVL(RESULTADO.VL_DESPESA_INDIRETA, 0) > 0)))
  ORDER BY 1,3;
IO_CURSOR := V_CURSOR;
END PRC_CTS_RES_RECEITA_DESPESA_D;
/
