CREATE OR REPLACE PROCEDURE "PRC_ATS_REL_16_PES_DIAG"
  (
     pDATA_INICIO IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_DT_REALIZ_PROCED%TYPE,
     pDATA_FIM IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_DT_REALIZ_PROCED%TYPE,
     pCAD_PES_ID_PESSOA VARCHAR2 DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
      --  , TESTE OUT LONG
  )
  is
  /********************************************************************
  *    Procedure: PRC_ATS_REL_16_PES_DIAG
  *
  *******************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(3000);
  V_SELECT  varchar2(28000);
  begin
  V_WHERE := NULL;
   IF pDATA_INICIO IS NOT NULL THEN       V_WHERE := V_WHERE || ' AND TRUNC(ATS.ATS_ATE_DT_REALIZ_PROCED) >= ' ||CHR(39)|| pDATA_INICIO ||CHR(39);    END IF;
   IF pDATA_FIM IS NOT NULL THEN       V_WHERE := V_WHERE || ' AND TRUNC(ATS.ATS_ATE_DT_REALIZ_PROCED) <= ' ||CHR(39)|| pDATA_FIM ||CHR(39);    END IF;
   IF pCAD_PES_ID_PESSOA IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PES_PAC.CAD_PES_ID_PESSOA IN ( ' || pCAD_PES_ID_PESSOA || ') ' ; END IF;

  V_SELECT :=
   '
SELECT
       ATS.ATS_ATE_DT_REALIZ_PROCED,
       ATS.ATS_ATE_HR_REALIZ_PROCED,
       ATS.ATS_ATE_CD_INTLIB,
       ATS.ATS_ATE_IN_INTLIB,
       ATS.ATS_ATE_ID,
       PRD.CAD_PRD_CD_CODIGO,
       PRD.CAD_PRD_NM_MNEMONICO,
       PRD.CAD_PRD_DS_DESCRICAO,

       --UNI.CAD_UNI_DS_UNIDADE,
       --LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
       --SETOR_PROCED.CAD_SET_DS_SETOR SETOR,
       --SETOR_EXEC.CAD_SET_DS_SETOR SETOR_EXEC,
       ATS.ATS_ATE_FL_STATUS,
       decode(pla.cad_pla_cd_tipoplano,
                                        ''FU'', ''FUNCIONARIO'',
                                        ''PA'', ''PA'',
                                        ''GB'', ''GLOBAL'',
                                        ''PL'', ''PESSOA FISICA'',
                                        ''SP'', ''SERVICOS PRESTADOS'',
                                        ''TODOS'') tipo_empresa,
       PES_PAC.CAD_PES_NM_PESSOA,
       PES_PAC.CAD_PES_DT_NASCIMENTO,
       FLOOR(FLOOR(MONTHS_BETWEEN(ATS.ATS_ATE_DT_REALIZ_PROCED, PES_PAC.CAD_PES_DT_NASCIMENTO)) / 12) IDADE,
       PES_PAC.CAD_PES_TP_SEXO,
       --CASE WHEN PRO.CAD_PRO_NM_NOME IS NOT NULL THEN PRO.CAD_PRO_NM_NOME ELSE PSO.CAD_PSO_NM_PROFISSIONAL END CAD_PRO_NM_NOME,
       --CNV.CAD_CNV_CD_HAC_PRESTADOR,
       --PLA.CAD_PLA_CD_PLANO_HAC,
       PAC.CAD_PAC_NR_PRONTUARIO,
       ATS.ATS_NUM_CONTROLE,
       (SELECT LISTAGG(DIA.ATS_APL_DS_DIAGNOSTICO, chr(10)) WITHIN GROUP (ORDER BY DIA.ATS_APL_DS_DIAGNOSTICO) AS ATS_APL_DS_DIAGNOSTICO
        FROM   TB_ATS_DIAGNOSTICO_LAUDO DIA
        WHERE dia.ats_apl_id = APL.ats_apl_id AND DIA.ATS_STATUS_DIAG=1
        ) ATS_APL_DS_DIAGNOSTICO,
       APL.ATS_APL_STATUS_LAUDO,
       APL.ATS_APL_DT_LAUDO,
       APL.ATS_APL_HR_LAUDO,
       APL.ATS_APL_TEXTO_LAUDO

FROM TB_ATS_ATE_ATENDIMENTO_SADT ATS
JOIN TB_ATS_APL_ATEN_PROCED_LAUDO APL
  ON APL.ATS_ATE_CD_INTLIB = ATS.ATS_ATE_CD_INTLIB
 AND APL.ATS_ATE_ID = ATS.ATS_ATE_ID
 AND APL.CAD_PRD_ID = ATS.CAD_PRD_ID
 AND APL.TIS_MED_CD_TABELAMEDICA = ATS.TIS_MED_CD_TABELAMEDICA
 AND APL.AUX_EPP_CD_ESPECPROC = ATS.AUX_EPP_CD_ESPECPROC
 AND APL.ATS_ATE_IN_INTLIB = ATS.ATS_ATE_IN_INTLIB

 --JOIN TB_CAD_SET_SETOR SETOR_EXEC   ON SETOR_EXEC.CAD_SET_ID = ATS.CAD_SET_ID_ATEN
 --JOIN TB_CAD_SET_SETOR SETOR_PROCED ON SETOR_PROCED.CAD_SET_ID = ATS.CAD_SET_ID
 --JOIN TB_CAD_UNI_UNIDADE UNI        ON UNI.CAD_UNI_ID_UNIDADE = SETOR_EXEC.CAD_UNI_ID_UNIDADE
 --JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = SETOR_EXEC.CAD_LAT_ID_LOCAL_ATENDIMENTO
 JOIN TB_CAD_PRD_PRODUTO PRD        ON PRD.CAD_PRD_ID = ATS.CAD_PRD_ID
 JOIN TB_CAD_PAC_PACIENTE PAC       ON PAC.CAD_PAC_ID_PACIENTE = ATS.CAD_PAC_ID_PACIENTE_INT
 JOIN TB_CAD_PES_PESSOA PES_PAC     ON PES_PAC.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
 --LEFT JOIN TB_CAD_PRO_PROFISSIONAL PRO   ON TRIM(PRO.CAD_PRO_SG_UF_CONSELHO) = TRIM(ATS.ATS_ATE_SG_UF_CONSELHO_SOLIC)
 --                                  AND TRIM(PRO.CAD_PRO_NR_CONSELHO) = TRIM(ATS.ATS_ATE_NR_CONSELHO_SOLIC)
 --                                  AND TRIM(PRO.TIS_CPR_CD_CONSELHOPROF) = TRIM(ATS.ATS_ATE_TP_CONSELHO_SOLIC)

 --LEFT JOIN TB_CAD_PSO_PROF_SOLICITANTE PSO   ON TRIM(PSO.CAD_PSO_SG_UF_CONSELHO) = TRIM(ATS.ATS_ATE_SG_UF_CONSELHO_SOLIC)
 --                                  AND TRIM(PSO.CAD_PSO_CD_CONSELHO) = TRIM(ATS.ATS_ATE_NR_CONSELHO_SOLIC)
 --                                  AND TRIM(PSO.TIS_CPR_CD_CONSELHOPROF) = TRIM(ATS.ATS_ATE_TP_CONSELHO_SOLIC)
-- LEFT JOIN TB_ATD_AIC_ATE_INT_COMPL AIC     ON AIC.ATD_ATE_ID = ATS.ATS_ATE_CD_INTLIB
 JOIN TB_CAD_PLA_PLANO PLA     ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 --JOIN TB_CAD_CNV_CONVENIO CNV     ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO


WHERE
    (ATS.ATS_ATE_FL_STATUS <> ''C'') AND ATS.AUX_EPP_CD_ESPECPROC = ''21'' AND APL.AUX_EPP_CD_ESPECPROC = ''21'' 
    '  || V_WHERE ||
   ' ORDER BY PES_PAC.CAD_PES_ID_PESSOA';
    -- ORDER BY 1,7,5
   --  TESTE :=  V_SELECT ;
OPEN v_cursor FOR
     V_SELECT ;
   -- SELECT 1 FROM DUAL;
    io_cursor := v_cursor;
  end PRC_ATS_REL_16_PES_DIAG;
