CREATE OR REPLACE PROCEDURE "PRC_REP_REL_RESUMO_PROCED_SCLI" (
    pREP_PGM_MES_PAGTO_INI       IN TB_REP_PGM_PAGTO_MEDICO.REP_PGM_MES_PAGTO%TYPE,
    pREP_PGM_ANO_PAGTO_INI       IN TB_REP_PGM_PAGTO_MEDICO.REP_PGM_ANO_PAGTO%TYPE,
    pCAD_CLC_ID                  IN TB_CAD_CLC_CLINICA_CREDENCIADA.CAD_CLC_ID%TYPE,
    pCAD_UNI_ID_UNIDADE          IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
    pCAD_PRO_ID_PROFISSIONAL     IN STRING DEFAULT NULL,
    pSEMCONSULTA                 IN STRING,
    IO_CURSOR                    OUT PKG_CURSOR.T_CURSOR
)
IS
/********************************************************************
*
*    PROCEDURE: PRC_REP_REL_RESUMO_PROCED_SCLI
*    DATA       POR:
*
*********************************************************************/
 V_CURSOR PKG_CURSOR.T_CURSOR;
 V_WHERE  VARCHAR2(5000);
 V_SELECT VARCHAR2(5000);
 V_GROUP  VARCHAR2(5000);
BEGIN
    V_SELECT := NULL;
    V_GROUP  := NULL;
    V_WHERE  := NULL;
    V_WHERE := V_WHERE || ' PGM.REP_PGM_FL_STATUS = ' || CHR(39) ||'A'|| CHR(39) || ' ';
    IF (pREP_PGM_MES_PAGTO_INI IS NOT NULL) THEN
      V_WHERE := V_WHERE || ' AND PGM.REP_PGM_MES_PAGTO = ' || pREP_PGM_MES_PAGTO_INI;
    END IF;
    IF (pREP_PGM_ANO_PAGTO_INI IS NOT NULL) THEN
      V_WHERE := V_WHERE || ' AND PGM.REP_PGM_ANO_PAGTO = ' || pREP_PGM_ANO_PAGTO_INI;
    END IF;
     IF (pCAD_CLC_ID IS NOT NULL) THEN
          V_WHERE := V_WHERE ||  ' AND PGM.CAD_CLC_ID = ' || pCAD_CLC_ID;
    END IF;
    IF (pCAD_UNI_ID_UNIDADE IS NOT NULL) THEN
      V_WHERE := V_WHERE ||  ' AND PGM.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE;
    END IF;
    IF PCAD_PRO_ID_PROFISSIONAL IS NOT NULL THEN
       V_WHERE := V_WHERE || ' AND PRO.CAD_PRO_ID_PROFISSIONAL IN ( SELECT * FROM TABLE(FNC_SPLIT(''' || PCAD_PRO_ID_PROFISSIONAL || ''' ))) ';
    END IF;
      IF (pSEMCONSULTA = 'S') THEN
       V_WHERE := V_WHERE || ' AND PGM.AUX_EPP_CD_ESPECPROC != 101 ';
    END IF;
    V_SELECT := 'SELECT PRD.CAD_PRD_CD_CODIGO || '' - '' || PRD.CAD_PRD_DS_DESCRICAO PROCEDIMENTO,
                        PRO.CAD_PRO_NR_CONSELHO,
                        PRO.CAD_PRO_NM_NOME,
                        LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
                        PGM.CAD_PLA_CD_TIPOPLANO,
                        UNI.CAD_UNI_DS_UNIDADE,
                        CLC.CAD_CLC_CD_CLINICA || '' - '' || CLC.CAD_CLC_DS_DESCRICAO CLINICA,
                        SUM(PGM.REP_PGM_QT_CONSUMO) QTD_CONSUMO,
                        SUM(PGM.REP_PGM_VL_PAGO) VL_PAGO
      FROM TB_REP_PGM_PAGTO_MEDICO PGM
     INNER JOIN TB_CAD_UNI_UNIDADE UNI
        ON UNI.CAD_UNI_ID_UNIDADE = PGM.CAD_UNI_ID_UNIDADE
     INNER JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT
        ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = PGM.CAD_LAT_ID_LOCAL_ATENDIMENTO
     INNER JOIN TB_CAD_PRD_PRODUTO PRD
        ON PRD.CAD_PRD_ID = PGM.CAD_PRD_ID
     INNER JOIN TB_CAD_CLC_CLINICA_CREDENCIADA CLC
        ON CLC.CAD_CLC_ID = PGM.CAD_CLC_ID
     INNER JOIN TB_CAD_PRO_PROFISSIONAL PRO
        ON PRO.CAD_PRO_ID_PROFISSIONAL = PGM.CAD_PRO_ID_PROFISSIONAL
     WHERE ' || V_WHERE;
     V_GROUP := ' GROUP BY PRD.CAD_PRD_CD_CODIGO || '' - '' || PRD.CAD_PRD_DS_DESCRICAO,
                           PRO.CAD_PRO_NR_CONSELHO,
                           PRO.CAD_PRO_NM_NOME,
                           LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
                           PGM.CAD_PLA_CD_TIPOPLANO,
                           UNI.CAD_UNI_DS_UNIDADE,
                           CLC.CAD_CLC_CD_CLINICA || '' - '' || CLC.CAD_CLC_DS_DESCRICAO ';
    OPEN v_cursor FOR
         V_SELECT || V_GROUP;
    io_cursor := v_cursor;
END PRC_REP_REL_RESUMO_PROCED_SCLI;
