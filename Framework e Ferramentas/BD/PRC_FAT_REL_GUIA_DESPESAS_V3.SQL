CREATE OR REPLACE PROCEDURE SGS."PRC_FAT_REL_GUIA_DESPESAS_V3" (
    pLOTE IN TB_FAT_FCL_CONTR_EMI_LOTE.FAT_FCL_NR_SEQ_LOTE%TYPE DEFAULT NULL,
    pATD_ATE_ID IN TSS_OUTRASDESP_SGS.NR_ATENDIMENTO%TYPE DEFAULT NULL,
    pFAT_CCP_ID IN TSS_OUTRASDESP_SGS.CD_PARCELA%TYPE DEFAULT NULL,
    pCAD_PAC_ID_PACIENTE IN TSS_OUTRASDESP_SGS.IDT_PACIENTE%TYPE DEFAULT NULL,
    pFAT_COC_ID IN TSS_OUTRASDESP_SGS.NR_CONTA%TYPE DEFAULT NULL,
    io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_FAT_REL_GUIA_DESPESAS_V3
  *
  *    Data Criacao: 19/05/2014  Por: Pedro
  *
 *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
  if pATD_ATE_ID is null then --a diferenca e o (IS NULL OR ) dos parametros para reduzir o custo
    OPEN v_cursor FOR
 --DESPESAS V3
 --PRC_FAT_REL_GUIA_DESPESAS_V3
SELECT DISTINCT
  S.CD_CONVENIO,
  S.DS_CONVENIO,
  S.NR_ATENDIMENTO,
  S.CD_PARCELA,
  S.IDT_PACIENTE,
  S.NR_CONTA,
  S.CD_REGISTRO_ANS,
  S.NR_GUIA_REF ,
--DADOS DO CONTRATADO EXECUTANTE
  S.CD_OPER_CNPJ_CPF_CONT,
  S.NM_CONT,
  S.CD_CNES_CONT,
--DESPESAS REALIZADAS
  P.NR_SEQ,
  CEIL(P.NR_SEQ / 10) QUEBRA_EM_10,
  P.DT_REAL,
  DECODE(P.HR_INI_PROC,NULL,'', SUBSTR(LPAD(TO_CHAR(P.HR_INI_PROC),4,'0'),1,2) || ':' || SUBSTR(LPAD(TO_CHAR(P.HR_INI_PROC),4,'0'),3,2)) HR_INI_PROC,
  DECODE(P.HR_FIM_PROC,NULL,'', SUBSTR(LPAD(TO_CHAR(P.HR_FIM_PROC),4,'0'),1,2) || ':' || SUBSTR(LPAD(TO_CHAR(P.HR_FIM_PROC),4,'0'),3,2)) HR_FIM_PROC,
  P.CD_TABELAS ,
  P.CD_PROC_REAL ,
  P.DS_DESPESA ,
  REPLACE(TO_CHAR(SUM(P.QT_PROC_REAL) OVER (PARTITION BY P.CD_TABELAS, P.CD_PROC_REAL, P.DS_DESPESA, P.DT_REAL,
         P.HR_INI_PROC,  P.HR_FIM_PROC, P.NR_RED_ACR, P.CD_TP_DESPESA, P.VL_UNIT_PROC, P.VL_TOTAL_PROC,
         CEIL(P.NR_SEQ / 10),S.CD_PARCELA,S.NR_ATENDIMENTO, S.NR_CONTA, S.IDT_PACIENTE, S.CD_REGISTRO_ANS, S.NR_GUIA_REF,
           P.CD_REF_MATERIAL_FABRICANTE, P.NR_AUTORIZ_FUNCIONAM_EMPRESA, P.SG_UNIDADE_VENDA_BRAS, P.CD_REGISTRO_ANVISA)),'.', ',') QT_PROC_REAL,
--  DECODE( CD_TP_DESPESA, 2, NULL, 3, NULL, P.DT_REAL) DATA,
  P.CD_UNIDADE_MEDIDA,  
  P.NR_RED_ACR ,
  P.VL_UNIT_PROC,
  SUM(P.VL_TOTAL_PROC) OVER (PARTITION BY P.CD_TABELAS, P.CD_PROC_REAL, P.DS_DESPESA, P.DT_REAL,
         P.HR_INI_PROC,  P.HR_FIM_PROC, P.NR_RED_ACR, P.CD_TP_DESPESA, P.VL_UNIT_PROC, P.VL_TOTAL_PROC,
         CEIL(P.NR_SEQ / 10),S.CD_PARCELA,S.NR_ATENDIMENTO, S.NR_CONTA, S.IDT_PACIENTE, S.CD_REGISTRO_ANS, S.NR_GUIA_REF,
           P.CD_REF_MATERIAL_FABRICANTE, P.NR_AUTORIZ_FUNCIONAM_EMPRESA, P.SG_UNIDADE_VENDA_BRAS, P.CD_REGISTRO_ANVISA) VL_TOTAL_PROC,
  P.CD_TP_DESPESA,
  P.MM_RECEITA,
  P.CD_REF_MATERIAL_FABRICANTE,
  P.NR_AUTORIZ_FUNCIONAM_EMPRESA,
  P.SG_UNIDADE_VENDA_BRAS,
  P.CD_REGISTRO_ANVISA,
  DECODE( P.CD_TP_DESPESA, 2, P.DS_DESPESA, 3, DS_DESPESA, P.CD_PROC_REAL) ORDEM,
--TOTAIS
  NVL(GASES.TOTAL,0)  TOTALGASESMEDICINAIS,
  NVL(MED.TOTAL,0)    TOTALMEDICAMENTO,
  NVL(MAT.TOTAL,0)   TOTALMATERIAIS,
  NVL(OPM.TOTAL,0)   TOTALOPM,
  NVL(TAX.TOTAL,0)   TOTALTAXASDIVERSAS,
  NVL(DIA.TOTAL,0)   TOTALDIARIAS,
  NVL(ALU.TOTAL,0)   TOTALALUGUEIS,
  NVL(SUM(P.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P.NR_SEQ / 10),S.CD_PARCELA,S.NR_ATENDIMENTO, S.NR_CONTA, S.IDT_PACIENTE, S.CD_REGISTRO_ANS, S.NR_GUIA_REF ),0) TOTALGERAL
FROM TSS_OUTRASDESP_SGS_V3 S,
     TSS_OUTRASDESP_PROC_SGS_V3 P,
     TB_FAT_FCL_CONTR_EMI_LOTE FCL,
  (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
           P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2, TB_FAT_FCL_CONTR_EMI_LOTE FCL2
   WHERE   FCL2.FAT_COC_ID            = P2.NR_CONTA
       AND FCL2.FAT_CCP_ID            = P2.CD_PARCELA
       AND FCL2.ATD_ATE_ID            = P2.NR_ATENDIMENTO
       AND FCL2.CAD_PAC_ID_PACIENTE   = P2.IDT_PACIENTE
       AND (FCL2.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
       AND TO_NUMBER(P2.CD_TP_DESPESA)            = 1
   ) GASES,
   (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
           P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2, TB_FAT_FCL_CONTR_EMI_LOTE FCL2
   WHERE   FCL2.FAT_COC_ID            = P2.NR_CONTA
       AND FCL2.FAT_CCP_ID            = P2.CD_PARCELA
       AND FCL2.ATD_ATE_ID            = P2.NR_ATENDIMENTO
       AND FCL2.CAD_PAC_ID_PACIENTE   = P2.IDT_PACIENTE
       AND (FCL2.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
       AND TO_NUMBER(P2.CD_TP_DESPESA)            = 2
  ) MED,
    (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
           P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2, TB_FAT_FCL_CONTR_EMI_LOTE FCL2
   WHERE   FCL2.FAT_COC_ID            = P2.NR_CONTA
       AND FCL2.FAT_CCP_ID            = P2.CD_PARCELA
       AND FCL2.ATD_ATE_ID            = P2.NR_ATENDIMENTO
       AND FCL2.CAD_PAC_ID_PACIENTE   = P2.IDT_PACIENTE
       AND (FCL2.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
       AND TO_NUMBER(P2.CD_TP_DESPESA)            = 3
  ) MAT,
    (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
           P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2, TB_FAT_FCL_CONTR_EMI_LOTE FCL2
   WHERE   FCL2.FAT_COC_ID            = P2.NR_CONTA
       AND FCL2.FAT_CCP_ID            = P2.CD_PARCELA
       AND FCL2.ATD_ATE_ID            = P2.NR_ATENDIMENTO
       AND FCL2.CAD_PAC_ID_PACIENTE   = P2.IDT_PACIENTE
       AND (FCL2.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
       AND TO_NUMBER(P2.CD_TP_DESPESA)            = 4
   ) TAX,
    (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
           P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2, TB_FAT_FCL_CONTR_EMI_LOTE FCL2
   WHERE   FCL2.FAT_COC_ID            = P2.NR_CONTA
       AND FCL2.FAT_CCP_ID            = P2.CD_PARCELA
       AND FCL2.ATD_ATE_ID            = P2.NR_ATENDIMENTO
       AND FCL2.CAD_PAC_ID_PACIENTE   = P2.IDT_PACIENTE
       AND (FCL2.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
       AND TO_NUMBER(P2.CD_TP_DESPESA)            = 5
   ) DIA,
    (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
           P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2, TB_FAT_FCL_CONTR_EMI_LOTE FCL2
   WHERE   FCL2.FAT_COC_ID            = P2.NR_CONTA
       AND FCL2.FAT_CCP_ID            = P2.CD_PARCELA
       AND FCL2.ATD_ATE_ID            = P2.NR_ATENDIMENTO
       AND FCL2.CAD_PAC_ID_PACIENTE   = P2.IDT_PACIENTE
       AND (FCL2.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
       AND TO_NUMBER(P2.CD_TP_DESPESA)            = 6
    ) ALU,
     (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
           P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2, TB_FAT_FCL_CONTR_EMI_LOTE FCL2
   WHERE   FCL2.FAT_COC_ID            = P2.NR_CONTA
       AND FCL2.FAT_CCP_ID            = P2.CD_PARCELA
       AND FCL2.ATD_ATE_ID            = P2.NR_ATENDIMENTO
       AND FCL2.CAD_PAC_ID_PACIENTE   = P2.IDT_PACIENTE
       AND (FCL2.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
       AND TO_NUMBER(P2.CD_TP_DESPESA)            = 8
    ) OPM
 WHERE
    S.CD_PARCELA               = P.CD_PARCELA
AND S.NR_ATENDIMENTO           = P.NR_ATENDIMENTO
AND S.NR_CONTA                 = P.NR_CONTA
AND S.IDT_PACIENTE             = P.IDT_PACIENTE
AND S.CD_REGISTRO_ANS          = P.CD_REGISTRO_ANS
AND S.NR_GUIA_REF              = P.NR_GUIA_REF
AND P.VL_TOTAL_PROC            > 0
AND GASES.CD_PARCELA        (+)   = P.CD_PARCELA
AND GASES.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
AND GASES.NR_CONTA          (+)   = P.NR_CONTA
AND GASES.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
AND GASES.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
AND GASES.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
AND GASES.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
AND MED.CD_PARCELA        (+)   = P.CD_PARCELA
AND MED.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
AND MED.NR_CONTA          (+)   = P.NR_CONTA
AND MED.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
AND MED.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
AND MED.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
AND MED.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
AND MAT.CD_PARCELA        (+)   = P.CD_PARCELA
AND MAT.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
AND MAT.NR_CONTA          (+)   = P.NR_CONTA
AND MAT.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
AND MAT.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
AND MAT.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
AND MAT.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
AND TAX.CD_PARCELA        (+)   = P.CD_PARCELA
AND TAX.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
AND TAX.NR_CONTA          (+)   = P.NR_CONTA
AND TAX.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
AND TAX.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
AND TAX.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
AND TAX.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
AND DIA.CD_PARCELA        (+)   = P.CD_PARCELA
AND DIA.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
AND DIA.NR_CONTA          (+)   = P.NR_CONTA
AND DIA.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
AND DIA.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
AND DIA.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
AND DIA.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
AND ALU.CD_PARCELA        (+)   = P.CD_PARCELA
AND ALU.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
AND ALU.NR_CONTA          (+)   = P.NR_CONTA
AND ALU.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
AND ALU.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
AND ALU.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
AND ALU.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
AND OPM.CD_PARCELA        (+)   = P.CD_PARCELA
AND OPM.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
AND OPM.NR_CONTA          (+)   = P.NR_CONTA
AND OPM.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
AND OPM.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
AND OPM.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
AND OPM.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
AND FCL.FAT_COC_ID            = S.NR_CONTA
AND FCL.FAT_CCP_ID            = S.CD_PARCELA
AND FCL.ATD_ATE_ID            = S.NR_ATENDIMENTO
AND FCL.CAD_PAC_ID_PACIENTE   = S.IDT_PACIENTE
AND (FCL.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
--AND (FCL.ATD_ATE_ID = PATD_ATE_ID)
--AND (FCL.FAT_CCP_ID = PFAT_CCP_ID)
--AND (FCL.CAD_PAC_ID_PACIENTE = PCAD_PAC_ID_PACIENTE)
--AND (FCL.FAT_COC_ID = PFAT_COC_ID)
     --   HAVING SUM(P.VL_TOTAL_PROC) > 0
ORDER BY P.NR_SEQ
;
             io_cursor := v_cursor;
else
 OPEN v_cursor FOR
        SELECT DISTINCT
          S.CD_CONVENIO,
          S.DS_CONVENIO,
          S.NR_ATENDIMENTO,
          S.CD_PARCELA,
          S.IDT_PACIENTE,
          S.NR_CONTA,
          S.CD_REGISTRO_ANS,
          S.NR_GUIA_REF ,
        --DADOS DO CONTRATADO EXECUTANTE
          S.CD_OPER_CNPJ_CPF_CONT,
          S.NM_CONT,
          S.CD_CNES_CONT,
        --DESPESAS REALIZADAS
          P.NR_SEQ,
          CEIL(P.NR_SEQ / 10) QUEBRA_EM_10,
          P.DT_REAL,
          DECODE(P.HR_INI_PROC,NULL,'', SUBSTR(LPAD(TO_CHAR(P.HR_INI_PROC),4,'0'),1,2) || ':' || SUBSTR(LPAD(TO_CHAR(P.HR_INI_PROC),4,'0'),3,2)) HR_INI_PROC,
          DECODE(P.HR_FIM_PROC,NULL,'', SUBSTR(LPAD(TO_CHAR(P.HR_FIM_PROC),4,'0'),1,2) || ':' || SUBSTR(LPAD(TO_CHAR(P.HR_FIM_PROC),4,'0'),3,2)) HR_FIM_PROC,
          P.CD_TABELAS ,
          P.CD_PROC_REAL ,
          P.DS_DESPESA ,
          REPLACE(TO_CHAR(SUM(P.QT_PROC_REAL) OVER (PARTITION BY P.CD_TABELAS, P.CD_PROC_REAL, P.DS_DESPESA, P.DT_REAL,
                 P.HR_INI_PROC,  P.HR_FIM_PROC, P.NR_RED_ACR, P.CD_TP_DESPESA, P.VL_UNIT_PROC, P.VL_TOTAL_PROC,
                 CEIL(P.NR_SEQ / 10),S.CD_PARCELA,S.NR_ATENDIMENTO, S.NR_CONTA, S.IDT_PACIENTE, S.CD_REGISTRO_ANS, S.NR_GUIA_REF,
           P.CD_REF_MATERIAL_FABRICANTE, P.NR_AUTORIZ_FUNCIONAM_EMPRESA, P.SG_UNIDADE_VENDA_BRAS, P.CD_REGISTRO_ANVISA)),'.', ',') QT_PROC_REAL,
        --  DECODE( CD_TP_DESPESA, 2, NULL, 3, NULL, P.DT_REAL) DATA,
          P.CD_UNIDADE_MEDIDA,  
          P.NR_RED_ACR ,
          P.VL_UNIT_PROC,
          SUM(P.VL_TOTAL_PROC) OVER (PARTITION BY P.CD_TABELAS, P.CD_PROC_REAL, P.DS_DESPESA, P.DT_REAL,
                 P.HR_INI_PROC,  P.HR_FIM_PROC, P.NR_RED_ACR, P.CD_TP_DESPESA, P.VL_UNIT_PROC, P.VL_TOTAL_PROC,
                 CEIL(P.NR_SEQ / 10),S.CD_PARCELA,S.NR_ATENDIMENTO, S.NR_CONTA, S.IDT_PACIENTE, S.CD_REGISTRO_ANS, S.NR_GUIA_REF,
           P.CD_REF_MATERIAL_FABRICANTE, P.NR_AUTORIZ_FUNCIONAM_EMPRESA, P.SG_UNIDADE_VENDA_BRAS, P.CD_REGISTRO_ANVISA) VL_TOTAL_PROC,
          P.CD_TP_DESPESA,
          P.MM_RECEITA,
          P.CD_REF_MATERIAL_FABRICANTE,
          P.NR_AUTORIZ_FUNCIONAM_EMPRESA,
          P.SG_UNIDADE_VENDA_BRAS,
          P.CD_REGISTRO_ANVISA,
          DECODE( P.CD_TP_DESPESA, 2, P.DS_DESPESA, 3, DS_DESPESA, P.CD_PROC_REAL) ORDEM,
        --TOTAIS
          NVL(GASES.TOTAL,0)  TOTALGASESMEDICINAIS,
          NVL(MED.TOTAL,0)    TOTALMEDICAMENTO,
          NVL(MAT.TOTAL,0)   TOTALMATERIAIS,
          NVL(OPM.TOTAL,0)   TOTALOPM,
          NVL(TAX.TOTAL,0)   TOTALTAXASDIVERSAS,
          NVL(DIA.TOTAL,0)   TOTALDIARIAS,
          NVL(ALU.TOTAL,0)   TOTALALUGUEIS,
          NVL(SUM(P.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P.NR_SEQ / 10),S.CD_PARCELA,S.NR_ATENDIMENTO, S.NR_CONTA, S.IDT_PACIENTE, S.CD_REGISTRO_ANS, S.NR_GUIA_REF ),0) TOTALGERAL
        FROM TSS_OUTRASDESP_SGS_V3 S,
             TSS_OUTRASDESP_PROC_SGS_V3 P,
             TB_FAT_FCL_CONTR_EMI_LOTE FCL,
          (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
                   P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2
           WHERE   TO_NUMBER(P2.CD_TP_DESPESA)            = 1
               AND (P2.CD_PARCELA = PFAT_CCP_ID)  AND (P2.NR_ATENDIMENTO = PATD_ATE_ID) AND (P2.NR_CONTA  = PFAT_COC_ID) AND (P2.IDT_PACIENTE = PCAD_PAC_ID_PACIENTE)           
           ) GASES,
           (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
                   P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2
           WHERE   TO_NUMBER(P2.CD_TP_DESPESA)            = 2
           AND (P2.CD_PARCELA = PFAT_CCP_ID)  AND (P2.NR_ATENDIMENTO = PATD_ATE_ID) AND (P2.NR_CONTA  = PFAT_COC_ID) AND (P2.IDT_PACIENTE = PCAD_PAC_ID_PACIENTE)
          ) MED,
            (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
                   P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2
           WHERE   TO_NUMBER(P2.CD_TP_DESPESA)            = 3
           AND (P2.CD_PARCELA = PFAT_CCP_ID)  AND (P2.NR_ATENDIMENTO = PATD_ATE_ID) AND (P2.NR_CONTA  = PFAT_COC_ID) AND (P2.IDT_PACIENTE = PCAD_PAC_ID_PACIENTE)
          ) MAT,
            (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
                   P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2
           WHERE   TO_NUMBER(P2.CD_TP_DESPESA)            = 4
           AND (P2.CD_PARCELA = PFAT_CCP_ID)  AND (P2.NR_ATENDIMENTO = PATD_ATE_ID) AND (P2.NR_CONTA  = PFAT_COC_ID) AND (P2.IDT_PACIENTE = PCAD_PAC_ID_PACIENTE)
           ) TAX,
            (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
                   P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2
           WHERE   TO_NUMBER(P2.CD_TP_DESPESA)           = 5
           AND (P2.CD_PARCELA = PFAT_CCP_ID)  AND (P2.NR_ATENDIMENTO = PATD_ATE_ID) AND (P2.NR_CONTA  = PFAT_COC_ID) AND (P2.IDT_PACIENTE = PCAD_PAC_ID_PACIENTE)
           ) DIA,
            (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
                   P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2
           WHERE   TO_NUMBER(P2.CD_TP_DESPESA)            = 6
           AND (P2.CD_PARCELA = PFAT_CCP_ID)  AND (P2.NR_ATENDIMENTO = PATD_ATE_ID) AND (P2.NR_CONTA  = PFAT_COC_ID) AND (P2.IDT_PACIENTE = PCAD_PAC_ID_PACIENTE)
            ) ALU,
             (SELECT DISTINCT SUM(P2.VL_TOTAL_PROC) OVER (PARTITION BY CEIL(P2.NR_SEQ / 10), P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF)  TOTAL, CEIL(P2.NR_SEQ / 10) QUEBRA_EM_10,
                   P2.CD_PARCELA,P2.NR_ATENDIMENTO, P2.NR_CONTA, P2.IDT_PACIENTE, P2.CD_REGISTRO_ANS, P2.NR_GUIA_REF    FROM TSS_OUTRASDESP_PROC_SGS_v3 P2
           WHERE   TO_NUMBER(P2.CD_TP_DESPESA)            = 8
           AND (P2.CD_PARCELA = PFAT_CCP_ID)  AND (P2.NR_ATENDIMENTO = PATD_ATE_ID) AND (P2.NR_CONTA  = PFAT_COC_ID) AND (P2.IDT_PACIENTE = PCAD_PAC_ID_PACIENTE)
            ) OPM
         WHERE
            S.CD_PARCELA               = P.CD_PARCELA
        AND S.NR_ATENDIMENTO           = P.NR_ATENDIMENTO
        AND S.NR_CONTA                 = P.NR_CONTA
        AND S.IDT_PACIENTE             = P.IDT_PACIENTE
        AND S.CD_REGISTRO_ANS          = P.CD_REGISTRO_ANS
        AND S.NR_GUIA_REF              = P.NR_GUIA_REF
        AND P.VL_TOTAL_PROC            > 0
        AND GASES.CD_PARCELA        (+)   = P.CD_PARCELA
        AND GASES.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
        AND GASES.NR_CONTA          (+)   = P.NR_CONTA
        AND GASES.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
        AND GASES.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
        AND GASES.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
        AND GASES.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
        AND MED.CD_PARCELA        (+)   = P.CD_PARCELA
        AND MED.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
        AND MED.NR_CONTA          (+)   = P.NR_CONTA
        AND MED.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
        AND MED.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
        AND MED.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
        AND MED.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
        AND MAT.CD_PARCELA        (+)   = P.CD_PARCELA
        AND MAT.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
        AND MAT.NR_CONTA          (+)   = P.NR_CONTA
        AND MAT.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
        AND MAT.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
        AND MAT.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
        AND MAT.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
        AND TAX.CD_PARCELA        (+)   = P.CD_PARCELA
        AND TAX.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
        AND TAX.NR_CONTA          (+)   = P.NR_CONTA
        AND TAX.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
        AND TAX.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
        AND TAX.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
        AND TAX.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
        AND DIA.CD_PARCELA        (+)   = P.CD_PARCELA
        AND DIA.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
        AND DIA.NR_CONTA          (+)   = P.NR_CONTA
        AND DIA.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
        AND DIA.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
        AND DIA.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
        AND DIA.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
        AND ALU.CD_PARCELA        (+)   = P.CD_PARCELA
        AND ALU.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
        AND ALU.NR_CONTA          (+)   = P.NR_CONTA
        AND ALU.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
        AND ALU.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
        AND ALU.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
        AND ALU.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
        AND OPM.CD_PARCELA        (+)   = P.CD_PARCELA
        AND OPM.NR_ATENDIMENTO    (+)   = P.NR_ATENDIMENTO
        AND OPM.NR_CONTA          (+)   = P.NR_CONTA
        AND OPM.IDT_PACIENTE      (+)   = P.IDT_PACIENTE
        AND OPM.CD_REGISTRO_ANS   (+)   = P.CD_REGISTRO_ANS
        AND OPM.NR_GUIA_REF       (+)   = P.NR_GUIA_REF
        AND OPM.QUEBRA_EM_10       (+)  = CEIL(P.NR_SEQ / 10)
        AND FCL.FAT_COC_ID            = S.NR_CONTA
        AND FCL.FAT_CCP_ID            = S.CD_PARCELA
        AND FCL.ATD_ATE_ID            = S.NR_ATENDIMENTO
        AND FCL.CAD_PAC_ID_PACIENTE   = S.IDT_PACIENTE
        AND (FCL.FAT_FCL_NR_SEQ_LOTE  = pLOTE)
        AND (FCL.ATD_ATE_ID = pATD_ATE_ID)
        AND (FCL.FAT_CCP_ID = pFAT_CCP_ID)
        AND (FCL.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE )
        AND (FCL.FAT_COC_ID = pFAT_COC_ID )
       -- HAVING SUM(P.VL_TOTAL_PROC) > 0
        ORDER BY P.NR_SEQ
         ;
             io_cursor := v_cursor;
end if;
  end PRC_FAT_REL_GUIA_DESPESAS_V3;
 