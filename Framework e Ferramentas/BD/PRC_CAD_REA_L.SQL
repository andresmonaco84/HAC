CREATE OR REPLACE PROCEDURE "PRC_CAD_REA_L"
(
     pCAD_PAC_ID_PACIENTE IN TB_CAD_REA_RESTRICAO_ATEND.CAD_PAC_ID_PACIENTE%type DEFAULT NULL,
   --  pCAD_REA_DT_INICIO_VIGENCIA IN TB_CAD_REA_RESTRICAO_ATEND.CAD_REA_DT_INICIO_VIGENCIA%type DEFAULT NULL,
    -- pCAD_REA_DT_FIM_VIGENCIA IN TB_CAD_REA_RESTRICAO_ATEND.CAD_REA_DT_FIM_VIGENCIA%type DEFAULT NULL,
   --  pSEG_USU_ID_USUARIO_CRIACAO IN TB_CAD_REA_RESTRICAO_ATEND.SEG_USU_ID_USUARIO_CRIACAO%type DEFAULT NULL,
    -- pCAD_REA_DT_CRIACAO IN TB_CAD_REA_RESTRICAO_ATEND.CAD_REA_DT_CRIACAO%type DEFAULT NULL,
    -- pSEG_USU_ID_USUARIO_ATUALIZ IN TB_CAD_REA_RESTRICAO_ATEND.SEG_USU_ID_USUARIO_ATUALIZ%type DEFAULT NULL,
    -- pCAD_REA_DT_ULTIMA_ATUALIZ IN TB_CAD_REA_RESTRICAO_ATEND.CAD_REA_DT_ULTIMA_ATUALIZ%type DEFAULT NULL,
     pCAD_PES_ID_PESSOA_RESPONSAVEL IN TB_CAD_REA_RESTRICAO_ATEND.CAD_PES_ID_PESSOA_RESPONSAVEL%type DEFAULT NULL,
     pATD_ATE_ID IN TB_CAD_REA_RESTRICAO_ATEND.ATD_ATE_ID%type DEFAULT NULL,
     pFAT_CCP_ID IN TB_CAD_REA_RESTRICAO_ATEND.FAT_CCP_ID%type DEFAULT NULL,
  --   pCAD_REA_DS_OBSERVACAO IN TB_CAD_REA_RESTRICAO_ATEND.CAD_REA_DS_OBSERVACAO%type DEFAULT NULL,
  --   pFAT_NOF_ID IN TB_CAD_REA_RESTRICAO_ATEND.FAT_NOF_ID%type DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
)
is
/********************************************************************
*    Procedure: PRC_CAD_REA_L
*
*    Data Criacao:   data da  criação   Por: Nome do Analista
*    Data Alteracao:  data da alteração  Por: Nome do Analista
*
*    Funcao: Descrição da funcionalidade da Stored Procedure
*
*******************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
    pCAD_PAC_ID  number;

begin

IF pATD_ATE_ID IS NOT NULL and pFAT_CCP_ID IS NOT NULL THEN 
  SELECT CAD_PAC_ID_PACIENTE INTO pCAD_PAC_ID FROM TB_FAT_CCP_CONTA_CONS_PARC CCP WHERE CCP.ATD_ATE_ID = pATD_ATE_ID AND CCP.FAT_CCP_ID = pFAT_CCP_ID ;
END IF;
  
  
OPEN v_cursor FOR
 
SELECT  --Paciente Inadimplente
       CAD_PAC_ID_PACIENTE,
       CAD_REA_DT_INICIO_VIGENCIA,
       CAD_REA_DT_FIM_VIGENCIA,
       SEG_USU_ID_USUARIO_CRIACAO,
       CAD_REA_DT_CRIACAO,
       SEG_USU_ID_USUARIO_ATUALIZ,
       CAD_REA_DT_ULTIMA_ATUALIZ,
       CAD_PES_ID_PESSOA_RESPONSAVEL,
       ATD_ATE_ID,
       FAT_CCP_ID,
       CAD_REA_DS_OBSERVACAO,
       FAT_NOF_ID
FROM   TB_CAD_REA_RESTRICAO_ATEND
WHERE  (CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE  OR CAD_PAC_ID_PACIENTE = pCAD_PAC_ID)

UNION

SELECT --Pessoa Responsavel do Paciente Inadimplente
       REA.CAD_PAC_ID_PACIENTE,
       REA.CAD_REA_DT_INICIO_VIGENCIA,
       REA.CAD_REA_DT_FIM_VIGENCIA,
       REA.SEG_USU_ID_USUARIO_CRIACAO,
       REA.CAD_REA_DT_CRIACAO,
       REA.SEG_USU_ID_USUARIO_ATUALIZ,
       REA.CAD_REA_DT_ULTIMA_ATUALIZ,
       REA.CAD_PES_ID_PESSOA_RESPONSAVEL,
       REA.ATD_ATE_ID,
       REA.FAT_CCP_ID,
       REA.CAD_REA_DS_OBSERVACAO,
       REA.FAT_NOF_ID
       
FROM   TB_CAD_PAC_PACIENTE        PAC,
       TB_CAD_REA_RESTRICAO_ATEND REA

WHERE  PAC.CAD_PES_ID_PESSOA    = REA.CAD_PES_ID_PESSOA_RESPONSAVEL  
AND    (PAC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE  OR PAC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID)

UNION

SELECT --Pessoa do Paciente é pessoa de outro paciente Inadimplente
       REA.CAD_PAC_ID_PACIENTE,
       REA.CAD_REA_DT_INICIO_VIGENCIA,
       REA.CAD_REA_DT_FIM_VIGENCIA,
       REA.SEG_USU_ID_USUARIO_CRIACAO,
       REA.CAD_REA_DT_CRIACAO,
       REA.SEG_USU_ID_USUARIO_ATUALIZ,
       REA.CAD_REA_DT_ULTIMA_ATUALIZ,
       REA.CAD_PES_ID_PESSOA_RESPONSAVEL,
       REA.ATD_ATE_ID,
       REA.FAT_CCP_ID,
       REA.CAD_REA_DS_OBSERVACAO,
       REA.FAT_NOF_ID
       
FROM   TB_CAD_PAC_PACIENTE        PAC1,
       TB_CAD_PAC_PACIENTE        PAC2,
       TB_CAD_REA_RESTRICAO_ATEND REA

WHERE  PAC2.CAD_PES_ID_PESSOA    = REA.CAD_PES_ID_PESSOA_RESPONSAVEL  
AND    PAC1.CAD_PES_ID_PESSOA    = PAC2.CAD_PES_ID_PESSOA
AND    (PAC1.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE  OR PAC1.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID)

union

SELECT --Pessoa do Paciente é pessoa de outro paciente Inadimplente
       REA.CAD_PAC_ID_PACIENTE,
       REA.CAD_REA_DT_INICIO_VIGENCIA,
       REA.CAD_REA_DT_FIM_VIGENCIA,
       REA.SEG_USU_ID_USUARIO_CRIACAO,
       REA.CAD_REA_DT_CRIACAO,
       REA.SEG_USU_ID_USUARIO_ATUALIZ,
       REA.CAD_REA_DT_ULTIMA_ATUALIZ,
       REA.CAD_PES_ID_PESSOA_RESPONSAVEL,
       REA.ATD_ATE_ID,
       REA.FAT_CCP_ID,
       REA.CAD_REA_DS_OBSERVACAO,
       REA.FAT_NOF_ID
       
FROM   TB_CAD_PAC_PACIENTE        PAC1,
       TB_CAD_PAC_PACIENTE        PAC2,
       TB_CAD_REA_RESTRICAO_ATEND REA

WHERE  PAC2.CAD_PAC_ID_PACIENTE    = REA.CAD_PAC_ID_PACIENTE  
AND    PAC1.CAD_PES_ID_PESSOA    = PAC2.CAD_PES_ID_PESSOA
AND    (PAC1.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE  OR PAC1.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID)

UNION

SELECT --Pessoa Responsavel do Paciente Inadimplente
       REA.CAD_PAC_ID_PACIENTE,
       REA.CAD_REA_DT_INICIO_VIGENCIA,
       REA.CAD_REA_DT_FIM_VIGENCIA,
       REA.SEG_USU_ID_USUARIO_CRIACAO,
       REA.CAD_REA_DT_CRIACAO,
       REA.SEG_USU_ID_USUARIO_ATUALIZ,
       REA.CAD_REA_DT_ULTIMA_ATUALIZ,
       REA.CAD_PES_ID_PESSOA_RESPONSAVEL,
       REA.ATD_ATE_ID,
       REA.FAT_CCP_ID,
       REA.CAD_REA_DS_OBSERVACAO,
       REA.FAT_NOF_ID
       
FROM   TB_CAD_REA_RESTRICAO_ATEND               REA
WHERE  REA.CAD_PES_ID_PESSOA_RESPONSAVEL      = pCAD_PES_ID_PESSOA_RESPONSAVEL

UNION

SELECT -- Paciente da Pessoa Responsavel Inadimplente
       REA.CAD_PAC_ID_PACIENTE,
       REA.CAD_REA_DT_INICIO_VIGENCIA,
       REA.CAD_REA_DT_FIM_VIGENCIA,
       REA.SEG_USU_ID_USUARIO_CRIACAO,
       REA.CAD_REA_DT_CRIACAO,
       REA.SEG_USU_ID_USUARIO_ATUALIZ,
       REA.CAD_REA_DT_ULTIMA_ATUALIZ,
       REA.CAD_PES_ID_PESSOA_RESPONSAVEL,
       REA.ATD_ATE_ID,
       REA.FAT_CCP_ID,
       REA.CAD_REA_DS_OBSERVACAO,
       REA.FAT_NOF_ID
       
FROM   TB_CAD_PAC_PACIENTE                      PAC,
       TB_CAD_REA_RESTRICAO_ATEND               REA

WHERE  PAC.CAD_PAC_ID_PACIENTE                = REA.CAD_PAC_ID_PACIENTE  
AND    PAC.CAD_PES_ID_PESSOA                  = pCAD_PES_ID_PESSOA_RESPONSAVEL 

 ;
  
 io_cursor := v_cursor;
end PRC_CAD_REA_L;
 