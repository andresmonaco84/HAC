CREATE OR REPLACE PROCEDURE "PRC_CTS_REL_06_GRAFICO"
(
 IO_CURSOR OUT PKG_CURSOR.T_CURSOR,
 pCTS_RES_RESU_MES       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_MES_PAGTO%type,
 pCTS_RES_RESU_ANO       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_ANO_PAGTO%type
)
IS
  V_CURSOR PKG_CURSOR.T_CURSOR;
BEGIN
  
DECLARE
  V_MES  NUMBER;
  V_ANO  NUMBER;
  V_DATA DATE;
  C_MES  VARCHAR(2);
  C_ANO  VARCHAR(4);
  C_DATA VARCHAR(10);
BEGIN
  V_MES := pCTS_RES_RESU_MES;
  V_ANO := pCTS_RES_RESU_ANO;
  C_MES := TO_CHAR(V_MES);
  C_ANO := TO_CHAR(V_ANO);
  C_DATA:= '01/' || LPAD(C_MES, 2, '0') || '/' || C_ANO;
  V_DATA := TO_DATE(C_DATA, 'DD/MM/YYYY');

BEGIN  
  OPEN V_CURSOR FOR
    SELECT RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI DESCRICAO,
           RES.CTS_RES_RESU_ANO || '/' || LPAD(RES.CTS_RES_RESU_MES,2,'0') ANOMES,
           (MES1.PERCENTUAL_DIRETO * 100) PERCENTUAL_DIRETO,
           (MES1.PERCENTUAL_TOTAL * 100) PERCENTUAL_TOTAL
      FROM TB_CTS_RES_RESUMO_GERAL RES,
      ( SELECT SEQ_CTS_RES_RESUMO_01,
               (CASE WHEN CTS_RES_RESU_VL_DESP_DIRETA  = 0 THEN 0
                  ELSE ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA / RES.CTS_RES_RESU_VL_DESP_DIRETA, 4) - 1 END) PERCENTUAL_DIRETO,
               (CASE WHEN (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA) = 0 THEN 0
                  ELSE ROUND(((RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA) /
                              (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA)), 4) - 1 END) PERCENTUAL_TOTAL,
               TOTAL_PERCENTUAL.TOT_PERC_TOTAL TOT_PERC_TOTAL,
               TOTAL_PERCENTUAL.TOT_PERC_DIRETO TOT_PERC_DIRETO,
               RES.CTS_RES_RESU_ANO||RES.CTS_RES_RESU_MES ANOMES
          FROM TB_CTS_RES_RESUMO_GERAL RES, 
          ( SELECT ROUND(((SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) + SUM(RES.CTS_RES_RESU_VL_REC_INDIRETA)) / 
                   (SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA) + SUM(RES.CTS_RES_RESU_VL_DESP_INDIRETA))) - 1, 4) TOT_PERC_TOTAL,
                   ROUND(((SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) / SUM(RES.CTS_RES_RESU_VL_DESP_DIRETA))) - 1, 4) TOT_PERC_DIRETO,
                   RES.CTS_RES_RESU_ANO||RES.CTS_RES_RESU_MES ANOMES
              FROM TB_CTS_RES_RESUMO_GERAL RES
             WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA LIKE '160%'
               AND RES.CTS_RES_RESU_TIPO = 'D'
               AND TO_DATE('01/' || LPAD(RES.CTS_RES_RESU_MES, 2, '0') || '/' || RES.CTS_RES_RESU_ANO, 'DD/MM/YYYY') 
               BETWEEN TRUNC(ADD_MONTHS(V_DATA, -12)) 
               AND TRUNC(ADD_MONTHS(V_DATA, -1))
               -- AND RES.CTS_RES_RESU_ANO||LPAD(RES.CTS_RES_RESU_MES, 2, '0') >= TO_NUMBER(TO_CHAR(V_DATA, 'YYYY')) - 1||TO_NUMBER(TO_CHAR(V_DATA, 'MM')) - 1
          GROUP BY RES.CTS_RES_RESU_ANO||RES.CTS_RES_RESU_MES ) TOTAL_PERCENTUAL
         WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA LIKE '160%'
           AND RES.CTS_RES_RESU_TIPO = 'D'
           AND RES.CTS_RES_RESU_ANO||RES.CTS_RES_RESU_MES = TOTAL_PERCENTUAL.ANOMES
           AND TO_DATE('01/' || LPAD(RES.CTS_RES_RESU_MES, 2, '0') || '/' || RES.CTS_RES_RESU_ANO, 'DD/MM/YYYY') 
           BETWEEN TRUNC(ADD_MONTHS(V_DATA, -12)) 
           AND TRUNC(ADD_MONTHS(V_DATA, -1))
           -- AND RES.CTS_RES_RESU_ANO||LPAD(RES.CTS_RES_RESU_MES, 2, '0') >= TO_NUMBER(TO_CHAR(V_DATA, 'YYYY')) - 1||TO_NUMBER(TO_CHAR(V_DATA, 'MM')) - 1
           ORDER BY RES.CTS_RES_RESU_TIPO, CTS_RES_RESU_CAD_CTS_CD_CONTA ) MES1
     WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA LIKE '160%'
       AND RES.SEQ_CTS_RES_RESUMO_01 = MES1.SEQ_CTS_RES_RESUMO_01(+)
       AND RES.CTS_RES_RESU_ANO||RES.CTS_RES_RESU_MES = MES1.ANOMES
       AND TO_DATE('01/' || LPAD(RES.CTS_RES_RESU_MES, 2, '0') || '/' || RES.CTS_RES_RESU_ANO, 'DD/MM/YYYY') 
       BETWEEN TRUNC(ADD_MONTHS(V_DATA, -12)) 
       AND TRUNC(ADD_MONTHS(V_DATA, -1))
     ORDER BY RES.CTS_RES_RESU_ANO || '/' || LPAD(RES.CTS_RES_RESU_MES,2,'0'), RES.CTS_RES_RESU_TIPO, CTS_RES_RESU_CAD_CTS_CD_CONTA;                                    
    IO_CURSOR := V_CURSOR;
    END;
  END;    
END  PRC_CTS_REL_06_GRAFICO;
