CREATE OR REPLACE PROCEDURE "PRC_COB_EXPORTAR_CONTAB"
  (
    pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_INI  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_CONTAB_INI     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pDATA_CONTAB_FIM     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pCAD_BAN_ID IN TB_CAD_BAN_BANCO.CAD_BAN_ID%TYPE DEFAULT NULL,
    pASS_BCT_ID IN TB_COB_MGC_MOV_GUIA_COBRANCA.ASS_BCT_ID%TYPE DEFAULT NULL,
    pFAT_NOF_NR_NOTAFISCAL   IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_NR_NOTAFISCAL%TYPE DEFAULT NULL,
    pFAT_NOF_TP_SERIEFISCAL  IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_TP_SERIEFISCAL%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
     --   ,TESTE OUT LONG
  )
  is
  /********************************************************************
  *    Procedure: PRC_COB_EXPORTAR_CONTAB
  *
  *    Data Criac?o: 19/11/2014  Por: PEDRO
  *    Alteracao:
  *
  *
  *******************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
 begin
 OPEN v_cursor FOR

 SELECT
       RPAD(TO_CHAR(MGC.COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_MOVIMENTO),'99999999999990.00'),'.',',')),13,' ')   VALOR1,
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. REC. DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    COMPLEMENTO,
       UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_MOVIMENTO) VALOR2,
       NOF.FAT_NOF_ID,CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 6
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          NOT IN (2,7,9)
 AND (MGC.COB_MGC_VL_MOVIMENTO > 0 )
 AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)

     -- ' || V_WHERE_NOTA || '
     -- ' || V_WHERE_MGC || ' ;
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
       RPAD('VLR. REC. DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       NOF.FAT_NOF_ID,CTB.COB_CTB_TIPO_MOVTO

UNION ------------------------------------------------------------------------------------
SELECT
      RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_IR),'99999999999990.00'),'.',',')),13,' ')   VALOR1,       
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. REF. IRPJ RETIDO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    COMPLEMENTO,
        UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_IR) VALOR2, NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 1
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          NOT IN (2,7,9)
 AND (MGC.COB_MGC_VL_IR > 0 )
  AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
       RPAD('VLR. REF. IRPJ RETIDO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

/*UNION --------------------------------------------------------------------------------------
SELECT
       RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_ISS),'99999999999990.00'),'.',',')),13,' ')   VALOR1,
       RPAD(' ',25,' ')   HISTORIO,
       RPAD('VLR. REF. ISS RETIDO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    COMPLEMENTO,
        UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_ISS) VALOR2, NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 0
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          NOT IN (2,7,9) 
 AND (MGC.COB_MGC_VL_ISS > 0 )
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
RPAD('VLR. REF. ISS RETIDO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    , 
      */
UNION --------------------------------------------------------------------------------------
SELECT
       RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_CSLL),'99999999999990.00'),'.',',')),13,' ')   VALOR1, 
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. REF. CSLL RETIDA DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    COMPLEMENTO,
       UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_CSLL) VALOR2, NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 2
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          NOT IN (2,7,9)
 AND (MGC.COB_MGC_VL_CSLL > 0 )
  AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
RPAD('VLR. REF. CSLL RETIDA DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

UNION --------------------------------------------------------------------------------------
SELECT
      RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_PIS),'99999999999990.00'),'.',',')),13,' ')   VALOR1,
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. REF. PIS RETIDO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    COMPLEMENTO,
       UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_PIS) VALOR2, NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 4
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          NOT IN (2,7,9)
 AND (MGC.COB_MGC_VL_PIS > 0 )
  AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
       RPAD('VLR. REF. PIS RETIDO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

UNION --------------------------------------------------------------------------------------
SELECT
      RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_COFINS),'99999999999990.00'),'.',',')),13,' ')   VALOR1,
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. REF. COFINS RETIDA DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    COMPLEMENTO,
       UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_COFINS) VALOR2, NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO
       
FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 3
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          NOT IN (2,7,9)
 AND (MGC.COB_MGC_VL_COFINS > 0 )
  AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
       RPAD('VLR. REF. COFINS RETIDA DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

UNION --------------------------------------------------------------------------------------
SELECT
      RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
                  NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)),'99999999999990.00'),'.',',')),13,' ')   VALOR1,
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. REF. TRIBUTOS DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    COMPLEMENTO,
       UNI.CODFILIAL   FILIAL,
       SUM(NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
                  NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)) VALOR2,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 7
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          = 8
 AND ((NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
                  NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)) > 0 )
  AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
       RPAD('VLR. REF. TRIBUTOS DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO
UNION  ------------------------------------------------------------------------------------------
SELECT
      RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_MOVIMENTO),'99999999999990.00'),'.',',')),13,' ')   VALOR1,
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. DESCONTADO DO ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CONFORME ' || 'N/C ' || MGC.COB_MGC_NR_NOTA_CREDITO || ' DE ' || TO_CHAR(COB_MGC_DT_MOVIMENTO,'ddMMyyyy'),170,' ')    COMPLEMENTO,
       UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_MOVIMENTO) VALOR2, NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 5
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          = 2
 AND (MGC.COB_MGC_VL_MOVIMENTO > 0 )
  AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
       RPAD('VLR. DESCONTADO DO ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CONFORME ' || 'N/C ' || MGC.COB_MGC_NR_NOTA_CREDITO || ' DE ' || TO_CHAR(COB_MGC_DT_MOVIMENTO,'ddMMyyyy'),170,' ')  ,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO
UNION  ------------------------------------------------------------------------------------------
SELECT
      RPAD(TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),17,' ')  DATA, -- RPAD(ATE.ATD_ATE_ID,20,' ')
       RPAD(CTB.COB_CTB_DEBITO,20,' ')   DEBITO,
       RPAD(CTB.COB_CTB_CREDITO,48,' ')   CREDITO,
       RPAD(TRIM(REPLACE(to_char(SUM(MGC.COB_MGC_VL_MOVIMENTO)*-1,'99999999999990.00'),'.',',')),13,' ')   VALOR1,
       RPAD(' ',25,' ')   HISTORICO,
       RPAD('VLR. ESTORNADO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       UNI.CODFILIAL   FILIAL,
       SUM(MGC.COB_MGC_VL_MOVIMENTO)*-1 VALOR2, NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO

FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_COB_MGC_MOV_GUIA_COBRANCA MGC  ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE  = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
LEFT JOIN TB_CAD_BAN_BANCO             BAN  ON  BAN.CAD_BAN_ID          = BCT.CAD_BAN_ID
LEFT JOIN TB_COB_CTB_CONTA_CONTABIL    CTB  ON  CTB.COB_CTB_TIPO_MOVTO = 8
WHERE  CNV.CAD_CNV_CD_OPCAO_PAGTO = '1'
 AND MGC.CAD_TMC_ID          IN ( 6,18)
 AND (MGC.COB_MGC_VL_MOVIMENTO < 0 )
  AND (pCAD_CNV_ID_CONVENIO IS NULL OR nof.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO)
 AND (pFAT_NOF_NR_NOTAFISCAL IS NULL OR NOF.FAT_NOF_NR_NOTAFISCAL = pFAT_NOF_NR_NOTAFISCAL)
 AND (pFAT_NOF_TP_SERIEFISCAL IS NULL OR NOF.FAT_NOF_TP_SERIEFISCAL = pFAT_NOF_TP_SERIEFISCAL)
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >=  pDATA_EMISSAO_INI 
 AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <=  pDATA_EMISSAO_FIM 
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >=  pDATA_VENCIMENTO_INI)
 AND (pDATA_VENCIMENTO_INI IS NULL OR TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <=  pDATA_VENCIMENTO_FIM)

 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >=  pDATA_CONTAB_INI 
 AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <=  pDATA_CONTAB_FIM 
 AND (pDATA_PAGTO_INI IS NULL OR MGC.COB_MGC_DT_MOVIMENTO >=  pDATA_PAGTO_INI )
 AND (pDATA_PAGTO_FIM IS NULL OR MGC.COB_MGC_DT_MOVIMENTO <=  pDATA_PAGTO_FIM )
 AND (pASS_BCT_ID IS NULL OR MGC.ASS_BCT_ID = pASS_BCT_ID)
 AND (pCAD_BAN_ID IS NULL OR BCT.CAD_BAN_ID = pCAD_BAN_ID)
GROUP BY  TO_CHAR(COB_MGC_DT_LIBERACAO_CONTAB,'ddMMyyyy'),
          CTB.COB_CTB_DEBITO ,
       CTB.COB_CTB_CREDITO ,
       UNI.CODFILIAL ,
       ' ',
       RPAD('VLR. ESTORNADO DE ' || CNV.CAD_CNV_CD_HAC_PRESTADOR || ' - ' || CNV.CAD_CNV_NM_FANTASIA || ' REF. NF ' || NOF.FAT_NOF_NR_NOTAFISCAL  || ' EMITIDA EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_EMISSAO,'dd/MM/yyyy') || ' VENCIMENTO EM ' ||  TO_CHAR(NOF.FAT_NFO_DT_VENCIMENTO,'dd/MM/yyyy') || ' CREDITADA EM ' ||  TO_CHAR(MGC.COB_MGC_DT_MOVIMENTO,'dd/MM/yyyy'),170,' ')    ,
       NOF.FAT_NOF_ID, CTB.COB_CTB_TIPO_MOVTO
ORDER BY 9,10
;
    io_cursor := v_cursor;
  end PRC_COB_EXPORTAR_CONTAB;
