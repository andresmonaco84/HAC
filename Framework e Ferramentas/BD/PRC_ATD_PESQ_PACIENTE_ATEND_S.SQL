CREATE OR REPLACE PROCEDURE "PRC_ATD_PESQ_PACIENTE_ATEND_S"
  (
     pNOMPAC IN TB_CAD_PES_PESSOA.CAD_PES_NM_PESSOA%type DEFAULT NULL,
     pATD_ATE_DT_ATENDIMENTO_INI IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%type DEFAULT NULL,
     pATD_ATE_DT_ATENDIMENTO_FIN IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%type DEFAULT NULL,
     pTIS_CBO_CD_CBOS IN TB_ATD_ATE_ATENDIMENTO.TIS_CBO_CD_CBOS%type  DEFAULT NULL,
     pCAD_UNI_ID_UNIDADE IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%type  DEFAULT NULL,
     pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%type DEFAULT NULL,
     pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%type DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
     --,TESTE OUT LONG
  )
is
  /********************************************************************
  *    Procedure: PRC_ATD_PESQ_PACIENTE_ATEND_S
  *
  *    Data Criacao: 	04/05/2008           Por: Caio H. B. Chagas
  *    Funcao: Lista Pacientes Atendidos
  *
  *    Data Alteracao: 10/02/2010  Por: Davi Silvestre M. dos Reis
  *    Alteracao: Inclusao do filtro por CAD_CNV_ID_CONVENIO (tarefa 13534)
  *
  *********************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(3000);
  V_SELECT  varchar2(20000);
begin
  V_WHERE := NULL;
IF pNOMPAC IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND PES.CAD_PES_NM_PESSOA LIKE ' ||CHR(39)|| pNOMPAC ||CHR(39); END IF;
IF pATD_ATE_DT_ATENDIMENTO_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATE.ATD_ATE_DT_ATENDIMENTO >= ' ||CHR(39)|| pATD_ATE_DT_ATENDIMENTO_INI ||CHR(39);    END IF;
IF pATD_ATE_DT_ATENDIMENTO_FIN IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATE.ATD_ATE_DT_ATENDIMENTO <= ' ||CHR(39)|| pATD_ATE_DT_ATENDIMENTO_FIN ||CHR(39);    END IF;
IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE; END IF;
IF pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO = ' || pCAD_LAT_ID_LOCAL_ATENDIMENTO; END IF;
IF pTIS_CBO_CD_CBOS IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATE.TIS_CBO_CD_CBOS = ' ||CHR(39)|| pTIS_CBO_CD_CBOS ||CHR(39); END IF;
IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PAC.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO;    END IF;
V_SELECT:=
'
        SELECT ATE.ATD_ATE_ID Idt,
               PLA.CAD_PLA_CD_PLANO_HAC || '||chr(39)||' / '||chr(39)||' || CNV.CAD_CNV_CD_HAC_PRESTADOR PlanoConvenio,
               PAC.CAD_PAC_CD_CREDENCIAL Credencial,
               PAC.CAD_PAC_NR_PRONTUARIO Prontuario,
               ATE.ATD_ATE_ID NroAtendimento,
               to_char(trunc(ATE.ATD_ATE_DT_ATENDIMENTO),'||chr(39)||'dd/MM/yyyy'||chr(39)||') || '||chr(39)||' '||chr(39)||' || SUBSTR(LPAD(TO_CHAR(ATE.ATD_ATE_HR_ATENDIMENTO),4,'||chr(39)||'0'||chr(39)||'),0,2) || '||chr(39)||':'||chr(39)||' || SUBSTR(LPAD(TO_CHAR(ATE.ATD_ATE_HR_ATENDIMENTO),4,'||chr(39)||'0'||chr(39)||'),3,2) DataHora,
               TAT.TIS_TAT_DS_TPATENDIMENTO Tipo_Atendimento,
               '||chr(39)||'ATE'||chr(39)||' Modulo,
               UNI.CAD_UNI_DS_UNIDADE || '||chr(39)||' / '||chr(39)||' || LAT.CAD_LAT_CD_LOCAL_ATENDIMENTO || '||chr(39)||' / '||chr(39)||' || SETOR.CAD_SET_CD_SETOR UnidadeLocal,
               ATE.ATD_ATE_FL_STATUS STATUS,
               PRO.CAD_PRO_NM_NOME PROFISSIONAL,
               PES.CAD_PES_NM_PESSOA Nome,
               TO_CHAR(PES.CAD_PES_DT_NASCIMENTO, '||chr(39)||'dd/MM/yyyy'||chr(39)||') DataNasc,
               TO_CHAR(ATE.ATD_ATE_DT_ATENDIMENTO, '||chr(39)||'dd/MM/yyyy'||chr(39)||') DATA,
               SUBSTR(LPAD(TO_CHAR(ATE.ATD_ATE_HR_ATENDIMENTO),4,''0''),0,2) || '':'' || SUBSTR(LPAD(TO_CHAR(ATE.ATD_ATE_HR_ATENDIMENTO),4,''0''),3,2)  HORA,
               CASE WHEN ATE.ATD_ATE_FL_PRONT_ELETR_ATIVO ='||chr(39)||'S'||chr(39)||' THEN '||chr(39)||'Sim'||chr(39)||' ELSE '||chr(39)||'Nao'||chr(39)||' END PRONTUARIOELETRONICO,
               ATE.ATD_ATE_DS_OBSERVACAO OBSERVACAO
          FROM TB_CAD_PES_PESSOA PES
         INNER JOIN TB_CAD_PAC_PACIENTE PAC
            ON PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
         INNER JOIN TB_ASS_PAT_PACIEATEND PAT
            ON PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
         INNER JOIN TB_ATD_ATE_ATENDIMENTO ATE
            ON ATE.ATD_ATE_ID = PAT.ATD_ATE_ID
         INNER JOIN TB_CAD_PLA_PLANO PLA
            ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
         INNER JOIN TB_CAD_UNI_UNIDADE UNI
            ON UNI.CAD_UNI_ID_UNIDADE = ATE.CAD_UNI_ID_UNIDADE
         INNER JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT
            ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO
         INNER JOIN TB_TIS_TAT_TP_ATENDIMENTO TAT
            ON TAT.TIS_TAT_CD_TPATENDIMENTO = ATE.TIS_TAT_CD_TPATENDIMENTO
         LEFT JOIN TB_CAD_PRO_PROFISSIONAL PRO
            ON PRO.CAD_PRO_ID_PROFISSIONAL = ATE.CAD_PRO_ID_PROF_EXEC
         INNER JOIN TB_CAD_SET_SETOR SETOR
            ON SETOR.CAD_SET_ID = ATE.CAD_SET_ID
         INNER JOIN TB_CAD_CNV_CONVENIO CNV
            ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
         /* Filtro Nome */
         WHERE 1=1 ' || V_WHERE || '
         ORDER BY ATE.ATD_ATE_DT_ATENDIMENTO desc';
   --   TESTE :=  V_SELECT ;
   --dbms_output.put_line(V_SELECT);
  OPEN v_cursor FOR
   V_SELECT ;
  -- SELECT 1 FROM DUAL;
    io_cursor := v_cursor;
end PRC_ATD_PESQ_PACIENTE_ATEND_S;


