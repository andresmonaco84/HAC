create or replace procedure PRC_AGE_HIS_HISTORICO_AGENDA_S
  (
     pCAD_PAC_ID_PACIENTE IN TB_CAD_PAC_PACIENTE.CAD_PAC_ID_PACIENTE%TYPE,
     pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.Tis_Cbo_Cd_Cbos%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_AGE_HIS_HISTORICO_AGENDA_S
  *
  *    Data Alterac?o: 05/10/2009           Por: Pedro
  *    Alterac?o:      incluido verifica??o na TB_AGE_AGC e corre??o do join com a ESF
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR
   SELECT DISTINCT AGE.AGE_AGD_ID,
                PAC.CAD_CNV_ID_CONVENIO,
                PAC.CAD_PLA_ID_PLANO,
                PAC.CAD_PAC_CD_CREDENCIAL,
                ESCALA.CAD_UNI_ID_UNIDADE,
                ESCALA.CAD_LAT_ID_LOCAL_ATENDIMENTO,
                CBOS.TIS_CBO_CD_CBOS,
                AGE.CAD_PRO_ID_PROFISSIONALEXEC,
                ESCALA.AGE_SAU_ID,
                AGE.AGE_AGD_DT_ATENDIMENTO,
                AGE.AGE_AGD_HR_ATENDIMENTO,
                AGE.AGE_AGD_FL_STATUS,
                AGE.AGE_AGD_DT_LIMITE_RETORNO,
                AGE.AGE_AGD_TP_AGENDA,
                ESCALA.AGE_PEE_ID,
                ESCALA.AGE_ESM_ID,
                AGE.SEG_USU_ID_USUARIO,
                AGE.AGE_AGD_DT_ULTIMA_ATUALIZACAO,
                AGE.AGE_AGD_TP_AGENDA
  FROM TB_AGE_AGD_AGENDA        AGE,
       TB_CAD_PAC_PACIENTE      PAC,
       TB_AGE_ESM_ESCALA_MEDICA ESCALA,
       TB_TIS_CBO_CBOS          CBOS
 WHERE PAC.CAD_PAC_ID_PACIENTE = AGE.CAD_PAC_ID_PACIENTE
   AND TO_DATE(TO_CHAR(AGE.AGE_AGD_DT_ATENDIMENTO,'dd-MM-yyyy')||TO_CHAR(AGE.AGE_AGD_HR_ATENDIMENTO,'0000'),'dd-MM-yyyy HH24MI')
                                   >= TRUNC(SYSDATE)
   AND AGE.AGE_ESM_ID = ESCALA.AGE_ESM_ID
   AND CBOS.TIS_CBO_CD_CBOS = ESCALA.TIS_CBO_CD_CBOS
   AND NOT EXISTS (SELECT *
           FROM   TB_AGE_AGD_AGENDA AGE2,  
                  TB_CAD_PAC_PACIENTE          PAC2,
                  TB_AGE_ESM_ESCALA_MEDICA     ESCALA2,
                  TB_TIS_CBO_CBOS CBOS2,                
                  TB_AGE_ESF_ESCALA_FALTAS ESF2
           WHERE  PAC2.CAD_PAC_ID_PACIENTE     = AGE2.CAD_PAC_ID_PACIENTE
           AND    AGE2.AGE_ESM_ID = ESF2.AGE_ESM_ID
           AND    AGE2.AGE_ESM_ID = ESCALA2.AGE_ESM_ID
           AND    CBOS2.TIS_CBO_CD_CBOS = ESCALA2.TIS_CBO_CD_CBOS
           AND    AGE2.AGE_ESM_ID = ESF2.AGE_ESM_ID
           AND    AGE2.AGE_AGD_ID = AGE.AGE_AGD_ID
           AND    TO_DATE(TO_CHAR(AGE2.AGE_AGD_DT_ATENDIMENTO,'dd-MM-yyyy')||TO_CHAR(AGE2.AGE_AGD_HR_ATENDIMENTO,'0000'),'dd-MM-yyyy HH24MI')
                                   >= TRUNC(SYSDATE)
           AND    (AGE2.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE)
           AND    (ESF2.AGE_ESF_FL_SUBSTITUTO_OK = 'N' OR ESF2.AGE_ESF_FL_SUBSTITUTO_OK IS NULL)
           AND    (pTIS_CBO_CD_CBOS IS NULL OR CBOS2.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS)
          -- AND    AGE2.AGE_AGD_ID NOT IN (SELECT AGC2.AGE_AGD_ID FROM TB_AGE_AGC_AGENDA_CANCELADA AGC2 
             --                            WHERE AGC2.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE             )
						AND (AGE2.AGE_AGD_DT_ATENDIMENTO BETWEEN ESF2.AGE_ESF_DT_INI_FALTA AND ESF2.AGE_ESF_DT_FIM_FALTA 
						AND (AGE2.AGE_AGD_HR_ATENDIMENTO BETWEEN ESF2.AGE_ESF_HR_INI_FALTA AND ESF2.AGE_ESF_HR_FIM_FALTA OR
						(ESF2.AGE_ESF_HR_INI_FALTA IS NULL AND ESF2.AGE_ESF_HR_FIM_FALTA IS NULL)))) 
   --AND AGE.AGE_AGD_ID NOT IN
    --   (SELECT AGC.AGE_AGD_ID  FROM TB_AGE_AGC_AGENDA_CANCELADA AGC  WHERE AGC.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE)
   AND (AGE.CAD_PAC_ID_PACIENTE = pCAD_PAC_ID_PACIENTE)
  AND (pTIS_CBO_CD_CBOS IS NULL OR CBOS.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS)
 ORDER BY ESCALA.CAD_UNI_ID_UNIDADE,
          ESCALA.CAD_LAT_ID_LOCAL_ATENDIMENTO,
          CBOS.TIS_CBO_CD_CBOS,
          AGE.CAD_PRO_ID_PROFISSIONALEXEC,
          ESCALA.AGE_PEE_ID,
          AGE.AGE_AGD_DT_ATENDIMENTO,
          AGE.AGE_AGD_HR_ATENDIMENTO
      ;
  io_cursor := v_cursor;
end PRC_AGE_HIS_HISTORICO_AGENDA_S;
