CREATE OR REPLACE PROCEDURE "PRC_AGE_REL_HORAR_BLOQ"
  (
     pDT_INICIO_CONSULTA in TB_AGE_AGD_AGENDA.AGE_AGD_DT_ATENDIMENTO%type,
     pDT_FIM_CONSULTA in TB_AGE_AGD_AGENDA.AGE_AGD_DT_ATENDIMENTO%type,
     pCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%type default null,
     pCAD_LAT_ID_LOCAL_ATENDIMENTO in TB_CAD_LAT_LOCAL_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%type default null,
     pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%type default null,
     pCAD_PRO_ID_PROFISSIONAL in TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%type default null,
     pAGE_SAU_CD_ANDAR IN TB_AGE_SAU_SALA_UNID_AND.AGE_SAU_CD_ANDAR%type default null,
    -- pAGE_AGD_FL_STATUS IN TB_AGE_AGD_AGENDA.AGE_AGD_FL_STATUS%type default null,
     pAGE_ESM_HR_INI_ESCALA in TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_HR_INI_ESCALA%type default null,
     pAGE_ESM_HR_FIM_ESCALA in TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_HR_FIM_ESCALA%type default null,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_AGE_REL_HORAR_BLOQ
  *
  *    Data Criacao:  05/08/2014   Por: PEDRO
  *
 *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR

SELECT UNI.CAD_UNI_DS_UNIDADE,
       LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
       CBO.TIS_CBO_DS_CBOS_HAC,
       PRO.CAD_PRO_NR_CONSELHO,
       PRO.CAD_PRO_NM_NOME,
       TRUNC(AGG.AGE_AGG_DT_AGENDA) AGE_AGG_DT_AGENDA,
       AGG.AGE_AGG_HR_AGENDA

FROM TB_AGE_AGG_AGENDA_GERADA     AGG
JOIN TB_AGE_ESM_ESCALA_MEDICA     ESM ON AGG.AGE_ESM_ID                   = ESM.AGE_ESM_ID
                                     AND ESM.AGE_ESM_FL_SITUACAO          = 'A'
JOIN TB_CAD_UNI_UNIDADE           UNI ON ESM.CAD_UNI_ID_UNIDADE           = UNI.CAD_UNI_ID_UNIDADE
                                     AND (PCAD_UNI_ID_UNIDADE IS NULL OR UNI.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE)
JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO
                                      AND (PCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = PCAD_LAT_ID_LOCAL_ATENDIMENTO)
JOIN TB_CAD_PRO_PROFISSIONAL      PRO ON ESM.CAD_PRO_ID_PROFISSIONAL      = PRO.CAD_PRO_ID_PROFISSIONAL
JOIN TB_TIS_CBO_CBOS              CBO ON ESM.TIS_CBO_CD_CBOS              = CBO.TIS_CBO_CD_CBOS

WHERE AGG.AGE_AGG_FL_STATUS_HORARIO = 4
  AND AGG.AGE_ESF_ID IS NULL
  AND AGG.AGE_AGG_DT_AGENDA BETWEEN PDT_INICIO_CONSULTA AND PDT_FIM_CONSULTA
  AND (PAGE_ESM_HR_INI_ESCALA IS NULL OR AGG.AGE_AGG_HR_AGENDA BETWEEN PAGE_ESM_HR_INI_ESCALA AND PAGE_ESM_HR_FIM_ESCALA)

ORDER BY UNI.CAD_UNI_DS_UNIDADE,PRO.CAD_PRO_NM_NOME,fnc_juntar_data_hora(TRUNC(AGG.AGE_AGG_DT_AGENDA),AGG.AGE_AGG_HR_AGENDA)
;

io_cursor := v_cursor;

end PRC_AGE_REL_HORAR_BLOQ;
