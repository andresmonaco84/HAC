CREATE OR REPLACE PROCEDURE PRC_REL_ESTAT_TX_CONV_INT_PS_M
(
     PCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE %TYPE DEFAULT NULL,
    -- PCAD_SET_CD_SETOR   IN TB_CAD_SET_SETOR.CAD_SET_CD_SETOR%TYPE,
     PTIS_CBO_CD_CBOS    IN TB_ATD_ATE_ATENDIMENTO.TIS_CBO_CD_CBOS%TYPE,
     PATD_DT_INICIO      IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
     PATD_DT_FIM         IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
     PGRUPO                 VARCHAR2 DEFAULT NULL,
     io_cursor           OUT PKG_CURSOR.t_cursor
  )
  is
/********************************************************************
*    Procedure: PRC_REL_ESTAT_TX_CONV_INT_PS_M
*
*    Data Criacao:    data da  cria??o   Por: Nome do Analista
*    Data Alteracao:  data da altera??o  Por: Nome do Analista
*
*    Funcao: Descri??o da funcionalidade da Stored Procedure
*
*******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR
SELECT DISTINCT 
         TB_MES_ANO.MES_ANO,         
         TB_CLASSIF.CLASSIF,
           NVL(ATEND_PS.TOTAL,0) TOTAL_PS,
           NVL(INTERNACAO.TOTAL,0) TOTAL_INT,
           ROUND(NVL(((INTERNACAO.TOTAL/ATEND_PS.TOTAL) * 100),0),2) TAXA_CONVERSAO,

           ATEND_PS.TOTAL_CLASSIF TOTAL_PS_CLASSIF,
           INTERNACAO.TOTAL_CLASSIF TOTAL_INT_CLASSIF,
           ROUND(((INTERNACAO.TOTAL_CLASSIF/ATEND_PS.TOTAL_CLASSIF) * 100),2) TAXA_CONVERSAO_CLASSIF,

           ATEND_PS.TOTAL_CLASSIF_GRUPO TOTAL_PS_CLASSIF_GRUPO,
           INTERNACAO.TOTAL_CLASSIF_GRUPO TOTAL_INT_CLASSIF_GRUPO,
           ROUND(((INTERNACAO.TOTAL_CLASSIF_GRUPO/ATEND_PS.TOTAL_CLASSIF_GRUPO) * 100),2) TAXA_CONVERSAO_CLASSIF_GRUPO,

           ATEND_PS.TOTAL_GERAL TOTAL_GERAL_PS,
           INTERNACAO.TOTAL_GERAL TOTAL_GERAL_INT,
           ROUND(((INTERNACAO.TOTAL_GERAL/ATEND_PS.TOTAL_GERAL) * 100),2) TAXA_CONVERSAO_GERAL


FROM 
      (SELECT DISTINCT CASE
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '01' THEN '01/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '02' THEN '02/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '03' THEN '03/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '04' THEN '04/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '05' THEN '05/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '06' THEN '06/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '07' THEN '07/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '08' THEN '08/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '09' THEN '09/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '10' THEN '10/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '11' THEN '11/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
          ELSE  '12/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
       END MES_ANO
       FROM TB_ATD_ATE_ATENDIMENTO ATD
       WHERE ATD.TIS_TAT_CD_TPATENDIMENTO = 4
   AND (ATD.ATD_ATE_DT_ATENDIMENTO BETWEEN PATD_DT_INICIO AND PATD_DT_FIM)
   AND (ATD.ATD_ATE_FL_STATUS = 'A')
   AND ATD.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE
     ) TB_MES_ANO,
     
     (SELECT 'GRUPO' CLASSIF, 'GRUPO' GRUPO  FROM DUAL
     UNION SELECT 'EXTRA GRUPO/MERCADO' CLASSIF, 'EXTRA GRUPO/MERCADO + PARTICULAR' GRUPO FROM DUAL
     UNION SELECT 'EXTRA GRUPO/PARTICULAR' CLASSIF, 'EXTRA GRUPO/MERCADO + PARTICULAR' GRUPO FROM DUAL
     ) TB_CLASSIF,
(SELECT CASE
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '01' THEN '01/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '02' THEN '02/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '03' THEN '03/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '04' THEN '04/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '05' THEN '05/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '06' THEN '06/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '07' THEN '07/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '08' THEN '08/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '09' THEN '09/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '10' THEN '10/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '11' THEN '11/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
          ELSE  '12/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
       END MES_ANO,
       CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END CLASSIF,
       SUM(COUNT(ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '01' THEN '01/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '02' THEN '02/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '03' THEN '03/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '04' THEN '04/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '05' THEN '05/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '06' THEN '06/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '07' THEN '07/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '08' THEN '08/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '09' THEN '09/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '10' THEN '10/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '11' THEN '11/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
          ELSE  '12/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
       END||CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END ) TOTAL,

       SUM(COUNT(ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF,

        SUM(COUNT(ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF_GRUPO,

       SUM(COUNT(ATD.ATD_ATE_ID)) OVER() TOTAL_GERAL

  FROM TB_ATD_ATE_ATENDIMENTO ATD
  JOIN TB_CAD_UNI_UNIDADE UNI    ON UNI.CAD_UNI_ID_UNIDADE = ATD.CAD_UNI_ID_UNIDADE
  JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT    ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
  JOIN TB_ASS_PAT_PACIEATEND PAT    ON ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
  JOIN TB_CAD_PAC_PACIENTE PAC    ON PAC.CAD_PAC_ID_PACIENTE = PAT.CAD_PAC_ID_PACIENTE
  JOIN TB_CAD_CNV_CONVENIO CNV    ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
  JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 WHERE ATD.TIS_TAT_CD_TPATENDIMENTO = 4
   AND (ATD.ATD_ATE_DT_ATENDIMENTO BETWEEN PATD_DT_INICIO AND PATD_DT_FIM)
   AND (ATD.ATD_ATE_FL_STATUS = 'A')
   AND ATD.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE
   AND (PGRUPO IS NULL OR 
   PGRUPO = '1' AND (CNV.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLA.CAD_PLA_ID_PLANO NOT IN(70292,70312) ) OR
   PGRUPO = '2' AND (PLA.CAD_PLA_ID_PLANO IN (70292, 70312)  OR CNV.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
   PGRUPO = '3' AND (CNV.CAD_CGC_ID = 1   AND CNV.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
   PGRUPO = '4' AND (CNV.CAD_CGC_ID = 1  AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNV.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
   PGRUPO = '5' AND (CNV.CAD_CGC_ID = 2  )       
   )      
       
  AND (PTIS_CBO_CD_CBOS IS NULL OR atd.tis_cbo_cd_cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS ))))
 GROUP BY CASE
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '01' THEN '01/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '02' THEN '02/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '03' THEN '03/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '04' THEN '04/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '05' THEN '05/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '06' THEN '06/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '07' THEN '07/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '08' THEN '08/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '09' THEN '09/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '10' THEN '10/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '11' THEN '11/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
          ELSE  '12/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
       END,CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END,
         CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END
) ATEND_PS,
(SELECT CASE
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '01' THEN '01/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '02' THEN '02/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '03' THEN '03/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '04' THEN '04/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '05' THEN '05/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '06' THEN '06/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '07' THEN '07/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '08' THEN '08/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '09' THEN '09/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '10' THEN '10/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '11' THEN '11/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
          ELSE  '12/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
       END MES_ANO,
           CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END CLASSIF,
       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '01' THEN '01/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '02' THEN '02/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '03' THEN '03/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '04' THEN '04/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '05' THEN '05/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '06' THEN '06/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '07' THEN '07/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '08' THEN '08/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '09' THEN '09/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '10' THEN '10/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '11' THEN '11/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
          ELSE  '12/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
       END|| CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END ) TOTAL,

       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF,

        SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER(PARTITION BY CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END) TOTAL_CLASSIF_GRUPO,

       SUM(COUNT(DISTINCT ATD.ATD_ATE_ID)) OVER() TOTAL_GERAL

  FROM TB_ATD_ATE_ATENDIMENTO ATD,
       TB_ASS_PAT_PACIEATEND PAT,
       TB_CAD_PAC_PACIENTE PAC,
       TB_CAD_UNI_UNIDADE UNI,
       TB_CAD_PES_PESSOA PES,
       TB_CAD_CNV_CONVENIO CNV,
       TB_CAD_PLA_PLANO PLA,
       (SELECT PATPS.CAD_PAC_ID_PACIENTE,
               ATDPS.ATD_ATE_DT_ATENDIMENTO,
               ATDPS.ATD_ATE_HR_ATENDIMENTO,
               ATDPS.ATD_ATE_ID,
               PACPS.CAD_PES_ID_PESSOA
          FROM TB_ASS_PAT_PACIEATEND  PATPS,
               TB_ATD_ATE_ATENDIMENTO ATDPS,
               TB_CAD_PAC_PACIENTE    PACPS,
               TB_CAD_CNV_CONVENIO    CNVPS,
               TB_CAD_PLA_PLANO      PLAPS
         WHERE PATPS.ATD_ATE_ID = ATDPS.ATD_ATE_ID
           AND PATPS.CAD_PAC_ID_PACIENTE = PACPS.CAD_PAC_ID_PACIENTE
           AND ATDPS.TIS_TAT_CD_TPATENDIMENTO = 4 --- CONSULTA
           AND ATDPS.CAD_LAT_ID_LOCAL_ATENDIMENTO IN (30, 34) --- NO PS
           AND (PTIS_CBO_CD_CBOS IS NULL OR ATDPS.Tis_Cbo_Cd_Cbos IN ( SELECT * FROM TABLE(FNC_SPLIT( PTIS_CBO_CD_CBOS ))))
           AND ATDPS.ATD_ATE_FL_STATUS = 'A'
          --  AND (PGRUPO IS NULL OR 
      -- PGRUPO = '1' AND (CNVPS.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLAPS.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
     --  PGRUPO = '2' AND (PLAPS.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNVPS.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
     --  PGRUPO = '3' AND (CNVPS.CAD_CGC_ID = 1   AND CNVPS.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
    --  PGRUPO = '4' AND (CNVPS.CAD_CGC_ID = 1  AND PLAPS.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNVPS.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
  -- PGRUPO = '5' AND (CNVPS.CAD_CGC_ID = 2  )      
    --   )
           AND PATPS.CAD_CNV_ID_CONVENIO = CNVPS.CAD_CNV_ID_CONVENIO
           AND PACPS.CAD_PLA_ID_PLANO = PLAPS.CAD_PLA_ID_PLANO
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO-1
           AND ATDPS.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
       AND ATDPS.CAD_UNI_ID_UNIDADE = PCAD_UNI_ID_UNIDADE) INT_VIAPS

 WHERE ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND ATD.ATD_ATE_DT_ATENDIMENTO >= PATD_DT_INICIO
   AND ATD.ATD_ATE_DT_ATENDIMENTO <= PATD_DT_FIM
   AND ATD.ATD_ATE_ID = PAT.ATD_ATE_ID
   AND ATD.ATD_ATE_FL_STATUS = 'A'
   AND ATD.ATD_ATE_TP_PACIENTE IN ('I', 'E')
   AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
   AND PAC.CAD_PES_ID_PESSOA = INT_VIAPS.CAD_PES_ID_PESSOA
   AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
   AND FNC_JUNTAR_DATA_HORA(ATD.ATD_ATE_DT_ATENDIMENTO, ATD.ATD_ATE_HR_ATENDIMENTO) > FNC_JUNTAR_DATA_HORA(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO, INT_VIAPS.ATD_ATE_HR_ATENDIMENTO)
   AND (TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) OR TRUNC(ATD.ATD_ATE_DT_ATENDIMENTO) = (TRUNC(INT_VIAPS.ATD_ATE_DT_ATENDIMENTO) + 1))
   AND ATD.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
   AND ATD.ATD_ATE_FL_CARATER_SOLIC = 'U'
   AND PAC.CAD_CNV_ID_CONVENIO = CNV.CAD_CNV_ID_CONVENIO
   AND PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
    AND (PGRUPO IS NULL OR 
       PGRUPO = '1' AND (CNV.CAD_CNV_CD_HAC_PRESTADOR = 'SD01' AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312)) OR
       PGRUPO = '2' AND (PLA.CAD_PLA_ID_PLANO IN( 70292, 70312)  OR CNV.CAD_CNV_CD_HAC_PRESTADOR = 'GG05') OR
       PGRUPO = '3' AND (CNV.CAD_CGC_ID = 1   AND CNV.CAD_CNV_CD_HAC_PRESTADOR IN( 'SZ85','SAV5')) OR
      PGRUPO = '4' AND (CNV.CAD_CGC_ID = 1  AND PLA.CAD_PLA_ID_PLANO NOT IN( 70292, 70312) AND CNV.CAD_CNV_CD_HAC_PRESTADOR NOT IN ('SZ85','SAV5','GG05','SD01')) OR
   PGRUPO = '5' AND (CNV.CAD_CGC_ID = 2  )      
       )
 GROUP BY CASE
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '01' THEN '01/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '02' THEN '02/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '03' THEN '03/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '04' THEN '04/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '05' THEN '05/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '06' THEN '06/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '07' THEN '07/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '08' THEN '08/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '09' THEN '09/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '10' THEN '10/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
         WHEN TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'MM') = '11' THEN '11/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
          ELSE  '12/'||TO_CHAR(ATD.ATD_ATE_DT_ATENDIMENTO,'YYYY')
       END,CASE WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO != 282 THEN 'EXTRA GRUPO/MERCADO'
         WHEN CNV.CAD_CGC_ID = 2 AND CNV.CAD_CNV_ID_CONVENIO = 282 THEN 'EXTRA GRUPO/PARTICULAR'
         ELSE 'GRUPO'
         END,
         CASE WHEN CNV.CAD_CGC_ID = 2 THEN 'EXTRA GRUPO/MERCADO + PARTICULAR'
         ELSE 'GRUPO'
         END
) INTERNACAO
WHERE
      ATEND_PS.CLASSIF (+) = TB_CLASSIF.CLASSIF
  AND ATEND_PS.MES_ANO (+) = TB_MES_ANO.MES_ANO
  AND INTERNACAO.MES_ANO (+) = TB_MES_ANO.MES_ANO
  AND INTERNACAO.CLASSIF (+) = TB_CLASSIF.CLASSIF
  
ORDER BY 1 ASC,2 DESC;


    io_cursor := v_cursor;
  end PRC_REL_ESTAT_TX_CONV_INT_PS_M;
