CREATE OR REPLACE TRIGGER "TR3_BNF_BENEFICIARIO"
  AFTER UPDATE OF "CODSITBEN" ON "BENEFICIARIO"."BNF_BENEFICIARIO"
  FOR EACH ROW
DECLARE
  V_FOUND       NUMBER(3);
BEGIN
  IF :NEW.CODSITBEN = 1 THEN  
    SELECT COUNT(*)
      INTO V_FOUND
      FROM SGS.TB_CAD_PAC_PACIENTE PAC, SGS.TB_CAD_PLA_PLANO PLA
     WHERE PAC.CAD_PAC_FL_ATIVO_OK = 'N'
       AND PAC.CAD_CNV_ID_CONVENIO IN (281)
       AND LENGTH(PAC.CAD_PAC_CD_CREDENCIAL) = 12
       AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
       AND PLA.CAD_PLA_CD_PLANO_HAC = :OLD.CODCON
       AND TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL, 0, 3)) =
           TO_NUMBER(:OLD.CODEST)
       AND TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL, 4, 7)) =
           TO_NUMBER(:OLD.CODBEN)
       AND TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL, 11, 2)) =
           TO_NUMBER(:OLD.CODSEQBEN);  
    IF V_FOUND > 0 THEN    
      FOR I IN (SELECT PAC.CAD_PAC_ID_PACIENTE
                  FROM SGS.TB_CAD_PAC_PACIENTE PAC, SGS.TB_CAD_PLA_PLANO PLA
                 WHERE PAC.CAD_PAC_FL_ATIVO_OK = 'N'
                   AND PAC.CAD_CNV_ID_CONVENIO IN (281)
                   AND LENGTH(PAC.CAD_PAC_CD_CREDENCIAL) = 12
                   AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
                   AND PLA.CAD_PLA_CD_PLANO_HAC = :OLD.CODCON
                   AND TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL, 0, 3)) =
                       TO_NUMBER(:OLD.CODEST)
                   AND TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL, 4, 7)) =
                       TO_NUMBER(:OLD.CODBEN)
                   AND TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL, 11, 2)) =
                       TO_NUMBER(:OLD.CODSEQBEN)) LOOP      
        UPDATE SGS.TB_CAD_PAC_PACIENTE PAC
           SET PAC.CAD_PAC_FL_ATIVO_OK = 'S'
         WHERE PAC.CAD_PAC_FL_ATIVO_OK = 'N'
           AND PAC.CAD_PAC_ID_PACIENTE = I.CAD_PAC_ID_PACIENTE;      
      END LOOP;    
    END IF;
  END IF;
END;
/
