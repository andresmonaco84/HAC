CREATE OR REPLACE PROCEDURE "PRC_INT_PESQ_GERENC_OCUPACAO_S"
(
       pCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
       IO_CURSOR           OUT PKG_CURSOR.T_CURSOR
) IS
  /********************************************************************
  *    Procedure: PRC_INT_PESQ_GERENC_OCUPACAO_S
  *
  *    Data Criacao:    04/10/2010     Por: Fabiola
  *
  *    Data Alteracao:  23/9/2011     Por: Pedro
  *
  *    Funcao: Pesquisa gerencial de ocupac?o do hospital
  *
  *    Alteracao: 1 - CLINICA CIRURGICA
2 - CLINICA MEDICA
3 - BERCARIO
4 - MATERNIDADE
5 - PEDIATRIA
6 - UNIDADES CRITICAS
7 - INTERMEDIARIO
8 - HOSPITAL DIA
9 - OBSERVACAO
  *
  *******************************************************************/
  V_CURSOR PKG_CURSOR.T_CURSOR;
BEGIN
  OPEN V_CURSOR FOR
  
    SELECT 1 ORDEM,
           CASE WHEN SETOR.CAD_CSE_ID <= 7 THEN 0 ELSE 11 END DIVISAO_CATEGORIA,
           SETOR.CAD_CSE_ID,
           CSE.CAD_CSE_DS_CATEGORIA DS_CATEGORIA,
           SETOR.CAD_SET_DS_SETOR || DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),0,' (FECHADO)','') DS_SETOR,
           DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),1,COUNT(OFICIAL.CAD_QLE_ID),0) QTD_OFICIAL,
           DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),1,COUNT(LIVRE.CAD_QLE_ID) ,0) QTD_LIVRE,
           DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),1,COUNT(OCUPADO.CAD_QLE_ID),0)  QTD_OCUPADO,
           DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),1,COUNT(INTERDITADO.CAD_QLE_ID),0)  QTD_INTERDITADO,
           DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),1,COUNT(LIMPEZA.CAD_QLE_ID),0)  QTD_LIMPEZA,
           DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),1,COUNT(EXTRA.CAD_QLE_ID),0)  QTD_EXTRA,
           CASE WHEN COUNT(OFICIAL.CAD_QLE_ID) > 0 AND FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID) = 1
                     THEN ROUND((COUNT(OCUPADO.CAD_QLE_ID) * 100) / COUNT(OFICIAL.CAD_QLE_ID), 2)
                ELSE 0
           END PERCENTUAL
           
      FROM TB_CAD_SET_SETOR        SETOR,
           TB_CAD_CSE_CATEGORIA_SETOR CSE,
           TB_CAD_QLE_QUARTO_LEITO QLE,
           (SELECT QLE.CAD_QLE_ID CAD_QLE_ID, QLE.CAD_SET_ID
              FROM TB_CAD_QLE_QUARTO_LEITO  QLE,
                   TB_CAD_SET_SETOR         SETOR
             WHERE SETOR.CAD_SET_ID = QLE.CAD_SET_ID
               AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
               AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
               AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
             --  AND SETOR.CAD_SET_ID NOT IN (2072,2312,5,140)
               AND QLE.CAD_QLE_TP_QUARTO_LEITO = 'I'
               AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO != 5) OFICIAL,
           (SELECT QLE.CAD_QLE_ID          CAD_QLE_ID,
                   QLE.CAD_SET_ID          CAD_SET_ID,
                   IML.CAD_PAC_ID_PACIENTE,
                   PES.CAD_PES_NM_PESSOA,
                   PES.CAD_PES_TP_SEXO,
                   IML.ATD_ATE_ID
              FROM TB_ATD_IML_INT_MOV_LEITO IML,
                   TB_CAD_QLE_QUARTO_LEITO  QLE,
                   TB_CAD_SET_SETOR         SETOR,
                   TB_CAD_PAC_PACIENTE      PAC,
                   TB_CAD_PES_PESSOA        PES
             WHERE IML.ATD_IML_DT_SAIDA IS NULL
               AND IML.ATD_IML_HR_SAIDA IS NULL
               AND IML.CAD_CAD_QLE_ID = QLE.CAD_QLE_ID
               AND SETOR.CAD_SET_ID = QLE.CAD_SET_ID
               AND IML.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
               AND PAC.CAD_PES_ID_PESSOA = PES.CAD_PES_ID_PESSOA
               AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
               AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
               AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
             --  AND SETOR.CAD_SET_ID NOT IN (2072,2312,5,140)
               AND QLE.CAD_QLE_TP_QUARTO_LEITO = 'I'
               AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = 2
               AND IML.ATD_IML_FL_STATUS = 'A') OCUPADO,
           (SELECT QLE.CAD_QLE_ID                     CAD_QLE_ID,
                   QLE.CAD_SET_ID                     CAD_SET_ID,
                   CAD_SET_DS_SETOR,
                   SETOR.CAD_UNI_ID_UNIDADE,
                   SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO
              FROM TB_CAD_QLE_QUARTO_LEITO QLE, TB_CAD_SET_SETOR SETOR
             WHERE QLE.CAD_QLE_TP_QUARTO_LEITO = 'I'
               AND QLE.CAD_SET_ID = SETOR.CAD_SET_ID
               AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = 1
               AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
               AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
               AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
            --   AND SETOR.CAD_SET_ID NOT IN (2072,2312,5,140)
            ) LIVRE,
           (SELECT QLE.CAD_QLE_ID                     CAD_QLE_ID,
                   QLE.CAD_SET_ID                     CAD_SET_ID,
                   CAD_SET_DS_SETOR,
                   SETOR.CAD_UNI_ID_UNIDADE,
                   SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO
              FROM TB_CAD_QLE_QUARTO_LEITO QLE, TB_CAD_SET_SETOR SETOR
             WHERE QLE.CAD_QLE_TP_QUARTO_LEITO = 'E'
               AND QLE.CAD_SET_ID = SETOR.CAD_SET_ID
               AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = 2
               AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
               AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
               AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
             --  AND SETOR.CAD_SET_ID NOT IN (2072,2312,5,140)
             ) EXTRA,
           (SELECT QLE.CAD_QLE_ID                     CAD_QLE_ID,
                   QLE.CAD_SET_ID                     CAD_SET_ID,
                   CAD_SET_DS_SETOR,
                   SETOR.CAD_UNI_ID_UNIDADE,
                   SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO
              FROM TB_CAD_QLE_QUARTO_LEITO QLE, TB_CAD_SET_SETOR SETOR
             WHERE QLE.CAD_QLE_TP_QUARTO_LEITO = 'I'
               AND QLE.CAD_SET_ID = SETOR.CAD_SET_ID
               AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = 3
               AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
               AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
               AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
            --   AND SETOR.CAD_SET_ID NOT IN (2072,2312,5,140)
            ) LIMPEZA,
           (SELECT QLE.CAD_QLE_ID                     CAD_QLE_ID,
                   QLE.CAD_SET_ID                     CAD_SET_ID,
                   CAD_SET_DS_SETOR,
                   SETOR.CAD_UNI_ID_UNIDADE,
                   SETOR.CAD_LAT_ID_LOCAL_ATENDIMENTO
              FROM TB_CAD_QLE_QUARTO_LEITO QLE, TB_CAD_SET_SETOR SETOR
             WHERE QLE.CAD_QLE_TP_QUARTO_LEITO = 'I'
               AND QLE.CAD_SET_ID = SETOR.CAD_SET_ID
               AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO = 4
               AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
               AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
               AND SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
             --  AND SETOR.CAD_SET_ID NOT IN (2072,2312,5,140)
             ) INTERDITADO
     WHERE SETOR.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
      -- AND SETOR.CAD_SET_ID NOT IN (2072,2312,5,140)
       AND SETOR.CAD_SET_FL_PERMITEINTERN_OK = 'S'
       AND SETOR.CAD_SET_FL_ATIVO_OK = 'S'
       AND SETOR.CAD_CSE_ID = CSE.CAD_CSE_ID
      -- AND QLE.CAD_SQL_CD_SIT_QUARTO_LEITO != 5
       AND QLE.CAD_SET_ID = SETOR.CAD_SET_ID
       AND OFICIAL.CAD_SET_ID(+) = QLE.CAD_SET_ID
       AND OFICIAL.CAD_QLE_ID(+) = QLE.CAD_QLE_ID
       AND OCUPADO.CAD_SET_ID(+) = QLE.CAD_SET_ID
       AND OCUPADO.CAD_QLE_ID(+) = QLE.CAD_QLE_ID
       AND LIVRE.CAD_SET_ID(+) = QLE.CAD_SET_ID
       AND LIVRE.CAD_QLE_ID(+) = QLE.CAD_QLE_ID
       AND EXTRA.CAD_SET_ID(+) = QLE.CAD_SET_ID
       AND EXTRA.CAD_QLE_ID(+) = QLE.CAD_QLE_ID
       AND LIMPEZA.CAD_SET_ID(+) = QLE.CAD_SET_ID
       AND LIMPEZA.CAD_QLE_ID(+) = QLE.CAD_QLE_ID
       AND INTERDITADO.CAD_SET_ID(+) = QLE.CAD_SET_ID
       AND INTERDITADO.CAD_QLE_ID(+) = QLE.CAD_QLE_ID
     GROUP BY SETOR.CAD_SET_DS_SETOR || DECODE(FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID),0,' (FECHADO)',''),
              CSE.CAD_CSE_DS_CATEGORIA,SETOR.CAD_CSE_ID,
              FNC_CAD_SET_ABERTO_INTERNAC(SETOR.CAD_SET_ID), CASE WHEN SETOR.CAD_CSE_ID <= 7 THEN 0 ELSE 1 END 
    
  ORDER BY 2,3,5;
  
  
  IO_CURSOR := V_CURSOR;
END PRC_INT_PESQ_GERENC_OCUPACAO_S;
