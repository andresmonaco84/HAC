create or replace procedure PRC_ATS_APE_ATEN_PROC_ECOCAR_I
  (
     pNewIdt OUT integer,
     pATS_ATE_CD_INTLIB IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_ATE_CD_INTLIB%type,
     pATS_ATE_IN_INTLIB IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_ATE_IN_INTLIB%type,
     pAUX_EPP_CDESPECPROC IN TB_ATS_APE_ATEN_PROCED_ECOCAR.AUX_EPP_CDESPECPROC%type,
     pATS_ATE_ID IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_ATE_ID%type,
     pCAD_PRD_ID IN TB_ATS_APE_ATEN_PROCED_ECOCAR.CAD_PRD_ID%type,
     pATS_UME_CD_ECOCAR IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_UME_CD_ECOCAR%type,
     pATS_UME_TP_UNID_MEDIDA IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_UME_TP_UNID_MEDIDA%type,
     pATS_UME_CD_UNID_MEDIDA IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_UME_CD_UNID_MEDIDA%type,
     pATS_APE_FL_STATUS IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_APE_FL_STATUS%type,
     pATS_APE_QT_RESULTADO IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_APE_QT_RESULTADO%type,
     pATS_APE_DT_ULTIMA_ATUALIZACAO IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_APE_DT_ULTIMA_ATUALIZACAO%type,
     pSEG_USU_ID_USUARIO IN TB_ATS_APE_ATEN_PROCED_ECOCAR.SEG_USU_ID_USUARIO%type,
     pATS_APE_ID IN TB_ATS_APE_ATEN_PROCED_ECOCAR.ATS_APE_ID%type default NULL,
     pTIS_MED_CD_TABELAMEDICA IN TB_ATS_APS_ATEN_PROC_SEGMENTO.TIS_MED_CD_TABELAMEDICA%type  
  ) 
  is
  /********************************************************************
  *    Procedure: PRC_ATS_APE_ATEN_PROCED_ECOCAR_I
  * 
  *    Data Criacao:   data da  cria√ß√£o   Por: Nome do Analista
  *    Data Alteracao:	27/03/2010  Por: Pedro
  *    AlteraÁ„o: pTIS_MED_CD_TABELAMEDICA
  *
  *    Funcao: Descri√ß√£o da funcionalidade da Stored Procedure
  *
  *******************************************************************/  
    lIdtRetorno integer;
    CD_MEDIDA VARCHAR2(5);
    pPESO NUMBER;
  begin
    SELECT SEQ_ATS_APE.NextVal INTO lIdtRetorno FROM DUAL;
  
  SELECT ATS_ATE_QT_PESO INTO pPESO 
  FROM   TB_ATS_ATE_ATENDIMENTO_SADT ATE
  WHERE ATE.ATS_ATE_CD_INTLIB = pATS_ATE_CD_INTLIB
     AND  ATE.ATS_ATE_IN_INTLIB = pATS_ATE_IN_INTLIB
    AND  ATE.ATS_ATE_ID = pATS_ATE_ID
   AND  ATE.CAD_PRD_ID = pCAD_PRD_ID
   AND  ATE.AUX_EPP_CD_ESPECPROC = pAUX_EPP_CDESPECPROC
   AND  ATE.TIS_MED_CD_TABELAMEDICA = pTIS_MED_CD_TABELAMEDICA;

    
    SELECT ATS_UME_CD_UNID_MEDIDA INTO CD_MEDIDA 
    FROM TB_ATS_UME_UNI_MEDIDA_ECOCAR
    WHERE ATS_UME_CD_ECOCARDIO = pATS_UME_CD_ECOCAR
    AND   pPESO BETWEEN ATS_UME_QT_UNID_MEDIDA_INI AND ATS_UME_QT_UNID_MEDIDA_FIM
    AND   ATS_UME_TP_UNID_MEDIDA = pATS_UME_TP_UNID_MEDIDA;  
      
    INSERT INTO TB_ATS_APE_ATEN_PROCED_ECOCAR
    (
       ATS_ATE_CD_INTLIB,
       ATS_ATE_IN_INTLIB,
       AUX_EPP_CDESPECPROC,
       ATS_ATE_ID,
       CAD_PRD_ID,
       ATS_UME_CD_ECOCAR,
       ATS_UME_TP_UNID_MEDIDA,
       ATS_UME_CD_UNID_MEDIDA,
       ATS_APE_FL_STATUS,
       ATS_APE_QT_RESULTADO,
       ATS_APE_DT_ULTIMA_ATUALIZACAO,
       SEG_USU_ID_USUARIO,
       ATS_APE_ID,
       TIS_MED_CD_TABELAMEDICA
    )
    VALUES
    (
       pATS_ATE_CD_INTLIB,
       pATS_ATE_IN_INTLIB,
       pAUX_EPP_CDESPECPROC,
       pATS_ATE_ID,
       pCAD_PRD_ID,
       pATS_UME_CD_ECOCAR,
       pATS_UME_TP_UNID_MEDIDA,
       CD_MEDIDA,
       pATS_APE_FL_STATUS,
       pATS_APE_QT_RESULTADO,
       pATS_APE_DT_ULTIMA_ATUALIZACAO,
       pSEG_USU_ID_USUARIO,
       lIdtRetorno,
       pTIS_MED_CD_TABELAMEDICA
    );
    pNewIdt := lIdtRetorno;  
  end PRC_ATS_APE_ATEN_PROC_ECOCAR_I;
/
