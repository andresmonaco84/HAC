CREATE OR REPLACE PROCEDURE "PRC_CTS_REL_05"
(
   pCTS_RES_RESU_MES       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_MES_PAGTO%type,
   pCTS_RES_RESU_ANO       IN TB_REP_RPA_RESUMO_PAGTO.REP_RPA_ANO_PAGTO%type,
   IO_CURSOR               OUT PKG_CURSOR.T_CURSOR
)
IS
v_cursor PKG_CURSOR.t_cursor;
BEGIN
  OPEN v_cursor FOR

/*
SELECT RES.CTS_RES_RESU_TIPO              TIPO,
       RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL  NIVEL,
       RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI DESCRICAO,
       RES.CTS_RES_RESU_CAD_CTS_CD_CONTA  CONTA,
       RES.CTS_RES_RESU_VL_REC_DIRETA VL_RECEITA_DIRETA,
       RES.CTS_RES_RESU_VL_REC_INDIRETA VL_RECEITA_INDIRETA,
       ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA, 2) VL_TOTAL_RECEITA_DI,
       RES.CTS_RES_RESU_VL_DESP_DIRETA VL_DESPESA_DIRETA,
       RES.CTS_RES_RESU_VL_DESP_INDIRETA VL_DESPESA_INDIRETA,
       ROUND(RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA, 2) VL_TOTAL_DESPESA_DI,
       (CASE WHEN CTS_RES_RESU_VL_DESP_DIRETA  = 0 THEN 0
         ELSE ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA / RES.CTS_RES_RESU_VL_DESP_DIRETA, 2) - 1 END) PERCENTUAL_DIRETO,
       (CASE WHEN (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA) = 0 THEN 0
         ELSE ROUND(((RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA) / (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA)), 2) - 1 END) PERCENTUAL_TOTAL,
       ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA /  TOTAL_RECEITA_DI.TOT_RECEITA_DI, 2) PERC_RECEITA_DI--,
       --TOTAL_RECEITA_DI.TOT_RECEITA_DI TOTAL_RECEITA_DI
  FROM TB_CTS_RES_RESUMO_GERAL RES, (SELECT SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) + SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI) TOT_RECEITA_DI
                                       FROM TB_CTS_RES_RESUMO_GERAL RES
                                      WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
                                        AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
                                        AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
                                        AND RES.CTS_RES_RESU_TIPO = 'R'
--                                        AND (RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA > 0)
                                        AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1) TOTAL_RECEITA_DI
                                        -- percentual receita direta + intermediaria do relat?rio 1.
 WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA LIKE '160%'
--   AND (RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA > 0)
   AND RES.CTS_RES_RESU_TIPO = 'D'
   AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
   AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
 ORDER BY RES.CTS_RES_RESU_TIPO, CTS_RES_RESU_CAD_CTS_CD_CONTA;
 */



SELECT RES.CTS_RES_RESU_TIPO              TIPO,
       RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL  NIVEL,
       RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI DESCRICAO,
       RES.CTS_RES_RESU_CAD_CTS_CD_CONTA  CONTA,
       0 VL_RECEITA_DIRETA,
       0 VL_RECEITA_INDIRETA,
       0 VL_TOTAL_RECEITA_DI,
       0 VL_DESPESA_DIRETA,
       0 VL_DESPESA_INDIRETA,
       0 VL_TOTAL_DESPESA_DI,
       0 PERCENTUAL_DIRETO,
       0 PERCENTUAL_TOTAL,
       0 PERC_RECEITA_DI,
       TOTAL_RECEITA_DI.TOT_RECEITA_DI TOTAL_RECEITA_DI
  FROM TB_CTS_RES_RESUMO_GERAL RES,
   (SELECT SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) + SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI) TOT_RECEITA_DI
                                       FROM TB_CTS_RES_RESUMO_GERAL RES
                                      WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
                                        AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
                                        AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
                                        AND RES.CTS_RES_RESU_TIPO = 'R'
                                        AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
                                        ) TOTAL_RECEITA_DI
 WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA LIKE '160%'
   AND RES.CTS_RES_RESU_TIPO = 'D'
   AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
   AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
   AND RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
UNION ALL
SELECT RES.CTS_RES_RESU_TIPO              TIPO,
       RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL  NIVEL,
       RES.CTS_RES_RESU_CAD_CTS_DS_DESCRI DESCRICAO,
       RES.CTS_RES_RESU_CAD_CTS_CD_CONTA  CONTA,
       RES.CTS_RES_RESU_VL_REC_DIRETA VL_RECEITA_DIRETA,
       RES.CTS_RES_RESU_VL_REC_INDIRETA VL_RECEITA_INDIRETA,
       ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA, 4) VL_TOTAL_RECEITA_DI,
       RES.CTS_RES_RESU_VL_DESP_DIRETA VL_DESPESA_DIRETA,
       RES.CTS_RES_RESU_VL_DESP_INDIRETA VL_DESPESA_INDIRETA,
       ROUND(RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA, 4) VL_TOTAL_DESPESA_DI,
       (CASE WHEN CTS_RES_RESU_VL_DESP_DIRETA  = 0 THEN 0
         ELSE ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA / RES.CTS_RES_RESU_VL_DESP_DIRETA, 4) - 1 END) PERCENTUAL_DIRETO,
       (CASE WHEN (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA) = 0 THEN 0
         ELSE ROUND(((RES.CTS_RES_RESU_VL_REC_DIRETA + RES.CTS_RES_RESU_VL_REC_INDIRETA) / (RES.CTS_RES_RESU_VL_DESP_DIRETA + RES.CTS_RES_RESU_VL_DESP_INDIRETA)), 4) - 1 END) PERCENTUAL_TOTAL,
       ROUND(RES.CTS_RES_RESU_VL_REC_DIRETA /  TOTAL_RECEITA_DI.TOT_RECEITA_DI, 4) PERC_RECEITA_DI,
       TOTAL_RECEITA_DI.TOT_RECEITA_DI TOTAL_RECEITA_DI
  FROM TB_CTS_RES_RESUMO_GERAL RES, (SELECT SUM(RES.CTS_RES_RESU_VL_REC_DIRETA) + SUM(RES.CTS_RES_RESU_VL_REC_INTERMEDI) TOT_RECEITA_DI
                                       FROM TB_CTS_RES_RESUMO_GERAL RES
                                      WHERE RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL = 2
                                        AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
                                        AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
                                        AND RES.CTS_RES_RESU_TIPO = 'R'
                                        AND RES.CTS_RES_RESU_CAD_CTS_CD_CONTA != 1
                                        ) TOTAL_RECEITA_DI
 WHERE RES.CTS_RES_RESU_CAD_CTS_CD_CONTA LIKE '160%'
   AND RES.CTS_RES_RESU_TIPO = 'D'
   AND RES.CTS_RES_RESU_MES = pCTS_RES_RESU_MES
   AND RES.CTS_RES_RESU_ANO = pCTS_RES_RESU_ANO
   AND RES.CTS_RES_RESU_CAD_CTS_CD_NIVEL != 2
 ORDER BY TIPO, CONTA;

    IO_CURSOR := V_CURSOR;
 END PRC_CTS_REL_05;
