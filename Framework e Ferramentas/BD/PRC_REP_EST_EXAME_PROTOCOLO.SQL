CREATE OR REPLACE PROCEDURE "PRC_REP_EST_EXAME_PROTOCOLO"
(
  P_DATA_INICIO             SADT_PACIENTE.DATEXA%TYPE DEFAULT NULL,
  P_DATA_FIM                SADT_PACIENTE.DATEXA%TYPE DEFAULT NULL,
  IO_CURSOR                 OUT PKG_CURSOR.T_CURSOR
)
  IS
V_CURSOR PKG_CURSOR.T_CURSOR;
BEGIN
  OPEN v_cursor FOR
    SELECT CBO.TIS_CBO_DS_CBOS_HAC        ESPECIALIDADE_TODOS,
           COUNT(CCI.FAT_CCI_QT_CONSUMO)  QUANTIDADE_TODOS,
           SUM(CCI.FAT_CCI_VL_FATURADO)   VALEXA_TODOS,
           EXAMESFORA.ESPECIALIDADE1      ESPECIALIDADE_FORA,
           EXAMESFORA.QUANTIDADE1         QUANTIDADE_FORA,
           EXAMESFORA.VALEXA1             VALOR_FORA,
           ROUND(EXAMESFORA.QUANTIDADE1 / COUNT(CCI.FAT_CCI_QT_CONSUMO) * 100, 2) PERCENTUAL_QUANTIDADE,
           ROUND(EXAMESFORA.VALEXA1 / SUM(CCI.FAT_CCI_VL_FATURADO) * 100, 2) PERCENTUAL_VALOR
      FROM SADT_PACIENTE                  SP,
           SADT_EXAMES_PACIENTE           SEP,
           SADT_EXAME                     SE,
           SADT_PROCEDENCIA               SPRO,
           TB_ATD_ATE_ATENDIMENTO         ATD,
           TB_ASS_PAT_PACIEATEND          PAT,
           TB_CAD_PAC_PACIENTE            PAC,
           TB_CAD_PLA_PLANO               PLA,
           TB_CAD_PRO_PROFISSIONAL        PRO,
           TB_CAD_PES_PESSOA              PES_PRO,
           TB_CAD_CLC_CLINICA_CREDENCIADA CLC,
           TB_FAT_MCC_MOV_COM_CONSUMO     MCC,
           TB_FAT_CCI_CONTA_CONSU_ITEM    CCI,
           TB_CAD_PRD_PRODUTO             PRD,
           TB_TIS_CBO_CBOS                CBO,
           (
           SELECT COUNT(CCI.FAT_CCI_QT_CONSUMO)  QUANTIDADE1,
           SUM(CCI.FAT_CCI_VL_FATURADO)   VALEXA1,
           CBO.TIS_CBO_DS_CBOS_HAC        ESPECIALIDADE1
        FROM SADT_PACIENTE                  SP,
           SADT_EXAMES_PACIENTE           SEP,
           SADT_EXAME                     SE,
           SADT_PROCEDENCIA               SPRO,
           TB_ATD_ATE_ATENDIMENTO         ATD,
           TB_ASS_PAT_PACIEATEND          PAT,
           TB_CAD_PAC_PACIENTE            PAC,
           TB_CAD_PLA_PLANO               PLA,
           TB_CAD_PRO_PROFISSIONAL        PRO,
           TB_CAD_PES_PESSOA              PES_PRO,
           TB_CAD_CLC_CLINICA_CREDENCIADA CLC,
           TB_FAT_MCC_MOV_COM_CONSUMO     MCC,
           TB_FAT_CCI_CONTA_CONSU_ITEM    CCI,
           TB_CAD_PRD_PRODUTO             PRD,
           TB_TIS_CBO_CBOS                CBO
        WHERE SP.CODUNIHOS = SEP.CODUNIHOS
        AND SP.CODUNISAD = SEP.CODUNISAD
        AND SP.CODEXA = SEP.CODEXA
        AND SEP.CODUNISAD = SE.CODUNISAD
        AND SEP.CODMNE = SE.CODMNE
        AND SP.CD_PROCED = SPRO.CD_PROCED
        AND SP.CODATEAMB = ATD.ATD_ATE_ID
        AND PAT.ATD_ATE_ID = ATD.ATD_ATE_ID
        AND PAT.CAD_PAC_ID_PACIENTE = FNC_BUSCAR_PACIENTE_ATUAL(ATD.ATD_ATE_ID)
        AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
        AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
        AND SP.CODCON = PLA.CAD_PLA_CD_PLANO_HAC
        AND ATD.CAD_PRO_ID_PROF_EXEC = PRO.CAD_PRO_ID_PROFISSIONAL
        AND PRO.CAD_PES_ID_PESSOA = PES_PRO.CAD_PES_ID_PESSOA
        AND TO_CHAR(SP.CODMED) = TO_CHAR(PRO.CAD_PRO_NR_CONSELHO)
        AND ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO = 27
        AND SP.CODATEAMB = MCC.ATD_ATE_ID
        AND MCC.ATD_ATE_ID = CCI.ATD_ATE_ID
        AND MCC.FAT_MCC_ID = CCI.FAT_MCC_ID
        AND CCI.CAD_PRD_ID = PRD.CAD_PRD_ID
        AND TRUNC(SP.DATEXA) = TRUNC(CCI.FAT_CCI_DT_INICIO_CONSUMO)
        AND DECODE(TO_CHAR(SE.CD_TUSS), NULL, TO_CHAR(SE.CODATOMED), TO_CHAR(SE.CD_TUSS)) = TRIM(PRD.CAD_PRD_CD_CODIGO)
        AND MCC.FAT_TCO_ID = 182
        AND CCI.FAT_CCI_FL_STATUS = 'A'
        AND PRD.TIS_MED_CD_TABELAMEDICA IN ('16', '0')
        AND SP.CODUNISAD = 'L'
        AND SP.CD_PROCED != 999
        AND PLA.CAD_PLA_CD_TIPOPLANO IN ('GB' , 'PL' )
        AND SPRO.LOCAL NOT LIKE 'PS%'
        AND SP.DATEXA >=  P_DATA_INICIO
        AND SP.DATEXA <=  P_DATA_FIM
        AND ATD.TIS_CBO_CD_CBOS = CBO.TIS_CBO_CD_CBOS
        AND CLC.CAD_CLC_ID(+) = SGS.FNC_OBTER_CLINICA_PROF(PRO.CAD_PRO_ID_PROFISSIONAL, SP.DATEXA)
        AND CCI.FAT_CCI_ID = (SELECT MAX(X.FAT_CCI_ID) FROM TB_FAT_CCI_CONTA_CONSU_ITEM X
                              WHERE X.ATD_ATE_ID = ATD.ATD_ATE_ID
                               AND TRUNC(X.FAT_CCI_DT_INICIO_CONSUMO) = TRUNC(SP.DATEXA)
                                AND X.FAT_CCI_FL_STATUS = 'A'
                                AND X.CAD_PRD_ID = PRD.CAD_PRD_ID)
        AND SEP.FL_PROTOCOLO = 'N'
        AND (SEP.FL_JUSTIFICATIVA != 'S' OR SEP.FL_JUSTIFICATIVA IS NULL)
        AND PRO.TIS_CPR_CD_CONSELHOPROF = 'CRM'
        AND PRO.CAD_PRO_NR_CONSELHO NOT IN ( '77225', '33377' , '90904' , '75050' )
        AND (SE.IN_ANEXO <> 'S' OR SE.IN_ANEXO IS NULL)
        GROUP BY CBO.TIS_CBO_DS_CBOS_HAC
        ORDER BY CBO.TIS_CBO_DS_CBOS_HAC
         ) EXAMESFORA
    WHERE SP.CODUNIHOS = SEP.CODUNIHOS
       AND SP.CODUNISAD = SEP.CODUNISAD
       AND SP.CODEXA = SEP.CODEXA
       AND SEP.CODUNISAD = SE.CODUNISAD
       AND SEP.CODMNE = SE.CODMNE
       AND SP.CD_PROCED = SPRO.CD_PROCED
       AND SP.CODATEAMB = ATD.ATD_ATE_ID
       AND PAT.ATD_ATE_ID = ATD.ATD_ATE_ID
       AND PAT.CAD_PAC_ID_PACIENTE = FNC_BUSCAR_PACIENTE_ATUAL(ATD.ATD_ATE_ID)
       AND PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
       AND PAC.CAD_PLA_ID_PLANO = PLA.CAD_PLA_ID_PLANO
       AND SP.CODCON = PLA.CAD_PLA_CD_PLANO_HAC
       AND ATD.CAD_PRO_ID_PROF_EXEC = PRO.CAD_PRO_ID_PROFISSIONAL
       AND PRO.CAD_PES_ID_PESSOA = PES_PRO.CAD_PES_ID_PESSOA
       AND TO_CHAR(SP.CODMED) = TO_CHAR(PRO.CAD_PRO_NR_CONSELHO)
       AND ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO = 27
       AND SP.CODATEAMB = MCC.ATD_ATE_ID
       AND MCC.ATD_ATE_ID = CCI.ATD_ATE_ID
       AND MCC.FAT_MCC_ID = CCI.FAT_MCC_ID
       AND CCI.CAD_PRD_ID = PRD.CAD_PRD_ID
       AND TRUNC(SP.DATEXA) = TRUNC(CCI.FAT_CCI_DT_INICIO_CONSUMO)
       AND DECODE(TO_CHAR(SE.CD_TUSS), NULL, TO_CHAR(SE.CODATOMED), TO_CHAR(SE.CD_TUSS)) = TRIM(PRD.CAD_PRD_CD_CODIGO)
       AND MCC.FAT_TCO_ID = 182
       AND CCI.FAT_CCI_FL_STATUS = 'A'
       AND PRD.TIS_MED_CD_TABELAMEDICA IN ('16', '0')
       AND SP.CODUNISAD = 'L'
       AND SP.CD_PROCED != 999
       AND PLA.CAD_PLA_CD_TIPOPLANO IN ('GB' , 'PL' )
       AND SPRO.LOCAL NOT LIKE 'PS%'
       AND SP.DATEXA >=  P_DATA_INICIO
       AND SP.DATEXA <=  P_DATA_FIM
       AND ATD.TIS_CBO_CD_CBOS = CBO.TIS_CBO_CD_CBOS
       AND CLC.CAD_CLC_ID(+) = SGS.FNC_OBTER_CLINICA_PROF(PRO.CAD_PRO_ID_PROFISSIONAL, SP.DATEXA)
       AND CCI.FAT_CCI_ID = (SELECT MAX(X.FAT_CCI_ID) FROM TB_FAT_CCI_CONTA_CONSU_ITEM X
                              WHERE X.ATD_ATE_ID = ATD.ATD_ATE_ID
                               AND TRUNC(X.FAT_CCI_DT_INICIO_CONSUMO) = TRUNC(SP.DATEXA)
                                AND X.FAT_CCI_FL_STATUS = 'A'
                                AND X.CAD_PRD_ID = PRD.CAD_PRD_ID)
       AND EXAMESFORA.ESPECIALIDADE1(+) = CBO.TIS_CBO_DS_CBOS_HAC
    GROUP BY CBO.TIS_CBO_DS_CBOS_HAC,
             EXAMESFORA.QUANTIDADE1,
             EXAMESFORA.VALEXA1,
             EXAMESFORA.ESPECIALIDADE1
    ORDER BY CBO.TIS_CBO_DS_CBOS_HAC;
   IO_CURSOR := V_CURSOR;
 END PRC_REP_EST_EXAME_PROTOCOLO;
