CREATE OR REPLACE PROCEDURE "PRC_ATS_REL_LAUDO_PROD_USU"
  (
     PDT_INI_CONSULTA IN TB_AGS_AGE_AGENDA_SADT.AGS_AGE_DT_ATENDIMENTO%TYPE,
     pDT_FIM_CONSULTA    IN TB_AGS_AGE_AGENDA_SADT.AGS_AGE_DT_ATENDIMENTO%TYPE,
     pCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
     PNM_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_DS_UNIDADE%TYPE DEFAULT NULL,
     pAUX_EPP_CD_ESPECPROC IN TB_ATS_ATE_ATENDIMENTO_SADT.AUX_EPP_CD_ESPECPROC%TYPE DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
  )
  is
  
  v_cursor PKG_CURSOR.t_cursor;
  begin
  OPEN v_cursor FOR
SELECT USU.SEG_USU_DS_NOME, --RES.DT,
      SUM(NVL(RES.R,0)) CADASTRADO,
      SUM(NVL(RES.L,0)) LAUDADO,
      SUM(NVL(RES.I,0)) IMPRESSO,
      SUM(NVL(RES.P,0)) PROTOCOLADO,
      SUM(NVL(RES.C,0)) CANCELADO
FROM TB_SEG_USU_USUARIO USU,
( SELECT APL.SEG_USU_ID_USUARIO, 
          0 I,
          COUNT(1) L,
          0 P,
          0 R,
          0 C
    FROM TB_ATS_APL_ATEN_PROCED_LAUDO APL
    WHERE TRUNC(APL.ATS_APL_DT_LAUDO) BETWEEN PDT_INI_CONSULTA AND pDT_FIM_CONSULTA
    AND ((pAUX_EPP_CD_ESPECPROC IS NULL and APL.AUX_EPP_CD_ESPECPROC NOT IN (21)) OR pAUX_EPP_CD_ESPECPROC IS NOT NULL)
    AND APL.ATS_APL_STATUS_LAUDO = 'L'
    AND (pAUX_EPP_CD_ESPECPROC IS NULL OR APL.AUX_EPP_CD_ESPECPROC = pAUX_EPP_CD_ESPECPROC)
   GROUP BY APL.SEG_USU_ID_USUARIO
  UNION
  SELECT APL.SEG_USU_ID_USUARIO, 
          COUNT(1) I,
          0 L,
          0 P,
          0 R,
          0 C
    FROM TB_ATS_APL_ATEN_PROCED_LAUDO APL
    WHERE TRUNC(APL.ATS_APL_DT_LAUDO) BETWEEN PDT_INI_CONSULTA AND pDT_FIM_CONSULTA
    AND ((pAUX_EPP_CD_ESPECPROC IS NULL and APL.AUX_EPP_CD_ESPECPROC NOT IN (21)) OR pAUX_EPP_CD_ESPECPROC IS NOT NULL)
    AND APL.ATS_APL_STATUS_LAUDO = 'I'
    AND (pAUX_EPP_CD_ESPECPROC IS NULL OR APL.AUX_EPP_CD_ESPECPROC = pAUX_EPP_CD_ESPECPROC)
   GROUP BY APL.SEG_USU_ID_USUARIO
  UNION
  SELECT ARP.SEG_USU_ID_USUARIO, --TRUNC(ARP.ATS_APR_DT_PROTOCOLO) DT,
          CASE WHEN ARP.ATS_APR_FL_STATUS = 'I' THEN 0 END I,
          CASE WHEN ARP.ATS_APR_FL_STATUS = 'L' THEN 0 END L,
          CASE WHEN ARP.ATS_APR_FL_STATUS = 'P' THEN COUNT(1) END P,
          CASE WHEN ARP.ATS_APR_FL_STATUS = 'R' THEN 0 END R,
          CASE WHEN ARP.ATS_APR_FL_STATUS = 'C' THEN 0 END C
     FROM TB_ATS_ARP_ATEN_RESULT_PROCED ARP
    WHERE TRUNC(ARP.ATS_APR_DT_PROTOCOLO) BETWEEN PDT_INI_CONSULTA AND pDT_FIM_CONSULTA
      AND ((pAUX_EPP_CD_ESPECPROC IS NULL and ARP.ATS_EPP_CD_ESPECPROC NOT IN (21)) OR pAUX_EPP_CD_ESPECPROC IS NOT NULL)
      AND ARP.ATS_APR_FL_STATUS IN ('P')
      AND (pAUX_EPP_CD_ESPECPROC IS NULL OR ARP.ATS_EPP_CD_ESPECPROC = pAUX_EPP_CD_ESPECPROC)
     GROUP BY ARP.SEG_USU_ID_USUARIO--, TRUNC(ARP.ATS_APR_DT_PROTOCOLO)
     , ARP.ATS_APR_FL_STATUS
 UNION
  SELECT ATS.SEG_USU_ID_USUARIO, --TRUNC(ATS.ATS_ATE_DT_REALIZ_PROCED) DT,
          0 I,
          0 L,
          0 P,
          COUNT(1) R,
          0 C
     FROM  TB_ATS_ATE_ATENDIMENTO_SADT ATS
    WHERE TRUNC(ATS.ATS_ATE_DT_REALIZ_PROCED) BETWEEN PDT_INI_CONSULTA AND pDT_FIM_CONSULTA
      AND ((pAUX_EPP_CD_ESPECPROC IS NULL and ATS.AUX_EPP_CD_ESPECPROC NOT IN (21)) OR pAUX_EPP_CD_ESPECPROC IS NOT NULL)
      AND ATS.ATS_ATE_FL_STATUS IN ('A')
      AND (pAUX_EPP_CD_ESPECPROC IS NULL OR ATS.AUX_EPP_CD_ESPECPROC = pAUX_EPP_CD_ESPECPROC)
     GROUP BY ATS.SEG_USU_ID_USUARIO--, TRUNC(ATS.ATS_ATE_DT_REALIZ_PROCED)
  UNION
    SELECT CANC.SEG_USU_ID_USUARIO, --TRUNC(CANC.ATS_ACS_DT_CANCELAMENTO) DT,
          0 I,
          0 L,
          0 P,
          0 R,
          COUNT(1) C
          FROM TB_ATS_ACS_ATEND_CANCE_SADT CANC
          WHERE TRUNC(CANC.ATS_ACS_DT_CANCELAMENTO) BETWEEN PDT_INI_CONSULTA AND pDT_FIM_CONSULTA
          AND ((pAUX_EPP_CD_ESPECPROC IS NULL and CANC.AUX_EPP_CD_ESPECPROC NOT IN (21)) OR pAUX_EPP_CD_ESPECPROC IS NOT NULL)
          AND (pAUX_EPP_CD_ESPECPROC IS NULL OR CANC.AUX_EPP_CD_ESPECPROC = pAUX_EPP_CD_ESPECPROC)
          GROUP BY CANC.SEG_USU_ID_USUARIO--, TRUNC(CANC.ATS_ACS_DT_CANCELAMENTO)
          ORDER BY 2,1
          ) RES
WHERE RES.SEG_USU_ID_USUARIO = USU.SEG_USU_ID_USUARIO
GROUP BY USU.SEG_USU_DS_NOME--, RES.DT
ORDER BY 2, 1;
io_cursor := v_cursor;
 end PRC_ATS_REL_LAUDO_PROD_USU;
 