CREATE OR REPLACE PROCEDURE "PRC_ATE_REL_PROCED_SETOR"
(
    pCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE,
    pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_CAD_LAT_LOCAL_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
    pCAD_SET_ID IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,
    pCAD_SET_NR_ANDAR IN TB_CAD_SET_SETOR.CAD_SET_NR_ANDAR%TYPE DEFAULT NULL,
    pATD_DT_INICIO IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_DT_ATUALIZACAO%TYPE,
    pATD_DT_FIM IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_DT_ATUALIZACAO%TYPE,
    pATD_HR_INICIO  IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_HR_ATUALIZACAO%TYPE DEFAULT NULL,
    pATD_HR_FIM IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_HR_ATUALIZACAO%TYPE DEFAULT NULL,
    pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%TYPE DEFAULT NULL,
    pCAD_PRO_ID_PROFISSIONAL IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%TYPE DEFAULT NULL,
    pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    pCAD_PLA_ID_PLANO IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%TYPE DEFAULT NULL,
    pTIS_TAT_CD_TPATENDIMENTO IN TB_TIS_TAT_TP_ATENDIMENTO.TIS_TAT_CD_TPATENDIMENTO%TYPE DEFAULT NULL,
    pCAD_PLA_CD_TIPOPLANO IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
         pCAD_CGC_ID IN tb_cad_cnv_convenio.cad_cgc_id%TYPE DEFAULT NULL,
    io_cursor OUT PKG_CURSOR.t_cursor
   -- , TESTE OUT LONG
)
IS
  /********************************************************************
  *    Procedure: PRC_ATE_REL_PROCED_SETOR
  *
  *    Data Criacao:  DD/MM/2008   Por: NONONONO
  *
  *    Funcao: Alimentar relatorio com informac?es dos procedimentos
  *            realizados em determinado setor
  *
  *    Data Alteracao: 02/06/2008   Por: Davi Silvestre M. dos Reis
  *    Alteracao: Relatorio renomeado de PRC_ATE_REL_SERV_MULHER para
  *               PRC_ATE_REL_PROCED_SETOR (pois nao traz apenas
  *               informacoes dos Servicos da Mulher).
  *               Inclusao de campos que nao estavam retornando
  *               inicialmente (como, por exemplo, especialidade)
  *
  *******************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
 V_SELECT  varchar2(20000);
  begin
V_SELECT :=
   '
  SELECT
         ATD.ATD_ATE_ID NRO_ATD,
         UNI.CAD_UNI_DS_UNIDADE NM_UNIDADE,
         LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO DS_LOCAL,
         SETOR.CAD_SET_DS_SETOR DS_SETOR,
         SETOR.CAD_SET_NR_ANDAR NR_ANDAR,
         ATD.ATD_ATE_DT_ATENDIMENTO DT_ATENDIMENTO,
         ATD.ATD_ATE_HR_ATENDIMENTO HR_ATENDIMENTO,
         CNV.CAD_CNV_CD_HAC_PRESTADOR CD_CONVENIO,
         PLA.CAD_PLA_CD_PLANO_HAC CD_PLANO,
         CBO.TIS_CBO_DS_CBOS_HAC DS_ESPECIALIDADE,
         PLA.CAD_PLA_CD_TIPOPLANO,
         DECODE(PLA.CAD_PLA_CD_TIPOPLANO,
                                  ''FU'', ''FUNCIONARIO'',
                                  ''PA'', ''PA'',
                                  ''GB'', ''GLOBAL'',
                                  ''PL'', ''PESSOA FISICA'',
                                  ''SP'', ''SERVICOS PRESTADOS'',
                                  ''TODOS'') TIPO_PLANO_DESC,
         PRO.CAD_PRO_NR_CONSELHO NR_CONSELHO,
         DECODE(PRO.CAD_PRO_NM_NOME,NULL,''SEM MEDICO EXECUTANTE'',PRO.CAD_PRO_NM_NOME) NOME_PROFISSIONAL,
         PES_PAC.CAD_PES_NM_PESSOA NOME_PACIENTE,
         PRD.CAD_PRD_NM_MNEMONICO MNEMONICO,
         PRD.CAD_PRD_CD_CODIGO CD_PRODUTO,
         PRD.CAD_PRD_DS_DESCRICAO DS_PRODUTO
         
    FROM TB_ATD_ATE_ATENDIMENTO ATD
   INNER JOIN TB_ASS_PAP_PAC_ATEN_PROC PAP ON PAP.ATD_ATE_ID = ATD.ATD_ATE_ID
   INNER JOIN TB_CAD_PRD_PRODUTO PRD ON PRD.CAD_PRD_ID = PAP.CAD_PRD_ID
   INNER JOIN TB_CAD_UNI_UNIDADE UNI ON ATD.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE AND UNI.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE || '
   INNER JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO ';
      IF pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NOT NULL THEN V_SELECT := V_SELECT || ' AND LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ' || pCAD_LAT_ID_LOCAL_ATENDIMENTO; END IF;
 V_SELECT:= V_SELECT || '
      JOIN TB_CAD_SET_SETOR SETOR ON ATD.CAD_SET_ID = SETOR.CAD_SET_ID ';
      IF pCAD_SET_ID IS NOT NULL THEN V_SELECT := V_SELECT || ' AND SETOR.CAD_SET_ID = ' || pCAD_SET_ID; END IF;
      IF pCAD_SET_NR_ANDAR IS NOT NULL THEN V_SELECT := V_SELECT || ' AND SETOR.CAD_SET_NR_ANDAR = ' || pCAD_SET_NR_ANDAR; END IF;
 V_SELECT:= V_SELECT || '
   JOIN TB_ASS_PAT_PACIEATEND PAT ON PAT.ATD_ATE_ID = ATD.ATD_ATE_ID
   JOIN TB_CAD_PAC_PACIENTE PAC ON PAC.CAD_PAC_ID_PACIENTE = PAT.CAD_PAC_ID_PACIENTE
   JOIN TB_CAD_CNV_CONVENIO CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO ';
      IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN V_SELECT := V_SELECT || ' AND CNV.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO; END IF;
      IF pCAD_CGC_ID IS NOT NULL THEN V_SELECT := V_SELECT || ' AND CNV.CAD_CGC_ID = ' || pCAD_CGC_ID; END IF;    
 V_SELECT:= V_SELECT || '
   INNER JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO ';
      IF pCAD_PLA_ID_PLANO IS NOT NULL THEN V_SELECT := V_SELECT || ' AND PLA.CAD_PLA_ID_PLANO = ' || pCAD_PLA_ID_PLANO; END IF;
      IF pCAD_PLA_CD_TIPOPLANO IS NOT NULL THEN V_SELECT := V_SELECT || ' AND PLA.CAD_PLA_CD_TIPOPLANO = ' || CHR(39) || pCAD_PLA_CD_TIPOPLANO || CHR(39) ; END IF;
 V_SELECT:= V_SELECT || '
   LEFT JOIN TB_TIS_CBO_CBOS CBO ON CBO.TIS_CBO_CD_CBOS = ATD.TIS_CBO_CD_CBOS ';
      IF pTIS_CBO_CD_CBOS IS NOT NULL THEN V_SELECT := V_SELECT || ' AND CBO.TIS_CBO_CD_CBOS = ' || CHR(39) || pTIS_CBO_CD_CBOS || CHR(39) ; END IF;
 V_SELECT:= V_SELECT || '
   LEFT JOIN TB_CAD_PRO_PROFISSIONAL PRO
      ON PRO.CAD_PRO_ID_PROFISSIONAL = ATD.CAD_PRO_ID_PROF_EXEC  ';
      IF pCAD_PRO_ID_PROFISSIONAL IS NOT NULL THEN V_SELECT := V_SELECT || ' AND PRO.CAD_PRO_ID_PROFISSIONAL = ' || pCAD_PRO_ID_PROFISSIONAL; END IF;
 V_SELECT:= V_SELECT || '
   JOIN TB_CAD_PES_PESSOA PES_PAC ON PES_PAC.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
  WHERE
       ((ATD.ATD_ATE_DT_ATENDIMENTO BETWEEN ' || CHR(39) || pATD_DT_INICIO || CHR(39) || ' AND ' || CHR(39) || pATD_DT_FIM  || CHR(39) ||') OR ' || CHR(39) || pATD_DT_INICIO || CHR(39) ||' IS NULL)
    AND ((ATD.ATD_ATE_HR_ATENDIMENTO >= ' || CHR(39) ||pATD_HR_INICIO || CHR(39) || ' AND ATD.ATD_ATE_HR_ATENDIMENTO <= ' || CHR(39) ||pATD_HR_FIM || CHR(39) || ') OR ' || CHR(39) ||pATD_HR_INICIO || CHR(39) || ' IS NULL) ';
      IF pTIS_TAT_CD_TPATENDIMENTO IS NOT NULL THEN V_SELECT := V_SELECT || ' AND ATD.TIS_TAT_CD_TPATENDIMENTO = ' || CHR(39) || pTIS_TAT_CD_TPATENDIMENTO || CHR(39) ; END IF;
  --TESTE :=  V_SELECT ;
OPEN v_cursor FOR
   V_SELECT ;
  -- SELECT 1 FROM DUAL;
    io_cursor := v_cursor;
END   PRC_ATE_REL_PROCED_SETOR;
