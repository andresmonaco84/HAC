CREATE OR REPLACE PROCEDURE "PRC_COB_REL_03_MOV_FAT_GUIA"
  (
    pCAD_UNI_ID_UNIDADE  IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
    pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_INI    IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_EMISSAO_FIM    IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_EMISSAO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_INI IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_VENCIMENTO_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_INI      IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_PAGTO_FIM      IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pDATA_CONTAB_INI     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pDATA_CONTAB_FIM     IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_LIBERACAO_CONTAB%TYPE DEFAULT NULL,
    pDATA_MOVIMENTO_FIM  IN TB_COB_MGC_MOV_GUIA_COBRANCA.COB_MGC_DT_MOVIMENTO%TYPE DEFAULT NULL,
    pCAD_BAN_ID          IN TB_CAD_BAN_BANCO.CAD_BAN_ID%TYPE DEFAULT NULL,
    pASS_BCT_ID          IN TB_COB_MGC_MOV_GUIA_COBRANCA.ASS_BCT_ID%TYPE DEFAULT NULL,
    pPENDETE_CONTABILIDADE   VARCHAR2 DEFAULT NULL,
    pENVIADO_CONTABILIDADE   VARCHAR2 DEFAULT NULL,
    pAMBULATORIO             VARCHAR2 DEFAULT NULL,
    pINTERNADO               VARCHAR2 DEFAULT NULL,
    pCOM_PAGAMENTO           VARCHAR2 DEFAULT NULL,
    pSEM_PAGAMENTO           VARCHAR2 DEFAULT NULL,
    pATD_ATE_TP_PACIENTE_A   VARCHAR2 DEFAULT NULL,
    pATD_ATE_TP_PACIENTE_I   VARCHAR2 DEFAULT NULL,
    PDESCONSIDERAR_QUITADOS  VARCHAR2 DEFAULT NULL,
    PDESCONSIDERAR_QUITADOS_VALOR VARCHAR2 DEFAULT NULL,
    pFAT_NOF_NR_NOTAFISCAL   IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_NR_NOTAFISCAL%TYPE DEFAULT NULL,
    pFAT_NOF_TP_SERIEFISCAL  IN TB_FAT_NOF_NOTA_FISCAL.FAT_NOF_TP_SERIEFISCAL%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_ACS   IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_FU    IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_PA    IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_SP    IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pCAD_TPE_CD_CODIGO_NP    IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
    pTABELAS_HISTORICO       VARCHAR2 DEFAULT NULL,
    pNOTAS_QUITADAS          VARCHAR2 DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
    -- ,TESTE OUT LONG
  )
  is
  /********************************************************************
  *    Procedure: PRC_COB_REL_03_MOV_FAT_GUIA
  *
  *    Data Criac?o: 26/11/2013  Por: PEDRO
  *    Alteracao:
  *
  *    UTILIZADO NOS RELATORIOS   03  04
  *******************************************************************/
v_cursor PKG_CURSOR.t_cursor;
  V_WHERE_NOTA  varchar2(6000);
  V_WHERE_MGC  varchar2(6000);
  V_WHERE_QUITADAS  varchar2(6000);
  V_SELECT  varchar2(30000);
  V_SELECT2  varchar2(30000);
  V_TABELA_MGC  varchar2(300);
  V_TABELA_CCP  varchar2(300);
  V_HAVING varchar2(8000);
begin
  V_WHERE_NOTA := NULL;
IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN V_WHERE_NOTA:= V_WHERE_NOTA || ' AND NOF.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE; END IF;
IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN V_WHERE_NOTA := V_WHERE_NOTA || ' AND NOF.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO;    END IF;
IF pFAT_NOF_NR_NOTAFISCAL IS NOT NULL THEN V_WHERE_NOTA := V_WHERE_NOTA || ' AND NOF.FAT_NOF_NR_NOTAFISCAL = ' ||CHR(39)|| pFAT_NOF_NR_NOTAFISCAL ||CHR(39);    END IF;
IF pFAT_NOF_TP_SERIEFISCAL IS NOT NULL THEN V_WHERE_NOTA := V_WHERE_NOTA || ' AND NOF.FAT_NOF_TP_SERIEFISCAL = ' ||CHR(39)|| pFAT_NOF_TP_SERIEFISCAL ||CHR(39);    END IF;
IF pDATA_EMISSAO_INI IS NOT NULL THEN V_WHERE_NOTA := V_WHERE_NOTA || ' AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) >= ' ||CHR(39)|| pDATA_EMISSAO_INI ||CHR(39);    END IF;
IF pDATA_EMISSAO_FIM IS NOT NULL THEN V_WHERE_NOTA := V_WHERE_NOTA || ' AND TRUNC(NOF.FAT_NFO_DT_EMISSAO) <= ' ||CHR(39)|| pDATA_EMISSAO_FIM ||CHR(39);    END IF;
IF pDATA_VENCIMENTO_INI IS NOT NULL THEN V_WHERE_NOTA := V_WHERE_NOTA || ' AND TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) >= ' ||CHR(39)|| pDATA_VENCIMENTO_INI ||CHR(39);    END IF;
IF pDATA_VENCIMENTO_FIM IS NOT NULL THEN V_WHERE_NOTA := V_WHERE_NOTA || ' AND TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) <= ' ||CHR(39)|| pDATA_VENCIMENTO_FIM ||CHR(39);    END IF;
V_WHERE_MGC := NULL;
IF pDATA_CONTAB_INI IS NOT NULL THEN V_WHERE_MGC := V_WHERE_MGC || ' AND MGC.COB_MGC_DT_LIBERACAO_CONTAB >= ' ||CHR(39)|| pDATA_CONTAB_INI ||CHR(39);    END IF;
IF pDATA_CONTAB_FIM IS NOT NULL THEN V_WHERE_MGC := V_WHERE_MGC || ' AND MGC.COB_MGC_DT_LIBERACAO_CONTAB <= ' ||CHR(39)|| pDATA_CONTAB_FIM ||CHR(39);    END IF;
IF pDATA_PAGTO_INI IS NOT NULL THEN V_WHERE_MGC := V_WHERE_MGC || ' AND MGC.COB_MGC_DT_MOVIMENTO >= ' ||CHR(39)|| pDATA_PAGTO_INI ||CHR(39);    END IF;
IF pDATA_PAGTO_FIM IS NOT NULL THEN V_WHERE_MGC := V_WHERE_MGC || ' AND MGC.COB_MGC_DT_MOVIMENTO <= ' ||CHR(39)|| pDATA_PAGTO_FIM ||CHR(39);    END IF;
IF pASS_BCT_ID IS NOT NULL THEN V_WHERE_MGC:= V_WHERE_MGC || ' AND MGC.ASS_BCT_ID = ' || pASS_BCT_ID; END IF;
V_TABELA_MGC:=NULL;
IF pTABELAS_HISTORICO IS NULL THEN V_TABELA_MGC:= ' TB_COB_MGC_MOV_GUIA_COBRANCA MGC '; ELSE V_TABELA_MGC:=' TB_COB_MGC_COBRANCA_HISTORICO MGC '; END IF;
V_TABELA_CCP:=NULL;
IF pTABELAS_HISTORICO IS NULL THEN V_TABELA_CCP:= ' TB_COB_CCP_CONTA_CONS_PARC CCP '; ELSE  V_TABELA_CCP:=' TB_COB_CCP_CONTA_HISTORICO CCP '; END IF;
V_WHERE_QUITADAS:=NULL;
IF pNOTAS_QUITADAS IS NOT NULL THEN V_WHERE_QUITADAS:= V_WHERE_QUITADAS || ' AND (PAGTO_FORA_DO_PERIODO.PAGTO_FORA_DO_PERIODO IS NULL) '; END IF;
IF pNOTAS_QUITADAS IS NOT NULL THEN V_WHERE_QUITADAS:= V_WHERE_QUITADAS || ' AND (EXISTE_GUIA_MENOR_OU_MAIOR.EXISTE_GUIA_MENOR_OU_MAIOR IS NULL) '; END IF;
V_HAVING:=NULL;
IF pNOTAS_QUITADAS IS NULL THEN V_HAVING:=
  /*(( '||chr(39)||PDESCONSIDERAR_QUITADOS ||chr(39)||' IS NOT NULL AND (SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0) + NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
       NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)) + TO_Number('||chr(39)|| PDESCONSIDERAR_QUITADOS_VALOR ||chr(39)||','||chr(39)||'999999.99'||chr(39)||')) < CCP.COB_CCP_VL_TOT_CONTA) OR '||chr(39)|| PDESCONSIDERAR_QUITADOS ||chr(39)||' IS NULL)
       AND */
  'HAVING (( '||chr(39)||pCOM_PAGAMENTO ||chr(39)||' IS NOT NULL AND SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0) + NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
               NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)) != 0) OR
           ( '||chr(39)||pSEM_PAGAMENTO ||chr(39)||' IS NOT NULL AND SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0) + NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
           NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)) = 0))';
ELSE 
  V_HAVING:=
 'HAVING   (ABS(NVL(CCP.COB_CCP_VL_TOT_CONTA,0) - NVL(((SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0))  + SUM(NVL(MGC.COB_MGC_VL_ISS,0))  +
                 SUM(NVL(MGC.COB_MGC_VL_IR,0))  + SUM(NVL(MGC.COB_MGC_VL_CSLL,0))  +
                 SUM(NVL(MGC.COB_MGC_VL_PIS,0))  + SUM(NVL(MGC.COB_MGC_VL_COFINS,0))
                 )),0)) = 0 --BETWEEN 0.0001 AND 0.05
                 AND 
                 NVL(ABS(NVL(CCP.VALOR_LIQUIDO_PARCELA,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0)),0)),0) = 0 --BETWEEN 0.0001 AND 0.05
                 AND 
                 NVL(ABS(NVL(CCP.COB_CCP_VL_ISS_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_ISS,0)),0)),0) = 0 --BETWEEN 0.000 AND 0.05
                 AND 
                 NVL(ABS(NVL(CCP.COB_CCP_VL_IR_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_IR,0)),0)),0) = 0 --BETWEEN 0.000 AND 0.05
                 AND 
                 NVL(ABS(NVL(CCP.COB_CCP_VL_CSLL_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_CSLL,0)),0)),0) = 0 --BETWEEN 0.000 AND 0.05
                 AND 
                 NVL(ABS(NVL(CCP.COB_CCP_VL_PIS_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_PIS,0)),0)),0) = 0 --BETWEEN 0.000 AND 0.05
                 AND 
                 NVL(ABS(NVL(CCP.COB_CCP_VL_COFINS_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_COFINS,0)),0)),0) = 0 --BETWEEN 0.000 AND 0.05
                 )';
    
--- TESTANDO BETWEEN 0.0000 ATE 0.0049

--TELA DE HISTORICO 

 END IF;
-------------------------------------------------------------------------------------------------------------------------------------------  
V_SELECT:=
'
SELECT CNV.CAD_CNV_CD_HAC_PRESTADOR,
       CNV.CAD_CNV_NM_FANTASIA,
       UNI.CAD_UNI_DS_UNIDADE,
       UNI.CAD_UNI_DS_RESUMIDA,
       TRUNC(NOF.FAT_NFO_DT_EMISSAO) FAT_NFO_DT_EMISSAO,
       TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) FAT_NFO_DT_VENCIMENTO,
       NOF.FAT_NOF_ID,
       NOF.FAT_NOF_NR_NOTAFISCAL,
       NOF.FAT_NOF_TP_SERIEFISCAL,
       NOF.FAT_NFO_VL_FATURADO,
       NOF.FAT_NOF_VL_ISS,
       NOF.FAT_NOF_VL_IR,
       NOF.FAT_NOF_VL_CSLL,
       NOF.FAT_NOF_VL_PIS,
       NOF.FAT_NOF_VL_COFINS,
       NOF.FAT_NOF_VL_DESCONTO,
       NOF.FAT_NFO_VL_RETENCAO,
       NOF.FAT_NFO_VL_LIQUIDO,
       NVL(CCP.COB_CCP_VL_ISS_FATURADO,0) COB_CCP_VL_ISS_FATURADO,
       NVL(CCP.COB_CCP_VL_IR_FATURADO,0) COB_CCP_VL_IR_FATURADO,
       NVL(CCP.COB_CCP_VL_CSLL_FATURADO,0) COB_CCP_VL_CSLL_FATURADO,
       NVL(CCP.COB_CCP_VL_PIS_FATURADO,0) COB_CCP_VL_PIS_FATURADO,
       NVL(CCP.COB_CCP_VL_COFINS_FATURADO,0) COB_CCP_VL_COFINS_FATURADO,
       NVL(CCP.COB_CCP_VL_TOT_CONTA,0) COB_CCP_VL_TOT_CONTA,
       NVL(CCP.VALOR_LIQUIDO_PARCELA,0) VALOR_LIQUIDO_PARCELA,
       SUM( NVL(MGC.COB_MGC_VL_ISS,0))  COB_MGC_VL_ISS,
       SUM( NVL(MGC.COB_MGC_VL_IR,0))  COB_MGC_VL_IR,
       SUM( NVL(MGC.COB_MGC_VL_CSLL,0))  COB_MGC_VL_CSLL,
       SUM( NVL(MGC.COB_MGC_VL_PIS,0))  COB_MGC_VL_PIS,
       SUM( NVL(MGC.COB_MGC_VL_COFINS,0))  COB_MGC_VL_COFINS,
       SUM(DECODE(MGC.CAD_TMC_ID,2,NVL(MGC.COB_MGC_VL_MOVIMENTO,0),0)) GLOSA,
       SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0))  COB_MGC_VL_MOVIMENTO,
       SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0))  +
       SUM(NVL(MGC.COB_MGC_VL_ISS,0))  +
       SUM(NVL(MGC.COB_MGC_VL_IR,0))  +
       SUM(NVL(MGC.COB_MGC_VL_CSLL,0))  +
       SUM(NVL(MGC.COB_MGC_VL_PIS,0))  +
       SUM(NVL(MGC.COB_MGC_VL_COFINS,0))  VALOR_DIGITADO, --vl calculado na tela
       SUM(NVL(MGC.COB_MGC_VL_ISS,0))  +
       SUM(NVL(MGC.COB_MGC_VL_IR,0))  +
       SUM(NVL(MGC.COB_MGC_VL_CSLL,0))  +
       SUM(NVL(MGC.COB_MGC_VL_PIS,0))  +
       SUM(NVL(MGC.COB_MGC_VL_COFINS,0)) TOTAL_RETENCOES,
       ABS(NVL(CCP.COB_CCP_VL_TOT_CONTA,0) - NVL(((SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0))  + SUM(NVL(MGC.COB_MGC_VL_ISS,0))  +
                 SUM(NVL(MGC.COB_MGC_VL_IR,0))  + SUM(NVL(MGC.COB_MGC_VL_CSLL,0))  +
                 SUM(NVL(MGC.COB_MGC_VL_PIS,0))  + SUM(NVL(MGC.COB_MGC_VL_COFINS,0))
                 )),0)) SALDO_SERVICO,
       NVL(ABS(NVL(CCP.VALOR_LIQUIDO_PARCELA,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0)),0)),0) SALDO_LIQUIDO,
       NVL(ABS(NVL(CCP.COB_CCP_VL_ISS_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_ISS,0)),0)),0) SALDO_ISS,
       NVL(ABS(NVL(CCP.COB_CCP_VL_IR_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_IR,0)),0)),0) SALDO_IR,
       NVL(ABS(NVL(CCP.COB_CCP_VL_CSLL_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_CSLL,0)),0)),0) SALDO_CSLL,        
       NVL(ABS(NVL(CCP.COB_CCP_VL_PIS_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_PIS,0)),0)),0) SALDO_PIS, 
       NVL(ABS(NVL(CCP.COB_CCP_VL_COFINS_FATURADO,0) - NVL(SUM(NVL(MGC.COB_MGC_VL_COFINS,0)),0)),0) SALDO_COFINS,    
       NVL(ANTECIPACAO.ISS,0) ANTECIPACAO_ISS,
       NVL(ANTECIPACAO.OP,0)  ANTECIPACAO_OP,  
       FNC_COB_PERIODO_VENCIMENTO(NOF.FAT_NFO_DT_VENCIMENTO, ' ||chr(39)|| pDATA_CONTAB_FIM ||chr(39)|| ','||chr(39)||'0'||chr(39)||') ORDEM,
       FNC_COB_PERIODO_VENCIMENTO(NOF.FAT_NFO_DT_VENCIMENTO, ' ||chr(39)|| pDATA_CONTAB_FIM ||chr(39)|| ','||chr(39)||'1'||chr(39)||') PERIODO
FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
JOIN      (SELECT
                 SUM( NVL(CCP.COB_CCP_VL_ISS_FATURADO,0))  COB_CCP_VL_ISS_FATURADO,
                 SUM( NVL(CCP.COB_CCP_VL_IR_FATURADO,0))  COB_CCP_VL_IR_FATURADO,
                 SUM( NVL(CCP.COB_CCP_VL_CSLL_FATURADO,0))  COB_CCP_VL_CSLL_FATURADO,
                 SUM( NVL(CCP.COB_CCP_VL_PIS_FATURADO,0))  COB_CCP_VL_PIS_FATURADO,
                 SUM( NVL(CCP.COB_CCP_VL_COFINS_FATURADO,0))  COB_CCP_VL_COFINS_FATURADO,
                 SUM( NVL(CCP.COB_CCP_VL_TOT_CONTA,0))  COB_CCP_VL_TOT_CONTA,
                 SUM( NVL(CCP.COB_CCP_VL_TOT_CONTA,0))  - SUM( NVL(CCP.COB_CCP_VL_ISS_FATURADO,0))
                 - SUM( NVL(CCP.COB_CCP_VL_IR_FATURADO,0))  - SUM( NVL(CCP.COB_CCP_VL_CSLL_FATURADO,0))  -
                 SUM( NVL(CCP.COB_CCP_VL_PIS_FATURADO,0))  -
                 SUM( NVL(CCP.COB_CCP_VL_COFINS_FATURADO,0))    VALOR_LIQUIDO_PARCELA,
                 CCP.FAT_NOF_ID
           FROM ' || V_TABELA_CCP  ||'
           JOIN TB_FAT_NOF_NOTA_FISCAL NOF ON NOF.FAT_NOF_ID = CCP.FAT_NOF_ID
           WHERE  1 = 1
            ' || V_WHERE_NOTA || '
           /* AND (( '||chr(39)||pAMBULATORIO ||chr(39)||' IS NOT NULL AND CCP.CAD_LAT_ID_LOCAL_ATENDIMENTO != 29) OR
      ( '||chr(39)||pINTERNADO ||chr(39)||' IS NOT NULL AND CCP.CAD_LAT_ID_LOCAL_ATENDIMENTO = 29))*/
           GROUP BY CCP.FAT_NOF_ID
           ) CCP ON  CCP.FAT_NOF_ID          = NOF.FAT_NOF_ID
JOIN      TB_CAD_CNV_CONVENIO          CNV  ON  CNV.CAD_CNV_ID_CONVENIO = NOF.CAD_CNV_ID_CONVENIO
JOIN      TB_CAD_UNI_UNIDADE           UNI  ON  UNI.CAD_UNI_ID_UNIDADE = NOF.CAD_UNI_ID_UNIDADE
LEFT JOIN ' || V_TABELA_MGC  ||'
                                            ON  MGC.FAT_NOF_ID          = NOF.FAT_NOF_ID
                                           AND  MGC.CAD_TMC_ID          NOT IN (7,8)
                                           ' || V_WHERE_MGC || '
LEFT JOIN TB_CAD_TMC_TIPO_MOV_COBRANCA TMC  ON  TMC.CAD_TMC_ID          = MGC.CAD_TMC_ID
LEFT JOIN TB_ASS_BCT_BANCO_CONTA       BCT  ON  BCT.ASS_BCT_ID          = MGC.ASS_BCT_ID
                                            AND ('||chr(39)|| pCAD_BAN_ID ||chr(39)||' is null or BCT.CAD_BAN_ID = '||chr(39)|| pCAD_BAN_ID ||chr(39)||')
LEFT JOIN (SELECT FAT_NOF_ID, SUM(ISS) ISS, SUM(OP) OP 
            FROM 
           (SELECT MGC.FAT_NOF_ID, SUM(NVL(MGC.COB_MGC_VL_ISS,0))  ISS,
                  SUM(NVL(MGC.COB_MGC_VL_IR,0)) + SUM(NVL(MGC.COB_MGC_VL_CSLL,0)) + SUM(NVL(MGC.COB_MGC_VL_PIS,0)) + SUM(NVL(MGC.COB_MGC_VL_COFINS,0)) OP
             FROM TB_FAT_NOF_NOTA_FISCAL       NOF
             JOIN TB_COB_MGC_MOV_GUIA_COBRANCA MGC ON MGC.FAT_NOF_ID = NOF.FAT_NOF_ID
            WHERE MGC.CAD_TMC_ID = 8  
           ' || V_WHERE_NOTA || ' ' || V_WHERE_MGC || '
            GROUP BY MGC.FAT_NOF_ID
         UNION ALL  
            SELECT MGC.FAT_NOF_ID, SUM(NVL(MGC.COB_MGC_VL_ISS,0))*-1  ISS,
                  (SUM(NVL(MGC.COB_MGC_VL_IR,0)) + SUM(NVL(MGC.COB_MGC_VL_CSLL,0)) + SUM(NVL(MGC.COB_MGC_VL_PIS,0)) + SUM(NVL(MGC.COB_MGC_VL_COFINS,0)))*-1 OP
             FROM TB_FAT_NOF_NOTA_FISCAL       NOF
             JOIN TB_COB_MGC_MOV_GUIA_COBRANCA MGC ON MGC.FAT_NOF_ID = NOF.FAT_NOF_ID
            WHERE MGC.CAD_TMC_ID = 9  
           ' || V_WHERE_NOTA || ' ' || V_WHERE_MGC || '
            GROUP BY MGC.FAT_NOF_ID
            )
            GROUP BY FAT_NOF_ID
          ) ANTECIPACAO ON ANTECIPACAO.FAT_NOF_ID = NOF.FAT_NOF_ID ' ;

IF (pNOTAS_QUITADAS IS NOT NULL) THEN --TELA DE HISTORICO       
V_SELECT2 := 
V_SELECT2 || 'LEFT JOIN (SELECT 1 PAGTO_FORA_DO_PERIODO,NOF.FAT_NOF_ID FROM TB_FAT_NOF_NOTA_FISCAL       NOF
             JOIN TB_COB_MGC_MOV_GUIA_COBRANCA MGC ON MGC.FAT_NOF_ID = NOF.FAT_NOF_ID
            WHERE MGC.COB_MGC_DT_LIBERACAO_CONTAB IS NULL
               OR MGC.COB_MGC_DT_LIBERACAO_CONTAB > ' ||CHR(39)|| pDATA_CONTAB_FIM ||CHR(39)||'
               OR MGC.COB_MGC_DT_LIBERACAO_CONTAB < ' ||CHR(39)|| pDATA_CONTAB_INI ||CHR(39)||'
               ' || V_WHERE_NOTA || '
               GROUP BY NOF.FAT_NOF_ID
           ) PAGTO_FORA_DO_PERIODO ON PAGTO_FORA_DO_PERIODO.FAT_NOF_ID = NOF.FAT_NOF_ID

LEFT  JOIN (SELECT DISTINCT AAA.EXISTE_GUIA_MENOR_OU_MAIOR,AAA.FAT_NOF_ID FROM
           (SELECT DISTINCT 1 EXISTE_GUIA_MENOR_OU_MAIOR,
                CCP.FAT_NOF_ID,CCP.ATD_ATE_ID,CCP.CAD_PAC_ID_PACIENTE,CCP.COB_COC_ID,CCP.COB_CCP_ID,CCP.ATD_GUI_CD_CODIGO,CCP.ATD_GUI_DT_VALIDADE,
               SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0) + NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
                NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)), CCP.COB_CCP_VL_TOT_CONTA
             FROM      TB_FAT_NOF_NOTA_FISCAL       NOF
             JOIN      TB_COB_CCP_CONTA_CONS_PARC   CCP ON  CCP.FAT_NOF_ID          = NOF.FAT_NOF_ID
             LEFT JOIN TB_COB_MGC_MOV_GUIA_COBRANCA MGC ON  MGC.FAT_NOF_ID          = CCP.FAT_NOF_ID
                                                       AND  MGC.ATD_ATE_ID          = CCP.ATD_ATE_ID
                                                       AND  MGC.CAD_PAC_ID_PACIENTE = CCP.CAD_PAC_ID_PACIENTE
                                                       AND  MGC.COB_COC_ID          = CCP.COB_COC_ID
                                                       AND  MGC.COB_CCP_ID          = CCP.COB_CCP_ID
                                                       AND  MGC.ATD_GUI_CD_CODIGO   = CCP.ATD_GUI_CD_CODIGO
                                                       AND  MGC.ATD_GUI_DT_VALIDADE = CCP.ATD_GUI_DT_VALIDADE
            WHERE 1=1  ' || V_WHERE_NOTA || '
              GROUP BY
                CCP.FAT_NOF_ID,CCP.ATD_ATE_ID,CCP.CAD_PAC_ID_PACIENTE,CCP.COB_COC_ID,CCP.COB_CCP_ID,CCP.ATD_GUI_CD_CODIGO,CCP.ATD_GUI_DT_VALIDADE
                ,CCP.COB_CCP_VL_TOT_CONTA
            HAVING  ABS(SUM(NVL(MGC.COB_MGC_VL_MOVIMENTO,0) + NVL(MGC.COB_MGC_VL_ISS,0) + NVL(MGC.COB_MGC_VL_IR,0) + NVL(MGC.COB_MGC_VL_CSLL,0) +
                NVL(MGC.COB_MGC_VL_PIS,0) + NVL(MGC.COB_MGC_VL_COFINS,0)) - CCP.COB_CCP_VL_TOT_CONTA) > 0.01
                ) AAA
            ) EXISTE_GUIA_MENOR_OU_MAIOR ON  EXISTE_GUIA_MENOR_OU_MAIOR.FAT_NOF_ID          = NOF.FAT_NOF_ID ';
END IF;            
V_SELECT2 := 
V_SELECT2 ||         
' WHERE 1 = 1
 ' || V_WHERE_NOTA || '
 ' || V_WHERE_QUITADAS || '
  AND    CNV.CAD_CNV_CD_OPCAO_PAGTO = 1
GROUP BY
       CNV.CAD_CNV_CD_HAC_PRESTADOR,
       CNV.CAD_CNV_NM_FANTASIA,
       UNI.CAD_UNI_DS_UNIDADE,
       UNI.CAD_UNI_DS_RESUMIDA,
       TRUNC(NOF.FAT_NFO_DT_EMISSAO) ,
       TRUNC(NOF.FAT_NFO_DT_VENCIMENTO) ,
       NOF.FAT_NOF_ID,
       NOF.FAT_NOF_NR_NOTAFISCAL,
       NOF.FAT_NOF_TP_SERIEFISCAL,
       NOF.FAT_NFO_VL_FATURADO,
       NOF.FAT_NOF_VL_ISS,
       NOF.FAT_NOF_VL_IR,
       NOF.FAT_NOF_VL_CSLL,
       NOF.FAT_NOF_VL_PIS,
       NOF.FAT_NOF_VL_COFINS,
       NOF.FAT_NOF_VL_DESCONTO,
       NOF.FAT_NFO_VL_RETENCAO,
       NOF.FAT_NFO_VL_LIQUIDO ,
       NVL(CCP.COB_CCP_VL_ISS_FATURADO,0),
       NVL(CCP.COB_CCP_VL_IR_FATURADO,0),
       NVL(CCP.COB_CCP_VL_CSLL_FATURADO,0),
       NVL(CCP.COB_CCP_VL_PIS_FATURADO,0),
       NVL(CCP.COB_CCP_VL_COFINS_FATURADO,0),
       NVL(CCP.COB_CCP_VL_TOT_CONTA,0),
       NVL(CCP.VALOR_LIQUIDO_PARCELA,0),
       NVL(ANTECIPACAO.ISS,0),
       NVL(ANTECIPACAO.OP,0),
       FNC_COB_PERIODO_VENCIMENTO(NOF.FAT_NFO_DT_VENCIMENTO, ' ||chr(39)|| pDATA_CONTAB_FIM ||chr(39)|| ','||chr(39)||'0'||chr(39)||') ,
       FNC_COB_PERIODO_VENCIMENTO(NOF.FAT_NFO_DT_VENCIMENTO, ' ||chr(39)|| pDATA_CONTAB_FIM ||chr(39)|| ','||chr(39)||'1'||chr(39)||')
       --, PAGTO_FORA_DO_PERIODO.PAGTO_FORA_DO_PERIODO
' || V_HAVING || '' ;
/*ORDER BY 1,--CNV.CAD_CNV_CD_HAC_PRESTADOR,
         4,--NOF.FAT_NFO_DT_VENCIMENTO,
         6,--NOF.FAT_NOF_NR_NOTAFISCAL,
         7--NOF.FAT_NOF_TP_SERIEFISCAL */
  --  TESTE :=  V_SELECT || V_SELECT2;
  -- dbms_output.put_line(V_SELECT || V_SELECT2);
  OPEN v_cursor FOR
  -- SELECT 1 FROM DUAL;
   V_SELECT || V_SELECT2;
    io_cursor := v_cursor;
  end PRC_COB_REL_03_MOV_FAT_GUIA;
 
