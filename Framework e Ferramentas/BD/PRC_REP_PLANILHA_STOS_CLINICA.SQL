CREATE OR REPLACE PROCEDURE PRC_REP_PLANILHA_STOS_CLINICA
  (
     pAGE_ESM_DT_INI_ESCALA IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_DT_INI_ESCALA%TYPE DEFAULT NULL,
     pAGE_ESM_DT_FIM_ESCALA IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_DT_FIM_ESCALA%TYPE DEFAULT NULL,
     IO_CURSOR OUT PKG_CURSOR.T_CURSOR
  )
is
  /********************************************************************
  *    Procedure:     PRC_REP_PLANILHA_STOS_CLINICA
  *
  *    Data Criacao:  17/04/2015                       Por: Fab?ola Lopes
  *    Funcao:
  *
  *********************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
 
BEGIN
 OPEN v_cursor FOR
       SELECT RESULTADO.CAD_UNI_DS_UNIDADE UNIDADE,
       RESULTADO.CAD_LAT_DS_LOCAL_ATENDIMENTO LOCAL,
       TRIM(RESULTADO.TIS_CPR_CD_CONSELHOPROF) CONSELHO,
       TO_NUMBER(RESULTADO.CAD_PRO_NR_CONSELHO) NROCONS,
       RESULTADO.CAD_PES_NM_PESSOA NOMPROF,
       RESULTADO.TIS_CBO_CD_CBOS_HAC CODESP,
       RESULTADO.TIS_CBO_DS_CBOS_HAC DESESP,
       RESULTADO.HORAS_DISPONIVEIS HORAS_DISPONIVEIS,
       NVL(HORAS_FALTA, 0) HORAS_FALTA,
       RESULTADO.HORAS_DISPONIVEIS - NVL(HORAS_FALTA, 0) HORAS_CONTRATADAS

  FROM (SELECT CBOS.TIS_CBO_CD_CBOS_HAC,
               CBOS.TIS_CBO_DS_CBOS_HAC,
               TMP.TIS_CBO_CD_CBOS,
               TMP.CAD_UNI_DS_UNIDADE,
               TMP.CAD_UNI_ID_UNIDADE,
               TMP.CAD_LAT_ID_LOCAL_ATENDIMENTO,
               TMP.CAD_LAT_DS_LOCAL_ATENDIMENTO,
               TMP.CAD_PRO_ID_PROFISSIONAL,
               ROUND(SUM(HOAS_DISPONIVEIS)) HORAS_DISPONIVEIS,
               PRO.CAD_PRO_NR_CONSELHO,
               PES.CAD_PES_NM_PESSOA,
               SUM(TOTAL_RETORNO) TOTAL_RETORNO,
               SUM(TOTAL_NORMAL) TOTAL_NORMAL,
               SUM(TOTAL_ENCAIXE_ESPECIAL) TOTAL_ENCAIXE_ESPECIAL,
               SUM(TOTAL_SERVICO_PRESTADO) TOTAL_SERVICO_PRESTADO,
               SUM(TOTAL_ENCAIXE) TOTAL_ENCAIXE,
               ROUND(SUM(HORAS_TRABALHADAS)) HORAS_TRABALHADAS,
               ROUND(SUM(HORAS_FALTA)) HORAS_FALTA,
               ROUND(SUM(HORAS_FALTA_PAC)) TOTAL_FALTA_PAC,
               SUM(CAPACIDADE) CAPACIDADE,
               SUM(CAPACIDADE_RETORNO) CAPACIDADE_RETORNO,
               PRO.TIS_CPR_CD_CONSELHOPROF

          FROM (SELECT ESM.CAD_UNI_ID_UNIDADE,
                       UNI.CAD_UNI_DS_UNIDADE,
                       ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
                       LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
                       ESM.CAD_PRO_ID_PROFISSIONAL,
                       ESM.TIS_CBO_CD_CBOS,
                       (SGS.FNC_AGE_ESM_DIAS_DISPONIVEIS(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA) * (ESM.AGE_ESM_HR_FIM_ESCALA - ESM.AGE_ESM_HR_INI_ESCALA)) / 100 HOAS_DISPONIVEIS, (SGS.FNC_AGE_ESM_TIPO_RETORNO(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_RETORNO,
                       (SGS.FNC_AGE_ESM_TIPO_NORMAL(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_NORMAL, (SGS.FNC_AGE_ESM_TIPO_EE(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_ENCAIXE_ESPECIAL,
                       (SGS.FNC_AGE_ESM_TIPO_SP(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_SERVICO_PRESTADO, (SGS.FNC_AGE_ESM_TIPO_ENCAIXE(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_ENCAIXE,
                       (SGS.FNC_AGE_ESM_DIAS_ATENDIDOS(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA) * (ESM.AGE_ESM_HR_FIM_ESCALA - ESM.AGE_ESM_HR_INI_ESCALA)) / 100 HORAS_TRABALHADAS,
                       (SGS.FNC_AGE_ESM_TOTAL_FALTAS(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA) * (ESM.AGE_ESM_HR_FIM_ESCALA - ESM.AGE_ESM_HR_INI_ESCALA)) / 100 HORAS_FALTA,
                       (SGS.FNC_AGE_ESM_TOTAL_FALTA_PAC(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) HORAS_FALTA_PAC,
                       (SGS.FNC_AGE_ESM_CAPAC_NORMAL_SP(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) CAPACIDADE,
                       (SGS.FNC_AGE_ESM_CAPAC_RETORNO(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) CAPACIDADE_RETORNO
                  FROM SGS.TB_AGE_ESM_ESCALA_MEDICA ESM,
                       TB_CAD_PRO_PROFISSIONAL      PRO,
                       TB_CAD_UNI_UNIDADE           UNI,
                       TB_CAD_LAT_LOCAL_ATENDIMENTO LAT
                 WHERE ESM.AGE_ESM_FL_SITUACAO IN ('A')
                   AND ESM.AGE_ESM_FL_AGENDAGERADA_OK = 'S'
                   AND ESM.AGE_ESM_DT_INI_ESCALA <= pAGE_ESM_DT_FIM_ESCALA
                   AND ESM.CAD_PRO_ID_PROFISSIONAL = PRO.CAD_PRO_ID_PROFISSIONAL
                   AND ESM.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
                   AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO
                   AND EXISTS
                 (SELECT CPR.CAD_PRO_ID_PROFISSIONAL
                          FROM TB_ASS_CPR_CLINICA_PROF        CPR,
                               TB_CAD_CLC_CLINICA_CREDENCIADA CLC,
                               TB_ASS_RPG_REGRA_PAGTO         RPG,
                               TB_CAD_REP_REGRA_PAGAMENTO     REP
                         WHERE CPR.CAD_CLC_ID = CLC.CAD_CLC_ID
                           AND CPR.CAD_PRO_ID_PROFISSIONAL = ESM.CAD_PRO_ID_PROFISSIONAL
                           AND CLC.CAD_CLC_CD_CLINICA = 45
                           AND CPR.ASS_CPR_DT_FIM_VIGENCIA IS NULL
                           AND RPG.CAD_REP_DT_FIM_VIGENCIA IS NULL
                           AND CPR.ASS_CPR_ID = RPG.ASS_CPR_ID
                           AND RPG.CAD_REP_ID = REP.CAD_REP_ID
                           AND REP.CAD_REP_TP_BASE_CALCULO = 'VLHORA'
                           AND CPR.CAD_UNI_ID_UNIDADE = ESM.CAD_UNI_ID_UNIDADE
                           AND CPR.CAD_LAT_ID_LOCAL_ATENDIMENTO = ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO)
                UNION ALL
                SELECT ESM.CAD_UNI_ID_UNIDADE,
                       UNI.CAD_UNI_DS_UNIDADE,
                       ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO,
                       LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
                       ESM.CAD_PRO_ID_PROFISSIONAL,
                       ESM.TIS_CBO_CD_CBOS,
                       (SGS.FNC_AGE_ESM_DIAS_DISPONIVEIS(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA) * (ESM.AGE_ESM_HR_FIM_ESCALA - ESM.AGE_ESM_HR_INI_ESCALA)) / 100 HOAS_DISPONIVEIS,
                       (SGS.FNC_AGE_ESM_TIPO_RETORNO(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_RETORNO,
                       (SGS.FNC_AGE_ESM_TIPO_NORMAL(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_NORMAL,
                       (SGS.FNC_AGE_ESM_TIPO_EE(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_ENCAIXE_ESPECIAL,
                       (SGS.FNC_AGE_ESM_TIPO_SP(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_SERVICO_PRESTADO,
                       (SGS.FNC_AGE_ESM_TIPO_ENCAIXE(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) TOTAL_ENCAIXE,
                       (SGS.FNC_AGE_ESM_DIAS_ATENDIDOS(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA) * (ESM.AGE_ESM_HR_FIM_ESCALA - ESM.AGE_ESM_HR_INI_ESCALA)) / 100 HORAS_TRABALHADAS,
                       (SGS.FNC_AGE_ESM_TOTAL_FALTAS(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA) * (ESM.AGE_ESM_HR_FIM_ESCALA - ESM.AGE_ESM_HR_INI_ESCALA)) / 100 HORAS_FALTA,
                       (SGS.FNC_AGE_ESM_TOTAL_FALTA_PAC(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) HORAS_FALTA_PAC,
                       (SGS.FNC_AGE_ESM_CAPAC_NORMAL_SP(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) CAPACIDADE,
                       (SGS.FNC_AGE_ESM_CAPAC_RETORNO(ESM.AGE_ESM_ID, pAGE_ESM_DT_INI_ESCALA, pAGE_ESM_DT_FIM_ESCALA)) CAPACIDADE_RETORNO
                  FROM SGS.TB_AGE_ESM_ESCALA_MEDICA ESM,
                       TB_CAD_PRO_PROFISSIONAL      PRO,
                       TB_CAD_UNI_UNIDADE           UNI,
                       TB_CAD_LAT_LOCAL_ATENDIMENTO LAT
                 WHERE ESM.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
                   AND ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO
                   AND ESM.AGE_ESM_FL_SITUACAO = 'I'
                   AND ESM.AGE_ESM_FL_AGENDAGERADA_OK = 'S'
                   AND ESM.AGE_ESM_DT_INI_ESCALA <= pAGE_ESM_DT_FIM_ESCALA
                   AND ESM.CAD_PRO_ID_PROFISSIONAL = PRO.CAD_PRO_ID_PROFISSIONAL
                   AND EXISTS
                 (SELECT CPR.CAD_PRO_ID_PROFISSIONAL
                          FROM TB_ASS_CPR_CLINICA_PROF        CPR,
                               TB_CAD_CLC_CLINICA_CREDENCIADA CLC,
                               TB_ASS_RPG_REGRA_PAGTO         RPG,
                               TB_CAD_REP_REGRA_PAGAMENTO     REP
                         WHERE CPR.CAD_CLC_ID = CLC.CAD_CLC_ID
                           AND CPR.CAD_PRO_ID_PROFISSIONAL = ESM.CAD_PRO_ID_PROFISSIONAL
                           AND CLC.CAD_CLC_CD_CLINICA = 45
                           AND CPR.ASS_CPR_DT_FIM_VIGENCIA IS NULL
                           AND RPG.CAD_REP_DT_FIM_VIGENCIA IS NULL
                           AND CPR.ASS_CPR_ID = RPG.ASS_CPR_ID
                           AND RPG.CAD_REP_ID = REP.CAD_REP_ID
                           AND REP.CAD_REP_TP_BASE_CALCULO = 'VLHORA'
                           AND CPR.CAD_UNI_ID_UNIDADE = ESM.CAD_UNI_ID_UNIDADE
                           AND CPR.CAD_LAT_ID_LOCAL_ATENDIMENTO = ESM.CAD_LAT_ID_LOCAL_ATENDIMENTO)) TMP
         INNER JOIN SGS.TB_CAD_PRO_PROFISSIONAL PRO
            ON PRO.CAD_PRO_ID_PROFISSIONAL = TMP.CAD_PRO_ID_PROFISSIONAL
         INNER JOIN SGS.TB_CAD_PES_PESSOA PES
            ON PES.CAD_PES_ID_PESSOA = PRO.CAD_PES_ID_PESSOA
         INNER JOIN SGS.TB_TIS_CBO_CBOS CBOS
            ON CBOS.TIS_CBO_CD_CBOS = TMP.TIS_CBO_CD_CBOS
         GROUP BY PRO.TIS_CPR_CD_CONSELHOPROF,
                  CBOS.TIS_CBO_CD_CBOS_HAC,
                  TMP.CAD_PRO_ID_PROFISSIONAL,
                  PRO.CAD_PRO_NR_CONSELHO,
                  PES.CAD_PES_NM_PESSOA,
                  TMP.CAD_UNI_ID_UNIDADE,
                  TMP.CAD_LAT_ID_LOCAL_ATENDIMENTO,
                  TMP.TIS_CBO_CD_CBOS,
                  TMP.CAD_PRO_ID_PROFISSIONAL,
                  TMP.CAD_UNI_DS_UNIDADE,
                  TMP.CAD_LAT_DS_LOCAL_ATENDIMENTO,
                  CBOS.TIS_CBO_DS_CBOS_HAC
         ORDER BY PES.CAD_PES_NM_PESSOA ) RESULTADO
 WHERE RESULTADO.HORAS_DISPONIVEIS - NVL(HORAS_FALTA, 0) > 0
 ORDER BY 1, 2, 4;
 IO_CURSOR := V_CURSOR;
END PRC_REP_PLANILHA_STOS_CLINICA;
/
