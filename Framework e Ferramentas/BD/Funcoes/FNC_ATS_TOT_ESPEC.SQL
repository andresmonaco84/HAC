create or replace function FNC_ATS_TOT_ESPEC(pAUX_EPP_CD_ESPECPROC         IN TB_ATS_ATE_ATENDIMENTO_SADT.AUX_EPP_CD_ESPECPROC%TYPE DEFAULT NULL,
                                             pDATA_INI                     IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_DT_REALIZ_PROCED%TYPE,
                                             pDATA_FIM                     IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_DT_REALIZ_PROCED%TYPE,
                                             pCAD_UNI_ID_UNIDADE           in TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%type DEFAULT NULL,
                                             pCAD_LAT_ID_LOCAL_ATENDIMENTO in TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%type default null,
                                             pCAD_SET_ID                   IN TB_ATS_ATE_ATENDIMENTO_SADT.CAD_SET_ID_ATEN%type DEFAULT NULL,
                                             pPERCENTUAL DECIMAL)
  return NUMBER is
  Result NUMBER;

BEGIN

  SELECT CASE
           WHEN COUNT(APL.ATS_APL_ID) > 0 THEN
            ceil((PPERCENTUAL * COUNT(APL.ATS_APL_ID)) / 100)
           ELSE
            0
         END
    INTO RESULT
    FROM TB_ATS_ATE_ATENDIMENTO_SADT ATS
    JOIN TB_ATS_APL_ATEN_PROCED_LAUDO APL
      ON APL.ATS_ATE_CD_INTLIB = ATS.ATS_ATE_CD_INTLIB
     AND APL.ATS_ATE_ID = ATS.ATS_ATE_ID
     AND APL.CAD_PRD_ID = ATS.CAD_PRD_ID
     AND APL.TIS_MED_CD_TABELAMEDICA = ATS.TIS_MED_CD_TABELAMEDICA
     AND APL.AUX_EPP_CD_ESPECPROC = ATS.AUX_EPP_CD_ESPECPROC
     AND APL.ATS_ATE_IN_INTLIB = ATS.ATS_ATE_IN_INTLIB
    JOIN TB_CAD_SET_SETOR SETOR_EXEC      ON SETOR_EXEC.CAD_SET_ID = ATS.CAD_SET_ID_ATEN
  
   WHERE (ATS.ATS_ATE_FL_STATUS <> 'C')
     AND (PAUX_EPP_CD_ESPECPROC IS NULL OR ATS.AUX_EPP_CD_ESPECPROC = PAUX_EPP_CD_ESPECPROC)
     AND (pCAD_UNI_ID_UNIDADE IS NULL OR SETOR_EXEC.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE)
     AND (pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR  SETOR_EXEC.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO)
     AND (pCAD_SET_ID IS NULL OR SETOR_EXEC.CAD_SET_ID = pCAD_SET_ID)

     AND ATS.ATS_ATE_DT_REALIZ_PROCED BETWEEN pDATA_INI AND pDATA_FIM
  
  ;
  return(RESULT);
end FNC_ATS_TOT_ESPEC;
