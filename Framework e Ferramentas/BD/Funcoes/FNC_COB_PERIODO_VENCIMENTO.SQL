CREATE OR REPLACE FUNCTION "FNC_COB_PERIODO_VENCIMENTO" (
 pDATA_VENCIMENTO  IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE,
 pDATA_CONTAB_FIM IN TB_FAT_NOF_NOTA_FISCAL.FAT_NFO_DT_VENCIMENTO%TYPE,
 pTIPO_RETORNO char
)
return varchar2 is Result varchar2(100);
--se n?o forcar a pDATA_CONTAB_FIM pode dar problema pois a data de vencimento as vezes ultrapassa sysdate
--exemplo emissao 31/12/2013 hoje=21/01/2014 vencto=28/02/2014
begin
if pTIPO_RETORNO = '0' then
SELECT CASE WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))                                                                                               THEN '1'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-30  AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))     THEN '2'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-60  AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-30  THEN '3'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-90  AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-60  THEN '4'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-120 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-90  THEN '5'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-150 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-120 THEN '6'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-180 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-150 THEN '7'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-359 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-180 THEN '8'
            WHEN pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-359                                                                                          THEN '9'
       END ORDEM INTO Result
       FROM DUAL;
else
SELECT CASE WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM)) THEN 'A VENCER'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-30  AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))     THEN 'VENCIDOS ATE 30 DIAS'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-60  AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-30  THEN 'VENCIDOS DE 31 A 60 DIAS'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-90  AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-60  THEN 'VENCIDOS DE 61 A 90 DIAS'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-120 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-90  THEN 'VENCIDOS DE 91 A 120 DIAS'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-150 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-120 THEN 'VENCIDOS DE 121 A 150 DIAS'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-180 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-150 THEN 'VENCIDOS DE 151 A 180 DIAS'
            WHEN pDATA_VENCIMENTO > TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-359 AND pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-180 THEN 'VENCIDOS DE 181 A 359 DIAS'
            WHEN pDATA_VENCIMENTO <= TRUNC(DECODE(pDATA_CONTAB_FIM,NULL,SYSDATE,pDATA_CONTAB_FIM))-359                                                                                          THEN 'VENCIDOS ACIMA DE 359 DIAS'
       END PERIODO INTO Result
       FROM DUAL;
END IF;
  return(Result);
end FNC_COB_PERIODO_VENCIMENTO;
 