create or replace function FNC_AGE_ATEND_STATUS
(
   pTIS_CBO_CD_CBOS IN TB_AGE_ESM_ESCALA_MEDICA.TIS_CBO_CD_CBOS%TYPE,
   pCAD_UNI_ID_UNIDADE in TB_AGE_ESM_ESCALA_MEDICA.CAD_UNI_ID_UNIDADE%TYPE,
    pCAD_LAT_ID_LOCAL_ATENDIMENTO in TB_AGE_ESM_ESCALA_MEDICA.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE,
     pCAD_PRO_ID_PROFISSIONAL in TB_AGE_ESM_ESCALA_MEDICA.CAD_PRO_ID_PROFISSIONAL%TYPE,
   pDATA_INI IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_DT_INI_ESCALA%TYPE,
   pDATA_FIM IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_DT_FIM_ESCALA%TYPE,
   pTIPOPLANO IN TB_CAD_CNV_CONVENIO.CAD_TPE_CD_CODIGO%TYPE DEFAULT NULL,
   pATD_ATE_FL_STATUS IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_STATUS%TYPE,
      pAGE_ESM_FL_AGEND_GRUPO    IN TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_FL_AGEND_GRUPO%TYPE DEFAULT NULL
)
return NUMBER is Result NUMBER;


BEGIN

    SELECT count(ATE.ATD_ATE_ID)into Result
     FROM TB_ATD_ATE_ATENDIMENTO ATE
    JOIN TB_ASS_PAT_PACIEATEND PAT ON PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
    JOIN TB_CAD_CNV_CONVENIO CNV ON CNV.CAD_CNV_ID_CONVENIO = PAT.CAD_CNV_ID_CONVENIO
    JOIN TB_CAD_PRO_PROFISSIONAL PRO ON PRO.CAD_PRO_ID_PROFISSIONAL = ATE.CAD_PRO_ID_PROF_EXEC
     where ATE.ATD_ATE_DT_ATENDIMENTO BETWEEN pDATA_INI AND pDATA_FIM
     AND ATE.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
     AND ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO
     AND ATE.CAD_PRO_ID_PROF_EXEC = pCAD_PRO_ID_PROFISSIONAL
     AND ATE.ATD_ATE_FL_STATUS = pATD_ATE_FL_STATUS
     AND ATE.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS

   AND ( (PRO.TIS_CPR_CD_CONSELHOPROF =  'CRM' AND ATE.TIS_TAT_CD_TPATENDIMENTO = 4 )
     OR (PRO.TIS_CPR_CD_CONSELHOPROF <> 'CRM'  AND ATE.TIS_TAT_CD_TPATENDIMENTO IN ( 3, 4) ))

     AND (pTIPOPLANO IS NULL OR CNV.CAD_TPE_CD_CODIGO = pTIPOPLANO)
   
     AND (
     ((pAGE_ESM_FL_AGEND_GRUPO IS NULL OR pAGE_ESM_FL_AGEND_GRUPO = 'N') AND  ATE.ATD_ATE_ID NOT IN (SELECT AGE.AGE_AGD_CD_INTAMB FROM TB_AGE_AGD_AGENDA AGE
                                JOIN TB_AGE_ESM_ESCALA_MEDICA ESM ON ESM.AGE_ESM_ID = AGE.AGE_ESM_ID
                                WHERE  AGE.AGE_AGD_DT_ATENDIMENTO BETWEEN pDATA_INI AND pDATA_FIM
                                AND ESM.CAD_PRO_ID_PROFISSIONAL =  pCAD_PRO_ID_PROFISSIONAL
                                AND ESM.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS
                                and (decode(esm.age_esm_fl_agend_grupo,null,'N',esm.age_esm_fl_agend_grupo) = 'S' )))
                                
     OR (pAGE_ESM_FL_AGEND_GRUPO = 'S' AND  ATE.ATD_ATE_ID IN (SELECT AGE.AGE_AGD_CD_INTAMB FROM TB_AGE_AGD_AGENDA AGE
                                JOIN TB_AGE_ESM_ESCALA_MEDICA ESM ON ESM.AGE_ESM_ID = AGE.AGE_ESM_ID
                                WHERE  AGE.AGE_AGD_DT_ATENDIMENTO BETWEEN pDATA_INI AND pDATA_FIM
                                AND ESM.CAD_PRO_ID_PROFISSIONAL =  pCAD_PRO_ID_PROFISSIONAL
                                AND ESM.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS
                                and (decode(esm.age_esm_fl_agend_grupo,null,'N',esm.age_esm_fl_agend_grupo) = 'S' )))
                                
         )                       

;
 return(RESULT);
end FNC_AGE_ATEND_STATUS;
