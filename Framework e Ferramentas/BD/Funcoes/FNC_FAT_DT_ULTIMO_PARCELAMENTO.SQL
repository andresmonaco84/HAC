CREATE OR REPLACE FUNCTION FNC_FAT_DT_ULTIMO_PARCELAMENTO(pATD_ATE_ID in NUMBER, pCAD_CNV_ID_CONVENIO in NUMBER)
return DATE is Result DATE;
begin

  SELECT CCP.FAT_CCP_DT_PARCELA
    INTO RESULT
    FROM TB_CAD_PAC_PACIENTE        PAC,
         TB_FAT_CCP_CONTA_CONS_PARC CCP
   WHERE CCP.ATD_ATE_ID = pATD_ATE_ID
     AND CCP.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
     AND CCP.FAT_CCP_FL_STATUS = 'A'
     AND CCP.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
     AND PAC.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO
     AND CCP.FAT_CCP_ID = (SELECT NVL(MAX(CCP.FAT_CCP_ID), 0) 
                             FROM TB_CAD_PAC_PACIENTE        PAC,
                                  TB_FAT_CCP_CONTA_CONS_PARC CCP
                            WHERE CCP.ATD_ATE_ID = pATD_ATE_ID
                              AND CCP.FAT_CCP_FL_STATUS = 'A'
                              AND PAC.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO
                              AND CCP.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE);
  return(Result);
end FNC_FAT_DT_ULTIMO_PARCELAMENTO;
/
