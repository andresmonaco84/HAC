create or replace function FNC_ESM_CANCELADOS2
(
 pAGE_ESM_ID in TB_AGE_ESM_ESCALA_MEDICA.AGE_ESM_ID%TYPE,
 pDATA_INI IN TB_AGE_AGD_AGENDA.AGE_AGD_DT_AGENDA%TYPE,
 pDATA_FIM IN TB_AGE_AGD_AGENDA.AGE_AGD_DT_AGENDA%TYPE
)
return NUMBER is Result NUMBER;

begin

SELECT count(*)into Result
 FROM TB_AGE_AGG_AGENDA_GERADA AGG
 INNER JOIN TB_AGE_ESM_ESCALA_MEDICA ESM
  ON AGG.AGE_ESM_ID = ESM.AGE_ESM_ID
 INNER JOIN TB_AGE_AGC_AGENDA_CANCELADA AGC
  ON AGC.AGE_AGG_ID = AGG.AGE_AGG_ID
 where ESM.AGE_ESM_ID =  pAGE_ESM_ID
 AND AGG.AGE_AGG_DT_AGENDA BETWEEN pDATA_INI AND pDATA_FIM
 AND (AGG.AGE_AGG_DT_AGENDA <= ESM.AGE_ESM_DT_FIM_ESCALA
 OR ESM.AGE_ESM_DT_FIM_ESCALA IS NULL);



 return(Result );
end FNC_ESM_CANCELADOS2;
 