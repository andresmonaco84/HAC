CREATE OR REPLACE PROCEDURE PRC_ATE_REL_ATEND_LIBERADOS
(
  pCAD_UNI_ID_UNIDADE IN TB_CAD_UNI_UNIDADE.CAD_UNI_ID_UNIDADE%TYPE,
  pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_CAD_LAT_LOCAL_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
  pCAD_SET_ID IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,
  pCAD_SET_NR_ANDAR IN TB_CAD_SET_SETOR.CAD_SET_NR_ANDAR%TYPE DEFAULT NULL,
  pATD_DT_INICIO IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_DT_ATUALIZACAO%TYPE,
  pATD_DT_FIM IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_DT_ATUALIZACAO%TYPE,
  pATD_HR_INICIO IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_HR_ATUALIZACAO%TYPE DEFAULT NULL,
  pATD_HR_FIM IN TB_SEG_HIU_HISTORICO_USUARIO.SEG_HIU_HR_ATUALIZACAO%TYPE DEFAULT NULL,
  pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%TYPE DEFAULT NULL,
  pCAD_PRO_ID_PROFISSIONAL IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%TYPE DEFAULT NULL,
  pCAD_CNV_ID_CONVENIO IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
  pCAD_PLA_ID_PLANO IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%TYPE DEFAULT NULL,
  pTIS_TAT_CD_TPATENDIMENTO IN TB_TIS_TAT_TP_ATENDIMENTO.TIS_TAT_CD_TPATENDIMENTO%TYPE DEFAULT NULL,
  pCAD_PLA_CD_TIPOPLANO IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
       pCAD_CGC_ID IN tb_cad_cnv_convenio.cad_cgc_id%TYPE DEFAULT NULL,
  io_cursor OUT PKG_CURSOR.t_cursor
)
IS
 v_cursor PKG_CURSOR.t_cursor;
  begin
    OPEN v_cursor FOR
SELECT
UNI.CAD_UNI_DS_UNIDADE AS NOME_UNIDADE,
LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
SETOR.CAD_SET_DS_SETOR,
SETOR.CAD_SET_NR_ANDAR,
CNV.CAD_CNV_CD_HAC_PRESTADOR,
PLA.CAD_PLA_CD_PLANO_HAC,
ATE.ATD_ATE_ID,
HIU.SEG_HIU_DT_ATUALIZACAO,
HIU.SEG_HIU_HR_ATUALIZACAO,
USU.SEG_USU_CD_MATRICULA,
USU.SEG_USU_DS_NOME,
PRO.CAD_PRO_NM_NOME AS NOME_PROFISSIONAL,
PRO.CAD_PRO_NR_CONSELHO AS NUMERO_CONSELHO,
PAC.CAD_PAC_NR_PRONTUARIO,
 (
   SELECT COUNT(ATE.ATD_ATE_ID) FROM
   TB_ATD_ATE_ATENDIMENTO ATE
INNER JOIN TB_CAD_UNI_UNIDADE UNI ON ATE.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
 AND UNI.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
INNER JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO
 AND (LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO OR pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL)
INNER JOIN TB_ASS_PAT_PACIEATEND PAT ON PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
INNER JOIN TB_CAD_PAC_PACIENTE PAC ON PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
INNER JOIN TB_CAD_SET_SETOR SETOR ON ATE.CAD_SET_ID = SETOR.CAD_SET_ID
 AND (SETOR.CAD_SET_ID = pCAD_SET_ID OR pCAD_SET_ID IS NULL)
 AND (SETOR.CAD_SET_NR_ANDAR = pCAD_SET_NR_ANDAR OR pCAD_SET_NR_ANDAR IS NULL)
INNER JOIN TB_SEG_HIU_HISTORICO_USUARIO HIU ON HIU.SEG_USU_ID_USUARIO = ATE.SEG_USU_ID_USUARIO
 AND HIU.SEG_FUN_ID_FUNCIONALIDADE = 260
 AND HIU.SEG_MOD_ID_MODULO = 41
 AND HIU.ATD_ATE_ID = ATE.ATD_ATE_ID
 AND HIU.SEG_HIU_DT_ATUALIZACAO BETWEEN pATD_DT_INICIO AND pATD_DT_FIM
 AND ((HIU.SEG_HIU_HR_ATUALIZACAO >= pATD_HR_INICIO AND HIU.SEG_HIU_HR_ATUALIZACAO <= pATD_HR_FIM)
     OR pATD_HR_INICIO IS NULL OR pATD_HR_FIM IS NULL)
INNER JOIN TB_SEG_USU_USUARIO USU ON USU.SEG_USU_ID_USUARIO = ATE.SEG_USU_ID_USUARIO
INNER JOIN TB_TIS_CBO_CBOS CBO ON ATE.TIS_CBO_CD_CBOS = CBO.TIS_CBO_CD_CBOS
 AND (CBO.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS OR pTIS_CBO_CD_CBOS IS NULL)
INNER JOIN TB_CAD_PRO_PROFISSIONAL PRO ON ATE.CAD_PRO_ID_PROF_EXEC = PRO.CAD_PRO_ID_PROFISSIONAL
 AND (PRO.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL OR pCAD_PRO_ID_PROFISSIONAL IS NULL)
INNER JOIN TB_CAD_CNV_CONVENIO CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
 AND (CNV.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO OR pCAD_CNV_ID_CONVENIO IS NULL)
INNER JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 AND (PLA.CAD_PLA_ID_PLANO = pCAD_PLA_ID_PLANO OR pCAD_PLA_ID_PLANO IS NULL)
 AND (PLA.CAD_PLA_CD_TIPOPLANO = pCAD_PLA_CD_TIPOPLANO OR pCAD_PLA_CD_TIPOPLANO IS NULL)
INNER JOIN TB_TIS_TAT_TP_ATENDIMENTO TAT
 ON TAT.TIS_TAT_CD_TPATENDIMENTO = ATE.TIS_TAT_CD_TPATENDIMENTO
 AND (TAT.TIS_TAT_CD_TPATENDIMENTO = pTIS_TAT_CD_TPATENDIMENTO OR pTIS_TAT_CD_TPATENDIMENTO IS NULL)
 ) TOTAL
 
 FROM TB_ATD_ATE_ATENDIMENTO ATE
INNER JOIN TB_CAD_UNI_UNIDADE UNI ON ATE.CAD_UNI_ID_UNIDADE = UNI.CAD_UNI_ID_UNIDADE
 AND UNI.CAD_UNI_ID_UNIDADE = pCAD_UNI_ID_UNIDADE
INNER JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON ATE.CAD_LAT_ID_LOCAL_ATENDIMENTO = LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO
 AND (LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO OR pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL)
INNER JOIN TB_ASS_PAT_PACIEATEND PAT ON PAT.ATD_ATE_ID = ATE.ATD_ATE_ID
INNER JOIN TB_CAD_PAC_PACIENTE PAC ON PAT.CAD_PAC_ID_PACIENTE = PAC.CAD_PAC_ID_PACIENTE
INNER JOIN TB_CAD_SET_SETOR SETOR ON ATE.CAD_SET_ID = SETOR.CAD_SET_ID
 AND (SETOR.CAD_SET_ID = pCAD_SET_ID OR pCAD_SET_ID IS NULL)
 AND (SETOR.CAD_SET_NR_ANDAR = pCAD_SET_NR_ANDAR OR pCAD_SET_NR_ANDAR IS NULL)
INNER JOIN TB_SEG_HIU_HISTORICO_USUARIO HIU ON HIU.SEG_USU_ID_USUARIO = ATE.SEG_USU_ID_USUARIO
 AND HIU.SEG_FUN_ID_FUNCIONALIDADE = 260
 AND HIU.SEG_MOD_ID_MODULO = 41
 AND HIU.ATD_ATE_ID = ATE.ATD_ATE_ID
 AND HIU.SEG_HIU_DT_ATUALIZACAO BETWEEN pATD_DT_INICIO AND pATD_DT_FIM
 AND ((HIU.SEG_HIU_HR_ATUALIZACAO >= pATD_HR_INICIO AND HIU.SEG_HIU_HR_ATUALIZACAO <= pATD_HR_FIM)
     OR pATD_HR_INICIO IS NULL OR pATD_HR_FIM IS NULL)
INNER JOIN TB_SEG_USU_USUARIO USU ON USU.SEG_USU_ID_USUARIO = ATE.SEG_USU_ID_USUARIO
INNER JOIN TB_TIS_CBO_CBOS CBO ON ATE.TIS_CBO_CD_CBOS = CBO.TIS_CBO_CD_CBOS
 AND (CBO.TIS_CBO_CD_CBOS = pTIS_CBO_CD_CBOS OR pTIS_CBO_CD_CBOS IS NULL)
INNER JOIN TB_CAD_PRO_PROFISSIONAL PRO ON ATE.CAD_PRO_ID_PROF_EXEC = PRO.CAD_PRO_ID_PROFISSIONAL
 AND (PRO.CAD_PRO_ID_PROFISSIONAL = pCAD_PRO_ID_PROFISSIONAL OR pCAD_PRO_ID_PROFISSIONAL IS NULL)
INNER JOIN TB_CAD_CNV_CONVENIO CNV ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
 AND (CNV.CAD_CNV_ID_CONVENIO = pCAD_CNV_ID_CONVENIO OR pCAD_CNV_ID_CONVENIO IS NULL)
     AND (CNV.CAD_CGC_ID = pCAD_CGC_ID OR  pCAD_CGC_ID IS NULL)  
INNER JOIN TB_CAD_PLA_PLANO PLA ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 AND (PLA.CAD_PLA_ID_PLANO = pCAD_PLA_ID_PLANO OR pCAD_PLA_ID_PLANO IS NULL)
 AND (PLA.CAD_PLA_CD_TIPOPLANO = pCAD_PLA_CD_TIPOPLANO OR pCAD_PLA_CD_TIPOPLANO IS NULL)
INNER JOIN TB_TIS_TAT_TP_ATENDIMENTO TAT ON TAT.TIS_TAT_CD_TPATENDIMENTO = ATE.TIS_TAT_CD_TPATENDIMENTO
 AND (TAT.TIS_TAT_CD_TPATENDIMENTO = pTIS_TAT_CD_TPATENDIMENTO OR pTIS_TAT_CD_TPATENDIMENTO IS NULL);
  io_cursor := v_cursor;
END PRC_ATE_REL_ATEND_LIBERADOS;
 