CREATE OR REPLACE PROCEDURE PRC_INT_REL_PAC
  (
pATD_ATE_DT_ATENDIMENTO_INI IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
pATD_ATE_DT_ATENDIMENTO_FIM IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_DT_ATENDIMENTO%TYPE DEFAULT NULL,
pATD_ATE_HR_ATENDIMENTO_INI IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_HR_ATENDIMENTO%TYPE DEFAULT NULL,
pATD_ATE_HR_ATENDIMENTO_FIM IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_HR_ATENDIMENTO%TYPE DEFAULT NULL,
pATD_ATE_FL_CARATER_SOLIC_U IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_CARATER_SOLIC%TYPE DEFAULT NULL,
pATD_ATE_FL_CARATER_SOLIC_E IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_FL_CARATER_SOLIC%TYPE DEFAULT NULL,
pFAIXA_ETARIA_INI varchar2 default null,
pFAIXA_ETARIA_FIM varchar2 default null,
pCAD_UNI_ID_UNIDADE IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
pCAD_SET_ID IN TB_CAD_SET_SETOR.CAD_SET_ID%TYPE DEFAULT NULL,
pCAD_SET_NR_ANDAR IN TB_CAD_SET_SETOR.CAD_SET_NR_ANDAR%TYPE DEFAULT NULL,
pATD_AIC_TP_SITUACAO_PAC IN TB_ATD_AIC_ATE_INT_COMPL.ATD_AIC_TP_SITUACAO_PAC%TYPE DEFAULT NULL,
pATD_ATE_TP_PACIENTE_I IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_TP_PACIENTE%TYPE DEFAULT NULL,
pATD_ATE_TP_PACIENTE_E IN TB_ATD_ATE_ATENDIMENTO.ATD_ATE_TP_PACIENTE%TYPE DEFAULT NULL,
pCAD_QLE_TP_QUARTO_LEITO IN TB_CAD_QLE_QUARTO_LEITO.CAD_QLE_TP_QUARTO_LEITO%TYPE DEFAULT NULL,
pTIS_TIN_CD_INTER IN TB_ATD_AIC_ATE_INT_COMPL.TIS_TIN_CD_INTERNACAO%TYPE DEFAULT NULL,
pTIS_TRI_CD_TP_REGINT IN TB_ATD_AIC_ATE_INT_COMPL.TIS_TRI_CD_REGINTENNACAO%TYPE DEFAULT NULL,
pCAD_PLA_CD_TIPOPLANO_GB IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL, --ACS
pCAD_PLA_CD_TIPOPLANO_PL IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL, --ACS
pCAD_PLA_CD_TIPOPLANO_FU IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
pCAD_PLA_CD_TIPOPLANO_NP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
pCAD_PLA_CD_TIPOPLANO_PA IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
pCAD_PLA_CD_TIPOPLANO_SP IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
pCAD_PRD_ID IN TB_CAD_PRD_PRODUTO.CAD_PRD_ID%TYPE DEFAULT NULL,
pTIS_TAC_CD_TIPO_ACOMODACAO IN TB_TIS_TAC_TIPO_ACOMODACAO.TIS_TAC_CD_TIPO_ACOMODACAO%TYPE DEFAULT NULL,
pTIS_CBO_CD_CBOS IN TB_TIS_CBO_CBOS.TIS_CBO_CD_CBOS%TYPE DEFAULT NULL,
pCAD_PRO_ID_PROF_EXEC IN TB_CAD_PRO_PROFISSIONAL.CAD_PRO_ID_PROFISSIONAL%TYPE DEFAULT NULL,
pCAD_PES_TP_SEXO IN TB_CAD_PES_PESSOA.CAD_PES_TP_SEXO%TYPE DEFAULT NULL,
pCAD_CNV_ID_CONVENIO     IN TB_CAD_CNV_CONVENIO.CAD_CNV_ID_CONVENIO%TYPE DEFAULT NULL,
pCAD_PLA_ID_PLANO        IN TB_CAD_PLA_PLANO.CAD_PLA_ID_PLANO%TYPE DEFAULT NULL,
pCAD_UNI_ID_UNID_PROC    IN TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNID_PROC%TYPE DEFAULT NULL,
pTIS_TAT_CD_TPATENDIMENTO_AH varchar2 default null,
pTIS_TAT_CD_TPATENDIMENTO_IH varchar2 default null,
pAUX_MUN_CD_IBGE IN TB_AUX_MUN_MUNICIPIO.AUX_MUN_CD_IBGE%TYPE DEFAULT NULL,
pAUX_MUN_SG_UF IN TB_AUX_MUN_MUNICIPIO.AUX_MUN_SG_UF%TYPE DEFAULT NULL,
pCAD_CGC_ID_G IN TB_CAD_CNV_CONVENIO.CAD_CGC_ID%TYPE DEFAULT NULL,
pCAD_CGC_ID_E IN TB_CAD_CNV_CONVENIO.CAD_CGC_ID%TYPE DEFAULT NULL,
--pRELATORIO_INSTGERIATRIA      varchar2 default null,
pID_PLANOS                varchar2 default null,
PPAC_PERMANENCIA_ACIMA_24H VARCHAR2 DEFAULT NULL,
  --  TESTE OUT LONG,
   io_cursor              OUT PKG_CURSOR.t_cursor) is
   /********************************************************************
  *    Procedure: PRC_INT_REL_PAC
  *
  *    Data Criacao:  11/08/2009      Por: Pedro
  *    Data Alteracao: 30/05/2012          Por: Pedro
  *    Alterado para V_SELECT V_WHERE
 *
  *    Funcao: Popula o Relatorio de Pacientes Internados com varias possibilidades de filtro
  *    Alterado em 07/03/2012 Por Eduardo Hyppolito Para: apresentar CNS
  *
 *******************************************************************/
v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(3000);
  V_SELECT  varchar2(15000);
  V_WHERESUB  varchar2(3000);
  begin
    V_WHERE := NULL;
    V_WHERESUB:=NULL;
IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN  V_WHERE := V_WHERE || ' AND ATD.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE; END IF;
IF pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO = ' || pCAD_LAT_ID_LOCAL_ATENDIMENTO; END IF;
IF pCAD_SET_ID IS NOT NULL THEN V_WHERE := V_WHERE || ' AND IML_QLE.CAD_SET_ID = ' || pCAD_SET_ID; END IF;
IF pATD_AIC_TP_SITUACAO_PAC IS NOT NULL THEN V_WHERE := V_WHERE || ' AND AIC.ATD_AIC_TP_SITUACAO_PAC = ' ||CHR(39)|| pATD_AIC_TP_SITUACAO_PAC ||CHR(39); END IF;
IF pATD_AIC_TP_SITUACAO_PAC = 'A' THEN V_WHERE := V_WHERE || ' AND INA.ATD_ATE_ID IS NOT NULL '; END IF;
IF pATD_ATE_HR_ATENDIMENTO_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATD.ATD_ATE_HR_ATENDIMENTO  BETWEEN ' || pATD_ATE_HR_ATENDIMENTO_INI || ' AND ' || pATD_ATE_HR_ATENDIMENTO_FIM  ; END IF;
IF pFAIXA_ETARIA_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND FLOOR(FLOOR(MONTHS_BETWEEN(DECODE(INA.ATD_INA_DT_ALTA_ADM,NULL,ATD.ATD_ATE_DT_ATENDIMENTO,INA.ATD_INA_DT_ALTA_ADM), PES.CAD_PES_DT_NASCIMENTO)) / 12) BETWEEN ' || pFAIXA_ETARIA_INI || ' AND ' || pFAIXA_ETARIA_FIM; END IF;
IF pTIS_CBO_CD_CBOS IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATD.TIS_CBO_CD_CBOS = ' ||CHR(39)|| pTIS_CBO_CD_CBOS ||CHR(39); END IF;
IF pCAD_PRO_ID_PROF_EXEC IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATD.CAD_PRO_ID_PROF_EXEC = ' || pCAD_PRO_ID_PROF_EXEC; END IF;
IF pCAD_CNV_ID_CONVENIO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PAC.CAD_CNV_ID_CONVENIO = ' || pCAD_CNV_ID_CONVENIO; END IF;
--IF pRELATORIO_ACS IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PAT.CAD_CNV_ID_CONVENIO = 281' || pRELATORIO_ACS; END IF;
IF pCAD_PLA_ID_PLANO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PAC.CAD_PLA_ID_PLANO = ' || pCAD_PLA_ID_PLANO; END IF;
IF pCAD_PRD_ID IS NOT NULL THEN V_WHERE := V_WHERE || ' AND AIC.CAD_PRD_ID = ' || pCAD_PRD_ID; END IF;
IF pCAD_PES_TP_SEXO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PES.CAD_PES_TP_SEXO = ' ||CHR(39)|| pCAD_PES_TP_SEXO ||CHR(39); END IF;
IF pTIS_TAC_CD_TIPO_ACOMODACAO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TAC.TIS_TAC_CD_TIPO_ACOMODACAO = ' ||CHR(39)|| pTIS_TAC_CD_TIPO_ACOMODACAO ||CHR(39); END IF;
IF pCAD_QLE_TP_QUARTO_LEITO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND IML_QLE.CAD_QLE_TP_QUARTO_LEITO = ' ||CHR(39)|| pCAD_QLE_TP_QUARTO_LEITO ||CHR(39); END IF;
IF pTIS_TIN_CD_INTER IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TIN.TIS_TIN_CD_INTERNACAO = ' ||CHR(39)|| pTIS_TIN_CD_INTER ||CHR(39); END IF;
IF pTIS_TRI_CD_TP_REGINT IS NOT NULL THEN V_WHERE := V_WHERE || ' AND  TRI.TIS_TRI_CD_TP_REGINTERNACAO = ' ||CHR(39)|| pTIS_TRI_CD_TP_REGINT ||CHR(39); END IF;
IF pCAD_UNI_ID_UNID_PROC  IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATD.CAD_UNI_ID_UNID_PROC = ' || pCAD_UNI_ID_UNID_PROC ; END IF;
IF pATD_ATE_DT_ATENDIMENTO_INI IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATD.ATD_ATE_DT_ATENDIMENTO >= TO_DATE('||CHR(39)||TO_CHAR(pATD_ATE_DT_ATENDIMENTO_INI,'DDMMYYYY')||CHR(39)||','||CHR(39)||'DDMMYYYY'||CHR(39)|| ')' ; END IF;
IF pATD_ATE_DT_ATENDIMENTO_FIM IS NOT NULL THEN V_WHERE:= V_WHERE || ' AND ATD.ATD_ATE_DT_ATENDIMENTO <= TO_DATE('||CHR(39)||TO_CHAR(pATD_ATE_DT_ATENDIMENTO_FIM,'DDMMYYYY')||CHR(39)||','||CHR(39)||'DDMMYYYY'||CHR(39)|| ')' ; END IF;
IF pATD_ATE_DT_ATENDIMENTO_INI IS NULL AND pATD_ATE_DT_ATENDIMENTO_FIM IS NULL THEN
   V_WHERE := V_WHERE || ' AND AIC.ATD_AIC_TP_SITUACAO_PAC = '||CHR(39)||'I'||CHR(39); END IF;
IF pAUX_MUN_CD_IBGE IS NOT NULL THEN V_WHERE := V_WHERE || ' AND FNC_CAD_PES_IBGE_MUNICIPIO_S(PES.CAD_PES_ID_PESSOA,1) = ' ||CHR(39)|| pAUX_MUN_CD_IBGE ||CHR(39); END IF;
IF pAUX_MUN_SG_UF IS NOT NULL THEN V_WHERE := V_WHERE || ' AND FNC_CAD_PES_UF_MUNICIPIO_S(PES.CAD_PES_ID_PESSOA,1) = ' ||CHR(39)|| pAUX_MUN_SG_UF ||CHR(39); END IF;

IF pID_PLANOS IS NOT NULL THEN
   V_WHERE := V_WHERE || ' AND PLA.CAD_PLA_ID_PLANO IN ( SELECT * FROM TABLE(FNC_SPLIT(''' || pID_PLANOS || ''' ))) ';
   END IF;

IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN  V_WHERESUB := V_WHERESUB || ' AND ATD2.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE; END IF;
IF pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NOT NULL THEN V_WHERESUB := V_WHERESUB || ' AND ATD2.CAD_LAT_ID_LOCAL_ATENDIMENTO = ' || pCAD_LAT_ID_LOCAL_ATENDIMENTO; END IF;
IF pATD_AIC_TP_SITUACAO_PAC IS NOT NULL THEN V_WHERESUB := V_WHERESUB || ' AND AIC2.ATD_AIC_TP_SITUACAO_PAC = ' ||CHR(39)|| pATD_AIC_TP_SITUACAO_PAC ||CHR(39); END IF;
IF pCAD_UNI_ID_UNID_PROC  IS NOT NULL THEN V_WHERESUB := V_WHERESUB || ' AND ATD2.CAD_UNI_ID_UNID_PROC = ' || pCAD_UNI_ID_UNID_PROC ; END IF;
IF pATD_ATE_DT_ATENDIMENTO_INI IS NOT NULL THEN V_WHERESUB:= V_WHERESUB || ' AND ATD2.ATD_ATE_DT_ATENDIMENTO >= TO_DATE('||CHR(39)||TO_CHAR(pATD_ATE_DT_ATENDIMENTO_INI,'DDMMYYYY')||CHR(39)||','||CHR(39)||'DDMMYYYY'||CHR(39)|| ')' ; END IF;
IF pATD_ATE_DT_ATENDIMENTO_FIM IS NOT NULL THEN V_WHERESUB:= V_WHERESUB || ' AND ATD2.ATD_ATE_DT_ATENDIMENTO <= TO_DATE('||CHR(39)||TO_CHAR(pATD_ATE_DT_ATENDIMENTO_FIM,'DDMMYYYY')||CHR(39)||','||CHR(39)||'DDMMYYYY'||CHR(39)|| ')' ; END IF;
IF pATD_ATE_DT_ATENDIMENTO_INI IS NULL AND pATD_ATE_DT_ATENDIMENTO_FIM IS NULL THEN V_WHERESUB := V_WHERESUB || ' AND AIC2.ATD_AIC_TP_SITUACAO_PAC = '||CHR(39)||'I'||CHR(39); END IF;

--IF pATD_ATE_DT_ATENDIMENTO_INI IS NOT NULL AND pATD_ATE_DT_ATENDIMENTO_FIM IS NULL THEN
--  V_WHERE:= V_WHERE || ' AND ATD.ATD_ATE_DT_ATENDIMENTO = TO_DATE('||CHR(39)||TO_CHAR(pATD_ATE_DT_ATENDIMENTO_INI,'DDMMYYYY')||CHR(39)||','||CHR(39)||'DDMMYYYY'||CHR(39)|| ')' ; END IF;

IF pPAC_PERMANENCIA_ACIMA_24H IS NOT NULL THEN
  V_WHERE := V_WHERE || ' AND TO_DATE(SYSDATE, ''dd/MM/yyyy HH24:mi:ss'') -
                              TO_DATE(SGS.FNC_JUNTAR_DATA_HORA(ATD.ATD_ATE_DT_ATENDIMENTO, ATD.ATD_ATE_HR_ATENDIMENTO), ''dd/MM/yyyy HH24:mi:ss'') >= 2 ';
END IF;


V_SELECT :=
   '
   SELECT
               ATD_IML_DT_ENTRADA,
               ATD_IML_HR_ENTRADA,
               CAD_QLE_TP_QUARTO_LEITO,
               CAD_QLE_NR_QUARTO,
               CAD_QLE_NR_LEITO,
               TIS_TAC_DS_TIPO_ACOMODACAO,
               TIS_TAC_DS_TIPO_ACOMODACAO_AUT,
               ATD_ATE_ID,
               ATD_ATE_FL_CARATER_SOLIC,
         --      PES_UNI.CAD_PES_NM_PESSOA UNIDADE,
               UNIDADE,
               CAD_UNI_ID_UNIDADE,
               CAD_LAT_DS_LOCAL_ATENDIMENTO,
               CAD_SET_DS_SETOR,
               CAD_PAC_CD_CREDENCIAL,
               CAD_PAC_NR_PRONTUARIO,
               PACIENTE,
               CAD_PES_DT_NASCIMENTO,
               CAD_PES_TP_SEXO,
               CAD_PES_CD_CNS_SUS,
               AUX_MUN_NM_MUNICIPIO,
               AUX_MUN_SG_UF,
               TIS_CBO_DS_CBOS_HAC,
               ATD_AIC_TP_SITUACAO_PAC,
               ATD_ATE_TP_PACIENTE,
               ATD_INA_DT_ALTA_CLINICA,
               CAD_CNV_CD_HAC_PRESTADOR,
               CAD_PLA_CD_TIPOPLANO,
               CAD_PLA_CD_PLANO_HAC,
               ATD_ATE_DT_ATENDIMENTO,
               ATD_ATE_HR_ATENDIMENTO,
            --   PES_PRO.CAD_PES_NM_PESSOA PROFISSIONAL,
               PROFISSIONAL,
               CAD_PRO_NR_CONSELHO,
               CAD_PRO_SG_UF_CONSELHO,
                CAD_CID_DS_CID10,
               TIS_TIN_DS_INTERNACAO,
               TIS_TRI_DS_TP_REGINTERNACAO,
               CAD_PRD_NM_MNEMONICO,
               CAD_PRD_DS_DESCRICAO,
               CAD_SET_NR_ANDAR,
                idade,
                GER,
               ATD_GUI_CD_CODIGO,
               ATD_GUI_CD_SENHA,
               TIS_TAT_CD_TPATENDIMENTO,
               SUM(QTD_I) OVER(PARTITION BY HOSPITALDIA) QTD_I ,
               SUM(QTD_A) OVER(PARTITION BY HOSPITALDIA) QTD_A,
               SEG_USU_CD_MATRICULA,
               SEG_USU_DS_NOME,
               NOME_RESP,
               DTNASC_RESP,
               TEL_RESP,
               EMAIL_RESP,
               HOSPITALDIA,
               ATD_ATE_FL_SUSPEITA_COVID19,
               CAD_PES_FL_CUIDADOINTEGRAL,
               CAD_PES_FL_ISOLAMENTO
FROM (
SELECT DISTINCT
               IML_QLE.ATD_IML_DT_ENTRADA,
               IML_QLE.ATD_IML_HR_ENTRADA,
               DECODE(IML_QLE.CAD_QLE_TP_QUARTO_LEITO,''I'',''INTERNO'','||CHR(39)||'E'||CHR(39)||','||CHR(39)||'EXTRA'||CHR(39)||') CAD_QLE_TP_QUARTO_LEITO,
               IML_QLE.CAD_QLE_NR_QUARTO,
               IML_QLE.CAD_QLE_NR_LEITO,
               TAC.TIS_TAC_DS_TIPO_ACOMODACAO,
               TAC_AUT.TIS_TAC_DS_TIPO_ACOMODACAO TIS_TAC_DS_TIPO_ACOMODACAO_AUT,
               ATD.ATD_ATE_ID,
               DECODE(ATD.ATD_ATE_FL_CARATER_SOLIC,'||CHR(39)||'U'||CHR(39)||','||CHR(39)||'URGENCIA'||CHR(39)||','||CHR(39)||'E'||CHR(39)||','||CHR(39)||'ELETIVA'||CHR(39)||') ATD_ATE_FL_CARATER_SOLIC,
         --      PES_UNI.CAD_PES_NM_PESSOA UNIDADE,
               UNI.CAD_UNI_DS_UNIDADE UNIDADE,
               UNI.CAD_UNI_ID_UNIDADE,
               LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
               SETOR.CAD_SET_DS_SETOR,
               PAC.CAD_PAC_CD_CREDENCIAL,
               PAC.CAD_PAC_NR_PRONTUARIO,
               PES.CAD_PES_NM_PESSOA PACIENTE,
               PES.CAD_PES_DT_NASCIMENTO,
               PES.CAD_PES_TP_SEXO,
               PES.CAD_PES_CD_CNS_SUS,
               --fnc_cad_pes_municipio_s(pes.cad_pes_id_pessoa,1) AUX_MUN_NM_MUNICIPIO,
               FNC_CAD_PES_MUNICIPIO_S(PES.CAD_PES_ID_PESSOA,1) AUX_MUN_NM_MUNICIPIO,
               FNC_CAD_PES_UF_MUNICIPIO_S(PES.CAD_PES_ID_PESSOA,1) AUX_MUN_SG_UF,
               CBOS.TIS_CBO_DS_CBOS_HAC,
               DECODE(AIC.ATD_AIC_TP_SITUACAO_PAC,'||CHR(39)||'I'||CHR(39)||','||CHR(39)||'INTERNADO'||CHR(39)||','||CHR(39)||'A'||CHR(39)||','||CHR(39)||'SAIDA'||CHR(39)||') ATD_AIC_TP_SITUACAO_PAC,
               DECODE(ATD_ATE_TP_PACIENTE,'||CHR(39)||'I'||CHR(39)||','||CHR(39)||'INTERNO'||CHR(39)||','||CHR(39)||'E'||CHR(39)||','||CHR(39)||'EXTERNO'||CHR(39)||') ATD_ATE_TP_PACIENTE,
               INA.ATD_INA_DT_ALTA_ADM ATD_INA_DT_ALTA_CLINICA,
               CNV.CAD_CNV_CD_HAC_PRESTADOR,
               PLA.CAD_PLA_CD_TIPOPLANO,
               PLA.CAD_PLA_CD_PLANO_HAC,
               ATD.ATD_ATE_DT_ATENDIMENTO,
               ATD.ATD_ATE_HR_ATENDIMENTO,
            --   PES_PRO.CAD_PES_NM_PESSOA PROFISSIONAL,
               PRO.CAD_PRO_NM_NOME PROFISSIONAL,
               PRO.CAD_PRO_NR_CONSELHO,
               PRO.CAD_PRO_SG_UF_CONSELHO,
               FNC_INT_ULTIMO_CID(ATD.ATD_ATE_ID) CAD_CID_DS_CID10,
               TIN.TIS_TIN_DS_INTERNACAO,
               TRI.TIS_TRI_DS_TP_REGINTERNACAO,
               PRD.CAD_PRD_NM_MNEMONICO,
               PRD.CAD_PRD_DS_DESCRICAO,
               SETOR.CAD_SET_NR_ANDAR,
               FLOOR(FLOOR(MONTHS_BETWEEN(DECODE(INA.ATD_INA_DT_ALTA_ADM,NULL,ATD.ATD_ATE_DT_ATENDIMENTO,INA.ATD_INA_DT_ALTA_ADM), PES.CAD_PES_DT_NASCIMENTO)) / 12) idade,
               CASE WHEN CNV.CAD_CNV_CD_HAC_PRESTADOR = '||CHR(39)||'SD01'||CHR(39)||' THEN
                DECODE(FNC_VERIFICA_INSGER( TO_CHAR(PLA.CAD_PLA_CD_PLANO_HAC),
                                            TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL,0,3)) ,
                                            TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL,4,7)),
                                            TO_NUMBER(SUBSTR(PAC.CAD_PAC_CD_CREDENCIAL,11,2))),0,'||CHR(39)||''||CHR(39)||',1,'||CHR(39)||'INST.GERIATRIA'||CHR(39)||',2,'||CHR(39)||'INST.GERIATRIA'||CHR(39)||',4,'||CHR(39)||'AMB. ALTA CRITICOS'||CHR(39)||')
               ELSE '||CHR(39)||''||CHR(39)||' END GER,
               GUI.ATD_GUI_CD_CODIGO,
               GUI.ATD_GUI_CD_SENHA,
               CASE WHEN ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO = 46 THEN DECODE(TRIM(ATD.TIS_TAT_CD_TPATENDIMENTO),''6'',''A'',''7'',''I'')
                    ELSE NULL
               END TIS_TAT_CD_TPATENDIMENTO,
               DECODE(AIC.ATD_AIC_TP_SITUACAO_PAC,''I'',1,0) QTD_I,
               DECODE(AIC.ATD_AIC_TP_SITUACAO_PAC,''A'',1,0) QTD_A,
               USU.SEG_USU_CD_MATRICULA,
               USU.SEG_USU_DS_NOME,
               PESRESP.CAD_PES_NM_PESSOA NOME_RESP,
               PESRESP.CAD_PES_DT_NASCIMENTO DTNASC_RESP,
               fnc_cad_pes_telefone_s(ARE.CAD_PES_ID_PESSOA,1)  TEL_RESP,
               fnc_cad_pes_email_s(ARE.CAD_PES_ID_PESSOA)  EMAIL_RESP,

               CASE WHEN SETOR.CAD_SET_ID IN (2072,2312,5,140,2472) THEN ''S'' ELSE ''N'' END HOSPITALDIA,
               ATD.ATD_ATE_FL_SUSPEITA_COVID19,
               DECODE(PES.CAD_PES_FL_CUIDADOINTEGRAL,1,''SAVE1'',2,''SAVE2'',3,''SAVE3'') CAD_PES_FL_CUIDADOINTEGRAL,
               CASE WHEN PES.CAD_PES_FL_ISOLAMENTO = ''S'' THEN ''ISOLAMENTO'' ELSE NULL END CAD_PES_FL_ISOLAMENTO
  FROM
                TB_ATD_ATE_ATENDIMENTO    ATD
  JOIN          TB_CAD_PAC_PACIENTE       PAC  ON            PAC.CAD_PAC_ID_PACIENTE = fnc_buscar_paciente_atual(ATD.atd_ate_id)
  JOIN          TB_CAD_PES_PESSOA         PES  ON            PES.CAD_PES_ID_PESSOA   = PAC.CAD_PES_ID_PESSOA
  JOIN          TB_CAD_CNV_CONVENIO       CNV  ON            CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
  JOIN          TB_CAD_PLA_PLANO          PLA  ON            PLA.CAD_PLA_ID_PLANO    = PAC.CAD_PLA_ID_PLANO
  JOIN          TB_ATD_AIC_ATE_INT_COMPL  AIC  ON            AIC.ATD_ATE_ID          = ATD.ATD_ATE_ID
  LEFT JOIN  (  SELECT     QLE.CAD_QLE_ID, QLE.CAD_SET_ID , QLE.CAD_QLE_NR_QUARTO, QLE.CAD_QLE_NR_LEITO,
                          IML.ATD_ATE_ID, IML.TIS_TAC_CD_TIPO_ACOMODACAO, IML.TIS_TAC_CD_TIPO_ACOMOD_AUT,
                          QLE.CAD_QLE_TP_QUARTO_LEITO , IML.ATD_IML_DT_ENTRADA, IML.ATD_IML_HR_ENTRADA
                 FROM      TB_ATD_IML_INT_MOV_LEITO IML
                 LEFT JOIN TB_CAD_QLE_QUARTO_LEITO QLE ON        QLE.CAD_QLE_ID = IML.CAD_CAD_QLE_ID
                 JOIN      TB_ATD_ATE_ATENDIMENTO ATD2 ON        ATD2.ATD_ATE_ID = IML.ATD_ATE_ID
                 JOIN      TB_ATD_AIC_ATE_INT_COMPL AIC2 ON      AIC2.ATD_ATE_ID = IML.ATD_ATE_ID
                 WHERE     IML.ATD_IML_DT_SAIDA IS NULL AND IML.ATD_ATE_ID = ATD2.ATD_ATE_ID AND IML.ATD_IML_FL_STATUS = '||CHR(39)||'A'||CHR(39)||'
                 ' || V_WHERESUB || '
                UNION
                 SELECT NULL CAD_QLE_ID, IMS.CAD_SET_ID_SETOR, NULL CAD_QLE_NR_QUARTO, NULL CAD_QLE_NR_LEITO,
                             IMS.ATD_ATE_ID, NULL TIS_TAC_CD_TIPO_ACOMODACAO, IMS.TIS_TAC_CD_TIPO_ACOMOD_AUT,
                             NULL CAD_QLE_TP_QUARTO_LEITO, IMS.ATD_IMS_DT_ENTRADA ATD_IML_DT_ENTRADA, IMS.ATD_IMS_HR_ENTRADA ATD_IML_HR_ENTRADA
                 FROM      TB_ATD_IMS_INT_MOV_SETOR IMS
                 JOIN      TB_ATD_ATE_ATENDIMENTO ATD2 ON        ATD2.ATD_ATE_ID = IMS.ATD_ATE_ID
                 JOIN      TB_ATD_AIC_ATE_INT_COMPL AIC2 ON      AIC2.ATD_ATE_ID = IMS.ATD_ATE_ID
                 WHERE     IMS.ATD_ATE_ID = ATD2.ATD_ATE_ID AND IMS.ATD_IMS_DT_SAIDA IS NULL AND IMS.ATD_ATE_ID = ATD2.ATD_ATE_ID AND IMS.ATD_IMS_FL_STATUS = '||CHR(39)||'A'||CHR(39)||'
                  ' || V_WHERESUB || '
                 AND       NOT IMS.ATD_ATE_ID IN (SELECT IML.ATD_ATE_ID
                                               FROM      TB_ATD_IML_INT_MOV_LEITO IML
                                               LEFT JOIN TB_CAD_QLE_QUARTO_LEITO QLE ON        QLE.CAD_QLE_ID = IML.CAD_CAD_QLE_ID
                                               JOIN      TB_ATD_ATE_ATENDIMENTO ATD2 ON        ATD2.ATD_ATE_ID = IML.ATD_ATE_ID
                                               WHERE     IML.ATD_IML_DT_SAIDA IS NULL AND IML.ATD_ATE_ID = ATD2.ATD_ATE_ID AND IML.ATD_IML_FL_STATUS = '||CHR(39)||'A'||CHR(39)||')
              )  IML_QLE
  ON IML_QLE.ATD_ATE_ID = ATD.ATD_ATE_ID
  LEFT JOIN     TB_ATD_INA_INT_ALTA         INA  ON INA.ATD_ATE_ID            = ATD.ATD_ATE_ID
  JOIN          TB_TIS_CBO_CBOS             CBOS ON CBOS.TIS_CBO_CD_CBOS      = ATD.TIS_CBO_CD_CBOS
  LEFT JOIN     TB_TIS_TAC_TIPO_ACOMODACAO  TAC  ON TAC.TIS_TAC_CD_TIPO_ACOMODACAO = IML_QLE.TIS_TAC_CD_TIPO_ACOMODACAO
  LEFT JOIN     TB_TIS_TAC_TIPO_ACOMODACAO  TAC_AUT  ON TAC_AUT.TIS_TAC_CD_TIPO_ACOMODACAO = IML_QLE.TIS_TAC_CD_TIPO_ACOMOD_AUT

  JOIN          TB_CAD_UNI_UNIDADE          UNI  ON UNI.CAD_UNI_ID_UNIDADE    = ATD.CAD_UNI_ID_UNIDADE
  JOIN          TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ATD.CAD_LAT_ID_LOCAL_ATENDIMENTO
  LEFT JOIN     TB_CAD_SET_SETOR            SETOR ON SETOR.CAD_SET_ID          = IML_QLE.CAD_SET_ID
  JOIN          TB_CAD_PRO_PROFISSIONAL     PRO  ON PRO.CAD_PRO_ID_PROFISSIONAL = ATD.CAD_PRO_ID_PROF_EXEC
  LEFT JOIN     TB_TIS_TIN_TP_INTERNACAO    TIN  ON TIN.TIS_TIN_CD_INTERNACAO = AIC.TIS_TIN_CD_INTERNACAO
  LEFT JOIN     TB_TIS_TRI_TP_REGINTERNACAO TRI  ON TRI.TIS_TRI_CD_TP_REGINTERNACAO = AIC.TIS_TRI_CD_REGINTENNACAO
  LEFT JOIN     TB_CAD_PRD_PRODUTO          PRD  ON PRD.CAD_PRD_ID            = AIC.CAD_PRD_ID
  LEFT JOIN     TB_ATD_GUI_GUIAATEND        GUI  ON GUI.ATD_ATE_ID            = ATD.ATD_ATE_ID

  AND           GUI.ATD_GUI_FL_GUIAPRINC_OK =  '||CHR(39)||'S'||CHR(39)||'
  AND           CASE WHEN GUI.CAD_PAC_ID_PACIENTE IS NOT NULL THEN GUI.CAD_PAC_ID_PACIENTE ELSE NULL END =
                CASE WHEN GUI.CAD_PAC_ID_PACIENTE IS NOT NULL THEN PAC.CAD_PAC_ID_PACIENTE ELSE NULL END
  JOIN          TB_SEG_USU_USUARIO         USU  ON USU.SEG_USU_ID_USUARIO  = ATD.SEG_USU_ID_USUARIO

  LEFT JOIN     tb_ass_are_atd_responsavel ARE ON ARE.ATD_ATE_ID = ATD.ATD_ATE_ID
  LEFT JOIN     tb_cad_pes_pessoa PESRESP ON PESRESP.CAD_PES_ID_PESSOA = ARE.CAD_PES_ID_PESSOA

   WHERE
      (ATD.ATD_ATE_FL_STATUS = '||CHR(39)||'A'||CHR(39)||')
    --  AND (SETOR.CAD_SET_ID NOT IN (2072,2312,5,140,2472) OR SETOR.CAD_SET_CD_SETOR IS NULL)
      AND     (' ||CHR(39)|| pATD_ATE_TP_PACIENTE_I ||CHR(39)|| ' IS NOT NULL AND ATD.ATD_ATE_TP_PACIENTE = ' ||CHR(39)|| 'I' ||CHR(39)|| '
       OR      ' ||CHR(39)|| pATD_ATE_TP_PACIENTE_E ||CHR(39)|| ' IS NOT NULL AND ATD.ATD_ATE_TP_PACIENTE = ' ||CHR(39)|| 'E' ||CHR(39)|| ')

    AND (' ||CHR(39)|| pCAD_CGC_ID_G ||CHR(39)|| ' IS NOT NULL AND CNV.CAD_CGC_ID = ' ||CHR(39)|| '1' ||CHR(39)|| '
      OR ' ||CHR(39)|| pCAD_CGC_ID_E ||CHR(39)|| ' IS NOT NULL AND CNV.CAD_CGC_ID = ' ||CHR(39)|| '2' ||CHR(39)|| ')

    AND (' ||CHR(39)|| pCAD_PLA_CD_TIPOPLANO_GB ||CHR(39)|| ' IS not NULL and PLA.CAD_PLA_CD_TIPOPLANO = ' ||CHR(39)|| 'GB' ||CHR(39)|| '
     OR ' ||CHR(39)|| pCAD_PLA_CD_TIPOPLANO_PL ||CHR(39)|| ' IS NOT NULL AND PLA.CAD_PLA_CD_TIPOPLANO = ' ||CHR(39)|| 'PL' ||CHR(39)|| '
     OR ' ||CHR(39)|| pCAD_PLA_CD_TIPOPLANO_PA ||CHR(39)|| ' IS NOT NULL AND PLA.CAD_PLA_CD_TIPOPLANO = ' ||CHR(39)|| 'PA' ||CHR(39)|| '
     OR ' ||CHR(39)|| pCAD_PLA_CD_TIPOPLANO_SP ||CHR(39)|| ' IS NOT NULL AND PLA.CAD_PLA_CD_TIPOPLANO = ' ||CHR(39)|| 'SP' ||CHR(39)|| '
     OR ' ||CHR(39)|| pCAD_PLA_CD_TIPOPLANO_FU ||CHR(39)|| ' IS NOT NULL AND PLA.CAD_PLA_CD_TIPOPLANO = ' ||CHR(39)|| 'FU' ||CHR(39)|| ')
   AND (PLA.CAD_PLA_CD_TIPOPLANO != '||CHR(39)||'NP'||CHR(39)||')
   AND ( ' ||CHR(39)|| pATD_ATE_FL_CARATER_SOLIC_U ||CHR(39)|| ' IS NOT NULL AND ATD.ATD_ATE_FL_CARATER_SOLIC = '||CHR(39)||'U'||CHR(39)||'
      OR ' ||CHR(39)|| pATD_ATE_FL_CARATER_SOLIC_E ||CHR(39)|| ' IS NOT NULL AND ATD.ATD_ATE_FL_CARATER_SOLIC = '||CHR(39)||'E'||CHR(39)||')';
IF pCAD_LAT_ID_LOCAL_ATENDIMENTO = 46 THEN V_SELECT := V_SELECT ||
 'AND ('||CHR(39)|| pTIS_TAT_CD_TPATENDIMENTO_AH ||CHR(39)|| 'IS NOT NULL AND ATD.TIS_TAT_CD_TPATENDIMENTO = ''6''
    OR '||CHR(39)|| pTIS_TAT_CD_TPATENDIMENTO_IH ||CHR(39)|| 'IS NOT NULL AND ATD.TIS_TAT_CD_TPATENDIMENTO = ''7'')'   ;
 END IF;
 V_SELECT := V_SELECT || V_WHERE || '
   order by SETOR.CAD_SET_DS_SETOR,
            IML_QLE.CAD_QLE_NR_QUARTO,
            IML_QLE.CAD_QLE_NR_LEITO  )'
  ;
  --  TESTE :=  V_SELECT ;
OPEN v_cursor FOR
     V_SELECT ;
  --  SELECT 1 FROM DUAL;
  io_cursor := v_cursor;
end PRC_INT_REL_PAC;
