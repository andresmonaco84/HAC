create or replace procedure PRC_MTMD_MOV_HIST_PACIENTE
(
     pCAD_LAT_ID_LOCAL_ATENDIMENTO IN TB_MTMD_MOV_MOVIMENTACAO.CAD_LAT_ID_LOCAL_ATENDIMENTO%TYPE DEFAULT NULL,
     pCAD_UNI_ID_UNIDADE           IN TB_MTMD_MOV_MOVIMENTACAO.CAD_UNI_ID_UNIDADE%TYPE DEFAULT NULL,
     pCAD_SET_ID                   IN TB_MTMD_MOV_MOVIMENTACAO.CAD_SET_ID%TYPE DEFAULT NULL,
     pATD_ATE_ID                   IN TB_MTMD_MOV_MOVIMENTACAO.ATD_ATE_ID%TYPE,
     pATD_ATE_TP_PACIENTE          IN TB_MTMD_MOV_MOVIMENTACAO.ATD_ATE_TP_PACIENTE%TYPE,
     pDATAINI                      IN DATE DEFAULT NULL,
     pDATAFIM                      IN DATE DEFAULT NULL,
     io_cursor                     OUT PKG_CURSOR.t_cursor
  )
  is
  /********************************************************************
  *    Procedure: PRC_MTMD_MOV_HIST_PACIENTE
  *
  *    Data Criacao: 08/07/2010   Por: RICARDO COSTA
  *    Data Alteracao:4/10/2010    Por: Andre Souza Monaco
  *         Alterac?o: Adic?o de campos no retorno da TB_MTMD_MOV_MOVIMENTACAO
  *                    e Unidade/Local/Setor opcional
  *    Funcao: RETORNA MOVIMENTAC?O DE PRODUTOS, POR PACIENTE/SETOR
  *
  *******************************************************************/
  v_cursor PKG_CURSOR.t_cursor;
  NAO_FRACIONADO CONSTANT NUMBER := 0;
  CONSUMO_FRACIONADO             CONSTANT NUMBER := 14;
  CONSUMO_FRACIONADO_NAOFATURADO CONSTANT NUMBER := 35;
  CONSUMO_NAO_FRACIONADO         CONSTANT NUMBER := 11;
  CONSUMO_NAO_FATURADO           CONSTANT NUMBER := 18;
  CONSUMO_REUTILIZAVEL           CONSTANT NUMBER := 36;
  SIM            CONSTANT NUMBER := 1;
  NAO            CONSTANT NUMBER := 0;
  begin
    OPEN v_cursor FOR
    SELECT
       MOVIMENTACAO.MTMD_MOV_ID,
       MOVIMENTACAO.CAD_LAT_ID_LOCAL_ATENDIMENTO,
       MOVIMENTACAO.CAD_UNI_ID_UNIDADE,
       MOVIMENTACAO.CAD_SET_ID,
       MOVIMENTACAO.MTMD_REQ_ID,
       MOVIMENTACAO.MTMD_LOTEST_ID,
       MOVIMENTACAO.CAD_MTMD_ID,
       MOVIMENTACAO.CAD_MTMD_TPMOV_ID,
       DECODE(MOVIMENTACAO.CAD_MTMD_SUBTP_ID, CONSUMO_REUTILIZAVEL, CONSUMO_FRACIONADO, MOVIMENTACAO.CAD_MTMD_SUBTP_ID) CAD_MTMD_SUBTP_ID,
       MOVIMENTACAO.MTMD_MOV_DATA,
       MOVIMENTACAO.MTMD_MOV_QTDE,
       MOVIMENTACAO.MTMD_MOV_FL_FINALIZADO,
       MOVIMENTACAO.ATD_ATE_ID,
       MOVIMENTACAO.ATD_ATE_TP_PACIENTE,
       MOVIMENTACAO.MTMD_MOV_FL_FATURADO,
       MOVIMENTACAO.CAD_MTMD_FILIAL_ID,
       MOVIMENTACAO.MTMD_TP_FRACAO_ID,
       MOVIMENTACAO.MTMD_QTD_CONVERTIDA,
       MOVIMENTACAO.MTMD_MOV_DATA_FATURAMENTO,
       MOVIMENTACAO.MTMD_MOV_HORA_FATURAMENTO,
       MOVIMENTACAO.SEQ_PACIENTE,
       PRODUTO.CAD_MTMD_CODMNE,
       CASE
          WHEN  MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN( CONSUMO_FRACIONADO,CONSUMO_FRACIONADO_NAOFATURADO)
          AND   PRODUTO.CAD_MTMD_FL_FRACIONA = NAO  THEN FNC_MTMD_SOUNDALIKE(PRODUTO.CAD_MTMD_NOMEFANTASIA,PRODUTO.CAD_MTMD_GRUPO_ID)||' (FRACIONADO) '
          ELSE FNC_MTMD_SOUNDALIKE(PRODUTO.CAD_MTMD_NOMEFANTASIA,PRODUTO.CAD_MTMD_GRUPO_ID)
       END CAD_MTMD_NOMEFANTASIA,
       PRODUTO.CAD_MTMD_UNIDADE_VENDA,
       -- PRODUTO.CAD_MTMD_FL_FRACIONA,
       CASE
             WHEN  MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN(CONSUMO_NAO_FRACIONADO, CONSUMO_NAO_FATURADO)
             AND   PRODUTO.CAD_MTMD_FL_FRACIONA = SIM THEN
                NAO_FRACIONADO  -- FRACIONADO PARA INTEIRO
             ELSE
                PRODUTO.CAD_MTMD_FL_FRACIONA
       END CAD_MTMD_FL_FRACIONA,
       CASE
         WHEN MOVIMENTACAO.MTMD_TP_FRACAO_ID IS NOT NULL
         AND  MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN (CONSUMO_FRACIONADO, CONSUMO_FRACIONADO_NAOFATURADO)  THEN
            TO_CHAR(MOVIMENTACAO.MTMD_QTD_CONVERTIDA)||' '||(SELECT MTMD_DS_TP_FRACAO FROM TB_MTMD_TIPO_FRACAO WHERE MTMD_TP_FRACAO_ID = MOVIMENTACAO.MTMD_TP_FRACAO_ID)
         WHEN MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN (CONSUMO_FRACIONADO, CONSUMO_FRACIONADO_NAOFATURADO)
         AND  PRODUTO.CAD_MTMD_FL_FRACIONA = NAO THEN
            'FRACIONADO' -- INTEIRO FRACIONADO
         WHEN MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN (CONSUMO_NAO_FRACIONADO, CONSUMO_NAO_FATURADO)
         AND  PRODUTO.CAD_MTMD_FL_FRACIONA = SIM  THEN
            'INTEIRO' -- FRACIONADO CONSUMIDO INTEIRO
         ELSE NULL
       END  DS_QTDE_CONVERTIDA,
       NULL MTMD_DT_RESSUPRIMENTO,
       SETOR.CAD_SET_DS_SETOR,
       UNIDADE.CAD_UNI_DS_UNIDADE,
       SUBTP.CAD_MTMD_SUBTP_DESCRICAO,
       SUBTP.CAD_MTMD_FL_FATURA,
       USU_MOV.SEG_USU_DS_NOME DS_USUARIO,
       (CASE
           WHEN PRODUTO.CAD_MTMD_FL_FRACIONA = SIM AND MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN (14, 26, 35) THEN
              TO_CHAR( MOVIMENTACAO.MTMD_MOV_QTDE )||'/'||TO_CHAR( PRODUTO.CAD_MTMD_UNIDADE_VENDA)
           ELSE
              TO_CHAR( MOVIMENTACAO.MTMD_MOV_QTDE )
        END)  DS_QTDE_CONSUMO,
        PRODUTO.CAD_MTMD_FL_MAV,
        MOVIMENTACAO.MTMD_COD_LOTE,
        (SELECT NVL(LL.MTMD_NUM_LOTE_ALT, LL.MTMD_NUM_LOTE)
           FROM TB_MTMD_LOTEST_LOTE_ESTOQUE LL
          WHERE LL.CAD_MTMD_FILIAL_ID = 1 AND
                LL.CAD_MTMD_ID   = MOVIMENTACAO.CAD_MTMD_ID AND
                LL.MTMD_COD_LOTE = MOVIMENTACAO.MTMD_COD_LOTE AND ROWNUM = 1) MTMD_NUM_LOTE,
        KIT.CAD_MTMD_KIT_ID,
        KIT.CAD_MTMD_KIT_DSC
    FROM TB_MTMD_MOV_MOVIMENTACAO       MOVIMENTACAO,
         TB_CAD_MTMD_MAT_MED            PRODUTO,
         TB_CAD_SET_SETOR               SETOR,
         TB_CAD_UNI_UNIDADE             UNIDADE,
         TB_CAD_MTMD_SUBTP_MOVIMENTACAO SUBTP,
         TB_SEG_USU_USUARIO             USU_MOV,
         TB_CAD_MTMD_KIT                KIT
    WHERE (pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NULL OR MOVIMENTACAO.CAD_LAT_ID_LOCAL_ATENDIMENTO = pCAD_LAT_ID_LOCAL_ATENDIMENTO)
    AND   (pCAD_UNI_ID_UNIDADE           IS NULL OR MOVIMENTACAO.CAD_UNI_ID_UNIDADE           = pCAD_UNI_ID_UNIDADE)
    AND   (pCAD_SET_ID                   IS NULL OR MOVIMENTACAO.CAD_SET_ID                   = pCAD_SET_ID)
    AND   MOVIMENTACAO.ATD_ATE_ID                   = pATD_ATE_ID
--    AND   MOVIMENTACAO.ATD_ATE_TP_PACIENTE          = pATD_ATE_TP_PACIENTE
    AND   ( pDATAINI IS NULL OR MOVIMENTACAO.MTMD_MOV_DATA BETWEEN pDATAINI AND pDATAFIM )
/*    WHERE MOVIMENTACAO.CAD_LAT_ID_LOCAL_ATENDIMENTO = 29
    AND   MOVIMENTACAO.CAD_UNI_ID_UNIDADE           = 244
    AND   MOVIMENTACAO.CAD_SET_ID                   = 61
    AND   MOVIMENTACAO.ATD_ATE_ID                   = 317728
    AND   MOVIMENTACAO.ATD_ATE_TP_PACIENTE          = 'I' */
    -- subtipo 18, 35 foi colocado para centro cirurgico
    AND   MOVIMENTACAO.CAD_MTMD_SUBTP_ID IN (11, 14, 18, 24, 25, 26, 35, 36, 60)
    AND   MOVIMENTACAO.mtmd_mov_fl_estorno = 0
    AND   MOVIMENTACAO.CAD_MTMD_ID       = PRODUTO.CAD_MTMD_ID
    AND   SETOR.CAD_SET_ID               = MOVIMENTACAO.CAD_SET_ID
    AND   UNIDADE.CAD_UNI_ID_UNIDADE     = MOVIMENTACAO.CAD_UNI_ID_UNIDADE
    AND   SUBTP.CAD_MTMD_SUBTP_ID        = MOVIMENTACAO.CAD_MTMD_SUBTP_ID
    AND   USU_MOV.SEG_USU_ID_USUARIO(+)  = MOVIMENTACAO.SEG_USU_ID_USUARIO
    AND   KIT.CAD_MTMD_KIT_ID(+)         = MOVIMENTACAO.CAD_MTMD_KIT_ID
    ORDER BY MOVIMENTACAO.MTMD_MOV_DATA DESC, PRODUTO.CAD_MTMD_NOMEFANTASIA ASC;
    io_cursor := v_cursor;
end PRC_MTMD_MOV_HIST_PACIENTE;