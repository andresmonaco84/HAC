CREATE OR REPLACE PROCEDURE "PRC_ATS_REL_EST_ANATOMIA"
  (
     pCAD_PRD_ID IN TB_ATS_ATE_ATENDIMENTO_SADT.CAD_PRD_ID%type DEFAULT NULL,
     pCAD_UNI_ID_UNIDADE in TB_ATD_ATE_ATENDIMENTO.CAD_UNI_ID_UNIDADE%type DEFAULT NULL,
     pCAD_LAT_ID_LOCAL_ATENDIMENTO in TB_ATD_ATE_ATENDIMENTO.CAD_LAT_ID_LOCAL_ATENDIMENTO%type default null,
     pCAD_SET_ID IN TB_ATS_ATE_ATENDIMENTO_SADT.CAD_SET_ID_ATEN%type DEFAULT NULL,
     pAUX_EPP_CD_ESPECPROC IN TB_ATS_ATE_ATENDIMENTO_SADT.AUX_EPP_CD_ESPECPROC%type DEFAULT NULL,
     pCAD_PRO_ID_PROF_EXECUTANTE IN TB_ATS_ATE_ATENDIMENTO_SADT.CAD_PRO_ID_PROF_EXECUTANTE%type DEFAULT NULL,
     pDT_INI_CONSULTA IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_DT_REALIZ_PROCED%type DEFAULT NULL,
     pDT_FIM_CONSULTA IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_DT_REALIZ_PROCED%type DEFAULT NULL,
     pHR_INI_CONSULTA IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_HR_REALIZ_PROCED%type DEFAULT NULL,
     pHR_FIM_CONSULTA IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_HR_REALIZ_PROCED%type DEFAULT NULL,
     pATS_ATE_IN_INTLIB IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_IN_INTLIB%TYPE DEFAULT NULL,
     pCAD_PLA_CD_TIPOPLANO IN TB_CAD_PLA_PLANO.CAD_PLA_CD_TIPOPLANO%TYPE DEFAULT NULL,
     pATS_APL_TEXTO_LAUDO IN TB_ATS_APL_ATEN_PROCED_LAUDO.ATS_APL_DS_DIAGNOSTICO%TYPE DEFAULT NULL,
     pATS_APL_DS_DIAGNOSTICO IN TB_ATS_APL_ATEN_PROCED_LAUDO.ATS_APL_DS_DIAGNOSTICO%TYPE DEFAULT NULL,
     pATS_NUM_CONTROLE IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_NUM_CONTROLE%TYPE DEFAULT NULL,     
     pIDADE_INI IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_HR_REALIZ_PROCED%type DEFAULT NULL,
     pIDADE_FIM IN TB_ATS_ATE_ATENDIMENTO_SADT.ATS_ATE_HR_REALIZ_PROCED%type DEFAULT NULL,
     pCAD_PES_TP_SEXO IN TB_CAD_PES_PESSOA.CAD_PES_TP_SEXO%TYPE DEFAULT NULL,
     pALTA NUMBER DEFAULT NULL,
     pORDERBY NUMBER DEFAULT NULL,
     io_cursor OUT PKG_CURSOR.t_cursor
      --  , TESTE OUT LONG
  )
  is
  /********************************************************************
  *    Procedure: PRC_ATS_REL_EST_ANATOMIA
  *
  *******************************************************************/
 v_cursor PKG_CURSOR.t_cursor;
  V_WHERE  varchar2(3000);
  V_ORDERBY  varchar2(1000);
  V_SELECT  varchar2(28000);
  begin
  V_WHERE := NULL;
  V_ORDERBY := NULL;
   IF pCAD_UNI_ID_UNIDADE IS NOT NULL THEN V_WHERE := V_WHERE || ' AND UNI.CAD_UNI_ID_UNIDADE = ' || pCAD_UNI_ID_UNIDADE; END IF;
   IF pCAD_LAT_ID_LOCAL_ATENDIMENTO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = ' || pCAD_LAT_ID_LOCAL_ATENDIMENTO; END IF;
   IF pCAD_PRD_ID IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATS.CAD_PRD_ID = ' || pCAD_PRD_ID; END IF;
   IF pCAD_SET_ID IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATS.CAD_SET_ID_ATEN = ' || pCAD_SET_ID; END IF;
   IF pAUX_EPP_CD_ESPECPROC IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATS.AUX_EPP_CD_ESPECPROC = ' ||CHR(39)|| pAUX_EPP_CD_ESPECPROC ||CHR(39); END IF;
   IF pCAD_PRO_ID_PROF_EXECUTANTE IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATS.CAD_PRO_ID_PROF_EXECUTANTE = ' || pCAD_PRO_ID_PROF_EXECUTANTE; END IF;
   IF pCAD_PLA_CD_TIPOPLANO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND PLA.CAD_PLA_CD_TIPOPLANO = ' ||CHR(39)|| pCAD_PLA_CD_TIPOPLANO ||CHR(39); END IF;
   IF pATS_ATE_IN_INTLIB IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ATS.ATS_ATE_IN_INTLIB = ' ||CHR(39)|| pATS_ATE_IN_INTLIB ||CHR(39); END IF;
   IF pIDADE_INI IS NOT NULL THEN V_WHERE := V_WHERE || ' AND FLOOR(FLOOR(MONTHS_BETWEEN(ATS.ATS_ATE_DT_REALIZ_PROCED,  case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_DT_NASCIMENTO  ELSE PES_PAC.CAD_PES_DT_NASCIMENTO END )) / 12)  >= ' || pIDADE_INI; end if;
   IF pIDADE_FIM IS NOT NULL THEN V_WHERE := V_WHERE || ' AND FLOOR(FLOOR(MONTHS_BETWEEN(ATS.ATS_ATE_DT_REALIZ_PROCED,  case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_DT_NASCIMENTO  ELSE PES_PAC.CAD_PES_DT_NASCIMENTO END )) / 12)  <= ' || pIDADE_FIM; end if;
   IF pATS_NUM_CONTROLE IS NOT NULL THEN V_WHERE := V_WHERE || ' AND UPPER(ATS.ATS_NUM_CONTROLE) LIKE ' ||CHR(39)|| UPPER(pATS_NUM_CONTROLE)  ||CHR(39); end if;
   IF pATS_APL_TEXTO_LAUDO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND (UPPER(APL.ATS_APL_TEXTO_LAUDO) LIKE ''%' ||CHR(39)|| '||'||CHR(39)|| UPPER(pATS_APL_TEXTO_LAUDO) ||CHR(39)|| '||'||CHR(39)|| '%'') ' ; END IF;   
   IF pATS_APL_DS_DIAGNOSTICO IS NOT NULL THEN V_WHERE := V_WHERE || 
     '  AND (UPPER((SELECT LISTAGG(DIA.ATS_APL_DS_DIAGNOSTICO, chr(10)) WITHIN GROUP (ORDER BY DIA.ATS_APL_DS_DIAGNOSTICO) AS ATS_APL_DS_DIAGNOSTICO FROM TB_ATS_DIAGNOSTICO_LAUDO DIA  WHERE dia.ats_apl_id = APL.ats_apl_id)) LIKE ''%' ||CHR(39)|| '||'||CHR(39)|| UPPER(pATS_APL_DS_DIAGNOSTICO) ||CHR(39)|| '||'||CHR(39)|| '%'') ' ; END IF;   
   IF pCAD_PES_TP_SEXO IS NOT NULL THEN V_WHERE := V_WHERE || ' AND case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_TP_SEXO  ELSE PES_PAC.CAD_PES_TP_SEXO END  = ' ||CHR(39)|| pCAD_PES_TP_SEXO ||CHR(39); END IF;      
 if (((pHR_INI_CONSULTA IS NULL) AND (pHR_FIM_CONSULTA IS NULL)) OR (pHR_INI_CONSULTA < pHR_FIM_CONSULTA)  ) THEN
    IF pDT_INI_CONSULTA IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TRUNC(ATS.ATS_ATE_DT_REALIZ_PROCED) >= ' ||CHR(39)|| pDT_INI_CONSULTA ||CHR(39);    END IF;
    IF pDT_FIM_CONSULTA IS NOT NULL THEN V_WHERE := V_WHERE || ' AND TRUNC(ATS.ATS_ATE_DT_REALIZ_PROCED) <= ' ||CHR(39)|| pDT_FIM_CONSULTA ||CHR(39);    END IF;
    IF pHR_INI_CONSULTA IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ats.ats_ate_hr_realiz_proced >= ' || pHR_INI_CONSULTA; end if;
    IF pHR_FIM_CONSULTA IS NOT NULL THEN V_WHERE := V_WHERE || ' AND ats.ats_ate_hr_realiz_proced <= ' || pHR_FIM_CONSULTA; end if;
 END IF;
 if ((pHR_INI_CONSULTA IS NOT NULL) AND (pHR_FIM_CONSULTA IS NOT NULL)) AND  (pHR_INI_CONSULTA > pHR_FIM_CONSULTA) THEN
    IF pDT_INI_CONSULTA IS NOT NULL THEN V_WHERE := V_WHERE || ' AND fnc_juntar_data_hora(ATS.ATS_ATE_DT_REALIZ_PROCED,ATS.ats_ate_hr_realiz_proced) >= ' ||CHR(39)|| fnc_juntar_data_hora(pDT_INI_CONSULTA,pHR_INI_CONSULTA) ||CHR(39);    END IF;
    IF pDT_FIM_CONSULTA IS NOT NULL THEN V_WHERE := V_WHERE || ' AND fnc_juntar_data_hora(ATS.ATS_ATE_DT_REALIZ_PROCED,ATS.ats_ate_hr_realiz_proced) <= ' ||CHR(39)|| fnc_juntar_data_hora(pDT_FIM_CONSULTA,pHR_FIM_CONSULTA) ||CHR(39);    END IF;
 end if;
--IF pALTA IS NOT NULL THEN
--IF pALTA = '0' THEN V_WHERE := V_WHERE || ' AND ATS.ATS_ATE_IN_INTLIB = ' ||CHR(39)||'I'||CHR(39)||' AND AIC.ATD_AIC_TP_SITUACAO_PAC = ' ||CHR(39)||'I'||CHR(39); END IF;
--IF pALTA = '1' THEN V_WHERE := V_WHERE || ' AND ATS.ATS_ATE_IN_INTLIB = ' ||CHR(39)||'I'||CHR(39)||' AND AIC.ATD_AIC_TP_SITUACAO_PAC = ' ||CHR(39)||'A'||CHR(39); END IF;
--END IF;
  IF pORDERBY IS NULL OR pORDERBY = '0' THEN V_ORDERBY := V_ORDERBY || ' ATS.ATS_ATE_DT_REALIZ_PROCED,ATS.ATS_ATE_ID ' ; END IF;
  IF pORDERBY = '1' THEN V_ORDERBY := V_ORDERBY || ' ATS.ATS_ATE_DT_REALIZ_PROCED, case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_NM_NOME
           -- WHEN PAC.CAD_PAC_IDT_RN = 1 AND PES_PAC.CAD_PES_NM_RN IS NOT NULL THEN PES_PAC.CAD_PES_NM_RN
            ELSE PES_PAC.CAD_PES_NM_PESSOA
        END  ';  END IF;
  V_SELECT :=
   '
SELECT 
       ATS.ATS_ATE_DT_REALIZ_PROCED,
       ATS.ATS_ATE_HR_REALIZ_PROCED,
       ATS.ATS_ATE_CD_INTLIB,
       ATS.ATS_ATE_IN_INTLIB,
       ATS.ATS_ATE_ID,
       PRD.CAD_PRD_CD_CODIGO,
       PRD.CAD_PRD_NM_MNEMONICO,
       PRD.CAD_PRD_DS_DESCRICAO,
       UNI.CAD_UNI_DS_UNIDADE,
       LAT.CAD_LAT_DS_LOCAL_ATENDIMENTO,
       SETOR_PROCED.CAD_SET_DS_SETOR SETOR,
       SETOR_EXEC.CAD_SET_DS_SETOR SETOR_EXEC,
       ATS.ATS_ATE_FL_STATUS,
       decode(pla.cad_pla_cd_tipoplano,
                                        ''FU'', ''FUNCIONARIO'',
                                        ''PA'', ''PA'',
                                        ''GB'', ''GLOBAL'',
                                        ''PL'', ''PESSOA FISICA'',
                                        ''SP'', ''SERVICOS PRESTADOS'',
                                        ''TODOS'') tipo_empresa,
        case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_NM_NOME
           -- WHEN PAC.CAD_PAC_IDT_RN = 1 AND PES_PAC.CAD_PES_NM_RN IS NOT NULL THEN PES_PAC.CAD_PES_NM_RN
            ELSE PES_PAC.CAD_PES_NM_PESSOA
        END CAD_PES_NM_PESSOA,
        case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_DT_NASCIMENTO
            ELSE PES_PAC.CAD_PES_DT_NASCIMENTO
        END CAD_PES_DT_NASCIMENTO,
       FLOOR(FLOOR(MONTHS_BETWEEN(ATS.ATS_ATE_DT_REALIZ_PROCED, case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_DT_NASCIMENTO  ELSE PES_PAC.CAD_PES_DT_NASCIMENTO END)) / 12) IDADE,
       case when ATS.ATS_ATE_FL_RN = ''S'' then IDR.ATD_IDR_TP_SEXO  ELSE PES_PAC.CAD_PES_TP_SEXO END CAD_PES_TP_SEXO,
       CASE WHEN PRO.CAD_PRO_NM_NOME IS NOT NULL THEN PRO.CAD_PRO_NM_NOME ELSE PSO.CAD_PSO_NM_PROFISSIONAL END CAD_PRO_NM_NOME,
       --CNV.CAD_CNV_CD_HAC_PRESTADOR,
       --PLA.CAD_PLA_CD_PLANO_HAC,
       PAC.CAD_PAC_NR_PRONTUARIO,
       ATS.ATS_NUM_CONTROLE,
       (SELECT LISTAGG(DIA.ATS_APL_DS_DIAGNOSTICO, chr(10)) WITHIN GROUP (ORDER BY DIA.ATS_APL_DS_DIAGNOSTICO) AS ATS_APL_DS_DIAGNOSTICO
        FROM   TB_ATS_DIAGNOSTICO_LAUDO DIA
        WHERE dia.ats_apl_id = APL.ats_apl_id
        ) ATS_APL_DS_DIAGNOSTICO,
       APL.ATS_APL_STATUS_LAUDO,
       APL.ATS_APL_DT_LAUDO,
       APL.ATS_APL_HR_LAUDO,
       APL.ATS_APL_TEXTO_LAUDO
FROM TB_ATS_ATE_ATENDIMENTO_SADT ATS
JOIN TB_ATS_APL_ATEN_PROCED_LAUDO APL
  ON APL.ATS_ATE_CD_INTLIB = ATS.ATS_ATE_CD_INTLIB
 AND APL.ATS_ATE_ID = ATS.ATS_ATE_ID
 AND APL.CAD_PRD_ID = ATS.CAD_PRD_ID
 AND APL.TIS_MED_CD_TABELAMEDICA = ATS.TIS_MED_CD_TABELAMEDICA
 AND APL.AUX_EPP_CD_ESPECPROC = ATS.AUX_EPP_CD_ESPECPROC
 AND APL.ATS_ATE_IN_INTLIB = ATS.ATS_ATE_IN_INTLIB
 JOIN TB_CAD_SET_SETOR SETOR_EXEC   ON SETOR_EXEC.CAD_SET_ID = ATS.CAD_SET_ID_ATEN
 JOIN TB_CAD_SET_SETOR SETOR_PROCED ON SETOR_PROCED.CAD_SET_ID = ATS.CAD_SET_ID
 JOIN TB_CAD_UNI_UNIDADE UNI        ON UNI.CAD_UNI_ID_UNIDADE = SETOR_EXEC.CAD_UNI_ID_UNIDADE
 JOIN TB_CAD_LAT_LOCAL_ATENDIMENTO LAT ON LAT.CAD_LAT_ID_LOCAL_ATENDIMENTO = SETOR_EXEC.CAD_LAT_ID_LOCAL_ATENDIMENTO
 JOIN TB_CAD_PRD_PRODUTO PRD        ON PRD.CAD_PRD_ID = ATS.CAD_PRD_ID
 JOIN TB_CAD_PAC_PACIENTE PAC       ON PAC.CAD_PAC_ID_PACIENTE = ATS.CAD_PAC_ID_PACIENTE_INT
 JOIN TB_CAD_PES_PESSOA PES_PAC     ON PES_PAC.CAD_PES_ID_PESSOA = PAC.CAD_PES_ID_PESSOA
 LEFT JOIN TB_CAD_PRO_PROFISSIONAL PRO   ON TRIM(PRO.CAD_PRO_SG_UF_CONSELHO) = TRIM(ATS.ATS_ATE_SG_UF_CONSELHO_SOLIC)
                                   AND TRIM(PRO.CAD_PRO_NR_CONSELHO) = TRIM(ATS.ATS_ATE_NR_CONSELHO_SOLIC)
                                   AND TRIM(PRO.TIS_CPR_CD_CONSELHOPROF) = TRIM(ATS.ATS_ATE_TP_CONSELHO_SOLIC)
 LEFT JOIN TB_CAD_PSO_PROF_SOLICITANTE PSO   ON TRIM(PSO.CAD_PSO_SG_UF_CONSELHO) = TRIM(ATS.ATS_ATE_SG_UF_CONSELHO_SOLIC)
                                   AND TRIM(PSO.CAD_PSO_CD_CONSELHO) = TRIM(ATS.ATS_ATE_NR_CONSELHO_SOLIC)
                                   AND TRIM(PSO.TIS_CPR_CD_CONSELHOPROF) = TRIM(ATS.ATS_ATE_TP_CONSELHO_SOLIC)      
-- LEFT JOIN TB_ATD_AIC_ATE_INT_COMPL AIC     ON AIC.ATD_ATE_ID = ATS.ATS_ATE_CD_INTLIB
 JOIN TB_CAD_PLA_PLANO PLA     ON PLA.CAD_PLA_ID_PLANO = PAC.CAD_PLA_ID_PLANO
 --JOIN TB_CAD_CNV_CONVENIO CNV     ON CNV.CAD_CNV_ID_CONVENIO = PAC.CAD_CNV_ID_CONVENIO
    LEFT JOIN TB_ATD_IDR_INT_DADOS_RN IDR ON IDR.ATD_IDR_ID = ATS.ATS_ATE_ID_RN
WHERE
    (ATS.ATS_ATE_FL_STATUS <> ''C'')
    '  || V_WHERE ||
   ' ORDER BY ' || V_ORDERBY;
    -- ORDER BY 1,7,5
   --  TESTE :=  V_SELECT ;
OPEN v_cursor FOR
     V_SELECT ;
   -- SELECT 1 FROM DUAL;
    io_cursor := v_cursor;
  end PRC_ATS_REL_EST_ANATOMIA;
